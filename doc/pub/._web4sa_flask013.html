<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Doconce: http://code.google.com/p/doconce/" />

<link rel="stylesheet" href="https://raw.githubusercontent.com/hplgit/doconce/master/bundled/html_styles/style_vagrant/css/twitter_bootstrap.css">
<link rel="stylesheet" href="https://raw.githubusercontent.com/hplgit/doconce/master/bundled/html_styles/style_vagrant/css/vagrant.css">
<!-- Define color of headings here (last definition counts) -->
<style type="text/css">
h1, h2, h3, h4, h5, h6 {
  color: #000;     /* black */
  color: #999;     /* gray */
  color: #005580;  /* dark blue */
  color: #08c;     /* characteristic blue */
</style>
</head>
<body>

<title>Using Flask for Scientific Web Applications</title>

<div class="container">
 <div class="row Header with-border">
  <div class="span3 Module logo">
   <h1><a href="/">Flask<span class="subtitle">4scientists</span></a></h1>
  </div>
  <div class="span9">
   <div class="Module navigation">
    <ul>
     <li> <a href="http://flask.pocoo.org/">Flask</a></li>
    </ul>
   </div>
  </div>
 </div>
</div>

<div class="row">
 <div class="span3 Module sidebar">
  <div class="well" style="padding: 8px 0px;">
   <ul class="nav nav-list">
          <!-- navigation toc: --> <li><a href="._web4sa_flask000.html#___sec0" style="font-size: 80%;">Web frameworks</a></li>
     <!-- navigation toc: --> <li><a href="._web4sa_flask004.html#___sec4" style="font-size: 80%;">Making a Flask application</a></li>
     <!-- navigation toc: --> <li><a href="._web4sa_flask006.html#wf:vib:flask" style="font-size: 80%;">Handling multiple input variables in Flask</a></li>
     <!-- navigation toc: --> <li><a href="._web4sa_flask017.html#___sec52" style="font-size: 80%;">Exercises</a></li>
     <!-- navigation toc: --> <li><a href="._web4sa_flask017.html#___sec60" style="font-size: 80%;">Flask resources</a></li>
     <!-- navigation toc: --> <li><a href="._web4sa_flask017.html#___sec61" style="font-size: 80%;">Remaining</a></li>

    </ul>
   </div>
  </div>

  <div class="span9">


<!-- tocinfo
{'highest level': 1,
 'sections': [(' Web frameworks ', 1, None, '___sec0'),
              (' The MVC pattern ', 2, None, '___sec1'),
              (' A very simple application ', 2, None, '___sec2'),
              (' Application of the MVC pattern ',
               2,
               'wf:hw:mvc',
               'wf:hw:mvc'),
              (' Making a Flask application ', 1, None, '___sec4'),
              (' Programming the Flask application ', 2, None, '___sec5'),
              (' The user interaction ', 3, None, '___sec6'),
              (' The Python code ', 3, None, '___sec7'),
              (' Dissection ', 3, None, '___sec8'),
              (' The template files ', 3, None, '___sec9'),
              (' Testing the application ', 3, None, '___sec10'),
              (' Equipping the input page with output results ',
               2,
               None,
               '___sec11'),
              (' Splitting the app into model, view, and controller files ',
               2,
               'wf:hw3:flask',
               'wf:hw3:flask'),
              (' Troubleshooting ', 2, None, '___sec13'),
              (' Address already in use ', 3, None, '___sec14'),
              (' Handling multiple input variables in Flask ',
               1,
               'wf:vib:flask',
               'wf:vib:flask'),
              (' Programming the Flask application ',
               2,
               'wf:vib1:flask:app',
               'wf:vib1:flask:app'),
              (' The compute part ', 3, None, '___sec17'),
              (' The model ', 3, None, '___sec18'),
              (' The view ', 3, None, '___sec19'),
              (' The HTML template ', 3, None, '___sec20'),
              (' Implementing error checking in the template ',
               2,
               None,
               '___sec21'),
              (' Using style sheets ', 2, None, '___sec22'),
              (' Using LaTeX mathematics ', 2, None, '___sec23'),
              (' Rearranging the elements in the HTML template ',
               2,
               None,
               '___sec24'),
              (' Bootstrap HTML style ', 2, None, '___sec25'),
              (' Custom validation ',
               2,
               'wf:vib1:flask:validation',
               'wf:vib1:flask:validation'),
              (' Using Flask validators ', 3, None, '___sec27'),
              (' Tailored validation ', 3, None, '___sec28'),
              (' Tailored validation of intervals ', 3, None, '___sec29'),
              (' Demo ', 3, None, '___sec30'),
              (' Avoiding plot files ',
               2,
               'wf:vib2:flask:nofiles',
               'wf:vib2:flask:nofiles'),
              (' PNG plots ', 3, None, '___sec32'),
              (' SVG plots ', 3, None, '___sec33'),
              (' Autogenerating the code ',
               2,
               'wf:autogen:flask',
               'wf:autogen:flask'),
              (' Inspecting function signatures ', 3, None, '___sec35'),
              (' Generating the model ', 3, None, '___sec36'),
              (' Generating the view ', 3, None, '___sec37'),
              (' Generating the template ', 3, None, '___sec38'),
              (' Application ', 3, None, '___sec39'),
              (' User login and storage of computed results ',
               2,
               'wf:flask:login',
               'wf:flask:login'),
              (' Required additional software ', 3, None, '___sec41'),
              (' The compute part ', 3, None, '___sec42'),
              (' The interfaces of the app ', 3, None, '___sec43'),
              (' The source code ', 3, None, '___sec44'),
              (' Resources ', 3, None, '___sec45'),
              (' Uploading of files ',
               2,
               'wf:flask:upload',
               'wf:flask:upload'),
              (' Overview of the application ', 3, None, '___sec47'),
              (' The model class ', 3, None, '___sec48'),
              (' The controller file ', 3, None, '___sec49'),
              (' The compute function ', 3, None, '___sec50'),
              (' The HTML template ', 3, None, '___sec51'),
              (' Exercises ', 1, None, '___sec52'),
              (' Exercise 1: Add two numbers ',
               2,
               'wf:exer:add2',
               'wf:exer:add2'),
              (' Exercise 2: Upload data file and visualize curves ',
               2,
               'wf:exer:upload',
               'wf:exer:upload'),
              (' Exercise 3: Plot a user-specified formula ',
               2,
               'wf:exer:formula',
               'wf:exer:formula'),
              (' Exercise 4: Visualize Taylor polynomial approximations ',
               2,
               'wf:exer:Taylor',
               'wf:exer:Taylor'),
              (' Exercise 5: Extend the `gen` app ',
               2,
               'wf:exer:gen:demo',
               'wf:exer:gen:demo'),
              (' Exercise 6: Equip the `gen` app with more data types ',
               2,
               'wf:exer:gen:lists',
               'wf:exer:gen:lists'),
              (' Exercise 7: Auto-generate code from function signature ',
               2,
               None,
               '___sec59'),
              (' Flask resources ', 1, None, '___sec60'),
              (' Remaining ', 1, None, '___sec61')]}
end of tocinfo -->





<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: "none"  },
     extensions: ["AMSmath.js", "AMSsymbols.js", "autobold.js", "color.js"]
  }
});
</script>
<script type="text/javascript"
 src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



<a name="part0013"></a>
<!-- !split -->

<h2 id="wf:vib2:flask:nofiles">Avoiding plot files</h2>

<p>
Files with plots are easy to deal with as long as they are in the
<code>static</code> subdirectory of the Flask application directory. However,
as already pointed out, the previous <code>vib1</code> app, which writes plot
files, is not suited for multiple simultaneous users since every
user will destroy <em>all</em> existing plot files before making a new
one. Therefore, we need a robust solution for multiple users of
the app.

<p>
The idea is to not write plot files, but instead return the plot
as a string and embed that string directly in the HTML code.
This is relatively straightforward with Matplotlib
and Python. The relevant code is found in the <code>compute.py</code> file
of the <code>vib2</code> app.

<h3 id="___sec32">PNG plots </h3>

<p>
Python has the <code>StringIO</code> object that is a string buffer with the
look and behavior of a file. The idea is to let Matplotlib write to
a <code>StringIO</code> object and afterwards extract the string from this object:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plot</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">StringIO</span> <span style="color: #008000; font-weight: bold">import</span> StringIO
<span style="color: #408080; font-style: italic"># run plt.plot, plt.title, etc.</span>
figfile <span style="color: #666666">=</span> StringIO()
plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span style="color: #BA2121">&#39;png&#39;</span>)
figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)  <span style="color: #408080; font-style: italic"># rewind to beginning of file</span>
figdata_png <span style="color: #666666">=</span> figfile<span style="color: #666666">.</span>buf  <span style="color: #408080; font-style: italic"># extract string</span>
</pre></div>
<p>
Before the PNG data can be embedded in HTML we need to convert the
data to base64 format:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">base64</span>
figdata_png <span style="color: #666666">=</span> base64<span style="color: #666666">.</span>b64encode(figdata_png)
</pre></div>
<p>
Now we can embed the PNG data in HTML by

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">&lt;</span>img src<span style="color: #666666">=</span><span style="color: #BA2121">&quot;data:image/png;base64,PLOTSTR&quot;</span> width<span style="color: #666666">=</span><span style="color: #BA2121">&quot;500&quot;</span><span style="color: #666666">&gt;</span>
</pre></div>
<p>
where <code>PLOTSTR</code> is the content of the string <code>figdata_png</code>.

<p>
The complete <code>compute.py</code> function takes the form

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute</span>(A, b, w, T, resolution<span style="color: #666666">=500</span>):
    <span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    t <span style="color: #666666">=</span> linspace(<span style="color: #666666">0</span>, T, resolution<span style="color: #666666">+1</span>)
    y <span style="color: #666666">=</span> damped_vibrations(t, A, b, w)
    plt<span style="color: #666666">.</span>figure()  <span style="color: #408080; font-style: italic"># needed to avoid adding curves in plot</span>
    plt<span style="color: #666666">.</span>plot(t, y)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;A=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, b=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">, w=</span><span style="color: #BB6688; font-weight: bold">%g</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> (A, b, w))

    <span style="color: #408080; font-style: italic"># Make Matplotlib write to StringIO file object and grab</span>
    <span style="color: #408080; font-style: italic"># return the object&#39;s string</span>
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">StringIO</span> <span style="color: #008000; font-weight: bold">import</span> StringIO
    figfile <span style="color: #666666">=</span> StringIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span style="color: #BA2121">&#39;png&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)  <span style="color: #408080; font-style: italic"># rewind to beginning of file</span>
    <span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">base64</span>
    figdata_png <span style="color: #666666">=</span> base64<span style="color: #666666">.</span>b64encode(figfile<span style="color: #666666">.</span>buf)
    <span style="color: #008000; font-weight: bold">return</span> figdata_png
</pre></div>
<p>
The relevant syntax in an HTML template is

<p>

<!-- code=html (!bc htmlcod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">&lt;img</span> <span style="color: #7D9029">src=</span><span style="color: #BA2121">&quot;data:image/png;base64,{{ results }}&quot;</span> <span style="color: #7D9029">width=</span><span style="color: #BA2121">&quot;500&quot;</span><span style="color: #008000; font-weight: bold">&gt;</span>
</pre></div>
<p>
if <code>results</code> holds the returned object from the <code>compute</code> function above.

<h3 id="___sec33">SVG plots </h3>

<p>
Inline figures in HTML, instead of using files, are most often realized
by XML code with the figure data in SVG format.
Plot strings in the SVG format are created very similarly to the PNG
example:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">figfile <span style="color: #666666">=</span> StringIO()
plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span style="color: #BA2121">&#39;svg&#39;</span>)
figdata_svg <span style="color: #666666">=</span> figfile<span style="color: #666666">.</span>buf
</pre></div>
<p>
The <code>figdata_svg</code> string contains XML code text can almost
be directly embedded in
HTML5. However, the beginning of the text contains information before
the <code>svg</code> tag that we want to remove:

<p>

<!-- code=text (!bc dat) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
  &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Created with matplotlib (http://matplotlib.sourceforge.net/) --&gt;
&lt;svg height=&quot;441pt&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 585 441&quot; ...
</pre></div>
<p>
The removal is done with a little string manipulation:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">figdata_svg <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&lt;svg&#39;</span> <span style="color: #666666">+</span> figfile<span style="color: #666666">.</span>buf<span style="color: #666666">.</span>split(<span style="color: #BA2121">&#39;&lt;svg&#39;</span>)[<span style="color: #666666">1</span>]
</pre></div>
<p>
Now, <code>figdata_svg</code> can be directly inserted in HTML code without
any surrounding tags (because it is perfectly valid HTML code in itself).

<p>
The SVG code generated by Matplotlib may contain UTF-8 characters
so it is necessary to make a unicode string out of the text:
<code>unicode(figdata_svg, 'utf-8')</code>, otherwise the HTML template will
lead to an encoding exception.

<p>
We have made an alternative compute function <code>compute_png_svg</code>
that returns both a PNG and an SVG plot:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">compute_png_svg</span>(A, b, w, T, resolution<span style="color: #666666">=500</span>):
    <span style="color: #666666">...</span>
    figfile <span style="color: #666666">=</span> StringIO()
    plt<span style="color: #666666">.</span>savefig(figfile, format<span style="color: #666666">=</span><span style="color: #BA2121">&#39;svg&#39;</span>)
    figfile<span style="color: #666666">.</span>seek(<span style="color: #666666">0</span>)
    figdata_svg <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&lt;svg&#39;</span> <span style="color: #666666">+</span> figfile<span style="color: #666666">.</span>buf<span style="color: #666666">.</span>split(<span style="color: #BA2121">&#39;&lt;svg&#39;</span>)[<span style="color: #666666">1</span>]
    figdata_svg <span style="color: #666666">=</span> <span style="color: #008000">unicode</span>(figdata_svg,<span style="color: #BA2121">&#39;utf-8&#39;</span>)
    <span style="color: #008000; font-weight: bold">return</span> figdata_png, figdata_svg
</pre></div>
<p>
The relevant syntax for inserting an SVG plot in the HTML template is now

<p>

<!-- code=html (!bc htmlcod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">{{ result[1]|safe }}
</pre></div>
<p>
The use of <code>safe</code> is essential here.

<p>
<div class="alert alert-block alert-success alert-text-normal"><b>Important: use <code>safe</code> for verbatim HTML code:</b>
Special HTML characters like <code>&lt;</code>, <code>&gt;</code>,
<code>&</code>, <code>&quot;</code>, and <code>'</code> are escaped in a template string like <code>{{ str }}</code>
(i.e., <code>&</code> is replaced by <code>&amp;</code> `<` is replaced by <code>&lt;</code>, etc.).
We need to avoid this manipulation of the string content
because <code>result[1]</code> contains
XML code where the mentioned characters are essential part of the syntax.
Writing <code>{{str|safe}}</code> ensures that the contents of the string <code>str</code>
are not altered before being embedded in the HTML text.
</div>


<p>
An alternative template, <code>view_svg.html</code> applies the SVG plot instead
of the PNG plot. We use the command-line argument <code>svg</code> for indicating
that we want an SVG instead of a PNG plot:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #408080; font-style: italic"># SVG or PNG plot?</span>
svg <span style="color: #666666">=</span> <span style="color: #008000">False</span>
<span style="color: #008000; font-weight: bold">try</span>:
    <span style="color: #008000; font-weight: bold">if</span> sys<span style="color: #666666">.</span>argv[<span style="color: #666666">1</span>] <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;svg&#39;</span>:
        svg <span style="color: #666666">=</span> <span style="color: #008000">True</span>
<span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">IndexError</span>:
    <span style="color: #008000; font-weight: bold">pass</span>
<span style="color: #008000; font-weight: bold">if</span> svg:
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute_png_svg <span style="color: #008000; font-weight: bold">as</span> compute
    template <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;view_svg.html&#39;</span>
<span style="color: #008000; font-weight: bold">else</span>:
    <span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">compute</span> <span style="color: #008000; font-weight: bold">import</span> compute
    template <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;view.html&#39;</span>
</pre></div>
<p>
<p>
<!-- navigation buttons at the bottom of the page -->
<ul class="pager">
  <li class="previous">
    <a href="._web4sa_flask012.html">&larr; Prev</a>
  </li>
  <li class="next">
    <a href="._web4sa_flask014.html">Next &rarr;</a>
  </li>
</ul>
<!-- ------------------- end of main content --------------- -->


 </div>

 <div class="row Footer">
  <div class="span12">
  &copy 2013; Hans Petter Langtangen and Anders E. Johansen.
  Last update: .
  </div>
 </div>
</div>
</body>
</html>

