
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Using Web Frameworks to Ease the Development of Web Applications for Computational Science</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-2.3.0/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-2.3.0/css/bootstrap-responsive.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-2.3.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="Using Web Frameworks to Ease the Development of Web Applications for Computational Science" href="index.html" />
    <link rel="prev" title="Using Web Frameworks to Ease the Development of Web Applications for Computational Science" href="index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>
<div class="container">
  
  <div id="navbar" class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
      <button class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a class="brand" href="index.html">Using Web Frameworks to Ease the Development of Web Applications for Computational Science</a>
      <span class="navbar-text pull-left"><b>1.0</b></span>

      <div class="nav-collapse">
        <ul class="nav">
          <li class="divider-vertical"></li>
          
            <li class="dropdown globaltoc-container">
  <a href="index.html"
     class="dropdown-toggle"
     data-toggle="dropdown">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
    ><ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="">Using Web Frameworks to Ease the Development of Web Applications for Computational Science</a></li>
<li class="toctree-l1"><a class="reference internal" href="#web-frameworks">Web frameworks</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-mvc-pattern">The MVC pattern</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-very-simple-application">A very simple application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#application-of-the-mvc-pattern">Application of the MVC pattern</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#making-a-flask-application">Making a Flask application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#programming-the-flask-application-1">Programming the Flask application  (1)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#equipping-the-input-page-with-output-results-1">Equipping the input page with output results  (1)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#splitting-the-app-into-model-view-and-controller-files">Splitting the app into model, view, and controller files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#making-a-django-application">Making a Django application</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#installing-django">Installing Django</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-a-django-project">Setting up a Django project</a></li>
<li class="toctree-l2"><a class="reference internal" href="#setting-up-a-django-application">Setting up a Django application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#programming-the-django-application-1">Programming the Django application  (1)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#equipping-the-input-page-with-output-results-2">Equipping the input page with output results  (2)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#handling-multiple-input-variables-in-flask">Handling multiple input variables in Flask</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#programming-the-flask-application-2">Programming the Flask application  (2)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementing-error-checking-in-the-template">Implementing error checking in the template</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-style-sheets">Using style sheets</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-latex-mathematics">Using LaTeX mathematics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#rearringing-the-elements-in-the-html-template">Rearringing the elements in the HTML template</a></li>
<li class="toctree-l2"><a class="reference internal" href="#user-provided-validation-1">User-provided validation  (1)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#autogenerating-the-code">Autogenerating the code</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#handling-multiple-input-variables-in-django">Handling multiple input variables in Django</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#programming-the-django-application-2">Programming the Django application  (2)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#user-provided-validation-2">User-provided validation  (2)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exercise-1-add-two-numbers">Exercise 1: Add two numbers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#remaining">Remaining</a></li>
</ul>
</ul>
</li>
            <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"><ul>
<li><a class="reference internal" href="#">Using Web Frameworks to Ease the Development of Web Applications for Computational Science</a></li>
<li><a class="reference internal" href="#web-frameworks">Web frameworks</a><ul>
<li><a class="reference internal" href="#the-mvc-pattern">The MVC pattern</a></li>
<li><a class="reference internal" href="#a-very-simple-application">A very simple application</a></li>
<li><a class="reference internal" href="#application-of-the-mvc-pattern">Application of the MVC pattern</a></li>
</ul>
</li>
<li><a class="reference internal" href="#making-a-flask-application">Making a Flask application</a><ul>
<li><a class="reference internal" href="#programming-the-flask-application-1">Programming the Flask application  (1)</a></li>
<li><a class="reference internal" href="#equipping-the-input-page-with-output-results-1">Equipping the input page with output results  (1)</a></li>
<li><a class="reference internal" href="#splitting-the-app-into-model-view-and-controller-files">Splitting the app into model, view, and controller files</a></li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#making-a-django-application">Making a Django application</a><ul>
<li><a class="reference internal" href="#installing-django">Installing Django</a></li>
<li><a class="reference internal" href="#setting-up-a-django-project">Setting up a Django project</a></li>
<li><a class="reference internal" href="#setting-up-a-django-application">Setting up a Django application</a></li>
<li><a class="reference internal" href="#programming-the-django-application-1">Programming the Django application  (1)</a></li>
<li><a class="reference internal" href="#equipping-the-input-page-with-output-results-2">Equipping the input page with output results  (2)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#handling-multiple-input-variables-in-flask">Handling multiple input variables in Flask</a><ul>
<li><a class="reference internal" href="#programming-the-flask-application-2">Programming the Flask application  (2)</a></li>
<li><a class="reference internal" href="#implementing-error-checking-in-the-template">Implementing error checking in the template</a></li>
<li><a class="reference internal" href="#using-style-sheets">Using style sheets</a></li>
<li><a class="reference internal" href="#using-latex-mathematics">Using LaTeX mathematics</a></li>
<li><a class="reference internal" href="#rearringing-the-elements-in-the-html-template">Rearringing the elements in the HTML template</a></li>
<li><a class="reference internal" href="#user-provided-validation-1">User-provided validation  (1)</a></li>
<li><a class="reference internal" href="#autogenerating-the-code">Autogenerating the code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#handling-multiple-input-variables-in-django">Handling multiple input variables in Django</a><ul>
<li><a class="reference internal" href="#programming-the-django-application-2">Programming the Django application  (2)</a></li>
<li><a class="reference internal" href="#user-provided-validation-2">User-provided validation  (2)</a></li>
<li><a class="reference internal" href="#exercise-1-add-two-numbers">Exercise 1: Add two numbers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remaining">Remaining</a></li>
</ul>
</ul>
</li>
          
          
            
  <li><a href="index.html"
         title="previous chapter">&laquo; Using Web Frameworks to Ease the Development of Web Applications for Computational Science</a></li>
          
          
            <li>
  <a href="_sources/web4sa.txt"
     rel="nofollow">Source</a></li>
          
        </ul>

        
          
<form class="navbar-search pull-right" style="margin-bottom:-3px;" action="search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        
      </div>
    </div>
  </div>

  
  <div class="section" id="using-web-frameworks-to-ease-the-development-of-web-applications-for-computational-science">
<h1>Using Web Frameworks to Ease the Development of Web Applications for Computational Science<a class="headerlink" href="#using-web-frameworks-to-ease-the-development-of-web-applications-for-computational-science" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Hans Petter Langtangen, Anders Johansen</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">Mar 22, 2013</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="web-frameworks">
<h1>Web frameworks<a class="headerlink" href="#web-frameworks" title="Permalink to this headline">¶</a></h1>
<p id="index-0">Computational scientists may want to offer their applications through
a web interface, thereby making a <em>web application</em>.
Basically, this means that users can set input data
to the application on a web page, then click on some <em>Compute</em> button,
and back comes a new web page with the results of the computations.
The web interface can either be used as a GUI locally on the
scientist&#8217;s computer, or the interface can be depolyed to
a server and made available to the whole world.</p>
<p>Web applications of the mentioned type can be created from scratch
using CGI scripts in (e.g.) Python, but the code quickly gets longer
and more involved as the complexity of the web interface
grows. Nowadays, most web applications are created with the aid of
<em>web frameworks</em>, which are software packages that simplify the
programming tasks of offering services through the Internet. The
downside of web frameworks is that there is a significant amount of
steps and details to learn before your first simple demo application
works.  The upside is that advanced applications are within reach,
without an overwhelming amount of programming, as soon as you have
understood the basic demos.</p>
<p>We shall explore two web frameworks: the very popular <a class="reference external" href="https://www.djangoproject.com/">Django framework</a> and the more high-level and easy-to-use framework
<a class="reference external" href="http://flask.pocoo.org/">Flask</a>. In addition, our examples are also
implemented in the <a class="reference external" href="http://www.web2py.com/">web2py</a> framework.
.. Its slogan says &#8220;Django makes it easier to build better Web apps more quickly and with less code&#8221;.</p>
<p>The primary advantage of Django
over other web frameworks is the rich set of documentation and
examples. Googling for &#8220;Django tutorials&#8221; gives lots of hits including
a  list of <a class="reference external" href="https://code.djangoproject.com/wiki/Tutorials">web tutorials</a>
and a list of <a class="reference external" href="http://www.youtube.com/playlist?list=PL385A53B00B8B158E">YouTube videos</a>. There is also an electronic <a class="reference external" href="http://www.djangobook.com/en/2.0/">Django book</a>. At the time of this writing, Flask is not
much documented beyond the <a class="reference external" href="http://flask.pocoo.org/">official web site</a> and the <a class="reference external" href="http://wtforms.simplecodes.com/docs/0.6/index.html">WTForms Documentation</a>. There is, unfortunately, hardly any examples on how Django or Flask can be used to enable typical scientific applications for the web, and that is why we have developed some targeted examples on this topic.</p>
<p>The problem for a computational scientist who wants to enable
mathematical calculations through the web is that most of
the introductory examples on utilizing a particular
web framework address web applications
of very different nature, e.g., blogs and polls. Therefore, we have made an
alternative introduction which explains, in the simplest possible way,
how web frameworks can be used to</p>
<ol class="arabic simple">
<li>generate a web page with input data to your application,</li>
<li>run the application to perform mathematical computations, and</li>
<li>generate a web page with the results of the computations.</li>
</ol>
<p>To work with Django, you need to know about Python packages and modules
as well as Python classes. With Flask it is enough to be familiar with
functions and modules, though knowledge of classes and a bit of
decorators might be an advantage.</p>
<div class="section" id="the-mvc-pattern">
<h2>The MVC pattern<a class="headerlink" href="#the-mvc-pattern" title="Permalink to this headline">¶</a></h2>
<p id="index-1">The MVC pattern stands for Model-View-Controller and is a way of
separating the user&#8217;s interaction with an application from the inner
workings of the application. In a scientific application this
usually means separaring mathematical computations from the
user interface and visualization of results.
The <a class="reference external" href="http://en.wikipedia.org/wiki/MVC_Pattern">Wikipedia definition of the MVC pattern</a> gives a very high-level
explanation of what the model, view, and controller do and mentions
the fact that different web frameworks interpret the three components
differently. Any web application works with a set of data and needs
a user interface for the communication of data between the user and
some data processing software. The classical
MVC pattern introduces</p>
<blockquote>
<div><ul class="simple">
<li>the model to hold the data</li>
<li>the view to display data</li>
<li>the controller to move data by gluing the model and the view.</li>
</ul>
</div></blockquote>
<p>For applications performing mathematical computations we find it
convenient to explicitly introduce a fourth component that we call
<em>compute</em> where the mathematical computations are encapsulated.  With
the MVC pattern and the compute component we have a clear separation
between data (model), the way data is presented (view), the
computations (compute), and the way these components communicate
(controller). In a small program such a separation may look as
overkill, but it pays off in more complicated applications. More
importantly, the concepts of the MVC pattern saturates the modules and
files of web frameworks so one really needs to adapt to the MVC way of
thinking.</p>
<p>Web frameworks often have their own way of interpreting the
model, view, and controller parts of the MVC pattern.
In particular, most frameworks often divide the view into two parts:
one software component and one HTML template. The latter takes care
of the look and feel of the web page while the former often takes
the role of being the controller too.
For our scientific applications
we shall employ an interpretation of the MVC pattern
which is compatible with what we need later on:</p>
<blockquote>
<div><ul class="simple">
<li>the model contains the data (often only the input data) of the application,</li>
<li>the view controls the user interface that handles input and output data,
and also calls to functionality that computes the output given the input.</li>
</ul>
</div></blockquote>
<p>The model will be a Python class with static attributes holding the data.
The view consists of Python code processing the model&#8217;s data and HTML
templates for the design of the web pages.</p>
<p>Flask does not force any MVC pattern on the programmer, but
the code needed to build web applications can easily be split into
model, view, controller, and compute components, as will be shown later.
Django, on the other hand, automatically generates application files with names
<tt class="docutils literal"><span class="pre">views.py</span></tt> and <tt class="docutils literal"><span class="pre">models.py</span></tt> so it is
necessary to have some idea what Django means with these terms.
The controller functionality in Django lies both in the <tt class="docutils literal"><span class="pre">views.py</span></tt> file and
in the configuration
files (<tt class="docutils literal"><span class="pre">settings.py</span></tt> and <tt class="docutils literal"><span class="pre">urls.py</span></tt>). The view component of the application
consists both of the <tt class="docutils literal"><span class="pre">views.py</span></tt> file and template files used to create
the HTML code in the web pages.</p>
<p>Forthcoming examples will illustrate how a scientific application is
split to meet the requirements of the MVC software design pattern.</p>
</div>
<div class="section" id="a-very-simple-application">
<h2>A very simple application<a class="headerlink" href="#a-very-simple-application" title="Permalink to this headline">¶</a></h2>
<p>We shall start with the simplest possible application,
a &#8220;scientific hello world program&#8221;, where the
task is to read a number of write out &#8220;Hello, World!&#8221; followed by
the sine of the number. This application has one input variable and
a line of text as output.</p>
<p>Our first implementation reads the input from the command
line and writes the results to the terminal window:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">math</span>
<span class="n">r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;Hello, World! sin(</span><span class="si">%g</span><span class="s">)=</span><span class="si">%g</span><span class="s">&#39; % (r, s)</span>
</pre></div>
</div>
<p>The task of the web version of this program is to read <tt class="docutils literal"><span class="pre">r</span></tt>
variable from a web page, compute the sine,
and write out a new web page with the resulting text.</p>
</div>
<div class="section" id="application-of-the-mvc-pattern">
<span id="wf-hw-mvc"></span><h2>Application of the MVC pattern<a class="headerlink" href="#application-of-the-mvc-pattern" title="Permalink to this headline">¶</a></h2>
<p>Before thinking of a web application, we first <em>refactor</em> our program
such that it fits with the classical MVC pattern and a compute component.
The refactoring does not change the functionality of the code, it
just distributes the original statements in functions and modules.
Here we create four modules: <tt class="docutils literal"><span class="pre">model</span></tt>, <tt class="docutils literal"><span class="pre">view</span></tt>,
<tt class="docutils literal"><span class="pre">compute</span></tt>, and <tt class="docutils literal"><span class="pre">controller</span></tt>.</p>
<blockquote>
<div><ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">compute</span></tt> module contains a function <tt class="docutils literal"><span class="pre">compute(r)</span></tt> that performs
the mathematics and returns the value of <tt class="docutils literal"><span class="pre">s</span></tt>.</li>
<li>The <tt class="docutils literal"><span class="pre">model</span></tt> module holds the input data, here <tt class="docutils literal"><span class="pre">r</span></tt>.</li>
<li>The <tt class="docutils literal"><span class="pre">view</span></tt> module has two functions, one for reading input data,
<tt class="docutils literal"><span class="pre">get_input</span></tt>,
and one for presenting the output, <tt class="docutils literal"><span class="pre">present_output</span></tt>.
The later takes the input, calls <tt class="docutils literal"><span class="pre">compute</span></tt> functionalty, and
generates the output.</li>
<li>The <tt class="docutils literal"><span class="pre">controller</span></tt> module initializes model&#8217;s data from the view
and calls the view to present the output.</li>
</ul>
</div></blockquote>
<p>The <tt class="docutils literal"><span class="pre">model.py</span></tt> file contains the <tt class="docutils literal"><span class="pre">r</span></tt> variable, which must
be declared with a default value in order to create the data object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">r</span> <span class="o">=</span> <span class="mf">0.0</span>    <span class="c"># input</span>
<span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># output</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">view.py</span></tt> file is restricted to the communication with the user and reads</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">compute</span>

<span class="c"># Input: float r</span>
<span class="c"># Output: &quot;Hello, World! sin(r)=...&quot;</span>

<span class="k">def</span> <span class="nf">get_input</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get input data from the command line.&quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">present_output</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write results to terminal window.&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Hello, World! sin(</span><span class="si">%g</span><span class="s">)=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>The mathematics is encapsulated in <tt class="docutils literal"><span class="pre">compute.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, <tt class="docutils literal"><span class="pre">controller.py</span></tt> glues the model and the view:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">model</span><span class="o">,</span> <span class="nn">view</span>

<span class="n">model</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">get_input</span><span class="p">()</span>
<span class="n">view</span><span class="o">.</span><span class="n">present_output</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
<p>Let us try our refactored code:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; python controller.py 1.2</span>
<span class="go">Hello, World! sin(1.2)=0.932039</span>
</pre></div>
</div>
<p>Our goal is to create a web interface to our scientific hello world
program such that we can fill in the number <tt class="docutils literal"><span class="pre">r</span></tt> in a text field, click a
<em>Compute</em> button and get back a new web page with the output text
shown above: &#8220;Hello, World! sin(r)=s&#8221;.</p>
</div>
</div>
<div class="section" id="making-a-flask-application">
<h1>Making a Flask application<a class="headerlink" href="#making-a-flask-application" title="Permalink to this headline">¶</a></h1>
<p id="index-2">Not much code or configuration is needed to make a Flask application.
Actually one short file is enough. For this file to work you need to
install Flask and some corresponding packages. This is easiest
performed by</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; sudo pip install Flask</span>
<span class="go">Terminal&gt; sudo pip install WTForms</span>
</pre></div>
</div>
<p>You can add <tt class="docutils literal"><span class="pre">--upgrade</span></tt> to upgrade a previous installation.</p>
<div class="section" id="programming-the-flask-application-1">
<h2>Programming the Flask application  (1)<a class="headerlink" href="#programming-the-flask-application-1" title="Permalink to this headline">¶</a></h2>
<p>We want our input page to feature in text field where the user can
write the value of <tt class="docutils literal"><span class="pre">r</span></tt>, see Figure <a class="reference internal" href="#wf-hw1-flask-fig-input"><em>The input page</em></a>.
By clicking <em>equals</em>
we compute the corresponding <tt class="docutils literal"><span class="pre">s</span></tt> and write out the result page
seen in Figure <a class="reference internal" href="#wf-hw1-flask-fig-result"><em>The output page</em></a>.</p>
<div class="figure" id="wf-hw1-flask-fig-input">
<img alt="_images/hw1_flask_input.png" src="_images/hw1_flask_input.png" style="width: 600px;" />
<p class="caption"><em>The input page</em></p>
</div>
<div class="figure" id="wf-hw1-flask-fig-result">
<img alt="_images/hw1_flask_output.png" src="_images/hw1_flask_output.png" style="width: 600px;" />
<p class="caption"><em>The output page</em></p>
</div>
<p>Flask does not require us to use the MVC pattern so there is actually
no need to split the original program into <tt class="docutils literal"><span class="pre">model.py</span></tt>, <tt class="docutils literal"><span class="pre">view.py</span></tt>,
<tt class="docutils literal"><span class="pre">controller.py</span></tt>, and <tt class="docutils literal"><span class="pre">compute.py</span></tt> as already explained.  First we make
a <tt class="docutils literal"><span class="pre">controller.py</span></tt> file where the view, the model, and the controller
parts are within the same part. Later, we split the view, model, and
controller into three files for illustration. The <tt class="docutils literal"><span class="pre">compute</span></tt> component
is always in a separate files as we like to encapsulate the
computations completely from user interfaces.</p>
<p id="index-3">The view that the user sees is determined by
HTML templates in a subdirectory <tt class="docutils literal"><span class="pre">templates</span></tt>, and consequently
we name the template files <tt class="docutils literal"><span class="pre">view*.html</span></tt>.
The model and other parts of the view concept are just parts of
the <tt class="docutils literal"><span class="pre">controller.py</span></tt> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">validators</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c"># Model</span>
<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>

<span class="c"># View</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/hw1&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">data</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view_output.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view_input.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>We collect the files associated with a Flask app in a directory,
here called <tt class="docutils literal"><span class="pre">hw1_flask</span></tt>.</p>
<p>The web application is the <tt class="docutils literal"><span class="pre">app</span></tt> object of class <tt class="docutils literal"><span class="pre">Flask</span></tt> initialized
as shown. The model is a special Flask class derived from <tt class="docutils literal"><span class="pre">Form</span></tt>
where the data are listed as static class attributes and initialized
by various form field objects from the <tt class="docutils literal"><span class="pre">wtforms</span></tt> package.
These form fields correspond to HTML forms in the input page.
For the <tt class="docutils literal"><span class="pre">r</span></tt> variable we apply <tt class="docutils literal"><span class="pre">FloatField</span></tt> since it is a floating-point
variable. A default validator, here checking that the user supplies
a real number, is easily included.</p>
<p>The view, controlling how the user interacts with the data, consists
an URL and corresponding function to call when this is invoked URL.
The function name is here <tt class="docutils literal"><span class="pre">index</span></tt> (corresponding to the standard
<tt class="docutils literal"><span class="pre">index.html</span></tt> page that is the main page of a URL) and the
decorator <tt class="docutils literal"><span class="pre">&#64;app.route('/hw1',</span> <span class="pre">...)</span></tt> maps the URL
<tt class="docutils literal"><span class="pre">http://127.0.0.1:5000/hw1</span></tt> to a call to <tt class="docutils literal"><span class="pre">index</span></tt>.
The <tt class="docutils literal"><span class="pre">methods</span></tt> argument must be as shown to allow the user to communicate
with the web page.</p>
<p id="index-4">The <tt class="docutils literal"><span class="pre">index</span></tt> function first makes a form object based on the data in
the model, here class <tt class="docutils literal"><span class="pre">InputForm</span></tt>. Then there are two possibilities:
either the user has provided data in the HTML form or the user is
to be offered an input form. In the former case, <tt class="docutils literal"><span class="pre">request.method</span></tt>
equals <tt class="docutils literal"><span class="pre">'POST'</span></tt> and we can extract the numerical value of <tt class="docutils literal"><span class="pre">r</span></tt>
from the <tt class="docutils literal"><span class="pre">form</span></tt> object, <tt class="docutils literal"><span class="pre">form.r.data</span></tt>, call up our mathematical
computations, and make a web page with the result.
In the latter case, we make an input page as displayed in
Figure <a class="reference internal" href="#wf-hw1-flask-fig-input"><em>The input page</em></a>.</p>
<p id="index-5">Making a web page with Flask is conveniently done through an HTML
template. Since the output page is simplest we display the
<tt class="docutils literal"><span class="pre">view_output.html</span></tt> template first:</p>
<div class="highlight-text"><div class="highlight"><pre>Hello, World! sin({{form.r.data}})={{s}}.
</pre></div>
</div>
<p>Keyword arguments sent to <tt class="docutils literal"><span class="pre">render_template</span></tt> are available in the
HTML template. With the <tt class="docutils literal"><span class="pre">form</span></tt> object we extract the value of
<tt class="docutils literal"><span class="pre">r</span></tt> in the HTML code by <tt class="docutils literal"><span class="pre">{{form.r.data}}</span></tt>. Similarly, the value of <tt class="docutils literal"><span class="pre">s</span></tt>
is simply <tt class="docutils literal"><span class="pre">{{s}}</span></tt>.</p>
<p>The HTML template for the input page is slightly more complicated
as we need to use an HTML form:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;form method=post action=&quot;&quot;&gt;
  Hello, World! The sine of {{form.r}}
  &lt;input type=submit value=equals&gt;
&lt;/form&gt;
</pre></div>
</div>
<p>All you have to do in order to run this web application is</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; python controller.py</span>
</pre></div>
</div>
</div>
<div class="section" id="equipping-the-input-page-with-output-results-1">
<h2>Equipping the input page with output results  (1)<a class="headerlink" href="#equipping-the-input-page-with-output-results-1" title="Permalink to this headline">¶</a></h2>
<p>Our application made two distinct pages for grabbing input from the
user and presenting the result. It is often more natural to add
the result to the input page. This is particularly the case in the present
web application, which is a kind of calculator. Figure <a class="reference internal" href="#wf-hw2-flask-fig-result"><em>The modified result page</em></a> shows what the user sees after clicking the <em>equals</em> button.</p>
<div class="figure" id="wf-hw2-flask-fig-result">
<img alt="_images/hw2_flask_output.png" src="_images/hw2_flask_output.png" style="width: 600px;" />
<p class="caption"><em>The modified result page</em></p>
</div>
<p>To let the user stay within the same page, we create a new directory <tt class="docutils literal"><span class="pre">hw2_flask</span></tt>
for this modified Flask app and copy the files from the previous
<tt class="docutils literal"><span class="pre">hw1_flask</span></tt> directory.  The idea now is to make use of just one
template, in <tt class="docutils literal"><span class="pre">templates/view.html</span></tt>:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;form method=post action=&quot;&quot;&gt;
  Hello, World! The sine of
  {{(form.r)}}
  &lt;input type=submit value=equals&gt;
{% if s != None %}
{{s}}
{% endif %}
&lt;/form&gt;
</pre></div>
</div>
<p>The form is identical to what we used in <tt class="docutils literal"><span class="pre">view_input.html</span></tt>, and the only
new thing is the value of <tt class="docutils literal"><span class="pre">s</span></tt>. We supply <tt class="docutils literal"><span class="pre">s</span></tt> as an object to the
<tt class="docutils literal"><span class="pre">render_template</span></tt> function and this object is available for
some programming in the HTML template. We can test on the value of <tt class="docutils literal"><span class="pre">s</span></tt>:
if it is <tt class="docutils literal"><span class="pre">None</span></tt>, we know that the computations are not performed and
<tt class="docutils literal"><span class="pre">s</span></tt> should not appear on the page, otherwise <tt class="docutils literal"><span class="pre">s</span></tt> holds the sine
value and we can write it out. The generated HTML code reads</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  Hello, World! The sine of
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;r&quot;</span> <span class="na">name=</span><span class="s">&quot;r&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;1.2&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">equals</span><span class="nt">&gt;</span>

0.932039085967

<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">index</span></tt> function needs adjustments since we use the same
template for the input and the output page:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># View</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/hw2&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">data</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>It is seen that if the user has given data, <tt class="docutils literal"><span class="pre">s</span></tt> is a <tt class="docutils literal"><span class="pre">float</span></tt>, otherwise
<tt class="docutils literal"><span class="pre">s</span></tt> is <tt class="docutils literal"><span class="pre">None</span></tt>. You are encouraged to test the app by running</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; python controller.py</span>
</pre></div>
</div>
<p>and loading <tt class="docutils literal"><span class="pre">http://127.0.0.1:5000/hw2</span></tt> into your browser.
A nice little exercise is to control the formatting of the result <tt class="docutils literal"><span class="pre">s</span></tt>.
To this end, you transform <tt class="docutils literal"><span class="pre">s</span></tt> to a string: <tt class="docutils literal"><span class="pre">s</span> <span class="pre">=</span> <span class="pre">'%.5f'</span> <span class="pre">%</span> <span class="pre">s</span></tt> before
sending it to <tt class="docutils literal"><span class="pre">render_template</span></tt>.</p>
</div>
<div class="section" id="splitting-the-app-into-model-view-and-controller-files">
<span id="wf-hw3-flask"></span><h2>Splitting the app into model, view, and controller files<a class="headerlink" href="#splitting-the-app-into-model-view-and-controller-files" title="Permalink to this headline">¶</a></h2>
<p id="index-6">In our previous to Flask apps we have had the model, view, and
controller parts in one file <tt class="docutils literal"><span class="pre">controller.py</span></tt>. For illustration we
may split the previous <tt class="docutils literal"><span class="pre">controller.py</span></tt> into three files:
<tt class="docutils literal"><span class="pre">model.py</span></tt>, <tt class="docutils literal"><span class="pre">view.py</span></tt>, and <tt class="docutils literal"><span class="pre">controller.py</span></tt>, located in a
directory <tt class="docutils literal"><span class="pre">hw3_flask</span></tt>. The contents
in these files reflects the splitting introduced in the original
scienticic hello world program in the section <a class="reference internal" href="#wf-hw-mvc"><em>Application of the MVC pattern</em></a>.
In the Flask context we have <tt class="docutils literal"><span class="pre">model.py</span></tt> as</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">validators</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
</pre></div>
</div>
<p>The view in &#8216;view.py&#8217; consists of</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/hw3&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">data</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">controller.py</span></tt> file finally runs the view&#8217;s <tt class="docutils literal"><span class="pre">app</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">view</span> <span class="kn">import</span> <span class="n">app</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The statements are indentical to those in the <tt class="docutils literal"><span class="pre">hw2_flask</span></tt> app, only
the organization of the statement in files differ.</p>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<p id="index-7"><em>Address already in use.</em> You can easily kill the Flask application and restart it, but sometimes
you will get an error that the address is already in use.
To recover from this problem, run the <tt class="docutils literal"><span class="pre">lsof</span></tt> program to see which program
that applies the 5000 port (Flask runs its server on <tt class="docutils literal"><span class="pre">http://127.0.0.1:5000</span></tt>):</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; lsof -i :5000</span>
<span class="go">COMMAND   PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME</span>
<span class="go">python  48824  hpl    3u  IPv4 1128848      0t0  TCP ...</span>
<span class="go">Terminal&gt; kill -9 48824</span>
</pre></div>
</div>
<p>The last command killed the <tt class="docutils literal"><span class="pre">python</span></tt> job that ran the test server and
you are ready to relaunch the Flask application.</p>
</div>
</div>
<div class="section" id="making-a-django-application">
<h1>Making a Django application<a class="headerlink" href="#making-a-django-application" title="Permalink to this headline">¶</a></h1>
<p>Django applies two concepts, <em>project</em> and <em>application</em>. The application,
or app for short,
is the program we want to run through a web interface. The project is
a Python package containing common settings and configurations for
a collection of apps. This means that before we can make a Django app,
we must to establish a Django project.</p>
<div class="section" id="installing-django">
<h2>Installing Django<a class="headerlink" href="#installing-django" title="Permalink to this headline">¶</a></h2>
<p id="index-8">We recommend to
download and istall the latest official version from
<a class="reference external" href="http://www.djangoproject.com/download/">http://www.djangoproject.com/download/</a>. Pack out the tarfile, go
to the directory, and run <tt class="docutils literal"><span class="pre">setup.py</span></tt>:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; tar xvzf Django-1.5-tar.gz</span>
<span class="go">Terminal&gt; cd Django-1.5</span>
<span class="go">Terminal&gt; sudo python setup.py install</span>
</pre></div>
</div>
<p>The version in this example, 1.5, may be different at the time you
follow these instructions.</p>
</div>
<div class="section" id="setting-up-a-django-project">
<h2>Setting up a Django project<a class="headerlink" href="#setting-up-a-django-project" title="Permalink to this headline">¶</a></h2>
<p id="index-9">A Django project for managing a set of Django apps is
created by the command</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; django-admin.py startproject django_project</span>
</pre></div>
</div>
<p>The result is a directory <tt class="docutils literal"><span class="pre">django_project</span></tt> whose content can be explored
by some <tt class="docutils literal"><span class="pre">ls</span></tt> and <tt class="docutils literal"><span class="pre">cd</span></tt> commands:</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; ls django_project</span>
<span class="go">manage.py django_project</span>
<span class="go">Terminal&gt; cd django_project/django_project</span>
<span class="go">Terminal&gt; ls</span>
<span class="go">__init__.py settings.py urls.py wsgi.py</span>
</pre></div>
</div>
<p>The meaning of the generated files are briefly listed below.</p>
<blockquote>
<div><ol class="arabic simple">
<li>The outer <tt class="docutils literal"><span class="pre">django_project/</span></tt> directory is just a container for your project. Its name does not matter to Django.</li>
<li><tt class="docutils literal"><span class="pre">manage.py</span></tt> is a command-line utility that lets you interact with this Django project in various ways. You will typically run <tt class="docutils literal"><span class="pre">manage.py</span></tt> to launch a Django application.</li>
<li>The inner <tt class="docutils literal"><span class="pre">django_project/</span></tt> directory is a Python package for the Django project. Its name is used in import statements in Python code (e.g., <tt class="docutils literal"><span class="pre">import</span> <span class="pre">django_project.settings</span></tt>).</li>
<li><tt class="docutils literal"><span class="pre">django_project/__init__.py</span></tt> is an empty file that just tells Python that this directory should be considered a Python package.</li>
<li><tt class="docutils literal"><span class="pre">django_project/settings.py</span></tt> contains the settings and configurations for this Django project.</li>
<li><tt class="docutils literal"><span class="pre">django_project/urls.py</span></tt> maps URLs to specific functions and thereby defines that actions that various URLs imply.</li>
<li><tt class="docutils literal"><span class="pre">django_project/wsgi.py</span></tt> is not needed in our examples.</li>
</ol>
</div></blockquote>
<p>Django comes with a web server for developing and debugging applications.
The server is started by running</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; python manage.py runserver</span>
</pre></div>
</div>
<p>You will see that the server runs on the URL &#8220;<a class="reference external" href="http://127.0.0.1:8000/">http://127.0.0.1:8000/</a>&#8221;.
Load this URL into your browser to see a welcome message from Django,
meaning that the server is working.</p>
<p>Despite the fact that our web applications do not need a database, you
have to register a database with a Django project. To this end,
open the <tt class="docutils literal"><span class="pre">django_project/settings.py</span></tt> file in a text editor,
locate the <tt class="docutils literal"><span class="pre">DATABASES</span></tt> dictionary and make sure the following
code is there:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">relative2absolute_path</span><span class="p">(</span><span class="n">relative_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the absolute path correspodning to relative_path.&quot;&quot;&quot;</span>
    <span class="n">dir_of_this_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_of_this_file</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s">&#39;default&#39;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s">&#39;django.db.backends.sqlite3&#39;</span><span class="p">,</span>
      <span class="s">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">relative2absolute_path</span><span class="p">(</span><span class="s">&#39;../database.db&#39;</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">settings.py</span></tt> file needs absolute paths to files, while it is
more convenient for us to specify relative paths. Therefore,
we made a function that figures out the absolute path to the <tt class="docutils literal"><span class="pre">settings.py</span></tt>
file and then combines this absolute path with the relative path.
The location and name of the database file can be chosen as desired.
Note that one should not use <tt class="docutils literal"><span class="pre">os.path.join</span></tt> to create paths as Django
applies the forward slash between directories also on Windows.</p>
</div>
<div class="section" id="setting-up-a-django-application">
<h2>Setting up a Django application<a class="headerlink" href="#setting-up-a-django-application" title="Permalink to this headline">¶</a></h2>
<p id="index-10">The next step is to create a Django app for our scientific hello
world program. We can place the app in any directory, but here we
utilize the following organization.
As neighbor to <tt class="docutils literal"><span class="pre">django_project</span></tt> we have
a directory <tt class="docutils literal"><span class="pre">apps</span></tt> containing our various scientific applications.
Under <tt class="docutils literal"><span class="pre">apps</span></tt> we create a directory <tt class="docutils literal"><span class="pre">hw</span></tt>
for the various versions of the scientific hello world applications:
<tt class="docutils literal"><span class="pre">orig</span></tt> for the original <tt class="docutils literal"><span class="pre">hw.py</span></tt> program, <tt class="docutils literal"><span class="pre">mvc</span></tt> for a split of this
program according to the original MVC pattern, <tt class="docutils literal"><span class="pre">mvc_django</span></tt> for
the MVC split according to the way Django requires,
and <tt class="docutils literal"><span class="pre">hw1_django</span></tt> for a first version of
the program with a Django-based web interface.</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; cd ..</span>
<span class="go">Terminal&gt; mkdir apps</span>
<span class="go">Terminal&gt; cd apps</span>
<span class="go">Terminal&gt; mkdir hw</span>
<span class="go">Terminal&gt; cd hw</span>
<span class="go">Terminal&gt; mkdir orig mvc</span>
</pre></div>
</div>
<p>The file <tt class="docutils literal"><span class="pre">hw.py</span></tt> is moved to <tt class="docutils literal"><span class="pre">orig</span></tt> while <tt class="docutils literal"><span class="pre">mvc</span></tt> contains
the MVC refactored version with the files <tt class="docutils literal"><span class="pre">model.py</span></tt>, <tt class="docutils literal"><span class="pre">view.py</span></tt>, <tt class="docutils literal"><span class="pre">compute.py</span></tt>,
and <tt class="docutils literal"><span class="pre">controller.py</span></tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">hw1_django</span></tt> directory, containing the Django application, must be
made with</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; python ../../django_project/manage.py startapp hw1_django</span>
</pre></div>
</div>
<p>The command creates a directory <tt class="docutils literal"><span class="pre">hw1_django</span></tt> with the content</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; cd hw1_django</span>
<span class="go">Terminal&gt; ls</span>
<span class="go">__init__.py models.py tests.py views.py</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">__init__.py</span></tt> file is empty and needed to ensure that the
Django application is a Python package. The other files are also
empty, but <tt class="docutils literal"><span class="pre">models.py</span></tt> and <tt class="docutils literal"><span class="pre">views.py</span></tt> will soon be filled with content.</p>
<p>At this point,
we need to register some information about our application in the
<tt class="docutils literal"><span class="pre">django_project/settings.py</span></tt> and <tt class="docutils literal"><span class="pre">django_project/urls.py</span></tt> files.</p>
<p><em>Step 1: Add the app.</em> Locate the <tt class="docutils literal"><span class="pre">INSTALLED_APPS</span></tt>
tuple in <tt class="docutils literal"><span class="pre">settings.py</span></tt> and add your Django application as a Python package:
directory <tt class="docutils literal"><span class="pre">django</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="o">...</span>
    <span class="s">&#39;hw1_django&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>However, Django will not be able to find the package <tt class="docutils literal"><span class="pre">hw1_django</span></tt>
unless we register the parent directory in <tt class="docutils literal"><span class="pre">sys.path</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">relative2absolute_path</span><span class="p">(</span><span class="s">&#39;../../apps/hw&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Note here that the relative path is given with respect to the
location of the <tt class="docutils literal"><span class="pre">settings.py</span></tt> script.</p>
<p><em>Step 2: Adding a template directory.</em> Make a subdirectory <tt class="docutils literal"><span class="pre">templates</span></tt> under <tt class="docutils literal"><span class="pre">hw1_django</span></tt>,</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">mkdir templates</span>
</pre></div>
</div>
<p>and add the absolute path of this directory to the <tt class="docutils literal"><span class="pre">TEMPLATE_DIRS</span></tt> tuple:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEMPLATE_DIRS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">relative2absolute_path</span><span class="p">(</span><span class="s">&#39;../../apps/hw/hw1_django/templates&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">templates</span></tt> directory will hold templates for the HTML code applied
in the web interfaces. The trailing comma is important (as this is
a tuple with only one element).</p>
<p><em>Step 3: Defining the URL.</em> We need to connect the Django app with
an URL, i.e., the address we write into the web browser to launch the
app. Our app will be associated with a Python function <tt class="docutils literal"><span class="pre">index</span></tt>
in the <tt class="docutils literal"><span class="pre">views</span></tt> module within the <tt class="docutils literal"><span class="pre">hw1_django</span></tt> package.
Say we want the corresponding URL to
be named <tt class="docutils literal"><span class="pre">hw</span></tt>. This is registered in the <tt class="docutils literal"><span class="pre">django_project/urls.py</span></tt> file
by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^hw1/&#39;</span><span class="p">,</span> <span class="s">&#39;hw1_django.views.index&#39;</span><span class="p">),</span>
</pre></div>
</div>
<p>The first argument to the <tt class="docutils literal"><span class="pre">url</span></tt> function is a regular expression for
the URL and the second argument is the name of the function to call.
The name <tt class="docutils literal"><span class="pre">index</span></tt> resembles the <tt class="docutils literal"><span class="pre">index.html</span></tt> main page associated
with an URL, but any other name than <tt class="docutils literal"><span class="pre">index</span></tt> can be used.</p>
</div>
<div class="section" id="programming-the-django-application-1">
<h2>Programming the Django application  (1)<a class="headerlink" href="#programming-the-django-application-1" title="Permalink to this headline">¶</a></h2>
<p>The Django application is about filling the files <tt class="docutils literal"><span class="pre">views.py</span></tt> and <tt class="docutils literal"><span class="pre">models.py</span></tt>
with content. The mathematical computations are performed in <tt class="docutils literal"><span class="pre">compute.py</span></tt>
so we copy this file from the <tt class="docutils literal"><span class="pre">mvc</span></tt> directory to the <tt class="docutils literal"><span class="pre">hw1_django</span></tt> directory
for convenience (we could alternatively add <tt class="docutils literal"><span class="pre">../mvc</span></tt> to <tt class="docutils literal"><span class="pre">sys.path</span></tt> such that
<tt class="docutils literal"><span class="pre">import</span> <span class="pre">compute</span></tt> would work from the <tt class="docutils literal"><span class="pre">hw1_django</span></tt> directory).</p>
<span class="target" id="index-11"></span><p id="index-12"><em>The model.</em> The <tt class="docutils literal"><span class="pre">models.py</span></tt> file contains the model which consists
of the data we need in the application, stored in Django&#8217;s data types.
Our data consists of one number, called <tt class="docutils literal"><span class="pre">r</span></tt>, and <tt class="docutils literal"><span class="pre">models.py</span></tt> then
look like</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">ModelForm</span>

<span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Input</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">Input</span></tt> class lists variables representing data as static class
attributes. The <tt class="docutils literal"><span class="pre">django.db.models</span></tt> module contains various classes
for different types of data, here we use <tt class="docutils literal"><span class="pre">FloatField</span></tt> to represent
a floating-point number (corresponding to a Python <tt class="docutils literal"><span class="pre">float</span></tt>).
The <tt class="docutils literal"><span class="pre">InputForm</span></tt> class has a the shown generic form across applications
if we by convention apply the name <tt class="docutils literal"><span class="pre">Input</span></tt> for the class holding the data.</p>
<span class="target" id="index-13"></span><p id="index-14"><em>The view.</em> The <tt class="docutils literal"><span class="pre">views.py</span></tt> file contains a function <tt class="docutils literal"><span class="pre">index</span></tt> which performs
the actions we want to perform when invoking
the URL ( here <tt class="docutils literal"><span class="pre">http://127.0.0.1:8000/hw/</span></tt>).
In addition, <tt class="docutils literal"><span class="pre">views.py</span></tt> has the <tt class="docutils literal"><span class="pre">present_output</span></tt> function from
the <tt class="docutils literal"><span class="pre">view.py</span></tt> file in the <tt class="docutils literal"><span class="pre">mvc_django</span></tt> directory.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">InputForm</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">present_output</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;hw1.html&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">present_output</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;Hello, World! sin(</span><span class="si">%s</span><span class="s">)=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">index</span></tt> function deserves some explanation. It must take one
argument, usually called <tt class="docutils literal"><span class="pre">request</span></tt>. There are two modes in the function. Either
the user has provided input on the web page, which means that
<tt class="docutils literal"><span class="pre">request.method</span></tt> equals <tt class="docutils literal"><span class="pre">'POST'</span></tt>, or we show a new web page
with which the user is supposed to interact.</p>
<p id="index-15"><em>Making the input page.</em> The input consists of a web form with
one field where we can fill in our <tt class="docutils literal"><span class="pre">r</span></tt> variable. This page
is realized by the two central statements</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Make info needed in the web form</span>
<span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">()</span>
<span class="c"># Make HTML code</span>
<span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;hw1.html&#39;</span><span class="p">,</span>
    <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">hw1.html</span></tt> file resides in the <tt class="docutils literal"><span class="pre">templates</span></tt> subdirectory and contains
a template for the HTML code:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;form method=&quot;post&quot; action=&quot;&quot;&gt;{% csrf_token %}
    Hello, World! The sine of {{ form.r }}
    &lt;input type=&quot;submit&quot; value=&quot;equals&quot; /&gt;
&lt;/form&gt;
</pre></div>
</div>
<p>This is a <em>template file</em> because it contains instructions like
<tt class="docutils literal"><span class="pre">{%</span> <span class="pre">csrf_token</span> <span class="pre">%}</span></tt> and variables like <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">form.r</span> <span class="pre">}}</span></tt>. Django will
replace the former by some appropriate HTML statements, while the
latter simply extracts the numerical value of the variable <tt class="docutils literal"><span class="pre">r</span></tt> in
our form (specified in the <tt class="docutils literal"><span class="pre">Input</span></tt> class in <tt class="docutils literal"><span class="pre">models.py</span></tt>).
Typically, this <tt class="docutils literal"><span class="pre">hw1.html</span></tt> file
results in the HTML code</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&#39;display:none&#39;</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name=</span><span class="s">&#39;csrfmiddlewaretoken&#39;</span>
<span class="na">value=</span><span class="s">&#39;oPWMuuy1gLlXm9GvUZINv49eVUYnux5Q&#39;</span> <span class="nt">/&gt;&lt;/div&gt;</span>
    Hello, World! The sine of <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;r&quot;</span> <span class="na">id=</span><span class="s">&quot;id_r&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;equals&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>Figure <a class="reference internal" href="#wf-hw1-django-fig-input"><em>The input page</em></a> shows how the input page looks like in the
web browser.</p>
<div class="figure" id="wf-hw1-django-fig-input">
<img alt="_images/hw1_django_input.png" src="_images/hw1_django_input.png" style="width: 600px;" />
<p class="caption"><em>The input page</em></p>
</div>
<p><em>Making the results page.</em> When then user has filled in a value in the text field on the input
page, the <tt class="docutils literal"><span class="pre">index</span></tt> function is called again and <tt class="docutils literal"><span class="pre">request.method</span></tt> equals
<tt class="docutils literal"><span class="pre">'POST'</span></tt>. A new form object is made, this time with user info (<tt class="docutils literal"><span class="pre">request.POST</span></tt>).
We can check that the form is valid and if so, proceed with
computations followed by presenting the results in a
new web page (see Figure <a class="reference internal" href="#wf-hw1-django-fig-result"><em>The result page</em></a>):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">present_output</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">present_output</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;Hello, World! sin(</span><span class="si">%s</span><span class="s">)=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
<p>The numerical value of <tt class="docutils literal"><span class="pre">r</span></tt> as given by the user is available as <tt class="docutils literal"><span class="pre">form.r</span></tt>.
Instead of using a template for the output page, which is natural to
do in more advanced cases, we here illustrate the possibility to
send raw HTML to the output page by returning an <tt class="docutils literal"><span class="pre">HttpResponse</span></tt>
object initialized by a string containing the desired HTML code.</p>
<div class="figure" id="wf-hw1-django-fig-result">
<img alt="_images/hw1_django_output.png" src="_images/hw1_django_output.png" style="width: 600px;" />
<p class="caption"><em>The result page</em></p>
</div>
<p>Launch this application by filling in the address <tt class="docutils literal"><span class="pre">http://127.0.0.1:8000/hw/</span></tt>
in your web browser (make sure the Django development server is running,
and if not, restart it by <tt class="docutils literal"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">runserver</span></tt>). Try to fill
in some number on the input page and view the output.
To show how easy it is to change the application, invoke the <tt class="docutils literal"><span class="pre">views.py</span></tt>
file in an editor and add some color to the output HTML code from
the <tt class="docutils literal"><span class="pre">present_output</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">&lt;font color=&#39;blue&#39;&gt;Hello&lt;/font&gt;, World!</span>
<span class="s">sin(</span><span class="si">%s</span><span class="s">)=</span><span class="si">%s</span><span class="s"></span>
<span class="s">&quot;&quot;&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
<p>Go back to the input page, provide a new number, and observe how
the &#8220;Hello&#8221; word now has a blue color.</p>
</div>
<div class="section" id="equipping-the-input-page-with-output-results-2">
<h2>Equipping the input page with output results  (2)<a class="headerlink" href="#equipping-the-input-page-with-output-results-2" title="Permalink to this headline">¶</a></h2>
<p>Instead of making a separate output page with the result, we can
simply add the sine value to the input page. This makes the user
feel that she interacts with the same page, as when operating a calculator.
The output page should then look as shown in Figure <a class="reference internal" href="#wf-hw2-django-fig-result"><em>The modified result page</em></a>.</p>
<div class="figure" id="wf-hw2-django-fig-result">
<img alt="_images/hw2_django_output.png" src="_images/hw2_django_output.png" style="width: 600px;" />
<p class="caption"><em>The modified result page</em></p>
</div>
<p>We need to make a new Django application, now called <tt class="docutils literal"><span class="pre">hw2_django</span></tt>.
Instead of running
<tt class="docutils literal"><span class="pre">manage.py</span> <span class="pre">startapp</span> <span class="pre">hw2_django</span></tt> we can simply copy the <tt class="docutils literal"><span class="pre">hw1_django</span></tt>
directory. We need, of course, to add information about this
new application in <tt class="docutils literal"><span class="pre">settings.py</span></tt> and <tt class="docutils literal"><span class="pre">urls.py</span></tt>.
In the former file we must have</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEMPLATE_DIRS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">relative2absolute_path</span><span class="p">(</span><span class="s">&#39;../../apps/hw1_django/templates&#39;</span><span class="p">),</span>
    <span class="n">relative2absolute_path</span><span class="p">(</span><span class="s">&#39;../../apps/hw2_django/templates&#39;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sites&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="c"># Uncomment the next line to enable the admin:</span>
    <span class="c"># &#39;django.contrib.admin&#39;,</span>
    <span class="c"># Uncomment the next line to enable admin documentation:</span>
    <span class="c"># &#39;django.contrib.admindocs&#39;,</span>
    <span class="s">&#39;hw1_django&#39;</span><span class="p">,</span>
    <span class="s">&#39;hw2_django&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In <tt class="docutils literal"><span class="pre">urls.py</span></tt> we add the URL <tt class="docutils literal"><span class="pre">hw2</span></tt> which is to call our <tt class="docutils literal"><span class="pre">index</span></tt> function
in the <tt class="docutils literal"><span class="pre">views.py</span></tt> file of the <tt class="docutils literal"><span class="pre">hw2_django</span></tt> app:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^hw1/&#39;</span><span class="p">,</span> <span class="s">&#39;hw1_django.views.index&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^hw2/&#39;</span><span class="p">,</span> <span class="s">&#39;hw2_django.views.index&#39;</span><span class="p">),</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">views.py</span></tt> file changes a bit since we shall generate almost the same
web page on input and output. This makes the <tt class="docutils literal"><span class="pre">present_output</span></tt> function
unnatural, and everything is done within the <tt class="docutils literal"><span class="pre">index</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># initial value of result</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;hw2.html&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
             <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
             <span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p>Note that the output variable <tt class="docutils literal"><span class="pre">s</span></tt> is computed within the <tt class="docutils literal"><span class="pre">index</span></tt>
function and defaults to <tt class="docutils literal"><span class="pre">None</span></tt>. The template file <tt class="docutils literal"><span class="pre">hw2.html</span></tt>
looks like</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;form method=&quot;post&quot; action=&quot;&quot;&gt;{% csrf_token %}
    Hello, World! The sine of {{ form.r }}
    &lt;input type=&quot;submit&quot; value=&quot;equals&quot; /&gt;
{% if s != &#39;&#39; %}
{{ s }}
{% endif %}
&lt;/form&gt;
</pre></div>
</div>
<p>The difference from <tt class="docutils literal"><span class="pre">hw1.html</span></tt> is that we right after the <em>equals</em>
button write out the value of <tt class="docutils literal"><span class="pre">s</span></tt>. However, we make a test that
the value is only written if it is computed, here recognized by
being a non-empty string. The <tt class="docutils literal"><span class="pre">s</span></tt> in the template file
is substituted by value corresponding to the key <tt class="docutils literal"><span class="pre">'s'</span></tt> in the
dictionary we pass to the <tt class="docutils literal"><span class="pre">render_to_response</span></tt>. As seen,
we pass a string where <tt class="docutils literal"><span class="pre">s</span></tt> is formatted with five digits if <tt class="docutils literal"><span class="pre">s</span></tt>
is a float, i.e., if <tt class="docutils literal"><span class="pre">s</span></tt> is computed. Otherwise, <tt class="docutils literal"><span class="pre">s</span></tt> has the
default value <tt class="docutils literal"><span class="pre">None</span></tt> and we send an empty string to the template.</p>
</div>
</div>
<div class="section" id="handling-multiple-input-variables-in-flask">
<span id="wf-vib-flask"></span><h1>Handling multiple input variables in Flask<a class="headerlink" href="#handling-multiple-input-variables-in-flask" title="Permalink to this headline">¶</a></h1>
<p>The scientific hello world example shows how to work with one input
variable and one output variable. We can easily derive a solution for
a collection of input variables and some corresponding HTML code
as result. Multiple input variables are listed in the <tt class="docutils literal"><span class="pre">InputForm</span></tt>
class using different types for different forms (text field,
float field, integer field, check box field for boolean values, etc.).
The value of these variables will be available in a <tt class="docutils literal"><span class="pre">form</span></tt> object
for computation. It is then a matter of taking the output from the
computation and format the corresponding HTML code for presenting
the result.</p>
<p>We address the task of plotting the function <span class="math">\(u(t)=Ae^{-bt}\sin (wt)\)</span> for
<span class="math">\(t\in [0,T]\)</span>. The web application must have fields for the numbers <span class="math">\(A\)</span>,
<span class="math">\(b\)</span>, <span class="math">\(w\)</span>, and <span class="math">\(T\)</span>, and a <em>Compute</em> button, as shown in Figure
<a class="reference internal" href="#wf-vib1-flask-fig-input"><em>The input page</em></a>. Filling in values, say <span class="math">\(0.1\)</span> for <span class="math">\(b\)</span> and
<span class="math">\(20\)</span> for <span class="math">\(T\)</span>, results in what we see in Figure <a class="reference internal" href="#wf-vib1-flask-fig-result"><em>The result page</em></a>,
i.e., a plot of <span class="math">\(u(t)\)</span> is added after the input fields and the <em>Compute</em>
button.</p>
<div class="figure" id="wf-vib1-flask-fig-input">
<img alt="_images/vib1_flask_input.png" src="_images/vib1_flask_input.png" style="width: 500px;" />
<p class="caption"><em>The input page</em></p>
</div>
<div class="figure" id="wf-vib1-flask-fig-result">
<img alt="_images/vib1_flask_output.png" src="_images/vib1_flask_output.png" style="width: 500px;" />
<p class="caption"><em>The result page</em></p>
</div>
<div class="section" id="programming-the-flask-application-2">
<h2>Programming the Flask application  (2)<a class="headerlink" href="#programming-the-flask-application-2" title="Permalink to this headline">¶</a></h2>
<p>The forthcoming text explains the necessary steps to realize a
Flask app that behaves as depicted in Figures <a class="reference internal" href="#wf-vib1-flask-fig-input"><em>The input page</em></a>
and <a class="reference internal" href="#wf-vib1-flask-fig-result"><em>The result page</em></a>. We start with the
<tt class="docutils literal"><span class="pre">compute.py</span></tt> module since it contains only the computation of <span class="math">\(u(t)\)</span>
and the making of the plot, without any interaction with Flask.</p>
<p>More specifically, inside <tt class="docutils literal"><span class="pre">compute.py</span></tt>, we have a function for
evaluating <span class="math">\(u(t)\)</span> and a <tt class="docutils literal"><span class="pre">compute</span></tt> function for making the plot. The
return value is the name of the plot file, which should get a unique
name every time the <tt class="docutils literal"><span class="pre">compute</span></tt> function is called such that the browser
cannot reuse an already cached image. Flask applications must have all
extra files (CSS, images, etc.) in a subdirectory <tt class="docutils literal"><span class="pre">static</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">linspace</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span>

<span class="k">def</span> <span class="nf">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  <span class="c"># needed to avoid adding curves in plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;A=</span><span class="si">%g</span><span class="s">, b=</span><span class="si">%g</span><span class="s">, w=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Remove old plot files</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;*.png&#39;</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c"># Use time since Jan 1, 1970 in filename in order make</span>
    <span class="c"># a unique filename that the browser has not chached</span>
    <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plotfile</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">compute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<p id="index-16">We organize the model, view, and controller as three separate
files, as illustrated in
the section <a class="reference internal" href="#wf-hw3-flask"><em>Splitting the app into model, view, and controller files</em></a>. This more complicated app involves
more code and especially the model will soon be handy to isolate in its own
file. Our first version of <tt class="docutils literal"><span class="pre">model.py</span></tt> reads</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">validators</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;amplitude (m)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;damping factor (kg/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;frequency (1/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;time interval (s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
</pre></div>
</div>
<p>As seen, the field classes can take a <tt class="docutils literal"><span class="pre">label</span></tt> argument for a longer
description, here also including the units in which the variable is
measured. It is also possible to add a <tt class="docutils literal"><span class="pre">description</span></tt> argument with
some help message. Furthermore, we include a <tt class="docutils literal"><span class="pre">default</span></tt> value, which
will appear in the text field such that the user does not need to
fill in all values.</p>
<p id="index-17">The view will of course make use of templates, and we shall experiment
with different templates. Therefore, we allow a command-line argument
to this Flask app for choosing which template we want. The rest of
the <tt class="docutils literal"><span class="pre">view.py</span></tt> file follows much the same set up as for the scientific
hello world app:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">InputForm</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;view0&#39;</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/vib1&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span> <span class="o">+</span> <span class="s">&#39;.html&#39;</span><span class="p">,</span>
                           <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>The details governing how the web page really looks like lie in the
template file. Since we have several fields and want them nicely
align in a tabular fashion, we place the field name, text areas,
and labels inside an HTML table in our first attempt to write a
template, <tt class="docutils literal"><span class="pre">view0.html</span></tt>:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;form method=post action=&quot;&quot;&gt;
&lt;table&gt;
  {% for field in form %}
    &lt;tr&gt;
    &lt;td&gt;{{ field.name }}&lt;/td&gt;&lt;td&gt;{{ field }}&lt;/td&gt;
    &lt;td&gt;{{ field.label }}&lt;/td&gt;
    &lt;/tr&gt;
  {% endfor %}
&lt;/table&gt;
&lt;p&gt;&lt;input type=submit value=Compute&gt;&lt;/form&gt;&lt;/p&gt;

&lt;p&gt;
{% if result != None %}
&lt;img src=&quot;{{ result }}&quot; width=500&gt;
{% endif %}
&lt;/p&gt;
</pre></div>
</div>
<p>Observe how easy it is to iterate over the <tt class="docutils literal"><span class="pre">form</span></tt> object and grab data
for each field: <tt class="docutils literal"><span class="pre">field.name</span></tt> is the name of the variable in the
<tt class="docutils literal"><span class="pre">InputForm</span></tt> class, <tt class="docutils literal"><span class="pre">field.label</span></tt> is the full name with units as given
through the <tt class="docutils literal"><span class="pre">label</span></tt> keyword when constructing the field object, and
writing the field object itself generates the text area for
input (i.e., the HTML input form). The control statements we can
use in the template are part of the <a class="reference external" href="http://jinja.pocoo.org/docs/">Jinja2</a>
<em>templating language</em>. For now, the if-test, for-loop and
output of values (<tt class="docutils literal"><span class="pre">{{</span> <span class="pre">object</span> <span class="pre">}}</span></tt>) are enough to generate the HTML
code we want.</p>
<p>Recall that the objects we need in the template, like <tt class="docutils literal"><span class="pre">result</span></tt> and <tt class="docutils literal"><span class="pre">form</span></tt>
in the present case, are transferred to the template via keyword
arguments to the <tt class="docutils literal"><span class="pre">render_template</span></tt> function. We can easily pass on
any object in our application to the template.</p>
<p>To get a runnable Flask application it remains to
run the <tt class="docutils literal"><span class="pre">app</span></tt> object from <tt class="docutils literal"><span class="pre">controller.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">view</span> <span class="kn">import</span> <span class="n">app</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>You are encouraged to run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span></tt> and load <tt class="docutils literal"><span class="pre">http://127.0.0.1:5000/vib1</span></tt> into your web browser for testing.</p>
</div>
<div class="section" id="implementing-error-checking-in-the-template">
<h2>Implementing error checking in the template<a class="headerlink" href="#implementing-error-checking-in-the-template" title="Permalink to this headline">¶</a></h2>
<p id="index-18">What happens if the user gives wrong input, for instance the letters <tt class="docutils literal"><span class="pre">asd</span></tt>
instead of a number? Actually nothing! The <tt class="docutils literal"><span class="pre">FloatField</span></tt> object
checks that the input is compatible with a real number in the
<tt class="docutils literal"><span class="pre">form.validate()</span></tt> call, but returns just <tt class="docutils literal"><span class="pre">False</span></tt> if this is not
the case. Looking at the code in <tt class="docutils literal"><span class="pre">view.py</span></tt>,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<p>we realize that wrong input implies <tt class="docutils literal"><span class="pre">result</span> <span class="pre">=</span> <span class="pre">None</span></tt> and no computations
and plot. Fortunately, each field object gets an attribute <tt class="docutils literal"><span class="pre">error</span></tt>
with information on errors that occur on input. We can write out
this information on the web page, as exemplified in the template
<tt class="docutils literal"><span class="pre">view1.html</span></tt>:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;form method=post action=&quot;&quot;&gt;
&lt;table&gt;
  {% for field in form %}
    &lt;tr&gt;
    &lt;td&gt;{{ field.name }}&lt;/td&gt;&lt;td&gt;{{ field(size=12) }}&lt;/td&gt;
    &lt;td&gt;{{ field.label }}&lt;/td&gt;
    {% if field.errors %}
      &lt;td&gt;&lt;ul class=errors&gt;
      {% for error in field.errors %}
        &lt;li&gt;&lt;font color=&quot;red&quot;&gt;{{ error }}&lt;/font&gt;&lt;/li&gt;
      {% endfor %}&lt;/ul&gt;&lt;/td&gt;
    {% endif %}
    &lt;/tr&gt;
  {% endfor %}
&lt;/table&gt;
&lt;p&gt;&lt;input type=submit value=Compute&gt;&lt;/form&gt;&lt;/p&gt;
&lt;p&gt;
{% if result != None %}
&lt;h4&gt;Plot:&lt;/h4&gt;
&lt;img src=&quot;{{ result }}&quot; width=500&gt;
{% endif %}
&lt;/p&gt;
</pre></div>
</div>
<p>Two things are worth noticing here:</p>
<ol class="arabic simple">
<li>We can control the width of the text field where the
user writes the numbers, here set to 12 characters.</li>
<li>We can make an extra column in the HTML table with a list
of possible errors for each field object.</li>
</ol>
<p>Let us test the <tt class="docutils literal"><span class="pre">A</span></tt> field by writing <tt class="docutils literal"><span class="pre">asd</span></tt> instead of a number. This
triggers an error, which is written in red to the right of the label,
see Figure <a class="reference internal" href="#wf-vib2-flask-fig-error1"><em>Triggering of a user-defined error check</em></a>.</p>
<div class="figure" id="wf-vib1-flask-fig-error1">
<img alt="_images/vib1_flask_error1.png" src="_images/vib1_flask_error1.png" style="width: 500px;" />
<p class="caption"><em>Error message because of wrong input</em></p>
</div>
</div>
<div class="section" id="using-style-sheets">
<h2>Using style sheets<a class="headerlink" href="#using-style-sheets" title="Permalink to this headline">¶</a></h2>
<p id="index-19">Web developers make heavy use of CSS style sheets to control the look
and feel of web pages. Templates can utilize style sheets as any other
standard HTML code. Here is a very simple example where we introduce
a class <tt class="docutils literal"><span class="pre">name</span></tt> for the column with the field name and set the
foreground color of the text in this column to blue.
The style sheet is called <tt class="docutils literal"><span class="pre">basic.css</span></tt> and <em>must</em> reside in the
<tt class="docutils literal"><span class="pre">static</span></tt> subdirectory of the Flask application directory:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">td</span><span class="o">.</span><span class="n">name</span> <span class="p">{</span> <span class="n">color</span><span class="p">:</span> <span class="n">blue</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">view2.html</span></tt> file using this style sheet features a <tt class="docutils literal"><span class="pre">link</span></tt> tag
to the style sheet in the HTML header, and the column containing
the field name has
the HTML tag <tt class="docutils literal"><span class="pre">&lt;td</span> <span class="pre">class=&quot;name&quot;&gt;</span></tt> to trigger the specification in
the style sheet:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;html&gt;
&lt;head&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;static/basic.css&quot; type=&quot;text/css&quot;&gt;
&lt;/head&gt;
&lt;body&gt;

&lt;form method=post action=&quot;&quot;&gt;
&lt;table&gt;
  {% for field in form %}
    &lt;tr&gt;
    &lt;td class=&quot;name&quot;&gt;{{ field.name }}&lt;/td&gt;
    &lt;td&gt;{{ field(size=12) }}&lt;/td&gt;
    &lt;td&gt;{{ field.label }}&lt;/td&gt;
</pre></div>
</div>
<p>Just run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span> <span class="pre">view2</span></tt> to see that the names
of the variables to set in the web page are blue.</p>
</div>
<div class="section" id="using-latex-mathematics">
<h2>Using LaTeX mathematics<a class="headerlink" href="#using-latex-mathematics" title="Permalink to this headline">¶</a></h2>
<p id="index-20">Scientific applications frequently have many input data that are
defined through mathematics and where the typesetting on the
web page should be as close as possible to the typesetting where
the mathematics is explained. In the present example we would like
to typeset <span class="math">\(A\)</span>, <span class="math">\(b\)</span>, <span class="math">\(w\)</span>, and <span class="math">\(T\)</span> with italic font as done
in LaTeX. Fortunately, native LaTeX typesetting is available in
HTML through the tool <a class="reference external" href="http://www.mathjax.org/">MathJax</a>.
Our template <tt class="docutils literal"><span class="pre">view3.html</span></tt> enables MathJax. Formulas are written
with standard LaTeX inside <tt class="docutils literal"><span class="pre">\(</span></tt> and <tt class="docutils literal"><span class="pre">\)</span></tt>, while equations are surrounded
by <tt class="docutils literal"><span class="pre">$$</span></tt>. Here we use formulas exclusively:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;script type=&quot;text/x-mathjax-config&quot;&gt;
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: &quot;AMS&quot;  },
     extensions: [&quot;AMSmath.js&quot;, &quot;AMSsymbols.js&quot;, &quot;autobold.js&quot;]
  }
});
&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot;
 src=&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;&gt;
&lt;/script&gt;

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

&lt;form method=post action=&quot;&quot;&gt;
&lt;table&gt;
  {% for field in form %}
    &lt;tr&gt;
    &lt;td&gt;\( {{ field.name }} \)&lt;/td&gt;&lt;td&gt;{{ field(size=12) }}&lt;/td&gt;
    &lt;td&gt;{{ field.label }}&lt;/td&gt;
</pre></div>
</div>
<p>Figure <a class="reference internal" href="#wf-vib1-flask-fig-latex"><em>LaTeX typesetting of mathematical symbols</em></a> displays how the
LaTeX rendering looks like in the browser.</p>
<div class="figure" id="wf-vib1-flask-fig-latex">
<img alt="_images/vib1_flask_latex.png" src="_images/vib1_flask_latex.png" style="width: 500px;" />
<p class="caption"><em>LaTeX typesetting of mathematical symbols</em></p>
</div>
</div>
<div class="section" id="rearringing-the-elements-in-the-html-template">
<h2>Rearringing the elements in the HTML template<a class="headerlink" href="#rearringing-the-elements-in-the-html-template" title="Permalink to this headline">¶</a></h2>
<p>Now we want to place the plot to the right of the input forms in
the web page, see Figure <a class="reference internal" href="#wf-vib1-flask-fig-sidebyside"><em>New design with input and output side by side</em></a>. This can
be accomplished by having an outer table with two rows. The first
row contains the table with the input forms in the first column and
the plot in the second column, while the second row features the
<em>Compute</em> button in the first column.</p>
<div class="figure" id="wf-vib1-flask-fig-sidebyside">
<img alt="_images/vib1_flask_table2.png" src="_images/vib1_flask_table2.png" style="width: 700px;" />
<p class="caption"><em>New design with input and output side by side</em></p>
</div>
<p>A relevant template file is <a href="#id1"><span class="problematic" id="id2">`</span></a>view4.html&#8217;:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;script type=&quot;text/x-mathjax-config&quot;&gt;
MathJax.Hub.Config({
  TeX: {
     equationNumbers: {  autoNumber: &quot;AMS&quot;  },
     extensions: [&quot;AMSmath.js&quot;, &quot;AMSsymbols.js&quot;, &quot;autobold.js&quot;]
  }
});
&lt;/script&gt;
&lt;script type=&quot;text/javascript&quot;
 src=&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;&gt;
&lt;/script&gt;

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

&lt;form method=post action=&quot;&quot;&gt;
&lt;table&gt; &lt;!-- table with forms to the left and plot to the right --&gt;
&lt;tr&gt;&lt;td&gt;
&lt;table&gt;
  {% for field in form %}
    &lt;tr&gt;
    &lt;td&gt;\( {{ field.name }} \)&lt;/td&gt;&lt;td&gt;{{ field(size=12) }}&lt;/td&gt;
    &lt;td&gt;{{ field.label }}&lt;/td&gt;
    {% if field.errors %}
      &lt;td&gt;&lt;ul class=errors&gt;
      {% for error in field.errors %}
        &lt;li&gt;&lt;font color=&quot;red&quot;&gt;{{ error }}&lt;/font&gt;&lt;/li&gt;
      {% endfor %}&lt;/ul&gt;&lt;/td&gt;
    {% endif %}
    &lt;/tr&gt;
  {% endfor %}
&lt;/table&gt;
&lt;/td&gt;
&lt;td&gt;
&lt;p&gt;
{% if result != None %}
&lt;img src=&quot;{{ result }}&quot; width=500&gt;
{% endif %}
&lt;/p&gt;
&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;p&gt;&lt;input type=submit value=Compute&gt;&lt;/form&gt;&lt;/p&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/table&gt;
</pre></div>
</div>
</div>
<div class="section" id="user-provided-validation-1">
<h2>User-provided validation  (1)<a class="headerlink" href="#user-provided-validation-1" title="Permalink to this headline">¶</a></h2>
<p id="index-21">The <tt class="docutils literal"><span class="pre">FloatField</span></tt> objects can check that the input is compatible with
a number, but what if we want to control that <span class="math">\(A&gt;0\)</span>, <span class="math">\(b&gt;0\)</span>, and
<span class="math">\(T\)</span> is not greater than 30 periods (otherwise the plot gets cluttered)?
We can write functions for checking appropriate conditions and
supply the function to the list of validator functions in the call to
the <tt class="docutils literal"><span class="pre">FloatField</span></tt> constructor or other field constructors. The extra
code is a part of the <tt class="docutils literal"><span class="pre">model.py</span></tt> and the presented extensions appear
in the directory <tt class="docutils literal"><span class="pre">vib2_flask</span></tt>.</p>
<p>The simplest approach to validation is to use existing functionality
in the web framework. Checking that <span class="math">\(A&gt;0\)</span> can be done by
the <tt class="docutils literal"><span class="pre">NumberRange</span></tt> validator which checks that the value is inside
a prescribed interval:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">validators</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;amplitude (m)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">NumberRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1E+20</span><span class="p">)])</span>
</pre></div>
</div>
<p>We can also easily provide our own more tailored validators.
As an example, let us explain how we can check that <span class="math">\(T\)</span> is less than 30 periods.
One period is <span class="math">\(2\pi /w\)</span> so we need to check if <span class="math">\(T&gt; 30\cdot 2\pi/w\)</span>
and raise an exception in that case.
A validation function takes two arguments: the whole <tt class="docutils literal"><span class="pre">form</span></tt> and the
specific <tt class="docutils literal"><span class="pre">field</span></tt> to test:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_T</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Form validation: failure if T &gt; 30 periods.&quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span>
    <span class="n">period</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">w</span>
    <span class="k">if</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="o">*</span><span class="n">period</span><span class="p">:</span>
        <span class="n">num_periods</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">period</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">validators</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">&#39;Cannot plot as much as </span><span class="si">%d</span><span class="s"> periods! T&lt;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">num_periods</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="n">period</span><span class="p">))</span>
</pre></div>
</div>
<p>The appropriate exception is of type <tt class="docutils literal"><span class="pre">validators.ValidationError</span></tt>.
Observe that through <tt class="docutils literal"><span class="pre">form</span></tt> we have in fact access to all the input
data so we can easily use the value of <span class="math">\(w\)</span> when checking the validity
of the value of <span class="math">\(T\)</span>. The <tt class="docutils literal"><span class="pre">check_T</span></tt> function is easy to
add to the list of validator functions in the call to the <tt class="docutils literal"><span class="pre">FloatField</span></tt>
constructor for <tt class="docutils literal"><span class="pre">T</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;time interval&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">pi</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">(),</span> <span class="n">check_T</span><span class="p">])</span>
</pre></div>
</div>
<p>The validator
objects are tested one by one as the appear in the list, and if
one fails, the others are not invoked.
We therefore add <tt class="docutils literal"><span class="pre">check_T</span></tt> after the check of input such that we know we
have a value for all data when we run the computations and test
in <tt class="docutils literal"><span class="pre">check_T</span></tt>.</p>
<p>Although there is already a <tt class="docutils literal"><span class="pre">NumberRange</span></tt> validator for checking
whether a value is inside an interval, we can write our own
version with some improved functionality for open intervals where
the maximum or minimum value can be infinite.
The infinite value can on input be represented by <tt class="docutils literal"><span class="pre">None</span></tt>.
A general such function may take the form</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_interval</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For validation: failure if value is outside an interval.&quot;&quot;&quot;</span>
    <span class="n">failure</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">min_value</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">max_value</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">min_value</span> <span class="o">=</span> <span class="s">&#39;-infty&#39;</span> <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_value</span><span class="p">)</span>
    <span class="n">max_value</span> <span class="o">=</span>  <span class="s">&#39;infty&#39;</span> <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">validators</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s"> not in [</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                       <span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">))</span>
</pre></div>
</div>
<p id="index-22">The problem is that <tt class="docutils literal"><span class="pre">check_interval</span></tt> takes four arguments, not only
the <tt class="docutils literal"><span class="pre">form</span></tt> and <tt class="docutils literal"><span class="pre">field</span></tt> arguments that a validator function can accept.
The way out of this difficulty is to use a Python tool <tt class="docutils literal"><span class="pre">functools.partial</span></tt>
which allows us to call a function with some of the arguments set.
Here, we want to create a new function that calls <tt class="docutils literal"><span class="pre">check_interval</span></tt>
with some prescribed values of <tt class="docutils literal"><span class="pre">min_value</span></tt> and <tt class="docutils literal"><span class="pre">max_value</span></tt>.
This function looks like it does not have these arguments, only
<tt class="docutils literal"><span class="pre">form</span></tt> and <tt class="docutils literal"><span class="pre">field</span></tt>. The following function produces this function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">interval</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">check_interval</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span>
</pre></div>
</div>
<p>We can in any field constructor just add
<tt class="docutils literal"><span class="pre">interval(a,</span> <span class="pre">b)</span></tt> as a validator function checking if the field value is
in the interval between <tt class="docutils literal"><span class="pre">a</span></tt> and <tt class="docutils literal"><span class="pre">b</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;damping factor (kg/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">(),</span> <span class="n">interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">None</span><span class="p">)])</span>
</pre></div>
</div>
<p>Let us test our tailored error checking. Run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span></tt>
in the <tt class="docutils literal"><span class="pre">vib2_flask</span></tt> directory and fill in <span class="math">\(-1.0\)</span> in the <span class="math">\(b\)</span> field.
Pressing <em>Compute</em> invokes our <tt class="docutils literal"><span class="pre">interval(0,None)</span></tt> function, which
is nothing but a call <tt class="docutils literal"><span class="pre">check_interval(field,</span> <span class="pre">form,</span> <span class="pre">0,</span> <span class="pre">None)</span></tt>,
and the test <tt class="docutils literal"><span class="pre">if</span> <span class="pre">field.data</span> <span class="pre">&lt;</span> <span class="pre">min_value</span></tt> becomes true, <tt class="docutils literal"><span class="pre">failure</span></tt>
is set and the exception is raised. The message in the exception
is available in the <tt class="docutils literal"><span class="pre">field.errors</span></tt> attribute so our template
will write it out in red, see Figure <a class="reference internal" href="#wf-vib2-flask-fig-error1"><em>Triggering of a user-defined error check</em></a>.
The template used in <tt class="docutils literal"><span class="pre">vib_flask</span></tt> is basically the same as <tt class="docutils literal"><span class="pre">view3.html</span></tt>
in <tt class="docutils literal"><span class="pre">vib1_flask</span></tt>, i.e., it feaures LaTeX mathematics and checking of
<tt class="docutils literal"><span class="pre">field.errors</span></tt>.</p>
<div class="figure" id="wf-vib2-flask-fig-error1">
<img alt="_images/vib2_flask_error1.png" src="_images/vib2_flask_error1.png" style="width: 500px;" />
<p class="caption"><em>Triggering of a user-defined error check</em></p>
</div>
<p>Finally, we mention a detail in the <tt class="docutils literal"><span class="pre">view.py</span></tt> file in the <tt class="docutils literal"><span class="pre">vib2_flask</span></tt>
app: instead of sending <tt class="docutils literal"><span class="pre">form.var.data</span></tt> to the <tt class="docutils literal"><span class="pre">compute</span></tt> function we
may automatically generate a set of local variables such that the
work with data from the web page looks nicer:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="c"># Make local variable (name field.name)</span>
            <span class="k">exec</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p>The idea is just to run <tt class="docutils literal"><span class="pre">exec</span></tt> on a declaration of a local variable
with name <tt class="docutils literal"><span class="pre">field.name</span></tt> for each field in the form. This trick is often
neat if data are buried in objects and you want variables in your
code to look like they do in mathematical writing.</p>
</div>
<div class="section" id="autogenerating-the-code">
<span id="wf-vib3-flask-autogen"></span><h2>Autogenerating the code<a class="headerlink" href="#autogenerating-the-code" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-23"></span><span class="target" id="index-24"></span><p id="index-25">We shall now present generic <tt class="docutils literal"><span class="pre">model.py</span></tt>, <tt class="docutils literal"><span class="pre">view.py</span></tt>, and <tt class="docutils literal"><span class="pre">controller.py</span></tt>
files that work with <em>any</em> <tt class="docutils literal"><span class="pre">compute</span></tt> function (!). This example will
demonstrate some advanced, powerful features of Python.</p>
<p>The basic idea is that the Python module <tt class="docutils literal"><span class="pre">inspect</span></tt> can be used to
retrieve the names of the arguments, and the default values of
keyword arguments of any given <tt class="docutils literal"><span class="pre">compute</span></tt> function. Say we have some</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">mycompute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]):</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Running</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">defaults</span>  <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span>
</pre></div>
</div>
<p>leads to</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">arg_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;x_range&#39;</span><span class="p">]</span>
<span class="n">defaults</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<p>Knowing the names <tt class="docutils literal"><span class="pre">name</span></tt> of some argument in the <tt class="docutils literal"><span class="pre">compute</span></tt>
function, we can make the corresponding class attribute
in the <tt class="docutils literal"><span class="pre">InputForm</span></tt> class by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">FloatForm</span><span class="p">())</span>
</pre></div>
</div>
<p>For name equal to <tt class="docutils literal"><span class="pre">'A'</span></tt> this is the same as hardcoding</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">FloatForm</span><span class="p">()</span>
</pre></div>
</div>
<p>Assuming that all arguments in <tt class="docutils literal"><span class="pre">compute</span></tt> are floats, we could
do</p>
<div class="highlight-text"><div class="highlight"><pre>class InputForm:
    pass  # Empty class

arg_names = inspect.getargspec(mycompute).args
for name in arg_names:
    setattr(InputForm, name, FloatForm())
</pre></div>
</div>
<p>However, we can do better than this: default values can be set for
keyword arguments, and the type of default value can be used to
select the appropriate form class. The complete <tt class="docutils literal"><span class="pre">model.py</span></tt> file
then goes as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example on generic model.py file which inspects the arguments</span>
<span class="sd">of the compute function and automatically generates a relevant</span>
<span class="sd">InputForm class.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">wtforms</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute_gamma</span> <span class="k">as</span> <span class="n">compute</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">defaults</span>  <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">wtforms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c"># Augment defaults with None elements for the positional</span>
<span class="c"># arguments</span>
<span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg_names</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
<span class="c"># Map type of default to right form field</span>
<span class="n">type2form</span> <span class="o">=</span> <span class="p">{</span><span class="nb">type</span><span class="p">(</span><span class="mf">1.0</span><span class="p">):</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">FloatField</span><span class="p">,</span>
             <span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>   <span class="n">wtforms</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">,</span>
             <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>  <span class="n">wtforms</span><span class="o">.</span><span class="n">TextField</span><span class="p">,</span>
             <span class="p">}</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arg_names</span><span class="p">,</span> <span class="n">defaults</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
            <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">type2form</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type2form</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)](</span>
                <span class="n">default</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;argument </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> not supported&#39;</span> <span class="o">%</span>
                            <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">InputForm</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
<p>(The <tt class="docutils literal"><span class="pre">compute_gamma</span></tt> function imported from <tt class="docutils literal"><span class="pre">compute</span></tt> will be treated later.)</p>
<p>The call to <tt class="docutils literal"><span class="pre">compute</span></tt> in the <tt class="docutils literal"><span class="pre">view.py</span></tt> file must also be expressed
in a general way such that it handle any type and number of
parameters. This is achieved by collecting all parameters in
a list or tuple, called <tt class="docutils literal"><span class="pre">args</span></tt>, and then calling <tt class="docutils literal"><span class="pre">compute(*args)</span></tt>
(which is equivalent to <tt class="docutils literal"><span class="pre">compute(args[0],</span> <span class="pre">args[1],</span> <span class="pre">...,</span> <span class="pre">args[l])</span></tt>
if <tt class="docutils literal"><span class="pre">l</span></tt> is <tt class="docutils literal"><span class="pre">len(args)-1</span></tt>). The value of the form variable with
name <tt class="docutils literal"><span class="pre">name</span></tt> (string) is extracted by <tt class="docutils literal"><span class="pre">getattr(form,</span> <span class="pre">name).data</span></tt>,
which is the same as <tt class="docutils literal"><span class="pre">form.A.data</span></tt> if <tt class="docutils literal"><span class="pre">name</span></tt> equals <tt class="docutils literal"><span class="pre">'A'</span></tt>.
Collecting all arguments and calling <tt class="docutils literal"><span class="pre">compute</span></tt> are done with</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Our <tt class="docutils literal"><span class="pre">InputForm</span></tt> class guarantees that all arguments in <tt class="docutils literal"><span class="pre">compute</span></tt>
are present in the form, but to be absolutely safe we can
test if <tt class="docutils literal"><span class="pre">name</span></tt> is present in the <tt class="docutils literal"><span class="pre">form</span></tt> object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
</pre></div>
</div>
<p>We could also use keyword arguments in the call in case
the <tt class="docutils literal"><span class="pre">args</span></tt> list should have the parameters in the wrong order:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span>
          <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)}</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">compute(**kwargs)</span></tt> becomes <tt class="docutils literal"><span class="pre">compute(A=1,</span> <span class="pre">b=3,</span> <span class="pre">w=0.5)</span></tt>
in case <tt class="docutils literal"><span class="pre">kwargs</span> <span class="pre">=</span> <span class="pre">{'w'=0.5,</span> <span class="pre">'A':1,</span> <span class="pre">'b':3}</span></tt> (recall that the order of
the keys in a Python dictionary is undetermined).</p>
<p>It remains to generate the right HTML template. The HTML code depends
what the returned <tt class="docutils literal"><span class="pre">result</span></tt> object from <tt class="docutils literal"><span class="pre">compute</span></tt> contains. Only the
writer of the <tt class="docutils literal"><span class="pre">compute</span></tt> function knows the details of the returned
result. Therefore, we leave it to this writer to provide the part
of the HTML template that renders the result. The file <tt class="docutils literal"><span class="pre">templates/view_results.html</span></tt> contains this user-provided code, while <tt class="docutils literal"><span class="pre">templates/view_forms.html</span></tt>
is the generic template for the forms:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;form method=post action=&quot;&quot;&gt;
&lt;table&gt;
  {% for field in form %}
    &lt;tr&gt;&lt;td&gt;{{ field.name }}&lt;/td&gt; &lt;td&gt;{{ field }}&lt;/td&gt;
    &lt;td&gt;{% if field.errors %}
      &lt;ul class=errors&gt;
      {% for error in field.errors %}
        &lt;li&gt;{{ error }}&lt;/li&gt;
      {% endfor %}&lt;/ul&gt;
    {% endif %}&lt;/td&gt;&lt;/tr&gt;
  {% endfor %}
&lt;/table&gt;
&lt;p&gt;&lt;input type=submit value=Compute&gt;&lt;/form&gt;&lt;/p&gt;
</pre></div>
</div>
<p>By default, in <tt class="docutils literal"><span class="pre">templates/view_results_default.html</span></tt>, we can
create a code that checks if <tt class="docutils literal"><span class="pre">results</span></tt> is a string ending in <tt class="docutils literal"><span class="pre">'.png'</span></tt>
or other typical file extensions for HTML images, and then write out
the code for an image, and otherwise a string version of the <tt class="docutils literal"><span class="pre">results</span></tt>
object is dumped to the web page:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">result</span> <span class="o">!=</span> <span class="bp">None</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="ow">and</span>
        <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.png&#39;</span> <span class="ow">or</span>  <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.gif&#39;</span> <span class="ow">or</span>
        <span class="n">result</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;.jpg&#39;</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;{{ result }}&quot;</span><span class="o">&gt;</span>
  <span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{{</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">}}</span>
  <span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The complete, generic <tt class="docutils literal"><span class="pre">index</span></tt> function now becomes</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                  <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c"># Concatenate view_forms.html and view_results.html</span>
    <span class="n">forms_html</span>   <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;view_forms.html&#39;</span><span class="p">)</span>
    <span class="n">results_html</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;view_results.html&#39;</span><span class="p">)</span>
    <span class="n">view_html</span>    <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;templates&#39;</span><span class="p">,</span> <span class="s">&#39;view.html&#39;</span><span class="p">)</span>
    <span class="n">f_forms</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">forms_html</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">f_res</span>   <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">results_html</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">f_view</span>  <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">view_html</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">f_view</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f_forms</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="o">+</span> <span class="n">f_res</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">f_forms</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>  <span class="n">f_res</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>  <span class="n">f_view</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">view_html</span><span class="p">),</span>
                           <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<p><em>Application.</em> Let us apply the files above to plot the <em>gamma probability density</em></p>
<div class="math">
\[g(x; a, h, A) = \frac{|h|}{\Gamma(a)A}\left(\frac{x}{A}\right)^{ah-1}
e^{-\left(\frac{x}{A}\right)^h},\]</div>
<p>and its cumulative density</p>
<div class="math">
\[G(x; a, h, A) = \int_0^x g(\tau; a, h, A)d\tau,\]</div>
<p>computed by numerically the Trapezoidal rule, for instance.
We also want to compute and display
the mean value <span class="math">\(A\Gamma(a + 1/h)/\Gamma(a)\)</span> and
standard deviation</p>
<div class="math">
\[\sigma = \frac{A}{\Gamma(a)}\sqrt{\Gamma(a + 2/h)\Gamma(a) - Gamma(a+1/h)^2}.\]</div>
<p>Here, <span class="math">\(\Gamma(a)\)</span> is the gamma function, which can be computed
by <tt class="docutils literal"><span class="pre">math.gamma(a)</span></tt> using Python&#8217;s <tt class="docutils literal"><span class="pre">math</span></tt> module.
Below are relevant implementations of <span class="math">\(g(x;a,h,A)\)</span> (<tt class="docutils literal"><span class="pre">gamma_density</span></tt>),
<span class="math">\(G(x; a, h, A)\)</span> (<tt class="docutils literal"><span class="pre">gamma_cumulative</span></tt>), and a function for
making a plot of <span class="math">\(g\)</span> og <span class="math">\(G\)</span> for <span class="math">\(x\in [0,7\sigma]\)</span>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="c"># http://en.wikipedia.org/wiki/Gamma_distribution</span>
    <span class="n">xA</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xA</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xA</span><span class="o">**</span><span class="n">h</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gamma_cumulative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="c"># Integrate gamma_density using the Trapezoidal rule.</span>
    <span class="c"># Assume x is array.</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">compute_gamma</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return plot and mean/st.dev. value of the gamma density.&quot;&quot;&quot;</span>
    <span class="n">gah</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">h</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">gah</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">stdev</span> <span class="o">=</span> <span class="n">A</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">/</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">gah</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="o">*</span><span class="n">stdev</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  <span class="c"># needed to avoid adding curves in plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;a=</span><span class="si">%g</span><span class="s">, h=</span><span class="si">%g</span><span class="s">, A=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Remove old plot files</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;*.png&#39;</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c"># Use time since Jan 1, 1970 in filename in order make</span>
    <span class="c"># a unique filename that the browser has not chached</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">plotfile1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;density_</span><span class="si">%s</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">plotfile2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;cumulative_</span><span class="si">%s</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">gamma_cumulative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plotfile1</span><span class="p">,</span> <span class="n">plotfile2</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">stdev</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">compute_gamma</span></tt> function returns a tuple of four values.
We want output as displayed in Figure <a class="reference internal" href="#wf-vib3-flask-fig-gamma"><em>Design of a web page illustrating the gamma probability functions</em></a>.</p>
<div class="figure" id="wf-vib3-flask-fig-gamma">
<img alt="_images/vib3_flask_gamma.png" src="_images/vib3_flask_gamma.png" style="width: 700px;" />
<p class="caption"><em>Design of a web page illustrating the gamma probability functions</em></p>
</div>
<p>The design is realized in the file <tt class="docutils literal"><span class="pre">view_results.html</span></tt> shown below.</p>
<div class="highlight-text"><div class="highlight"><pre>{% if result != None %}
&lt;p&gt;
&lt;table&gt;
&lt;tr&gt;
&lt;td&gt;&lt;img src=&quot;{{ result[0] }}&quot; width=&quot;400&quot;&gt;&lt;/td&gt;
&lt;td&gt;&lt;img src=&quot;{{ result[1] }}&quot; width=&quot;400&quot;&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;
Mean value: {{ result[2] }} &lt;br&gt;
Standard deviation value: {{ result[3] }}
&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
&lt;/p&gt;
{% endif %}
</pre></div>
</div>
</div>
</div>
<div class="section" id="handling-multiple-input-variables-in-django">
<span id="wf-vib-django"></span><h1>Handling multiple input variables in Django<a class="headerlink" href="#handling-multiple-input-variables-in-django" title="Permalink to this headline">¶</a></h1>
<p>We shall briefly demonstrate how to make the multi-variable input
application from the section <a class="reference internal" href="#wf-vib-flask"><em>Handling multiple input variables in Flask</em></a> in Django.
There are four float input variables: <span class="math">\(A\)</span>, <span class="math">\(b\)</span>, <span class="math">\(w\)</span>, and <span class="math">\(T\)</span>.
A function <tt class="docutils literal"><span class="pre">compute</span></tt> in the file <tt class="docutils literal"><span class="pre">compute.py</span></tt> makes
a plot of a function depending on these four parameters and returns
the name of the plot file. Our task is to define four input fields,
execute the <tt class="docutils literal"><span class="pre">compute</span></tt> function and show the input fields together with
the resulting plot, cf. Figures <a class="reference internal" href="#wf-vib1-flask-fig-input"><em>The input page</em></a>
and <a class="reference internal" href="#wf-vib1-flask-fig-result"><em>The result page</em></a>.</p>
<div class="section" id="programming-the-django-application-2">
<h2>Programming the Django application  (2)<a class="headerlink" href="#programming-the-django-application-2" title="Permalink to this headline">¶</a></h2>
<p>Any Django app needs a project, but here we reuse the project
we set up for the scientific hello world examples. We go to
<tt class="docutils literal"><span class="pre">apps/vib</span></tt> and create the Django app</p>
<div class="highlight-console"><div class="highlight"><pre><span class="go">Terminal&gt; python ../../django_project/manage.py startapp vib1_django</span>
</pre></div>
</div>
<p>Then we</p>
<ol class="arabic simple">
<li>add <tt class="docutils literal"><span class="pre">sys.path.insert(0,</span> <span class="pre">relative2absolute_path('../../apps/vib'))</span></tt>
in <tt class="docutils literal"><span class="pre">settings.py</span></tt>,</li>
<li>add <tt class="docutils literal"><span class="pre">relative2absolute_path('../../apps/vib/vib1_django/templates'),</span></tt>
to the <tt class="docutils literal"><span class="pre">TEMPLATE_DIRS</span></tt> tuple in <tt class="docutils literal"><span class="pre">settings.py</span></tt>, and</li>
<li>add <tt class="docutils literal"><span class="pre">url(r'^vib1/',</span> <span class="pre">'vib1_django.views.index')</span></tt> to the <tt class="docutils literal"><span class="pre">patterns</span></tt>
call in <tt class="docutils literal"><span class="pre">urls.py</span></tt>.</li>
</ol>
<p id="index-26">We can now invoke <tt class="docutils literal"><span class="pre">models.py</span></tt> to add form fields for the four
input variables:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">ModelForm</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; amplitude (m)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; damping coefficient (kg/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; frequency (1/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; time interval (s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Input</span>
</pre></div>
</div>
<p>Note here that we can provide a more explanatory name than just
the variable name, e.g., <tt class="docutils literal"><span class="pre">'</span> <span class="pre">amplitude</span> <span class="pre">(m)'</span></tt> for <tt class="docutils literal"><span class="pre">A</span></tt>. However,
Django will always capitalize these descriptions, so if one really
needs lower case names (e.g., to be compatible with mathematics),
one must start the text with a space. We also provide a default
value such that all fields have a value when the user sees
the page.</p>
<p id="index-27">The <tt class="docutils literal"><span class="pre">views.py</span></tt> file looks as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">InputForm</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form2</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">form2</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">form2</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">form2</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">form2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;static/&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;vib1.html&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
             <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
             <span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p>Some remarks are necessary:</p>
<ol class="arabic simple">
<li>Doing an <tt class="docutils literal"><span class="pre">os.chdir</span></tt> to the current working directory is necessary
as Django may be back in another working directory if you have
tested other apps.</li>
<li>The <tt class="docutils literal"><span class="pre">form2</span></tt> object from <tt class="docutils literal"><span class="pre">form.save</span></tt> is the object we extract
data from and send to <tt class="docutils literal"><span class="pre">compute</span></tt>, but the original <tt class="docutils literal"><span class="pre">form</span></tt>
object is needed when making the HTML page through the template.</li>
<li>Images, media files, style sheets, javascript files, etc. must
reside in a subdirectory <tt class="docutils literal"><span class="pre">static</span></tt>. The specifications of the
URL applies tools to find this <tt class="docutils literal"><span class="pre">static</span></tt> directory and then
the <tt class="docutils literal"><span class="pre">static</span></tt> prefix in the <tt class="docutils literal"><span class="pre">result</span></tt> filename must be removed.</li>
</ol>
<p>The template for rendering the page is listed next.</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;form method=post action=&quot;&quot;&gt;{% csrf_token %}
&lt;table&gt;
  {% for field in form %}
    &lt;tr&gt;
    &lt;td&gt;{{ field.name }}&lt;/td&gt;
    &lt;td&gt;{{ field }}&lt;/td&gt;
    &lt;td&gt;{{ field.label }}&lt;/td&gt;
    &lt;td&gt;{{ field.errors }}&lt;/td&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;/tr&gt;
  {% endfor %}
&lt;/table&gt;
&lt;p&gt;&lt;input type=submit value=Compute&gt;&lt;/form&gt;&lt;/p&gt;

&lt;p&gt;
{% if result != None %}
{% load static %}
&lt;img src=&quot;{% get_static_prefix %}{{ result }}&quot; width=500&gt;
{% endif %}
&lt;/p&gt;
</pre></div>
</div>
<p>The tricky part is the syntax for displaying <em>static content</em>, such as
the plot file made in the <tt class="docutils literal"><span class="pre">compute</span></tt> function.</p>
</div>
<div class="section" id="user-provided-validation-2">
<h2>User-provided validation  (2)<a class="headerlink" href="#user-provided-validation-2" title="Permalink to this headline">¶</a></h2>
<p>Django has a series of methods available for user-provided validation
of form data. These are exemplified in the app <tt class="docutils literal"><span class="pre">vib2_django</span></tt>, which
is an extension of the <tt class="docutils literal"><span class="pre">vib1_django</span></tt> app (with additional code, and
of course, registrations in <tt class="docutils literal"><span class="pre">settings.py</span></tt> and <tt class="docutils literal"><span class="pre">urls.py</span></tt>).</p>
<p id="index-28">Checking that <span class="math">\(A&gt;0\)</span> is easiest done with a built-in Django
validator:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; amplitude (m)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span>
</pre></div>
</div>
<p>We can write our own validators, which are functions taking one parameter
as argument, a value, and raising a <tt class="docutils literal"><span class="pre">ValidationError</span></tt> if the value
is wrong. Checking that a value is inside an interval can first be
implemented by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_interval</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate that a value is inside an interval.&quot;&quot;&quot;</span>
    <span class="n">failure</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">min_value</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">max_value</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">min_value</span> <span class="o">=</span> <span class="s">&#39;-infty&#39;</span> <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_value</span><span class="p">)</span>
    <span class="n">max_value</span> <span class="o">=</span>  <span class="s">&#39;infty&#39;</span> <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">&#39;value=</span><span class="si">%s</span><span class="s"> not in [</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">))</span>
</pre></div>
</div>
<p>However, this function takes more than the value as argument. We therefore
need to wrap it by a function with <tt class="docutils literal"><span class="pre">value</span></tt> as the only argument:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">interval</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Django-compatible interface to check_interval.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">check_interval</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, <tt class="docutils literal"><span class="pre">interval(0,</span> <span class="pre">1)</span></tt> returns a function that takes <tt class="docutils literal"><span class="pre">value</span></tt> as its
only argument and checks if it is inside <span class="math">\([0,1]\)</span>.
Such a function can be inserted in the <tt class="docutils literal"><span class="pre">validators</span></tt> list in
the field constructor, here to tell that <span class="math">\(b\)</span> must be in <span class="math">\([0,\infty)\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; damping coefficient (kg/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">None</span><span class="p">)])</span>
</pre></div>
</div>
<p>A final example on custom validation is to avoid plotting more
than 30 periods of the oscillating function <span class="math">\(u\)</span>. This translates
to checking of <span class="math">\(T\)</span> is geater
than 30 periods, i.e., <span class="math">\(T&gt;30\cdot 2\pi/w\)</span>. The task is done in
the <tt class="docutils literal"><span class="pre">InputForm</span></tt> class, where any method <tt class="docutils literal"><span class="pre">clean_T</span></tt> can do
validation and adjustment of the field name <tt class="docutils literal"><span class="pre">T</span></tt>. The code goes
as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Input</span>

    <span class="k">def</span> <span class="nf">clean_T</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;w&#39;</span><span class="p">]</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">w</span>
        <span class="k">if</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="o">*</span><span class="n">period</span><span class="p">:</span>
            <span class="n">num_periods</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">period</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Cannot plot as much as </span><span class="si">%d</span><span class="s"> periods! T &lt; </span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">num_periods</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="n">period</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">T</span>
</pre></div>
</div>
<p>We refer to the vast Django documentation for many other ways of
validating forms.</p>
</div>
<div class="section" id="exercise-1-add-two-numbers">
<span id="wf-exer-add2"></span><h2>Exercise 1: Add two numbers<a class="headerlink" href="#exercise-1-add-two-numbers" title="Permalink to this headline">¶</a></h2>
<p>Make a web application that reads two numbers from a web page,
adds the numbers, and prints the sum in a new web page.
Package the necessary files that constitute the application
in a tar file.
Filename: <tt class="docutils literal"><span class="pre">add2.tar.gz</span></tt>.</p>
</div>
</div>
<div class="section" id="remaining">
<h1>Remaining<a class="headerlink" href="#remaining" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><ul class="simple">
<li>apply (generated apps) to simviz (make py simviz too and describe that)</li>
<li>store data in database</li>
<li>discuss list values read as text and use of eval, perhaps exercise</li>
<li>avoid Flask or Django in exercises, just do not specify and have
common exercises at the very end</li>
<li>app: username, TextAreaField, store in database and retrieve for admin</li>
</ul>
</div></blockquote>
</div>


</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2013, H. P. Langtangen and A. E. Johansen.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>