
<!DOCTYPE html>




<html lang="en">
  <head>
    <meta charset="utf-8" />
    
    <title>Using Web Frameworks for Scientific Applications &mdash; Using Web Frameworks for Scientific Applications</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    
<link rel="stylesheet" href="_static/css/basicstrap-base.css" type="text/css" />
<link rel="stylesheet" href="_static/css/bootstrap.min.css" type="text/css" />
<link rel="stylesheet" href="_static/css/font-awesome.min.css">
<!--[if IE 7]>
<link rel="stylesheet" href="_static/css/font-awesome-ie7.min.css">
<![endif]-->
<style type="text/css">
  body {
    padding-top: 60px;
    padding-bottom: 40px;
  }
}
</style>
<link rel="stylesheet" href="_static/basicstrap.css" type="text/css" />
<link rel="stylesheet" href="_static/pygments.css" type="text/css" />
<link rel="stylesheet" href="_static/css/bootstrap-responsive.min.css" type="text/css" />
    
<script type="text/javascript">
  var DOCUMENTATION_OPTIONS = {
            URL_ROOT:    './',
            VERSION:     '1.0',
            COLLAPSE_INDEX: false,
            FILE_SUFFIX: '.html',
            HAS_SOURCE:  true
  };
</script>
<script type="text/javascript" src="_static/js/jquery.min.js"></script>
<script type="text/javascript" src="_static/underscore.js"></script>
<script type="text/javascript" src="_static/doctools.js"></script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript" src="_static/js/bootstrap.min.js"></script>
<script type="text/javascript">
  $(document).ready(function(){
    $('.show-sidebar').click(function(e) {
       e.preventDefault();
       if ($(".show-sidebar").html() == "Open Table Of Contents") {
          $('.for-mobile').removeClass('hidden-phone');
          $(".show-sidebar").html("Close Table Of Contents");
       } else {
          $(".show-sidebar").html("Open Table Of Contents");
       }
    });
  });
</script>

        <script src="http://sagecell.sagemath.org/static/jquery.min.js"></script>
        <script src="http://sagecell.sagemath.org/static/embedded_sagecell.js"></script>

        <script>sagecell.makeSagecell({inputLocation: ".sage"});</script>

        <style type="text/css">
                .sagecell .CodeMirror-scroll {
                        overflow-y: hidden;
                        overflow-x: auto;
                }
                .sagecell .CodeMirror {
                        height: auto;
                }
        </style>

    
    <link rel="top" title="Using Web Frameworks for Scientific Applications" href="index.html" />
    <link rel="prev" title="&lt;no title&gt;" href="._web4sa000.html" />
 
  </head>
  <body>
    <div class="navbar navbar-fixed-top ">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="index.html">Using Web Frameworks for Scientific Applications</a>
          <div class="nav-collapse collapse">
            <ul class="nav pull-right">
              
                <li>
                <a href="genindex.html" title="General Index" accesskey="I">index</a>
                </li>
                <li>
                <a href="._web4sa000.html" title="&lt;no title&gt;" accesskey="P">previous</a>
                </li>
              
            </ul>
          </div>
        </div>
      </div>
    </div>
    

    <!-- container -->
    <div class="container-fluid">


      
      <div class="row-fluid hidden-desktop hidden-tablet">
      
<div class="span3 ">
  <a class="visible-phone btn btn-small show-sidebar" data-toggle="collapse" data-target=".for-mobile">Open Table Of Contents</a>
  <div class="for-mobile sidebar hidden-phone">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Using Web Frameworks for Scientific Applications</a><ul>
<li><a class="reference internal" href="#web-frameworks">Web frameworks</a><ul>
<li><a class="reference internal" href="#the-mvc-pattern">The MVC pattern</a></li>
<li><a class="reference internal" href="#a-very-simple-application">A very simple application</a></li>
<li><a class="reference internal" href="#application-of-the-mvc-pattern">Application of the MVC pattern</a></li>
</ul>
</li>
<li><a class="reference internal" href="#making-a-flask-application">Making a Flask application</a><ul>
<li><a class="reference internal" href="#programming-the-flask-application-1">Programming the Flask application  (1)</a><ul>
<li><a class="reference internal" href="#the-user-interaction-1">The user interaction  (1)</a></li>
<li><a class="reference internal" href="#the-python-code">The Python code</a></li>
<li><a class="reference internal" href="#dissection">Dissection</a></li>
<li><a class="reference internal" href="#the-template-files">The template files</a></li>
<li><a class="reference internal" href="#testing-the-application">Testing the application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#equipping-the-input-page-with-output-results-1">Equipping the input page with output results  (1)</a></li>
<li><a class="reference internal" href="#splitting-the-app-into-model-view-and-controller-files">Splitting the app into model, view, and controller files</a></li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#address-already-in-use">Address already in use</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#making-a-django-application">Making a Django application</a><ul>
<li><a class="reference internal" href="#setting-up-a-django-project">Setting up a Django project</a></li>
<li><a class="reference internal" href="#setting-up-a-django-application">Setting up a Django application</a></li>
<li><a class="reference internal" href="#programming-the-django-application-1">Programming the Django application  (1)</a><ul>
<li><a class="reference internal" href="#the-user-interaction-2">The user interaction  (2)</a></li>
<li><a class="reference internal" href="#the-model-1">The model  (1)</a></li>
<li><a class="reference internal" href="#the-view-1">The view  (1)</a></li>
<li><a class="reference internal" href="#making-the-input-page">Making the input page</a></li>
<li><a class="reference internal" href="#making-the-results-page">Making the results page</a></li>
</ul>
</li>
<li><a class="reference internal" href="#equipping-the-input-page-with-output-results-2">Equipping the input page with output results  (2)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#handling-multiple-input-variables-in-flask">Handling multiple input variables in Flask</a><ul>
<li><a class="reference internal" href="#programming-the-flask-application-2">Programming the Flask application  (2)</a><ul>
<li><a class="reference internal" href="#the-compute-part-1">The compute part  (1)</a></li>
<li><a class="reference internal" href="#the-model-2">The model  (2)</a></li>
<li><a class="reference internal" href="#the-view-2">The view  (2)</a></li>
<li><a class="reference internal" href="#the-html-template-1">The HTML template  (1)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-error-checking-in-the-template">Implementing error checking in the template</a></li>
<li><a class="reference internal" href="#using-style-sheets">Using style sheets</a></li>
<li><a class="reference internal" href="#using-latex-mathematics">Using LaTeX mathematics</a></li>
<li><a class="reference internal" href="#rearranging-the-elements-in-the-html-template">Rearranging the elements in the HTML template</a></li>
<li><a class="reference internal" href="#bootstrap-html-style">Bootstrap HTML style</a></li>
<li><a class="reference internal" href="#custom-validation-1">Custom validation  (1)</a><ul>
<li><a class="reference internal" href="#using-flask-validators">Using Flask validators</a></li>
<li><a class="reference internal" href="#tailored-validation">Tailored validation</a></li>
<li><a class="reference internal" href="#tailored-validation-of-intervals">Tailored validation of intervals</a></li>
<li><a class="reference internal" href="#demo">Demo</a></li>
</ul>
</li>
<li><a class="reference internal" href="#avoiding-plot-files">Avoiding plot files</a><ul>
<li><a class="reference internal" href="#png-plots">PNG plots</a></li>
<li><a class="reference internal" href="#svg-plots">SVG plots</a></li>
</ul>
</li>
<li><a class="reference internal" href="#autogenerating-the-code">Autogenerating the code</a><ul>
<li><a class="reference internal" href="#inspecting-function-signatures">Inspecting function signatures</a></li>
<li><a class="reference internal" href="#generating-the-model">Generating the model</a></li>
<li><a class="reference internal" href="#generating-the-view">Generating the view</a></li>
<li><a class="reference internal" href="#generating-the-template">Generating the template</a></li>
<li><a class="reference internal" href="#application">Application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-login-and-storage-of-computed-results">User login and storage of computed results</a><ul>
<li><a class="reference internal" href="#required-additional-software">Required additional software</a></li>
<li><a class="reference internal" href="#the-compute-part-2">The compute part  (2)</a></li>
<li><a class="reference internal" href="#the-interfaces-of-the-app">The interfaces of the app</a></li>
<li><a class="reference internal" href="#the-source-code">The source code</a></li>
<li><a class="reference internal" href="#resources-1">Resources  (1)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#uploading-of-files">Uploading of files</a><ul>
<li><a class="reference internal" href="#overview-of-the-application">Overview of the application</a></li>
<li><a class="reference internal" href="#the-model-class">The model class</a></li>
<li><a class="reference internal" href="#the-controller-file">The controller file</a></li>
<li><a class="reference internal" href="#the-compute-function">The compute function</a></li>
<li><a class="reference internal" href="#the-html-template-2">The HTML template  (2)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#handling-multiple-input-variables-in-django">Handling multiple input variables in Django</a><ul>
<li><a class="reference internal" href="#programming-the-django-application-2">Programming the Django application  (2)</a><ul>
<li><a class="reference internal" href="#adding-the-app-to-a-project">Adding the app to a project</a></li>
<li><a class="reference internal" href="#the-compute-part-3">The compute part  (3)</a></li>
<li><a class="reference internal" href="#the-model-3">The model  (3)</a></li>
<li><a class="reference internal" href="#the-view-3">The view  (3)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-validation-2">Custom validation  (2)</a></li>
<li><a class="reference internal" href="#customizing-widgets">Customizing widgets</a></li>
<li><a class="reference internal" href="#resources-2">Resources  (2)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercises">Exercises</a><ul>
<li><a class="reference internal" href="#exercise-1-add-two-numbers">Exercise 1: Add two numbers</a></li>
<li><a class="reference internal" href="#exercise-2-upload-data-file-and-visualize-curves">Exercise 2: Upload data file and visualize curves</a></li>
<li><a class="reference internal" href="#exercise-3-plot-a-user-specified-formula">Exercise 3: Plot a user-specified formula</a></li>
<li><a class="reference internal" href="#exercise-4-visualize-taylor-polynomial-approximations">Exercise 4: Visualize Taylor polynomial approximations</a></li>
<li><a class="reference internal" href="#exercise-5-extend-the-gen-app">Exercise 5: Extend the <tt class="docutils literal"><span class="pre">gen</span></tt> app</a></li>
<li><a class="reference internal" href="#exercise-6-equip-the-gen-app-with-more-data-types">Exercise 6: Equip the <tt class="docutils literal"><span class="pre">gen</span></tt> app with more data types</a></li>
<li><a class="reference internal" href="#exercise-7-auto-generate-code-from-function-signature">Exercise 7: Auto-generate code from function signature</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resources-3">Resources  (3)</a><ul>
<li><a class="reference internal" href="#flask-resources">Flask resources</a></li>
<li><a class="reference internal" href="#django-resources">Django resources</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remaining">Remaining</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="._web4sa000.html"
                        title="previous chapter">&lt;no title&gt;</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/._web4sa001.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox">
  <h3>Quick search</h3>
  <form class="search form-search" action="search.html" method="get">
      <div class="input-append">
        <input type="text" class="search-query" name="q">
        <input type="submit" class="btn" value="Go" />
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  </div>
</div>
      </div>
      

      <!-- row -->
      <div class="row-fluid">
         
<div class="span3 visible-desktop visible-tablet">
  <div class=" sidebar hidden-phone">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Using Web Frameworks for Scientific Applications</a><ul>
<li><a class="reference internal" href="#web-frameworks">Web frameworks</a><ul>
<li><a class="reference internal" href="#the-mvc-pattern">The MVC pattern</a></li>
<li><a class="reference internal" href="#a-very-simple-application">A very simple application</a></li>
<li><a class="reference internal" href="#application-of-the-mvc-pattern">Application of the MVC pattern</a></li>
</ul>
</li>
<li><a class="reference internal" href="#making-a-flask-application">Making a Flask application</a><ul>
<li><a class="reference internal" href="#programming-the-flask-application-1">Programming the Flask application  (1)</a><ul>
<li><a class="reference internal" href="#the-user-interaction-1">The user interaction  (1)</a></li>
<li><a class="reference internal" href="#the-python-code">The Python code</a></li>
<li><a class="reference internal" href="#dissection">Dissection</a></li>
<li><a class="reference internal" href="#the-template-files">The template files</a></li>
<li><a class="reference internal" href="#testing-the-application">Testing the application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#equipping-the-input-page-with-output-results-1">Equipping the input page with output results  (1)</a></li>
<li><a class="reference internal" href="#splitting-the-app-into-model-view-and-controller-files">Splitting the app into model, view, and controller files</a></li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a><ul>
<li><a class="reference internal" href="#address-already-in-use">Address already in use</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#making-a-django-application">Making a Django application</a><ul>
<li><a class="reference internal" href="#setting-up-a-django-project">Setting up a Django project</a></li>
<li><a class="reference internal" href="#setting-up-a-django-application">Setting up a Django application</a></li>
<li><a class="reference internal" href="#programming-the-django-application-1">Programming the Django application  (1)</a><ul>
<li><a class="reference internal" href="#the-user-interaction-2">The user interaction  (2)</a></li>
<li><a class="reference internal" href="#the-model-1">The model  (1)</a></li>
<li><a class="reference internal" href="#the-view-1">The view  (1)</a></li>
<li><a class="reference internal" href="#making-the-input-page">Making the input page</a></li>
<li><a class="reference internal" href="#making-the-results-page">Making the results page</a></li>
</ul>
</li>
<li><a class="reference internal" href="#equipping-the-input-page-with-output-results-2">Equipping the input page with output results  (2)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#handling-multiple-input-variables-in-flask">Handling multiple input variables in Flask</a><ul>
<li><a class="reference internal" href="#programming-the-flask-application-2">Programming the Flask application  (2)</a><ul>
<li><a class="reference internal" href="#the-compute-part-1">The compute part  (1)</a></li>
<li><a class="reference internal" href="#the-model-2">The model  (2)</a></li>
<li><a class="reference internal" href="#the-view-2">The view  (2)</a></li>
<li><a class="reference internal" href="#the-html-template-1">The HTML template  (1)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-error-checking-in-the-template">Implementing error checking in the template</a></li>
<li><a class="reference internal" href="#using-style-sheets">Using style sheets</a></li>
<li><a class="reference internal" href="#using-latex-mathematics">Using LaTeX mathematics</a></li>
<li><a class="reference internal" href="#rearranging-the-elements-in-the-html-template">Rearranging the elements in the HTML template</a></li>
<li><a class="reference internal" href="#bootstrap-html-style">Bootstrap HTML style</a></li>
<li><a class="reference internal" href="#custom-validation-1">Custom validation  (1)</a><ul>
<li><a class="reference internal" href="#using-flask-validators">Using Flask validators</a></li>
<li><a class="reference internal" href="#tailored-validation">Tailored validation</a></li>
<li><a class="reference internal" href="#tailored-validation-of-intervals">Tailored validation of intervals</a></li>
<li><a class="reference internal" href="#demo">Demo</a></li>
</ul>
</li>
<li><a class="reference internal" href="#avoiding-plot-files">Avoiding plot files</a><ul>
<li><a class="reference internal" href="#png-plots">PNG plots</a></li>
<li><a class="reference internal" href="#svg-plots">SVG plots</a></li>
</ul>
</li>
<li><a class="reference internal" href="#autogenerating-the-code">Autogenerating the code</a><ul>
<li><a class="reference internal" href="#inspecting-function-signatures">Inspecting function signatures</a></li>
<li><a class="reference internal" href="#generating-the-model">Generating the model</a></li>
<li><a class="reference internal" href="#generating-the-view">Generating the view</a></li>
<li><a class="reference internal" href="#generating-the-template">Generating the template</a></li>
<li><a class="reference internal" href="#application">Application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-login-and-storage-of-computed-results">User login and storage of computed results</a><ul>
<li><a class="reference internal" href="#required-additional-software">Required additional software</a></li>
<li><a class="reference internal" href="#the-compute-part-2">The compute part  (2)</a></li>
<li><a class="reference internal" href="#the-interfaces-of-the-app">The interfaces of the app</a></li>
<li><a class="reference internal" href="#the-source-code">The source code</a></li>
<li><a class="reference internal" href="#resources-1">Resources  (1)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#uploading-of-files">Uploading of files</a><ul>
<li><a class="reference internal" href="#overview-of-the-application">Overview of the application</a></li>
<li><a class="reference internal" href="#the-model-class">The model class</a></li>
<li><a class="reference internal" href="#the-controller-file">The controller file</a></li>
<li><a class="reference internal" href="#the-compute-function">The compute function</a></li>
<li><a class="reference internal" href="#the-html-template-2">The HTML template  (2)</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#handling-multiple-input-variables-in-django">Handling multiple input variables in Django</a><ul>
<li><a class="reference internal" href="#programming-the-django-application-2">Programming the Django application  (2)</a><ul>
<li><a class="reference internal" href="#adding-the-app-to-a-project">Adding the app to a project</a></li>
<li><a class="reference internal" href="#the-compute-part-3">The compute part  (3)</a></li>
<li><a class="reference internal" href="#the-model-3">The model  (3)</a></li>
<li><a class="reference internal" href="#the-view-3">The view  (3)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#custom-validation-2">Custom validation  (2)</a></li>
<li><a class="reference internal" href="#customizing-widgets">Customizing widgets</a></li>
<li><a class="reference internal" href="#resources-2">Resources  (2)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#exercises">Exercises</a><ul>
<li><a class="reference internal" href="#exercise-1-add-two-numbers">Exercise 1: Add two numbers</a></li>
<li><a class="reference internal" href="#exercise-2-upload-data-file-and-visualize-curves">Exercise 2: Upload data file and visualize curves</a></li>
<li><a class="reference internal" href="#exercise-3-plot-a-user-specified-formula">Exercise 3: Plot a user-specified formula</a></li>
<li><a class="reference internal" href="#exercise-4-visualize-taylor-polynomial-approximations">Exercise 4: Visualize Taylor polynomial approximations</a></li>
<li><a class="reference internal" href="#exercise-5-extend-the-gen-app">Exercise 5: Extend the <tt class="docutils literal"><span class="pre">gen</span></tt> app</a></li>
<li><a class="reference internal" href="#exercise-6-equip-the-gen-app-with-more-data-types">Exercise 6: Equip the <tt class="docutils literal"><span class="pre">gen</span></tt> app with more data types</a></li>
<li><a class="reference internal" href="#exercise-7-auto-generate-code-from-function-signature">Exercise 7: Auto-generate code from function signature</a></li>
</ul>
</li>
<li><a class="reference internal" href="#resources-3">Resources  (3)</a><ul>
<li><a class="reference internal" href="#flask-resources">Flask resources</a></li>
<li><a class="reference internal" href="#django-resources">Django resources</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remaining">Remaining</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="._web4sa000.html"
                        title="previous chapter">&lt;no title&gt;</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/._web4sa001.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox">
  <h3>Quick search</h3>
  <form class="search form-search" action="search.html" method="get">
      <div class="input-append">
        <input type="text" class="search-query" name="q">
        <input type="submit" class="btn" value="Go" />
      </div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
  </div>
</div> 
        

        <div class="span9">
          <div class="document">
            <div class="documentwrapper">
              <div class="bodywrapper">
                <div class="body">
                  
  <div class="section" id="using-web-frameworks-for-scientific-applications">
<h1>Using Web Frameworks for Scientific Applications<a class="headerlink" href="#using-web-frameworks-for-scientific-applications" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Authors:</th><td class="field-body">Hans Petter Langtangen, Anders E. Johansen</td>
</tr>
<tr class="field-even field"><th class="field-name">Date:</th><td class="field-body">Feb 26, 2015</td>
</tr>
</tbody>
</table>
<div class="section" id="web-frameworks">
<h2>Web frameworks<a class="headerlink" href="#web-frameworks" title="Permalink to this headline">¶</a></h2>
<p id="index-0">Computational scientists may want to offer their applications through
a web interface, thereby making a <em>web application</em>.
Basically, this means that users can set input data
to the application on a web page, then click on some <em>Compute</em> button,
and back comes a new web page with the results of the computations.
The web interface can either be used as a GUI locally on the
scientist&#8217;s computer, or the interface can be depolyed to
a server and made available to the whole world.</p>
<p>Web applications of the mentioned type can be created from scratch
using CGI scripts in (e.g.) Python, but the code quickly gets longer
and more involved as the complexity of the web interface
grows. Nowadays, most web applications are created with the aid of
<em>web frameworks</em>, which are software packages that simplify the
programming tasks of offering services through the Internet. The
downside of web frameworks is that there is a significant amount of
steps and details to learn before your first simple demo application
works.  The upside is that advanced applications are within reach,
without an overwhelming amount of programming, as soon as you have
understood the basic demos.</p>
<p>We shall explore two web frameworks: the very popular <a class="reference external" href="https://www.djangoproject.com/">Django framework</a> and the more high-level and easy-to-use framework
<a class="reference external" href="http://flask.pocoo.org/">Flask</a>. Our introductory examples were also
implemented in the <a class="reference external" href="http://www.web2py.com/">web2py</a> framework, but according
to our experience, Flask and Django are easier to explain to scientists.
The primary advantage of Django
over other web frameworks is the rich set of documentation and
examples. Googling for &#8220;Django tutorials&#8221; gives lots of hits including
a  list of <a class="reference external" href="https://code.djangoproject.com/wiki/Tutorials">web tutorials</a>
and a list of <a class="reference external" href="http://www.youtube.com/playlist?list=PL385A53B00B8B158E">YouTube videos</a>. There is also an electronic <a class="reference external" href="http://www.djangobook.com/en/2.0/">Django book</a>. At the time of this writing, the Flask documentation is not comparable. The two most important resources are the</p>
<blockquote>
<div><a class="reference external" href="http://flask.pocoo.org/">official web site</a> and the <a class="reference external" href="http://wtforms.simplecodes.com/docs/0.6/index.html">WTForms Documentation</a>. There is, unfortunately, hardly any examples on how Django or Flask can be used to enable typical scientific applications for the web, and that is why we have developed some targeted examples on this topic.</div></blockquote>
<p>A basic question is, of course, whether you should apply Flask or
Django for your web project. Googling for <em>flask vs django</em> gives a
lot of diverging opinions. The authors&#8217; viewpoint is that Flask is
much easier to get started with than Django. You can grow your
application to a really big one with both frameworks, but some
advanced features is easier in one framework than in the other.</p>
<p>The problem for a computational scientist who wants to enable
mathematical calculations through the web is that most of
the introductory examples on utilizing a particular
web framework address web applications
of very different nature, e.g., blogs and polls. Therefore, we have made an
alternative introduction which explains, in the simplest possible way,
how web frameworks can be used to</p>
<ol class="arabic simple">
<li>generate a web page with input data to your application,</li>
<li>run the application to perform mathematical computations, and</li>
<li>generate a web page with the results of the computations.</li>
</ol>
<p>To work with Django, you need to know about Python packages and modules
as well as Python classes. With Flask it is enough to be familiar with
functions and modules, though knowledge of classes and a bit of
decorators might be an advantage.</p>
<p>All the files associated with this document are available in a
<a class="reference external" href="https://github.com/hplgit/web4sciapps/">GitHub repository</a>.
The relevant files for the web applications are located
in a subtree <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/">doc/src/web4sa/src-web4sa/apps</a>
of this repository.</p>
<div class="section" id="the-mvc-pattern">
<h3>The MVC pattern<a class="headerlink" href="#the-mvc-pattern" title="Permalink to this headline">¶</a></h3>
<p id="index-1">The MVC pattern stands for Model-View-Controller and is a way of
separating the user&#8217;s interaction with an application from the inner
workings of the application. In a scientific application this
usually means separating mathematical computations from the
user interface and visualization of results.
The <a class="reference external" href="http://en.wikipedia.org/wiki/MVC_Pattern">Wikipedia definition of the MVC pattern</a> gives a very high-level
explanation of what the model, view, and controller do and mentions
the fact that different web frameworks interpret the three components
differently. Any web application works with a set of data and needs
a user interface for the communication of data between the user and
some data processing software. The classical
MVC pattern introduces</p>
<blockquote>
<div><ul class="simple">
<li>the model to hold the data</li>
<li>the view to display the data</li>
<li>the controller to move the data by gluing the model and the view.</li>
</ul>
</div></blockquote>
<p>For applications performing mathematical computations we find it
convenient to explicitly introduce a fourth component that we call
<em>compute</em> where the mathematical computations are encapsulated.  With
the MVC pattern and the compute component we have a clear separation
between data (model), the way data is presented (view), the
computations (compute), and the way these components communicate
(controller). In a small program such a separation may look as
overkill, but it pays off in more complicated applications. More
importantly, the concepts of the MVC pattern are widely used in web
frameworks and their documentation so one should really adapt to the
MVC way of thinking.</p>
<p>Web frameworks often have their own way of interpreting the
model, view, and controller parts of the MVC pattern.
In particular, most frameworks often divide the view into two parts:
one software component and one HTML template. The latter takes care
of the look and feel of the web page while the former often takes
the role of being the controller too.
For our scientific applications
we shall employ an interpretation of the MVC pattern
which is compatible with what we need later on:</p>
<blockquote>
<div><ul class="simple">
<li>the model contains the data (often only the input data) of the application,</li>
<li>the view controls the user interface that handles input and output data,
and also calls to functionality that computes the output given the input.</li>
</ul>
</div></blockquote>
<p>The model will be a Python class with static attributes holding the data.
The view consists of Python code processing the model&#8217;s data, calling the
compute component, and specifying HTML
templates for the design of the web pages.</p>
<p>Flask does not force any MVC pattern on the programmer, but
the code needed to build web applications can easily be split into
model, view, controller, and compute components, as will be shown later.
Django, on the other hand, automatically generates application files with names
<tt class="docutils literal"><span class="pre">views.py</span></tt> and <tt class="docutils literal"><span class="pre">models.py</span></tt> so it is
necessary to have some idea what Django means by these terms.
The controller functionality in Django lies both in the <tt class="docutils literal"><span class="pre">views.py</span></tt> file and
in the configuration
files (<tt class="docutils literal"><span class="pre">settings.py</span></tt> and <tt class="docutils literal"><span class="pre">urls.py</span></tt>). The view component of the application
consists both of the <tt class="docutils literal"><span class="pre">views.py</span></tt> file and template files used to create
the HTML code in the web pages.</p>
<p>Forthcoming examples will illustrate how a scientific application is
split to meet the requirements of the MVC software design pattern.</p>
</div>
<div class="section" id="a-very-simple-application">
<h3>A very simple application<a class="headerlink" href="#a-very-simple-application" title="Permalink to this headline">¶</a></h3>
<p>We shall start with the simplest possible application,
a &#8220;scientific hello world program&#8221;, where the
task is to read a number and write out &#8220;Hello, World!&#8221; followed by
the sine of the number. This application has one input variable and
a line of text as output.</p>
<p>Our first implementation reads the input from the command
line and writes the results to the terminal window:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">math</span>
<span class="n">r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;Hello, World! sin(</span><span class="si">%g</span><span class="s">)=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>In the terminal we can exemplify the program</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python hw.py 1.2
Hello, World! sin(1.2)=0.932039
</pre></div>
</div>
<p>The task of the web version of this program is to read the <tt class="docutils literal"><span class="pre">r</span></tt>
variable from a web page, compute the sine,
and write out a new web page with the resulting text.</p>
</div>
<div class="section" id="application-of-the-mvc-pattern">
<span id="wf-hw-mvc"></span><h3>Application of the MVC pattern<a class="headerlink" href="#application-of-the-mvc-pattern" title="Permalink to this headline">¶</a></h3>
<p>Before thinking of a web application, we first <em>refactor</em> our program
such that it fits with the classical MVC pattern and a compute component.
The refactoring does not change the functionality of the code, it
just distributes the original statements in functions and modules.
Here we create four modules: <tt class="docutils literal"><span class="pre">model</span></tt>, <tt class="docutils literal"><span class="pre">view</span></tt>,
<tt class="docutils literal"><span class="pre">compute</span></tt>, and <tt class="docutils literal"><span class="pre">controller</span></tt>.</p>
<blockquote>
<div><ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">compute</span></tt> module contains a function <tt class="docutils literal"><span class="pre">compute(r)</span></tt> that performs
the mathematics and returns the value <tt class="docutils literal"><span class="pre">s</span></tt>, which equals <tt class="docutils literal"><span class="pre">sin(r)</span></tt>.</li>
<li>The <tt class="docutils literal"><span class="pre">model</span></tt> module holds the input data, here <tt class="docutils literal"><span class="pre">r</span></tt>.</li>
<li>The <tt class="docutils literal"><span class="pre">view</span></tt> module has two functions, one for reading input data,
<tt class="docutils literal"><span class="pre">get_input</span></tt>,
and one for presenting the output, <tt class="docutils literal"><span class="pre">present_output</span></tt>.
The latter takes the input, calls <tt class="docutils literal"><span class="pre">compute</span></tt> functionalty, and
generates the output.</li>
<li>The <tt class="docutils literal"><span class="pre">controller</span></tt> module calls the view to initialize
the model&#8217;s data from the command line. Thereafter, the
view is called to present the output.</li>
</ul>
</div></blockquote>
<p>The <tt class="docutils literal"><span class="pre">model.py</span></tt> file contains the <tt class="docutils literal"><span class="pre">r</span></tt> variable, which must
be declared with a default value in order to create the data object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">r</span> <span class="o">=</span> <span class="mf">0.0</span>    <span class="c"># input</span>
<span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>   <span class="c"># output</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">view.py</span></tt> file is restricted to the communication with the user and reads</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">compute</span>

<span class="c"># Input: float r</span>
<span class="c"># Output: &quot;Hello, World! sin(r)=...&quot;</span>

<span class="k">def</span> <span class="nf">get_input</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get input data from the command line.&quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">present_output</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write results to terminal window.&quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&#39;Hello, World! sin(</span><span class="si">%g</span><span class="s">)=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>The mathematics is encapsulated in <tt class="docutils literal"><span class="pre">compute.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, <tt class="docutils literal"><span class="pre">controller.py</span></tt> glues the model and the view:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">model</span><span class="o">,</span> <span class="nn">view</span>

<span class="n">model</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">view</span><span class="o">.</span><span class="n">get_input</span><span class="p">()</span>
<span class="n">view</span><span class="o">.</span><span class="n">present_output</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
<p>Let us try our refactored code:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python controller.py 1.2
Hello, World! sin(1.2)=0.932039
</pre></div>
</div>
<p>The next step is to create a web interface to our scientific hello world
program such that we can fill in the number <tt class="docutils literal"><span class="pre">r</span></tt> in a text field, click a
<em>Compute</em> button and get back a new web page with the output text
shown above: &#8220;Hello, World! sin(r)=s&#8221;.</p>
</div>
</div>
<div class="section" id="making-a-flask-application">
<h2>Making a Flask application<a class="headerlink" href="#making-a-flask-application" title="Permalink to this headline">¶</a></h2>
<p id="index-2">Not much code or configuration is needed to make a Flask application.
Actually one short file is enough. For this file to work you need to
install Flask and some corresponding packages. This is easiest
performed by</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; sudo pip install --upgrade Flask
Terminal&gt; sudo pip install --upgrade Flask-WTF
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">--upgrade</span></tt> option ensures that you upgrade to the latest version in
case you already have these packages.</p>
<div class="section" id="programming-the-flask-application-1">
<h3>Programming the Flask application  (1)<a class="headerlink" href="#programming-the-flask-application-1" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-user-interaction-1">
<h4>The user interaction  (1)<a class="headerlink" href="#the-user-interaction-1" title="Permalink to this headline">¶</a></h4>
<p>We want our input page to feature a text field where the user can
write the value of <tt class="docutils literal"><span class="pre">r</span></tt>, see Figure <a class="reference internal" href="#wf-hw1-flask-fig-input"><em>The input page</em></a>.
By clicking on the <em>equals</em> button
the corresponding <tt class="docutils literal"><span class="pre">s</span></tt> value is computed and written out the result page
seen in Figure <a class="reference internal" href="#wf-hw1-flask-fig-result"><em>The output page</em></a>.</p>
<div class="figure" id="wf-hw1-flask-fig-input">
<a class="reference internal image-reference" href="_images/hw1_flask_input.png"><img alt="_images/hw1_flask_input.png" src="_images/hw1_flask_input.png" style="width: 600px;" /></a>
<p class="caption"><em>The input page</em></p>
</div>
<div class="figure" id="wf-hw1-flask-fig-result">
<a class="reference internal image-reference" href="_images/hw1_flask_output.png"><img alt="_images/hw1_flask_output.png" src="_images/hw1_flask_output.png" style="width: 600px;" /></a>
<p class="caption"><em>The output page</em></p>
</div>
</div>
<div class="section" id="the-python-code">
<h4>The Python code<a class="headerlink" href="#the-python-code" title="Permalink to this headline">¶</a></h4>
<p>Flask does not require us to use the MVC pattern so there is actually
no need to split the original program into model, view, controller,
and compute files as already explained (but it will be
done later).  First we make a <tt class="docutils literal"><span class="pre">controller.py</span></tt> file where the view, the
model, and the controller parts appear within the same file.
The <tt class="docutils literal"><span class="pre">compute</span></tt> component is always in a separate file as
we like to encapsulate the computations completely from user
interfaces.</p>
<p id="index-3">The view that the user sees is determined by
HTML templates in a subdirectory <tt class="docutils literal"><span class="pre">templates</span></tt>, and consequently
we name the template files <tt class="docutils literal"><span class="pre">view*.html</span></tt>.
The model and other parts of the view concept are just parts of
the <tt class="docutils literal"><span class="pre">controller.py</span></tt> file. The complete file is short and explained
in detail below.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">validators</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c"># Model</span>
<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>

<span class="c"># View</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/hw1&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">data</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view_output.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view_input.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="dissection">
<h4>Dissection<a class="headerlink" href="#dissection" title="Permalink to this headline">¶</a></h4>
<p>The web application is the <tt class="docutils literal"><span class="pre">app</span></tt> object of class <tt class="docutils literal"><span class="pre">Flask</span></tt>, and initialized
as shown. The model is a special Flask class derived from <tt class="docutils literal"><span class="pre">Form</span></tt>
where the input variable in the app is listed as a
static class attribute and initialized
by a special form field object from the <tt class="docutils literal"><span class="pre">wtforms</span></tt> package.
Such form field objects correspond to HTML forms in the input page.
For the <tt class="docutils literal"><span class="pre">r</span></tt> variable we apply <tt class="docutils literal"><span class="pre">FloatField</span></tt> since it is a floating-point
variable. A default validator, here checking that the user supplies
a real number, is automatically included, but we add another validator,
<tt class="docutils literal"><span class="pre">InputRequired</span></tt>, to force the user to provide input before clicking on
the <em>equals</em> button.</p>
<p>The view part of this Python code consists of
a URL and a corresponding function to call when the URL is invoked.
The function name is here chosen to be <tt class="docutils literal"><span class="pre">index</span></tt> (inspired by the standard
<tt class="docutils literal"><span class="pre">index.html</span></tt> page that is the main page of a web app). The
decorator <tt class="docutils literal"><span class="pre">&#64;app.route('/hw1',</span> <span class="pre">...)</span></tt> maps the URL
<tt class="docutils literal"><span class="pre">http://127.0.0.1:5000/hw1</span></tt> to a call to <tt class="docutils literal"><span class="pre">index</span></tt>.
The <tt class="docutils literal"><span class="pre">methods</span></tt> argument must be as shown to allow the user to communicate
with the web page.</p>
<p id="index-4">The <tt class="docutils literal"><span class="pre">index</span></tt> function first makes a form object based on the data in
the model, here class <tt class="docutils literal"><span class="pre">InputForm</span></tt>. Then there are two possibilities:
either the user has provided data in the HTML form or the user is
to be offered an input form. In the former case, <tt class="docutils literal"><span class="pre">request.method</span></tt>
equals <tt class="docutils literal"><span class="pre">'POST'</span></tt> and we can extract the numerical value of <tt class="docutils literal"><span class="pre">r</span></tt>
from the <tt class="docutils literal"><span class="pre">form</span></tt> object, using <tt class="docutils literal"><span class="pre">form.r.data</span></tt>, call up our mathematical
computations, and make a web page with the result.
In the latter case, we make an input page as displayed in
Figure <a class="reference internal" href="#wf-hw1-flask-fig-input"><em>The input page</em></a>.</p>
</div>
<div class="section" id="the-template-files">
<span id="index-5"></span><h4>The template files<a class="headerlink" href="#the-template-files" title="Permalink to this headline">¶</a></h4>
<p>Making a web page with Flask is conveniently done by an HTML
template. Since the output page is simplest we display the
<tt class="docutils literal"><span class="pre">view_output.html</span></tt> template first:</p>
<div class="highlight-html"><div class="highlight"><pre>Hello, World! sin({{ form.r.data }})={{s}}.
</pre></div>
</div>
<p>Keyword arguments sent to <tt class="docutils literal"><span class="pre">render_template</span></tt> are available in the
HTML template. Here we have <tt class="docutils literal"><span class="pre">form</span></tt> and <tt class="docutils literal"><span class="pre">s</span></tt>.
With the <tt class="docutils literal"><span class="pre">form</span></tt> object we extract the value of
<tt class="docutils literal"><span class="pre">r</span></tt> in the HTML code by <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">form.r.data</span> <span class="pre">}}</span></tt>. Similarly, the value of <tt class="docutils literal"><span class="pre">s</span></tt>
is simply <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">s</span> <span class="pre">}}</span></tt>.</p>
<p>The HTML template for the input page is slightly more complicated
as we need to use an HTML form:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  Hello, World! The sine of {{ form.r }}
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">equals</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="testing-the-application">
<h4>Testing the application<a class="headerlink" href="#testing-the-application" title="Permalink to this headline">¶</a></h4>
<p>We collect the files associated with a Flask application (often called
just <em>app</em>) in a directory,
here called <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/hw1">hw1</a>.
All you have to do in order to run this web application is to find
this directory and run</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python controller.py
 * Running on http://127.0.0.1:5000/
 * Restarting with reloader
</pre></div>
</div>
<p>Open a new window or tab in your browser and type in the URL
<tt class="docutils literal"><span class="pre">http://127.0.0.1:5000/hw1</span></tt>.</p>
</div>
</div>
<div class="section" id="equipping-the-input-page-with-output-results-1">
<h3>Equipping the input page with output results  (1)<a class="headerlink" href="#equipping-the-input-page-with-output-results-1" title="Permalink to this headline">¶</a></h3>
<p>Our application made two distinct pages for grabbing input from the
user and presenting the result. It is often more natural to add
the result to the input page. This is particularly the case in the present
web application, which is a kind of calculator. Figure <a class="reference internal" href="#wf-hw2-flask-fig-result"><em>The modified result page</em></a> shows what the user sees after clicking the <em>equals</em> button.</p>
<div class="figure" id="wf-hw2-flask-fig-result">
<a class="reference internal image-reference" href="_images/hw2_flask_output.png"><img alt="_images/hw2_flask_output.png" src="_images/hw2_flask_output.png" style="width: 600px;" /></a>
<p class="caption"><em>The modified result page</em></p>
</div>
<p>To let the user stay within the same page, we create a new directory
<a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/hw2">hw2</a>
for this modified Flask app and copy the files from the previous
<tt class="docutils literal"><span class="pre">hw1</span></tt> directory.  The idea now is to make use of just one
template, in <tt class="docutils literal"><span class="pre">templates/view.html</span></tt>:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  Hello, World! The sine of
  {{( form.r )}}
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">equals</span><span class="nt">&gt;</span>
{% if s != None %}
{{s}}
{% endif %}
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>The form is identical to what we used in <tt class="docutils literal"><span class="pre">view_input.html</span></tt> in
the <tt class="docutils literal"><span class="pre">hw1</span></tt> directory, and the only
new thing is the output of <tt class="docutils literal"><span class="pre">s</span></tt> below the form.</p>
<p>The template language supports some programming with Python objects
inside <tt class="docutils literal"><span class="pre">{%</span></tt> and <tt class="docutils literal"><span class="pre">%}</span></tt> tags.
Specifically in this file, we can test on the value of <tt class="docutils literal"><span class="pre">s</span></tt>:
if it is <tt class="docutils literal"><span class="pre">None</span></tt>, we know that the computations are not performed and
<tt class="docutils literal"><span class="pre">s</span></tt> should not appear on the page, otherwise <tt class="docutils literal"><span class="pre">s</span></tt> holds the sine
value and we can write it out. Note that, contrary to plain Python,
the template language does not rely on indentation of blocks and
therefore needs an explicit end statement <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">endif</span> <span class="pre">%}</span></tt> to finish
the if-test.
The generated HTML code from this template file reads</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  Hello, World! The sine of
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;r&quot;</span> <span class="na">name=</span><span class="s">&quot;r&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;1.2&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">equals</span><span class="nt">&gt;</span>

0.932039085967

<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">index</span></tt> function of our modified application
needs adjustments since we use the same
template for the input and the output page:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># View</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/hw2&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">data</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
<p>It is seen that if the user has given data, <tt class="docutils literal"><span class="pre">s</span></tt> is a <tt class="docutils literal"><span class="pre">float</span></tt>, otherwise
<tt class="docutils literal"><span class="pre">s</span></tt> is <tt class="docutils literal"><span class="pre">None</span></tt>. You are encouraged to test the app by running</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python controller.py
</pre></div>
</div>
<p>and loading <tt class="docutils literal"><span class="pre">http://127.0.0.1:5000/hw2</span></tt> into your browser.
A nice little exercise is to control the formatting of the result <tt class="docutils literal"><span class="pre">s</span></tt>.
To this end, you can simply transform <tt class="docutils literal"><span class="pre">s</span></tt> to a string: <tt class="docutils literal"><span class="pre">s</span> <span class="pre">=</span> <span class="pre">'%.5f'</span> <span class="pre">%</span> <span class="pre">s</span></tt> before
sending it to <tt class="docutils literal"><span class="pre">render_template</span></tt>.</p>
</div>
<div class="section" id="splitting-the-app-into-model-view-and-controller-files">
<span id="wf-hw3-flask"></span><h3>Splitting the app into model, view, and controller files<a class="headerlink" href="#splitting-the-app-into-model-view-and-controller-files" title="Permalink to this headline">¶</a></h3>
<p id="index-6">In our previous two Flask apps we have had the view displayed for the
user in a separate template file, and the computations as always in
<tt class="docutils literal"><span class="pre">compute.py</span></tt>, but everything else was placed in one file <tt class="docutils literal"><span class="pre">controller.py</span></tt>.
For illustration of the MVC concept we
may split the <tt class="docutils literal"><span class="pre">controller.py</span></tt> into two files: <tt class="docutils literal"><span class="pre">model.py</span></tt> and
<tt class="docutils literal"><span class="pre">controller.py</span></tt>. The view is in <tt class="docutils literal"><span class="pre">templates/view.html</span></tt>.
These new files are located in a
directory
<a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/hw3">hw3_flask</a>
The contents
in the files reflect the splitting introduced in the original
scientific hello world program in the section <a class="reference internal" href="#wf-hw-mvc"><em>Application of the MVC pattern</em></a>.
The <tt class="docutils literal"><span class="pre">model.py</span></tt> file now consists of the input form class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">validators</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
</pre></div>
</div>
<p>The file <tt class="docutils literal"><span class="pre">templates/view.html</span></tt> is as before, while <tt class="docutils literal"><span class="pre">controller.py</span></tt> contains</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/hw3&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">data</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The statements are indentical to those in the <tt class="docutils literal"><span class="pre">hw2</span></tt> app, only
the organization of the statement in files differ.</p>
</div>
<div class="section" id="troubleshooting">
<h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h3>
<div class="section" id="address-already-in-use">
<span id="index-7"></span><h4>Address already in use<a class="headerlink" href="#address-already-in-use" title="Permalink to this headline">¶</a></h4>
<p>You can easily kill the Flask application and restart it, but sometimes
you will get an error that the address is already in use.
To recover from this problem, run the <tt class="docutils literal"><span class="pre">lsof</span></tt> program to see which program
that applies the 5000 port (Flask runs its server on <tt class="docutils literal"><span class="pre">http://127.0.0.1:5000</span></tt>,
which means that it uses the 5000 port). Find the PID of the program
that occupies the port and force abortion of that program:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; lsof -i :5000
COMMAND   PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
python  48824  hpl    3u  IPv4 1128848      0t0  TCP ...
Terminal&gt; kill -9 48824
</pre></div>
</div>
<p>You are now ready to restart a Flask application.</p>
</div>
</div>
</div>
<div class="section" id="making-a-django-application">
<h2>Making a Django application<a class="headerlink" href="#making-a-django-application" title="Permalink to this headline">¶</a></h2>
<p id="index-8">We recommend to
download and istall the latest official version of Django from
<a class="reference external" href="http://www.djangoproject.com/download/">http://www.djangoproject.com/download/</a>. Pack out the tarfile, go
to the directory, and run <tt class="docutils literal"><span class="pre">setup.py</span></tt>:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; tar xvzf Django-1.5-tar.gz
Terminal&gt; cd Django-1.5
Terminal&gt; sudo python setup.py install
</pre></div>
</div>
<p>The version in this example, 1.5, may be different at the time you
follow these instructions.</p>
<div class="section" id="setting-up-a-django-project">
<h3>Setting up a Django project<a class="headerlink" href="#setting-up-a-django-project" title="Permalink to this headline">¶</a></h3>
<p id="index-9">Django applies two concepts: <em>project</em> and <em>application</em> (or <em>app</em>).
The app is the program we want to run through a web interface. The
project is a Python package containing common settings and
configurations for a collection of apps. This means that before we can
make a Django app, we must to establish a Django project.</p>
<p>A Django project for managing a set of Django apps is
created by the command</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; django-admin.py startproject django_project
</pre></div>
</div>
<p>The result in this example
is a directory <tt class="docutils literal"><span class="pre">django_project</span></tt> whose content can be explored
by some <tt class="docutils literal"><span class="pre">ls</span></tt> and <tt class="docutils literal"><span class="pre">cd</span></tt> commands:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; ls django_project
manage.py django_project
Terminal&gt; cd django_project/django_project
Terminal&gt; ls
__init__.py settings.py urls.py wsgi.py
</pre></div>
</div>
<p>The meaning of the generated files is briefly listed below.</p>
<blockquote>
<div><ul class="simple">
<li>The outer <tt class="docutils literal"><span class="pre">django_project/</span></tt> directory is just a container for your project. Its name does not matter to Django.</li>
<li><tt class="docutils literal"><span class="pre">manage.py</span></tt> is a command-line utility that lets you interact with this Django project in various ways. You will typically run <tt class="docutils literal"><span class="pre">manage.py</span></tt> to launch a Django application.</li>
<li>The inner <tt class="docutils literal"><span class="pre">django_project/</span></tt> directory is a Python package for the Django project. Its name is used in import statements in Python code (e.g., <tt class="docutils literal"><span class="pre">import</span> <span class="pre">django_project.settings</span></tt>).</li>
<li><tt class="docutils literal"><span class="pre">django_project/__init__.py</span></tt> is an empty file that just tells Python that this directory should be considered a Python package.</li>
<li><tt class="docutils literal"><span class="pre">django_project/settings.py</span></tt> contains the settings and configurations for this Django project.</li>
<li><tt class="docutils literal"><span class="pre">django_project/urls.py</span></tt> maps URLs to specific functions and thereby defines that actions that various URLs imply.</li>
<li><tt class="docutils literal"><span class="pre">django_project/wsgi.py</span></tt> is not needed in our examples.</li>
</ul>
</div></blockquote>
<p>Django comes with a web server for developing and debugging applications.
The server is started by running</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python manage.py runserver
Validating models...

0 errors found
March 34, 201x - 01:09:24
Django version 1.5, using settings &#39;django_project.settings&#39;
Development server is running at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
</pre></div>
</div>
<p>The output from starting the server tells that the server runs on the
URL <tt class="docutils literal"><span class="pre">http://127.0.0.1:8000/</span></tt>.
Load this URL into your browser to see a welcome message from Django,
meaning that the server is working.</p>
<p>Despite the fact that our introductory
web applications do not need a database, you
have to register a database with any Django project. To this end,
open the <tt class="docutils literal"><span class="pre">django_project/settings.py</span></tt> file in a text editor,
locate the <tt class="docutils literal"><span class="pre">DATABASES</span></tt> dictionary and type in the following
code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">relative2absolute_path</span><span class="p">(</span><span class="n">relative_path</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the absolute path correspodning to relative_path.&quot;&quot;&quot;</span>
    <span class="n">dir_of_this_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dir_of_this_file</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">relative_path</span>

<span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
   <span class="s">&#39;default&#39;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s">&#39;django.db.backends.sqlite3&#39;</span><span class="p">,</span>
      <span class="s">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">relative2absolute_path</span><span class="p">(</span><span class="s">&#39;../database.db&#39;</span><span class="p">)</span>
   <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">settings.py</span></tt> file needs absolute paths to files, while it is
more convenient for us to specify relative paths. Therefore,
we made a function that figures out the absolute path to the <tt class="docutils literal"><span class="pre">settings.py</span></tt>
file and then combines this absolute path with the relative path.
The location and name of the database file can be chosen as desired.
Note that one should <em>not</em> use <tt class="docutils literal"><span class="pre">os.path.join</span></tt> to create paths as Django
always applies the forward slash between directories, also on Windows.</p>
</div>
<div class="section" id="setting-up-a-django-application">
<h3>Setting up a Django application<a class="headerlink" href="#setting-up-a-django-application" title="Permalink to this headline">¶</a></h3>
<p id="index-10">The next step is to create a Django app for our scientific hello
world program. We can place the app in any directory, but here we
utilize the following organization.
As neighbor to <tt class="docutils literal"><span class="pre">django_project</span></tt> we have
a directory <tt class="docutils literal"><span class="pre">apps</span></tt> containing our various scientific applications.
Under <tt class="docutils literal"><span class="pre">apps</span></tt> we create a directory <tt class="docutils literal"><span class="pre">django_apps</span></tt> with
our different versions of Django applications.
The directory <tt class="docutils literal"><span class="pre">py_apps</span></tt> contains the
original <tt class="docutils literal"><span class="pre">hw.py</span></tt> program in the subdirectory <tt class="docutils literal"><span class="pre">orig</span></tt>,
while split of this
program according to the MVC pattern appears in the <tt class="docutils literal"><span class="pre">mvc</span></tt> directory.</p>
<p>The directory <tt class="docutils literal"><span class="pre">django_apps/hw1</span></tt> is our first attempt to write
a Django-based web interface for the <tt class="docutils literal"><span class="pre">hw.py</span></tt> program.
The directory structure is laid out by</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; cd ..
Terminal&gt; mkdir apps
Terminal&gt; cd apps
Terminal&gt; mkdir py_apps
Terminal&gt; cd py
Terminal&gt; mkdir orig mvc
Terminal&gt; cd ../..
Terminal&gt; mkdir django_apps
Terminal&gt; cd django_apps
</pre></div>
</div>
<p>The file <tt class="docutils literal"><span class="pre">hw.py</span></tt> is moved to <tt class="docutils literal"><span class="pre">orig</span></tt> while <tt class="docutils literal"><span class="pre">mvc</span></tt> contains
the MVC refactored version with the files <tt class="docutils literal"><span class="pre">model.py</span></tt>, <tt class="docutils literal"><span class="pre">view.py</span></tt>, <tt class="docutils literal"><span class="pre">compute.py</span></tt>,
and <tt class="docutils literal"><span class="pre">controller.py</span></tt>.</p>
<p>The <tt class="docutils literal"><span class="pre">hw1</span></tt> directory, containing our first Django application, must be
made with</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python ../../django_project/manage.py startapp hw1
</pre></div>
</div>
<p>The command creates a directory <tt class="docutils literal"><span class="pre">hw1</span></tt> with four empty files:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; cd hw1
Terminal&gt; ls
__init__.py models.py tests.py views.py
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">__init__.py</span></tt> file will remain empty to just indicate that the
Django application is a Python package. The other files need to be
filled with the right content, which happens in the next section.</p>
<p>At this point,
we need to register some information about our application in the
<tt class="docutils literal"><span class="pre">django_project/settings.py</span></tt> and <tt class="docutils literal"><span class="pre">django_project/urls.py</span></tt> files.</p>
<p><strong>Step 1: Add the app.</strong>
Locate the <tt class="docutils literal"><span class="pre">INSTALLED_APPS</span></tt>
tuple in <tt class="docutils literal"><span class="pre">settings.py</span></tt> and add your Django application as a Python package:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="o">...</span>
    <span class="s">&#39;hw1&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Unfortunately, Django will not be able to find the package <tt class="docutils literal"><span class="pre">hw1</span></tt>
unless we register the parent directory in <tt class="docutils literal"><span class="pre">sys.path</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">relative2absolute_path</span><span class="p">(</span><span class="s">&#39;../../apps/django_apps&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Note here that the relative path is given with respect to the
location of the <tt class="docutils literal"><span class="pre">settings.py</span></tt> script.</p>
<p><strong>Step 2: Add a template directory.</strong>
Make a subdirectory <tt class="docutils literal"><span class="pre">templates</span></tt> under <tt class="docutils literal"><span class="pre">hw1</span></tt>,</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; mkdir templates
</pre></div>
</div>
<p>and add the absolute path of this directory to the <tt class="docutils literal"><span class="pre">TEMPLATE_DIRS</span></tt> tuple:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEMPLATE_DIRS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">relative2absolute_path</span><span class="p">(</span><span class="s">&#39;../../apps/django_apps/hw1/templates&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">templates</span></tt> directory will hold templates for the HTML code applied
in the web interfaces. The trailing comma is important as this is
a tuple with only one element.</p>
<p><strong>Step 3: Define the URL.</strong>
We need to connect the Django app with
an URL. Our app will be associated with a Python function <tt class="docutils literal"><span class="pre">index</span></tt>
in the <tt class="docutils literal"><span class="pre">views</span></tt> module within the <tt class="docutils literal"><span class="pre">hw1</span></tt> package.
Say we want the corresponding URL to
be named <tt class="docutils literal"><span class="pre">hw1</span></tt> relative to the server URL.
This information is registered in the <tt class="docutils literal"><span class="pre">django_project/urls.py</span></tt> file
by the syntax</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^hw1/&#39;</span><span class="p">,</span> <span class="s">&#39;django_apps.hw1.views.index&#39;</span><span class="p">),</span>
</pre></div>
</div>
<p>The first argument to the <tt class="docutils literal"><span class="pre">url</span></tt> function is a regular expression for
the URL and the second argument is the name of the function to call,
using Python&#8217;s syntax for a function <tt class="docutils literal"><span class="pre">index</span></tt> in a module <tt class="docutils literal"><span class="pre">views</span></tt> in
a package <tt class="docutils literal"><span class="pre">hw1</span></tt>.
The function name <tt class="docutils literal"><span class="pre">index</span></tt> resembles the <tt class="docutils literal"><span class="pre">index.html</span></tt> main page associated
with an URL, but any other name than <tt class="docutils literal"><span class="pre">index</span></tt> can be used.</p>
</div>
<div class="section" id="programming-the-django-application-1">
<h3>Programming the Django application  (1)<a class="headerlink" href="#programming-the-django-application-1" title="Permalink to this headline">¶</a></h3>
<p>The Django application is about filling the files <tt class="docutils literal"><span class="pre">views.py</span></tt> and <tt class="docutils literal"><span class="pre">models.py</span></tt>
with content. The mathematical computations are performed in <tt class="docutils literal"><span class="pre">compute.py</span></tt>
so we copy this file from the <tt class="docutils literal"><span class="pre">mvc</span></tt> directory to the <tt class="docutils literal"><span class="pre">hw1</span></tt> directory
for convenience (we could alternatively add <tt class="docutils literal"><span class="pre">../mvc</span></tt> to <tt class="docutils literal"><span class="pre">sys.path</span></tt> such that
<tt class="docutils literal"><span class="pre">import</span> <span class="pre">compute</span></tt> would work from the <tt class="docutils literal"><span class="pre">hw1</span></tt> directory).</p>
<div class="section" id="the-user-interaction-2">
<h4>The user interaction  (2)<a class="headerlink" href="#the-user-interaction-2" title="Permalink to this headline">¶</a></h4>
<p>The web application offers a text field where the user can
write the value of <tt class="docutils literal"><span class="pre">r</span></tt>, see Figure <a class="reference internal" href="#wf-hw1-django-fig-input"><em>The input page</em></a>.
After clicking on the <em>equals</em> button,
the mathematics is performed and a new page as
seen in Figure <a class="reference internal" href="#wf-hw1-django-fig-result"><em>The result page</em></a> appears.</p>
<div class="figure" id="wf-hw1-django-fig-input">
<a class="reference internal image-reference" href="_images/hw1_django_input.png"><img alt="_images/hw1_django_input.png" src="_images/hw1_django_input.png" style="width: 600px;" /></a>
<p class="caption"><em>The input page</em></p>
</div>
<div class="figure" id="wf-hw1-django-fig-result">
<a class="reference internal image-reference" href="_images/hw1_django_output.png"><img alt="_images/hw1_django_output.png" src="_images/hw1_django_output.png" style="width: 600px;" /></a>
<p class="caption"><em>The result page</em></p>
</div>
<span class="target" id="index-11"></span></div>
<div class="section" id="the-model-1">
<span id="index-12"></span><h4>The model  (1)<a class="headerlink" href="#the-model-1" title="Permalink to this headline">¶</a></h4>
<p>The <tt class="docutils literal"><span class="pre">models.py</span></tt> file contains the model, which consists
of the data we need in the application, stored in Django&#8217;s data types.
Our data consists of one number, called <tt class="docutils literal"><span class="pre">r</span></tt>, and <tt class="docutils literal"><span class="pre">models.py</span></tt> then
look like</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">ModelForm</span>

<span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Input</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">Input</span></tt> class lists variables representing data as static class
attributes. The <tt class="docutils literal"><span class="pre">django.db.models</span></tt> module contains various classes
for different types of data, here we use <tt class="docutils literal"><span class="pre">FloatField</span></tt> to represent
a floating-point number.
The <tt class="docutils literal"><span class="pre">InputForm</span></tt> class has a the shown generic form across applications
if we by convention apply the name <tt class="docutils literal"><span class="pre">Input</span></tt> for the class holding the data.</p>
<span class="target" id="index-13"></span></div>
<div class="section" id="the-view-1">
<span id="index-14"></span><h4>The view  (1)<a class="headerlink" href="#the-view-1" title="Permalink to this headline">¶</a></h4>
<p>The <tt class="docutils literal"><span class="pre">views.py</span></tt> file contains a function <tt class="docutils literal"><span class="pre">index</span></tt> which defines
the actions we want to perform when invoking
the URL ( here <tt class="docutils literal"><span class="pre">http://127.0.0.1:8000/hw1/</span></tt>).
In addition, <tt class="docutils literal"><span class="pre">views.py</span></tt> has the <tt class="docutils literal"><span class="pre">present_output</span></tt> function from
the <tt class="docutils literal"><span class="pre">view.py</span></tt> file in the <tt class="docutils literal"><span class="pre">mvc</span></tt> directory.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">InputForm</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">present_output</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;hw1.html&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">present_output</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;Hello, World! sin(</span><span class="si">%s</span><span class="s">)=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">index</span></tt> function deserves some explanation. It must take one
argument, usually called <tt class="docutils literal"><span class="pre">request</span></tt>. There are two modes in the function. Either
the user has provided input on the web page, which means that
<tt class="docutils literal"><span class="pre">request.method</span></tt> equals <tt class="docutils literal"><span class="pre">'POST'</span></tt>, or we show a new web page
with which the user is supposed to interact.</p>
</div>
<div class="section" id="making-the-input-page">
<span id="index-15"></span><h4>Making the input page<a class="headerlink" href="#making-the-input-page" title="Permalink to this headline">¶</a></h4>
<p>The input consists of a web form with
one field where we can fill in our <tt class="docutils literal"><span class="pre">r</span></tt> variable. This page
is realized by the two central statements</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Make info needed in the web form</span>
<span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">()</span>
<span class="c"># Make HTML code</span>
<span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;hw1.html&#39;</span><span class="p">,</span>
    <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">hw1.html</span></tt> file resides in the <tt class="docutils literal"><span class="pre">templates</span></tt> subdirectory and contains
a template for the HTML code:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>{% csrf_token %}
    Hello, World! The sine of {{ form.r }}
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;equals&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>This is a <em>template file</em> because it contains instructions like
<tt class="docutils literal"><span class="pre">{%</span> <span class="pre">csrf_token</span> <span class="pre">%}</span></tt> and variables like <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">form.r</span> <span class="pre">}}</span></tt>. Django will
replace the former by some appropriate HTML statements, while the
latter simply extracts the numerical value of the variable <tt class="docutils literal"><span class="pre">r</span></tt> in
our form (specified in the <tt class="docutils literal"><span class="pre">Input</span></tt> class in <tt class="docutils literal"><span class="pre">models.py</span></tt>).
Typically, this <tt class="docutils literal"><span class="pre">hw1.html</span></tt> file
results in the HTML code</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&#39;display:none&#39;</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&#39;hidden&#39;</span> <span class="na">name=</span><span class="s">&#39;csrfmiddlewaretoken&#39;</span>
<span class="na">value=</span><span class="s">&#39;oPWMuuy1gLlXm9GvUZINv49eVUYnux5Q&#39;</span> <span class="nt">/&gt;&lt;/div&gt;</span>
    Hello, World! The sine of <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">name=</span><span class="s">&quot;r&quot;</span> <span class="na">id=</span><span class="s">&quot;id_r&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;equals&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="making-the-results-page">
<h4>Making the results page<a class="headerlink" href="#making-the-results-page" title="Permalink to this headline">¶</a></h4>
<p>When then user has filled in a value in the text field on the input
page, the <tt class="docutils literal"><span class="pre">index</span></tt> function is called again and <tt class="docutils literal"><span class="pre">request.method</span></tt> equals
<tt class="docutils literal"><span class="pre">'POST'</span></tt>. A new form object is made, this time with user info (<tt class="docutils literal"><span class="pre">request.POST</span></tt>).
We can check that the form is valid and if so, proceed with
computations followed by presenting the results in a
new web page (see Figure <a class="reference internal" href="#wf-hw1-django-fig-result"><em>The result page</em></a>):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">present_output</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">present_output</span><span class="p">(</span><span class="n">form</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;Hello, World! sin(</span><span class="si">%s</span><span class="s">)=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
<p>The numerical value of <tt class="docutils literal"><span class="pre">r</span></tt> as given by the user is available as <tt class="docutils literal"><span class="pre">form.r</span></tt>.
Instead of using a template for the output page, which is natural to
do in more advanced cases, we here illustrate the possibility to
send raw HTML to the output page by returning an <tt class="docutils literal"><span class="pre">HttpResponse</span></tt>
object initialized by a string containing the desired HTML code.</p>
<p>Launch this application by filling in the address <tt class="docutils literal"><span class="pre">http://127.0.0.1:8000/hw1/</span></tt>
in your web browser. Make sure the Django development server is running,
and if not, restart it by</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python ../../../django_project/manage.py runserver
</pre></div>
</div>
<p>Fill
in some number on the input page and view the output.
To show how easy it is to change the application, invoke the <tt class="docutils literal"><span class="pre">views.py</span></tt>
file in an editor and add some color to the output HTML code from
the <tt class="docutils literal"><span class="pre">present_output</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre>    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">&lt;font color=&#39;blue&#39;&gt;Hello&lt;/font&gt;, World!</span>
<span class="s">sin(</span><span class="si">%s</span><span class="s">)=</span><span class="si">%s</span><span class="s"></span>
<span class="s">&quot;&quot;&quot;</span><span class="o">%</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
<p>Go back to the input page, provide a new number, and observe how
the &#8220;Hello&#8221; word now has a blue color.</p>
</div>
</div>
<div class="section" id="equipping-the-input-page-with-output-results-2">
<h3>Equipping the input page with output results  (2)<a class="headerlink" href="#equipping-the-input-page-with-output-results-2" title="Permalink to this headline">¶</a></h3>
<p>Instead of making a separate output page with the result, we can
simply add the sine value to the input page. This makes the user
feel that she interacts with the same page, as when operating a calculator.
The output page should then look as shown in Figure <a class="reference internal" href="#wf-hw2-django-fig-result"><em>The modified result page</em></a>.</p>
<div class="figure" id="wf-hw2-django-fig-result">
<a class="reference internal image-reference" href="_images/hw2_django_output.png"><img alt="_images/hw2_django_output.png" src="_images/hw2_django_output.png" style="width: 600px;" /></a>
<p class="caption"><em>The modified result page</em></p>
</div>
<p>We need to make a new Django application, now called
<a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/django_apps/hw2">hw2</a>.
Instead of running the standard
<tt class="docutils literal"><span class="pre">manage.py</span> <span class="pre">startapp</span> <span class="pre">hw2</span></tt> command,
we can simply copy the <tt class="docutils literal"><span class="pre">hw1</span></tt>
directory to <tt class="docutils literal"><span class="pre">hw2</span></tt>. We need, of course, to add information about this
new application in <tt class="docutils literal"><span class="pre">settings.py</span></tt> and <tt class="docutils literal"><span class="pre">urls.py</span></tt>.
In the former file we must have</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">TEMPLATE_DIRS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">relative2absolute_path</span><span class="p">(</span><span class="s">&#39;../../apps/django_apps/hw1/templates&#39;</span><span class="p">),</span>
    <span class="n">relative2absolute_path</span><span class="p">(</span><span class="s">&#39;../../apps/django_apps/hw2/templates&#39;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;django.contrib.auth&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.contenttypes&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sessions&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.sites&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.messages&#39;</span><span class="p">,</span>
    <span class="s">&#39;django.contrib.staticfiles&#39;</span><span class="p">,</span>
    <span class="c"># Uncomment the next line to enable the admin:</span>
    <span class="c"># &#39;django.contrib.admin&#39;,</span>
    <span class="c"># Uncomment the next line to enable admin documentation:</span>
    <span class="c"># &#39;django.contrib.admindocs&#39;,</span>
    <span class="s">&#39;hw1&#39;</span><span class="p">,</span>
    <span class="s">&#39;hw2&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In <tt class="docutils literal"><span class="pre">urls.py</span></tt> we add the URL <tt class="docutils literal"><span class="pre">hw2</span></tt> which is to call our <tt class="docutils literal"><span class="pre">index</span></tt> function
in the <tt class="docutils literal"><span class="pre">views.py</span></tt> file of the <tt class="docutils literal"><span class="pre">hw2</span></tt> app:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^hw1/&#39;</span><span class="p">,</span> <span class="s">&#39;django_apps.hw1.views.index&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^hw2/&#39;</span><span class="p">,</span> <span class="s">&#39;django_apps.hw2.views.index&#39;</span><span class="p">),</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">views.py</span></tt> file changes a bit since we shall generate almost the same
web page on input and output. This makes the <tt class="docutils literal"><span class="pre">present_output</span></tt> function
unnatural, and everything is done within the <tt class="docutils literal"><span class="pre">index</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># initial value of result</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">r</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;hw2.html&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
             <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%.5f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">s</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;&#39;</span>
             <span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p>Note that the output variable <tt class="docutils literal"><span class="pre">s</span></tt> is computed within the <tt class="docutils literal"><span class="pre">index</span></tt>
function and defaults to <tt class="docutils literal"><span class="pre">None</span></tt>. The template file <tt class="docutils literal"><span class="pre">hw2.html</span></tt>
looks like</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>{% csrf_token %}
    Hello, World! The sine of {{ form.r }}
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;equals&quot;</span> <span class="nt">/&gt;</span>
{% if s != &#39;&#39; %}
{{ s }}
{% endif %}
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>The difference from <tt class="docutils literal"><span class="pre">hw1.html</span></tt> is that we right after the <em>equals</em>
button write out the value of <tt class="docutils literal"><span class="pre">s</span></tt>. However, we make a test that
the value is only written if it is computed, here recognized by
being a non-empty string. The <tt class="docutils literal"><span class="pre">s</span></tt> in the template file
is substituted by the value of the object
corresponding to the key <tt class="docutils literal"><span class="pre">'s'</span></tt> in the
dictionary we pass to the <tt class="docutils literal"><span class="pre">render_to_response</span></tt>. As seen,
we pass a string where <tt class="docutils literal"><span class="pre">s</span></tt> is formatted with five digits if <tt class="docutils literal"><span class="pre">s</span></tt>
is a float, i.e., if <tt class="docutils literal"><span class="pre">s</span></tt> is computed. Otherwise, <tt class="docutils literal"><span class="pre">s</span></tt> has the
default value <tt class="docutils literal"><span class="pre">None</span></tt> and we send an empty string to the template.
The template language allows tests using Python syntax, but the
if-block must be explicitly ended by <tt class="docutils literal"><span class="pre">{%</span> <span class="pre">endif</span> <span class="pre">%}</span></tt>.</p>
</div>
</div>
<div class="section" id="handling-multiple-input-variables-in-flask">
<span id="wf-vib-flask"></span><h2>Handling multiple input variables in Flask<a class="headerlink" href="#handling-multiple-input-variables-in-flask" title="Permalink to this headline">¶</a></h2>
<p>The scientific hello world example shows how to work with one input
variable and one output variable. We can easily derive an extensible
recipe for apps with a collection of input variables and some
associated HTML code as result. Multiple input variables are listed
in the <tt class="docutils literal"><span class="pre">InputForm</span></tt> class using different types for different forms
(text field, float field, integer field, check box field for boolean
values, etc.).  The value of these variables will be available in a
<tt class="docutils literal"><span class="pre">form</span></tt> object for computation. It is then a matter of setting
up a template code where the various variables if the <tt class="docutils literal"><span class="pre">form</span></tt> object
are formatted in HTML code as desired.</p>
<p>Our sample web application
addresses the task of plotting the function <span class="math">\(u(t)=Ae^{-bt}\sin (wt)\)</span> for
<span class="math">\(t\in [0,T]\)</span>. The web application must have fields for the numbers <span class="math">\(A\)</span>,
<span class="math">\(b\)</span>, <span class="math">\(w\)</span>, and <span class="math">\(T\)</span>, and a <em>Compute</em> button, as shown in Figure
<a class="reference internal" href="#wf-vib1-flask-fig-input"><em>The input page</em></a>. Filling in values, say <span class="math">\(0.1\)</span> for <span class="math">\(b\)</span> and
<span class="math">\(20\)</span> for <span class="math">\(T\)</span>, results in what we see in Figure <a class="reference internal" href="#wf-vib1-flask-fig-result"><em>The result page</em></a>,
i.e., a plot of <span class="math">\(u(t)\)</span> is added after the input fields and the <em>Compute</em>
button.</p>
<div class="figure" id="wf-vib1-flask-fig-input">
<a class="reference internal image-reference" href="_images/vib1_flask_input.png"><img alt="_images/vib1_flask_input.png" src="_images/vib1_flask_input.png" style="width: 500px;" /></a>
<p class="caption"><em>The input page</em></p>
</div>
<div class="figure" id="wf-vib1-flask-fig-result">
<a class="reference internal image-reference" href="_images/vib1_flask_output.png"><img alt="_images/vib1_flask_output.png" src="_images/vib1_flask_output.png" style="width: 700px;" /></a>
<p class="caption"><em>The result page</em></p>
</div>
<p>We shall make a series of different versions of this app:</p>
<ol class="arabic simple">
<li><tt class="docutils literal"><span class="pre">vib1</span></tt> for the basic set-up and illustration of tailoring the HTML code.</li>
<li><tt class="docutils literal"><span class="pre">vib2</span></tt> for custom validation of input, governed by the programmer,
and inlined graphics in the HTML code.</li>
<li><tt class="docutils literal"><span class="pre">gen</span></tt> for automatic generation of the Flask app (!).</li>
<li><tt class="docutils literal"><span class="pre">login</span></tt> for storing computed results in user accounts.</li>
</ol>
<div class="section" id="programming-the-flask-application-2">
<span id="wf-vib1-flask-app"></span><h3>Programming the Flask application  (2)<a class="headerlink" href="#programming-the-flask-application-2" title="Permalink to this headline">¶</a></h3>
<p>The forthcoming text explains the necessary steps to realize a
Flask app that behaves as depicted in Figures <a class="reference internal" href="#wf-vib1-flask-fig-input"><em>The input page</em></a>
and <a class="reference internal" href="#wf-vib1-flask-fig-result"><em>The result page</em></a>. We start with the
<tt class="docutils literal"><span class="pre">compute.py</span></tt> module since it contains only the computation of <span class="math">\(u(t)\)</span>
and the making of the plot, without any interaction with Flask.</p>
<p>The files associated with this app are found in the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib1">vib1</a> directory.</p>
<div class="section" id="the-compute-part-1">
<h4>The compute part  (1)<a class="headerlink" href="#the-compute-part-1" title="Permalink to this headline">¶</a></h4>
<p>More specifically, inside <tt class="docutils literal"><span class="pre">compute.py</span></tt>, we have a function for
evaluating <span class="math">\(u(t)\)</span> and a <tt class="docutils literal"><span class="pre">compute</span></tt> function for making the plot. The
return value of the latter is the name of the plot file, which should
get a unique name every time the <tt class="docutils literal"><span class="pre">compute</span></tt> function is called such
that the browser cannot reuse an already cached image when displaying
the plot. Flask
applications must have all extra files (CSS, images, etc.) in a
subdirectory <tt class="docutils literal"><span class="pre">static</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">linspace</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span>

<span class="k">def</span> <span class="nf">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  <span class="c"># needed to avoid adding curves in plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;A=</span><span class="si">%g</span><span class="s">, b=</span><span class="si">%g</span><span class="s">, w=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Remove old plot files</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;*.png&#39;</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c"># Use time since Jan 1, 1970 in filename in order make</span>
    <span class="c"># a unique filename that the browser has not chached</span>
    <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plotfile</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">compute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition-avoid-file-writing admonition" id="index-16">
<p class="first admonition-title">Avoid file writing</p>
<p class="last">It is in general not a good idea to write plots to file or let a
web app write to file. If this app is deployed at some web site and
multiple users are running the app, the <tt class="docutils literal"><span class="pre">os.remove</span></tt> statements may remove
plots created by all other users. However, the app is useful as a
graphical user interface run locally on a machine.
Later, we shall avoid writing plot files and instead
store plots in strings and embed the strings
in the <tt class="docutils literal"><span class="pre">img</span></tt> tag in the HTML code.</p>
</div>
<p>We organize the model, view, and controller as three separate
files, as illustrated in
the section <a class="reference internal" href="#wf-hw3-flask"><em>Splitting the app into model, view, and controller files</em></a>. This more complicated app involves
more code and especially the model will soon be handy to isolate in its own
file.</p>
</div>
<div class="section" id="the-model-2">
<h4>The model  (2)<a class="headerlink" href="#the-model-2" title="Permalink to this headline">¶</a></h4>
<p>Our first version of <tt class="docutils literal"><span class="pre">model.py</span></tt> reads</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">validators</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;amplitude (m)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;damping factor (kg/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;frequency (1/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;time interval (s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
</pre></div>
</div>
<p>As seen, the field classes can take a <tt class="docutils literal"><span class="pre">label</span></tt> argument for a longer
description, here also including the units in which the variable is
measured. It is also possible to add a <tt class="docutils literal"><span class="pre">description</span></tt> argument with
some help message. Furthermore, we include a <tt class="docutils literal"><span class="pre">default</span></tt> value, which
will appear in the text field such that the user does not need to
fill in all values.</p>
</div>
<div class="section" id="the-view-2">
<span id="index-17"></span><h4>The view  (2)<a class="headerlink" href="#the-view-2" title="Permalink to this headline">¶</a></h4>
<p>The view component will of course make use of templates, and we shall experiment
with different templates. Therefore, we allow a command-line argument
to this Flask app for choosing which template we want. The rest of
the <tt class="docutils literal"><span class="pre">controller.py</span></tt> file follows much the same set up as for the scientific
hello world app:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">InputForm</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;view_plain&#39;</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">if</span> <span class="n">template_name</span> <span class="o">==</span> <span class="s">&#39;view_flask_bootstrap&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
    <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/vib1&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span> <span class="o">+</span> <span class="s">&#39;.html&#39;</span><span class="p">,</span>
                           <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-html-template-1">
<h4>The HTML template  (1)<a class="headerlink" href="#the-html-template-1" title="Permalink to this headline">¶</a></h4>
<p>The details governing how the web page really looks like lie in the
template file. Since we have several fields and want them nicely
align in a tabular fashion, we place the field name, text areas,
and labels inside an HTML table in our first attempt to write a
template, <tt class="docutils literal"><span class="pre">view_plain.html</span></tt>:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;&lt;td&gt;</span>{{ field }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Compute</span><span class="nt">&gt;&lt;/form&gt;&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>Observe how easy it is to iterate over the <tt class="docutils literal"><span class="pre">form</span></tt> object and grab data
for each field: <tt class="docutils literal"><span class="pre">field.name</span></tt> is the name of the variable in the
<tt class="docutils literal"><span class="pre">InputForm</span></tt> class, <tt class="docutils literal"><span class="pre">field.label</span></tt> is the full name with units as given
through the <tt class="docutils literal"><span class="pre">label</span></tt> keyword when constructing the field object, and
writing the field object itself generates the text area for
input (i.e., the HTML input form). The control statements we can
use in the template are part of the <a class="reference external" href="http://jinja.pocoo.org/docs/">Jinja2</a>
templating language. For now, the if-test, for-loop and
output of values (<tt class="docutils literal"><span class="pre">{{</span> <span class="pre">object</span> <span class="pre">}}</span></tt>) are enough to generate the HTML
code we want.</p>
<p>Recall that the objects we need in the template, like <tt class="docutils literal"><span class="pre">result</span></tt> and <tt class="docutils literal"><span class="pre">form</span></tt>
in the present case, are transferred to the template via keyword
arguments to the <tt class="docutils literal"><span class="pre">render_template</span></tt> function. We can easily pass on
any object in our application to the template. Debugging of the template
is done by viewing the HTML source of the web page in the browser.</p>
<p>You are encouraged to go to the <tt class="docutils literal"><span class="pre">vib</span></tt> directory,
run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span></tt>, and load</p>
<div class="highlight-text"><div class="highlight"><pre>`http://127.0.0.1:5000/vib1`
</pre></div>
</div>
<p>into your web browser for testing.</p>
</div>
</div>
<div class="section" id="implementing-error-checking-in-the-template">
<h3>Implementing error checking in the template<a class="headerlink" href="#implementing-error-checking-in-the-template" title="Permalink to this headline">¶</a></h3>
<p id="index-18">What happens if the user gives wrong input, for instance the letters <tt class="docutils literal"><span class="pre">asd</span></tt>
instead of a number? Actually nothing! The <tt class="docutils literal"><span class="pre">FloatField</span></tt> object
checks that the input is compatible with a real number in the
<tt class="docutils literal"><span class="pre">form.validate()</span></tt> call, but returns just <tt class="docutils literal"><span class="pre">False</span></tt> if this is not
the case. Looking at the code in <tt class="docutils literal"><span class="pre">controller.py</span></tt>,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<p>we realize that wrong input implies <tt class="docutils literal"><span class="pre">result</span> <span class="pre">=</span> <span class="pre">None</span></tt> and no computations
and no plot! Fortunately, each field object gets an attribute <tt class="docutils literal"><span class="pre">error</span></tt>
with information on errors that occur on input. We can write out
this information on the web page, as exemplified in the template
<tt class="docutils literal"><span class="pre">view_errcheck.html</span></tt>:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;&lt;td&gt;</span>{{ field(size=12) }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
    {% if field.errors %}
      <span class="nt">&lt;td&gt;&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
      {% for error in field.errors %}
        <span class="nt">&lt;li&gt;&lt;font</span> <span class="na">color=</span><span class="s">&quot;red&quot;</span><span class="nt">&gt;</span>{{ error }}<span class="nt">&lt;/font&gt;&lt;/li&gt;</span>
      {% endfor %}<span class="nt">&lt;/ul&gt;&lt;/td&gt;</span>
    {% endif %}
    <span class="nt">&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Compute</span><span class="nt">&gt;&lt;/form&gt;&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>Two things are worth noticing here:</p>
<ol class="arabic simple">
<li>We can control the width of the text field where the
user writes the numbers, here set to 12 characters.</li>
<li>We can make an extra column in the HTML table with a list
of possible errors for each field object.</li>
</ol>
<p>Let us test the error handling of the <tt class="docutils literal"><span class="pre">A</span></tt> field by
writing <tt class="docutils literal"><span class="pre">asd</span></tt> instead of a number. This input
triggers an error, whose message is written in red to the right of the label,
see Figure <a class="reference internal" href="#wf-vib1-flask-fig-error1"><em>Error message because of wrong input</em></a>.</p>
<div class="figure" id="wf-vib1-flask-fig-error1">
<a class="reference internal image-reference" href="_images/vib1_flask_error1.png"><img alt="_images/vib1_flask_error1.png" src="_images/vib1_flask_error1.png" style="width: 500px;" /></a>
<p class="caption"><em>Error message because of wrong input</em></p>
</div>
<p>It is possible to use the additional HTML5 fields for input in a Flask
context. Instead of explaining how here, we recommend to use the
<a class="reference external" href="https://github.com/hplgit/parampool">Parampool</a>
package to automatically generate Flask files with HTML5 fields.</p>
</div>
<div class="section" id="using-style-sheets">
<h3>Using style sheets<a class="headerlink" href="#using-style-sheets" title="Permalink to this headline">¶</a></h3>
<p id="index-19">Web developers make heavy use of CSS style sheets to control the look
and feel of web pages. Templates can utilize style sheets as any other
standard HTML code. Here is a very simple example where we introduce
a class <tt class="docutils literal"><span class="pre">name</span></tt> for the HTML table&#8217;s column with the field name and set the
foreground color of the text in this column to blue.
The style sheet is called <tt class="docutils literal"><span class="pre">basic.css</span></tt> and <em>must</em> reside in the
<tt class="docutils literal"><span class="pre">static</span></tt> subdirectory of the Flask application directory. The content
of <tt class="docutils literal"><span class="pre">basic.css</span></tt> is just the line</p>
<div class="highlight-text"><div class="highlight"><pre>td.name { color: blue; }
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">view_css.html</span></tt> file using this style sheet features a <tt class="docutils literal"><span class="pre">link</span></tt> tag
to the style sheet in the HTML header, and the column containing
the field name has
the HTML tag <tt class="docutils literal"><span class="pre">&lt;td</span> <span class="pre">class=&quot;name&quot;&gt;</span></tt> to trigger the specification in
the style sheet:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;static/basic.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field(size=12) }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
</pre></div>
</div>
<p>Just run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span> <span class="pre">view_css</span></tt> to see that the names
of the variables to set in the web page are blue.</p>
</div>
<div class="section" id="using-latex-mathematics">
<h3>Using LaTeX mathematics<a class="headerlink" href="#using-latex-mathematics" title="Permalink to this headline">¶</a></h3>
<p id="index-20">Scientific applications frequently have many input data that are
defined through mathematics and where the typesetting on the
web page should be as close as possible to the typesetting where
the mathematics is documented. In the present example we would like
to typeset <span class="math">\(A\)</span>, <span class="math">\(b\)</span>, <span class="math">\(w\)</span>, and <span class="math">\(T\)</span> with italic font as done
in LaTeX. Fortunately, native LaTeX typesetting is available in
HTML through the tool <a class="reference external" href="http://www.mathjax.org/">MathJax</a>.
Our template <tt class="docutils literal"><span class="pre">view_tex.html</span></tt> enables MathJax. Formulas are written
with standard LaTeX inside <tt class="docutils literal"><span class="pre">\(</span></tt> and <tt class="docutils literal"><span class="pre">\)</span></tt>, while equations are surrounded
by <tt class="docutils literal"><span class="pre">$$</span></tt>. Here we use formulas only:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
 <span class="na">src=</span><span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>\( {{ field.name }} \)<span class="nt">&lt;/td&gt;&lt;td&gt;</span>{{ field(size=12) }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
</pre></div>
</div>
<p>Figure <a class="reference internal" href="#wf-vib1-flask-fig-latex"><em>LaTeX typesetting of mathematical symbols</em></a> displays how the
LaTeX rendering looks like in the browser.</p>
<div class="figure" id="wf-vib1-flask-fig-latex">
<a class="reference internal image-reference" href="_images/vib1_flask_latex.png"><img alt="_images/vib1_flask_latex.png" src="_images/vib1_flask_latex.png" style="width: 650px;" /></a>
<p class="caption"><em>LaTeX typesetting of mathematical symbols</em></p>
</div>
</div>
<div class="section" id="rearranging-the-elements-in-the-html-template">
<h3>Rearranging the elements in the HTML template<a class="headerlink" href="#rearranging-the-elements-in-the-html-template" title="Permalink to this headline">¶</a></h3>
<p>Now we want to place the plot to the right of the input forms in
the web page, see Figure <a class="reference internal" href="#wf-vib1-flask-fig-sidebyside"><em>New design with input and output side by side</em></a>. This can
be accomplished by having an outer table with two rows. The first
row contains the table with the input forms in the first column and
the plot in the second column, while the second row features the
<em>Compute</em> button in the first column.</p>
<div class="figure" id="wf-vib1-flask-fig-sidebyside">
<a class="reference internal image-reference" href="_images/vib1_flask_table2.png"><img alt="_images/vib1_flask_table2.png" src="_images/vib1_flask_table2.png" style="width: 700px;" /></a>
<p class="caption"><em>New design with input and output side by side</em></p>
</div>
<p>The enabling template file is <tt class="docutils literal"><span class="pre">view_table.html</span></tt>:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
 <span class="na">src=</span><span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span> <span class="c">&lt;!-- table with forms to the left and plot to the right --&gt;</span>
<span class="nt">&lt;tr&gt;&lt;td&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>\( {{ field.name }} \)<span class="nt">&lt;/td&gt;&lt;td&gt;</span>{{ field(size=12) }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
    {% if field.errors %}
      <span class="nt">&lt;td&gt;&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
      {% for error in field.errors %}
        <span class="nt">&lt;li&gt;&lt;font</span> <span class="na">color=</span><span class="s">&quot;red&quot;</span><span class="nt">&gt;</span>{{ error }}<span class="nt">&lt;/font&gt;&lt;/li&gt;</span>
      {% endfor %}<span class="nt">&lt;/ul&gt;&lt;/td&gt;</span>
    {% endif %}
    <span class="nt">&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/td&gt;</span>

<span class="nt">&lt;td&gt;</span>
<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td&gt;&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Compute</span><span class="nt">&gt;&lt;/p&gt;&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="bootstrap-html-style">
<h3>Bootstrap HTML style<a class="headerlink" href="#bootstrap-html-style" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="http://getbootstrap.com/">Bootstrap</a> framework for creating web pages
has been very popular in recent years, both because of the design and
the automatic support for responsive pages on all sorts of devices.
Bootstrap can easily be used in combination with Flask. The template file
<tt class="docutils literal"><span class="pre">view_bootstrap.html</span></tt> is identical to the former <tt class="docutils literal"><span class="pre">view_table.html</span></tt>,
except that we load the Bootstrap CSS file and include in comments
how to add the typical navigation bar found in many Bootstrap-based
web pages. Moreover, we use the grid layout functionality of Bootstrap
to control the placement of elements (name, input field, label,
and error message) in the input form.</p>
<p>The template looks like</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>


<span class="nt">&lt;link</span> <span class="na">href=</span>
<span class="s">&quot;http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css&quot;</span>
<span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span>
<span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>
<span class="c">&lt;!--</span>
<span class="c">&lt;nav class=&quot;navbar navbar-default&quot; role=&quot;navigation&quot;&gt;</span>
<span class="c">&lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;bs-example-navbar-collapse-1&quot;&gt;</span>
<span class="c">    &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span>
<span class="c">       {% for text, url in some_sequence %}</span>
<span class="c">       &lt;li&gt;&lt;a href=&quot;/{{url}}&quot;&gt;{{ text }}&lt;/a&gt;&lt;/li&gt;</span>
<span class="c">       {% endfor %}</span>
<span class="c">       &lt;/ul&gt;</span>
<span class="c">&lt;/div&gt;</span>
<span class="c">&lt;/nav&gt;</span>
<span class="c">--&gt;</span>

<span class="nt">&lt;h2&gt;</span>Damped sine wave<span class="nt">&lt;/h2&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;navbar-form navbar-top&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-group&quot;</span><span class="nt">&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;input-group&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;col-xs-1 control-label&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;input-group-addon&quot;</span><span class="nt">&gt;</span> \( {{ field.name }} \) <span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-xs-2&quot;</span><span class="nt">&gt;</span>
      {{ field(class_=&quot;form-control&quot;) }}
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-xs-3&quot;</span><span class="nt">&gt;</span>
        {{ field.label }}
      <span class="nt">&lt;/div&gt;</span>
      {% if field.errors %}
        {% for error in field.errors %}
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-xs-3&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;color: red;&quot;</span><span class="nt">&gt;</span>{{ error }}<span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        {% endfor %}
      {% endif %}
     <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  {% endfor %}
<span class="nt">&lt;br/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Compute&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-default&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The input fields and fonts now get the typical Bootstrap look and feel:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/vib1_flask_bootstrap.png"><img alt="_images/vib1_flask_bootstrap.png" src="_images/vib1_flask_bootstrap.png" style="width: 800px;" /></a>
</div>
<p>The only special feature in this template is the need to pass a CSS
class <tt class="docutils literal"><span class="pre">form-control</span></tt> to the field object in the part that defines
the input field. We also use the standard <tt class="docutils literal"><span class="pre">input-group-addon</span></tt> style
in the name part of the Bootstrap form. A heading <em>Damped sine wave</em> was
added to demonstrate the Bootstrap fonts.</p>
<p>It is easy to switch to other Bootstrap styles, e.g., those in the
&#8220;Bootswatch family&#8221;: &#8220;<a class="reference external" href="http:bootswatch.com">http:bootswatch.com</a>&#8221;:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">href=</span>
<span class="s">&quot;http://netdna.bootstrapcdn.com/bootswatch/3.1.1/X/bootstrap.min.css&quot;</span>
<span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">X</span></tt> can be <tt class="docutils literal"><span class="pre">journal</span></tt>, <tt class="docutils literal"><span class="pre">cosmo</span></tt>, <tt class="docutils literal"><span class="pre">flatly</span></tt>, and other legal
Bootswatch styles. The journal style looks like this:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/vib1_flask_bootswatch_journal.png"><img alt="_images/vib1_flask_bootswatch_journal.png" src="_images/vib1_flask_bootswatch_journal.png" style="width: 800px;" /></a>
</div>
<p>While <tt class="docutils literal"><span class="pre">view_bootstrap.html</span></tt> makes use of plain Bootstrap HTML code, there is
also a higher-level framework, called <a class="reference external" href="http://pythonhosted.org/Flask-Bootstrap/">Flask-Bootstrap</a> that combines Flask and Bootstrap. Installation of
this extension is done by <tt class="docutils literal"><span class="pre">sudo</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">flask-bootstrap</span></tt>.</p>
<p>After <tt class="docutils literal"><span class="pre">app</span> <span class="pre">=</span> <span class="pre">Flask(__name__)</span></tt> we need to do</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>The template employs new keywords <tt class="docutils literal"><span class="pre">extends</span></tt> and <tt class="docutils literal"><span class="pre">block</span></tt>:</p>
<div class="highlight-html"><div class="highlight"><pre>{% extends &quot;bootstrap/base.html&quot; %}

{% block styles %}
{{super()}}
<span class="nt">&lt;style&gt;</span>
    <span class="nc">.appsize</span> <span class="p">{</span> <span class="k">width</span><span class="o">:</span> <span class="m">800px</span> <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span>
<span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>
{% endblock %}

<span class="c">&lt;!--</span>
<span class="c">{% block navbar %}</span>
<span class="c">&lt;nav class=&quot;navbar navbar-default&quot; role=&quot;navigation&quot;&gt;</span>
<span class="c">&lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;bs-example-navbar-collapse-1&quot;&gt;</span>
<span class="c">    &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span>
<span class="c">       {% for f in some_sequence %}</span>
<span class="c">       &lt;li&gt;&lt;a href=&quot;/{{f}}&quot;&gt;{{f}}&lt;/a&gt;&lt;/li&gt;</span>
<span class="c">       {% endfor %}</span>
<span class="c">       &lt;/ul&gt;</span>
<span class="c">&lt;/div&gt;</span>
<span class="c">&lt;/nav&gt;</span>
<span class="c">{% endblock %}</span>
<span class="c">--&gt;</span>

{% block content %}

<span class="nt">&lt;h2&gt;</span>Damped sine wave<span class="nt">&lt;/h2&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;navbar-form navbar-top&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-group&quot;</span><span class="nt">&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;input-group appsize&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;col-sm-1 control-label&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;input-group-addon&quot;</span><span class="nt">&gt;</span> \( {{ field.name }} \) <span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-sm-4&quot;</span><span class="nt">&gt;</span>
      {{ field(class_=&quot;form-control&quot;) }}
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-sm-4&quot;</span><span class="nt">&gt;</span>
        {{ field.label }}
      <span class="nt">&lt;/div&gt;</span>
      {% if field.errors %}
        {% for error in field.errors %}
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-sm-3&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;color: red;&quot;</span><span class="nt">&gt;</span>{{ error }}<span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        {% endfor %}
      {% endif %}
     <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  {% endfor %}
<span class="nt">&lt;br/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Compute&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-default&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/html&gt;</span>
{% endblock %}
</pre></div>
</div>
<p>It is important to have the MathJax script declaration and all styles within
<tt class="docutils literal"><span class="pre">{%</span> <span class="pre">block</span> <span class="pre">styles</span> <span class="pre">%}</span></tt>.</p>
<p>It seems easier to apply plain Bootstrap HTML code than the
functionality in the Flask-Bootstrap layer.</p>
</div>
<div class="section" id="custom-validation-1">
<span id="wf-vib1-flask-validation"></span><h3>Custom validation  (1)<a class="headerlink" href="#custom-validation-1" title="Permalink to this headline">¶</a></h3>
<p id="index-21">The <tt class="docutils literal"><span class="pre">FloatField</span></tt> objects can check that the input is compatible with
a number, but what if we want to control that <span class="math">\(A&gt;0\)</span>, <span class="math">\(b&gt;0\)</span>, and
<span class="math">\(T\)</span> is not greater than 30 periods (otherwise the plot gets cluttered)?
We can write functions for checking appropriate conditions and
supply the function to the list of validator functions in the call to
the <tt class="docutils literal"><span class="pre">FloatField</span></tt> constructor or other field constructors. The extra
code is a part of the <tt class="docutils literal"><span class="pre">model.py</span></tt> and the presented extensions appear
in the directory <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib2">vib2</a>.</p>
<div class="section" id="using-flask-validators">
<h4>Using Flask validators<a class="headerlink" href="#using-flask-validators" title="Permalink to this headline">¶</a></h4>
<p>The simplest approach to validation is to use existing functionality
in the web framework. Checking that <span class="math">\(A&gt;0\)</span> can be done by
the <tt class="docutils literal"><span class="pre">NumberRange</span></tt> validator which checks that the value is inside
a prescribed interval:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">validators</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;amplitude (m)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">NumberRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1E+20</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="section" id="tailored-validation">
<h4>Tailored validation<a class="headerlink" href="#tailored-validation" title="Permalink to this headline">¶</a></h4>
<p>We can also easily provide our own more tailored validators.
As an example, let us explain how we can check that <span class="math">\(T\)</span> is less than 30 periods.
One period is <span class="math">\(2\pi /w\)</span> so we need to check if <span class="math">\(T&gt; 30\cdot 2\pi/w\)</span>
and raise an exception in that case.
A validation function takes two arguments: the whole <tt class="docutils literal"><span class="pre">form</span></tt> and the
specific <tt class="docutils literal"><span class="pre">field</span></tt> to test:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_T</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Form validation: failure if T &gt; 30 periods.&quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span>
    <span class="n">period</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">w</span>
    <span class="k">if</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="o">*</span><span class="n">period</span><span class="p">:</span>
        <span class="n">num_periods</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">period</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">validators</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">&#39;Cannot plot as much as </span><span class="si">%d</span><span class="s"> periods! T&lt;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">num_periods</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="n">period</span><span class="p">))</span>
</pre></div>
</div>
<p>The appropriate exception is of type <tt class="docutils literal"><span class="pre">validators.ValidationError</span></tt>.
Observe that through <tt class="docutils literal"><span class="pre">form</span></tt> we have in fact access to all the input
data so we can easily use the value of <span class="math">\(w\)</span> when checking the validity
of the value of <span class="math">\(T\)</span>. The <tt class="docutils literal"><span class="pre">check_T</span></tt> function is easy to
add to the list of validator functions in the call to the <tt class="docutils literal"><span class="pre">FloatField</span></tt>
constructor for <tt class="docutils literal"><span class="pre">T</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;time interval&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">pi</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">(),</span> <span class="n">check_T</span><span class="p">])</span>
</pre></div>
</div>
<p>The validator
objects are tested one by one as they appear in the list, and if
one fails, the others are not invoked.
We therefore add <tt class="docutils literal"><span class="pre">check_T</span></tt> after the check of input such that we know we
have a value for all data when we run the computations and test
in <tt class="docutils literal"><span class="pre">check_T</span></tt>.</p>
</div>
<div class="section" id="tailored-validation-of-intervals">
<h4>Tailored validation of intervals<a class="headerlink" href="#tailored-validation-of-intervals" title="Permalink to this headline">¶</a></h4>
<p>Although there is already a <tt class="docutils literal"><span class="pre">NumberRange</span></tt> validator for checking
whether a value is inside an interval, we can write our own
version with some improved functionality for open intervals where
the maximum or minimum value can be infinite.
The infinite value can on input be represented by <tt class="docutils literal"><span class="pre">None</span></tt>.
A general such function may take the form</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_interval</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For validation: failure if value is outside an interval.&quot;&quot;&quot;</span>
    <span class="n">failure</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">min_value</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">max_value</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">validators</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s"> not in [</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
             <span class="s">&#39;-infty&#39;</span> <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_value</span><span class="p">),</span>
             <span class="s">&#39;infty&#39;</span>  <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_value</span><span class="p">)))</span>
</pre></div>
</div>
<p id="index-22">The problem is that <tt class="docutils literal"><span class="pre">check_interval</span></tt> takes four arguments, not only
the <tt class="docutils literal"><span class="pre">form</span></tt> and <tt class="docutils literal"><span class="pre">field</span></tt> arguments that a validator function in the
Flask framework can accept.
The way out of this difficulty is to use a Python tool <tt class="docutils literal"><span class="pre">functools.partial</span></tt>
which allows us to call a function with some of the arguments set beforehand.
Here, we want to create a new function that calls <tt class="docutils literal"><span class="pre">check_interval</span></tt>
with some prescribed values of <tt class="docutils literal"><span class="pre">min_value</span></tt> and <tt class="docutils literal"><span class="pre">max_value</span></tt>.
This function looks like it does not have these arguments, only
<tt class="docutils literal"><span class="pre">form</span></tt> and <tt class="docutils literal"><span class="pre">field</span></tt>. The following function produces this function, which we
can use as a valid Flask validator function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">interval</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">check_interval</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span>
</pre></div>
</div>
<p>We can now in any field constructor just add
<tt class="docutils literal"><span class="pre">interval(a,</span> <span class="pre">b)</span></tt> as a validator function, here checking that <span class="math">\(b\in [0,\infty)\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;damping factor (kg/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">(),</span> <span class="n">interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">None</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="section" id="demo">
<h4>Demo<a class="headerlink" href="#demo" title="Permalink to this headline">¶</a></h4>
<p>Let us test our tailored error checking. Run <tt class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span></tt>
in the <tt class="docutils literal"><span class="pre">vib2</span></tt> directory and fill in <span class="math">\(-1.0\)</span> in the <span class="math">\(b\)</span> field.
Pressing <em>Compute</em> invokes our <tt class="docutils literal"><span class="pre">interval(0,None)</span></tt> function, which
is nothing but a call to <tt class="docutils literal"><span class="pre">check_interval</span></tt> with the
arguments <tt class="docutils literal"><span class="pre">field</span></tt>, <tt class="docutils literal"><span class="pre">form</span></tt>, <tt class="docutils literal"><span class="pre">0</span></tt>, and <tt class="docutils literal"><span class="pre">None</span></tt>.
Inside this function,
the test <tt class="docutils literal"><span class="pre">if</span> <span class="pre">field.data</span> <span class="pre">&lt;</span> <span class="pre">min_value</span></tt> becomes true, <tt class="docutils literal"><span class="pre">failure</span></tt>
is set, and the exception is raised. The message in the exception
is available in the <tt class="docutils literal"><span class="pre">field.errors</span></tt> attribute so our template
will write it out in red, see Figure <a class="reference internal" href="#wf-vib2-flask-fig-error1"><em>Triggering of a user-defined error check</em></a>.
The template used in <tt class="docutils literal"><span class="pre">vib2</span></tt> is basically the same as <tt class="docutils literal"><span class="pre">view_tex.html</span></tt>
in <tt class="docutils literal"><span class="pre">vib1</span></tt>, i.e., it feaures LaTeX mathematics and checking of
<tt class="docutils literal"><span class="pre">field.errors</span></tt>.</p>
<div class="figure" id="wf-vib2-flask-fig-error1">
<a class="reference internal image-reference" href="_images/vib2_flask_error1.png"><img alt="_images/vib2_flask_error1.png" src="_images/vib2_flask_error1.png" style="width: 500px;" /></a>
<p class="caption"><em>Triggering of a user-defined error check</em></p>
</div>
<p>Finally, we mention a detail in the <tt class="docutils literal"><span class="pre">controller.py</span></tt> file in the <tt class="docutils literal"><span class="pre">vib2</span></tt>
app: instead of sending <tt class="docutils literal"><span class="pre">form.var.data</span></tt> to the <tt class="docutils literal"><span class="pre">compute</span></tt> function we
may automatically generate a set of local variables such that the
application of data from the web page, here in the <tt class="docutils literal"><span class="pre">compute</span></tt> call, looks nicer:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="c"># Make local variable (name field.name)</span>
            <span class="k">exec</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The idea is just to run <tt class="docutils literal"><span class="pre">exec</span></tt> on a declaration of a local variable
with name <tt class="docutils literal"><span class="pre">field.name</span></tt> for each field in the form. This trick is often
neat if web variables are buried in objects (<tt class="docutils literal"><span class="pre">form.T.data</span></tt>) and you want these
variables in your
code to look like they do in mathematical writing (<tt class="docutils literal"><span class="pre">T</span></tt> for <span class="math">\(T\)</span>).</p>
</div>
</div>
<div class="section" id="avoiding-plot-files">
<span id="wf-vib2-flask-nofiles"></span><h3>Avoiding plot files<a class="headerlink" href="#avoiding-plot-files" title="Permalink to this headline">¶</a></h3>
<p>Files with plots are easy to deal with as long as they are in the
<tt class="docutils literal"><span class="pre">static</span></tt> subdirectory of the Flask application directory. However,
as already pointed out, the previous <tt class="docutils literal"><span class="pre">vib1</span></tt> app, which writes plot
files, is not suited for multiple simultaneous users since every
user will destroy <em>all</em> existing plot files before making a new
one. Therefore, we need a robust solution for multiple users of
the app.</p>
<p>The idea is to not write plot files, but instead return the plot
as a string and embed that string directly in the HTML code.
This is relatively straightforward with Matplotlib
and Python. The relevant code is found in the <tt class="docutils literal"><span class="pre">compute.py</span></tt> file
of the <tt class="docutils literal"><span class="pre">vib2</span></tt> app.</p>
<span class="target" id="index-23"></span><span class="target" id="index-24"></span><span class="target" id="index-25"></span><span class="target" id="index-26"></span><div class="section" id="png-plots">
<span id="index-27"></span><h4>PNG plots<a class="headerlink" href="#png-plots" title="Permalink to this headline">¶</a></h4>
<p>Python has the <tt class="docutils literal"><span class="pre">io.StringIO</span></tt> object for writing text to a
string buffer with the same syntax as used for writing text to
files. For binary streams, such as PNG files, one can use
a similar object, <tt class="docutils literal"><span class="pre">io.BytesIO</span></tt>, to hold the stream (i.e., the plot file)
in memory. The idea is to let Matplotlib write to
a <tt class="docutils literal"><span class="pre">io.BytesIO</span></tt> object and afterwards extract the
series of bytes in the plot file from this object and embed it in
the HTML file directly. This approach avoids storing plots in separate
files, at the cost of bigger HTML files.</p>
<p>The first step is to let Matplotlib write the PNG data to
the <tt class="docutils literal"><span class="pre">BytesIO</span></tt> buffer:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plot</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="c"># run plt.plot, plt.title, etc.</span>
<span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
<span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># rewind to beginning of file</span>
<span class="n">figdata_png</span> <span class="o">=</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>  <span class="c"># extract string (stream of bytes)</span>
</pre></div>
</div>
<p>Before the PNG data can be embedded in HTML we need to convert the
data to base64 format:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">base64</span>
<span class="n">figdata_png</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">figdata_png</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can embed the PNG data in HTML by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;data:image/png;base64,PLOTSTR&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s">&quot;500&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">PLOTSTR</span></tt> is the content of the string <tt class="docutils literal"><span class="pre">figdata_png</span></tt>.</p>
<p>The complete <tt class="docutils literal"><span class="pre">compute.py</span></tt> function takes the form</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  <span class="c"># needed to avoid adding curves in plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;A=</span><span class="si">%g</span><span class="s">, b=</span><span class="si">%g</span><span class="s">, w=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>

    <span class="c"># Make Matplotlib write to BytesIO file object and grab</span>
    <span class="c"># return the object&#39;s string</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># rewind to beginning of file</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="n">figdata_png</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">figdata_png</span>
</pre></div>
</div>
<p>The relevant syntax in an HTML template is</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ results }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>
<p>if <tt class="docutils literal"><span class="pre">results</span></tt> holds the returned object from the <tt class="docutils literal"><span class="pre">compute</span></tt> function above.</p>
</div>
<div class="section" id="svg-plots">
<span id="index-28"></span><h4>SVG plots<a class="headerlink" href="#svg-plots" title="Permalink to this headline">¶</a></h4>
<p>Inline figures in HTML, instead of using files, are most often realized
by XML code with the figure data in SVG format.
Plot strings in the SVG format are created very similarly to the PNG
example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;svg&#39;</span><span class="p">)</span>
<span class="n">figdata_svg</span> <span class="o">=</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">figdata_svg</span></tt> string contains XML code text can almost
be directly embedded in
HTML5. However, the beginning of the text contains information before
the <tt class="docutils literal"><span class="pre">svg</span></tt> tag that we want to remove:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
  &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Created with matplotlib (http://matplotlib.sourceforge.net/) --&gt;
&lt;svg height=&quot;441pt&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 585 441&quot; ...
</pre></div>
</div>
<p>The removal is done with a little string manipulation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">figdata_svg</span> <span class="o">=</span> <span class="s">&#39;&lt;svg&#39;</span> <span class="o">+</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;svg&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Now, <tt class="docutils literal"><span class="pre">figdata_svg</span></tt> can be directly inserted in HTML code without
any surrounding tags (because it is perfectly valid HTML code in itself).</p>
<p>The SVG code generated by Matplotlib may contain UTF-8 characters
so it is necessary to make a unicode string out of the text:
<tt class="docutils literal"><span class="pre">unicode(figdata_svg,</span> <span class="pre">'utf-8')</span></tt>, otherwise the HTML template will
lead to an encoding exception.</p>
<p>We have made an alternative compute function <tt class="docutils literal"><span class="pre">compute_png_svg</span></tt>
that returns both a PNG and an SVG plot:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">compute_png_svg</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;svg&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">figdata_svg</span> <span class="o">=</span> <span class="s">&#39;&lt;svg&#39;</span> <span class="o">+</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;svg&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">figdata_svg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">figdata_svg</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">figdata_png</span><span class="p">,</span> <span class="n">figdata_svg</span>
</pre></div>
</div>
<p id="index-29">The relevant syntax for inserting an SVG plot in the HTML template is now</p>
<div class="highlight-html"><div class="highlight"><pre>{{ result[1]|safe }}
</pre></div>
</div>
<p>The use of <tt class="docutils literal"><span class="pre">safe</span></tt> is essential here.</p>
<div class="admonition-important-use-safe-for-verbatim-html-code admonition">
<p class="first admonition-title">Important: use <tt class="docutils literal"><span class="pre">safe</span></tt> for verbatim HTML code</p>
<p class="last">Special HTML characters like <tt class="docutils literal"><span class="pre">&lt;</span></tt>, <tt class="docutils literal"><span class="pre">&gt;</span></tt>,
<tt class="docutils literal"><span class="pre">&amp;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;</span></tt>, and <tt class="docutils literal"><span class="pre">'</span></tt> are escaped in a template string like <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">str</span> <span class="pre">}}</span></tt>
(i.e., <tt class="docutils literal"><span class="pre">&amp;</span></tt> is replaced by <tt class="docutils literal"><span class="pre">&amp;amp;</span></tt> <cite>&lt;</cite> is replaced by <tt class="docutils literal"><span class="pre">&amp;lt;</span></tt>, etc.).
We need to avoid this manipulation of the string content
because <tt class="docutils literal"><span class="pre">result[1]</span></tt> contains
XML code where the mentioned characters are essential part of the syntax.
Writing <tt class="docutils literal"><span class="pre">{{str|safe}}</span></tt> ensures that the contents of the string <tt class="docutils literal"><span class="pre">str</span></tt>
are not altered before being embedded in the HTML text.</p>
</div>
<p>An alternative template, <tt class="docutils literal"><span class="pre">view_svg.html</span></tt> applies the SVG plot instead
of the PNG plot. We use the command-line argument <tt class="docutils literal"><span class="pre">svg</span></tt> for indicating
that we want an SVG instead of a PNG plot:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># SVG or PNG plot?</span>
<span class="n">svg</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;svg&#39;</span><span class="p">:</span>
        <span class="n">svg</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">if</span> <span class="n">svg</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute_png_svg</span> <span class="k">as</span> <span class="n">compute</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s">&#39;view_svg.html&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s">&#39;view.html&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="autogenerating-the-code">
<span id="wf-autogen-flask"></span><h3>Autogenerating the code<a class="headerlink" href="#autogenerating-the-code" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-30"></span><span class="target" id="index-31"></span><p id="index-32">We shall now present generic <tt class="docutils literal"><span class="pre">model.py</span></tt> and <tt class="docutils literal"><span class="pre">controller.py</span></tt>
files that work with <em>any</em> <tt class="docutils literal"><span class="pre">compute</span></tt> function (!). This example will
demonstrate some advanced, powerful features of Python. The source code
is found in the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/gen">gen</a>
directory.</p>
<div class="section" id="inspecting-function-signatures">
<h4>Inspecting function signatures<a class="headerlink" href="#inspecting-function-signatures" title="Permalink to this headline">¶</a></h4>
<p>The basic idea is that the Python module <tt class="docutils literal"><span class="pre">inspect</span></tt> can be used to
retrieve the names of the arguments and the default values of
keyword arguments of <em>any</em> given <tt class="docutils literal"><span class="pre">compute</span></tt> function. Say we have some</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">mycompute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]):</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Running</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">defaults</span>  <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span>
</pre></div>
</div>
<p>leads to</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">arg_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;x_range&#39;</span><span class="p">]</span>
<span class="n">defaults</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<p>We have all the argument names in <tt class="docutils literal"><span class="pre">arg_names</span></tt> and
<tt class="docutils literal"><span class="pre">defaults[i]</span></tt> is the default value of keyword argument
<tt class="docutils literal"><span class="pre">arg_names[j]</span></tt>, where <tt class="docutils literal"><span class="pre">j</span> <span class="pre">=</span> <span class="pre">len(arg_names)</span> <span class="pre">-</span> <span class="pre">len(defaults)</span> <span class="pre">+</span> <span class="pre">i</span></tt>.</p>
</div>
<div class="section" id="generating-the-model">
<h4>Generating the model<a class="headerlink" href="#generating-the-model" title="Permalink to this headline">¶</a></h4>
<p>Knowing the name <tt class="docutils literal"><span class="pre">name</span></tt> of some argument in the <tt class="docutils literal"><span class="pre">compute</span></tt>
function, we can make the corresponding class attribute
in the <tt class="docutils literal"><span class="pre">InputForm</span></tt> class by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">FloatForm</span><span class="p">())</span>
</pre></div>
</div>
<p>For name equal to <tt class="docutils literal"><span class="pre">'A'</span></tt> this is the same as hardcoding</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">FloatForm</span><span class="p">()</span>
</pre></div>
</div>
<p>Assuming that all arguments in <tt class="docutils literal"><span class="pre">compute</span></tt> are floats, we could
do</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">:</span>
    <span class="k">pass</span>  <span class="c"># Empty class</span>

<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">FloatForm</span><span class="p">())</span>
</pre></div>
</div>
<p>However, we can do better than this: for
keyword arguments the type of the default value can be used to
select the appropriate form class. The complete <tt class="docutils literal"><span class="pre">model.py</span></tt> file
then goes as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example on generic model.py file which inspects the arguments</span>
<span class="sd">of the compute function and automatically generates a relevant</span>
<span class="sd">InputForm class.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">wtforms</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute_gamma</span> <span class="k">as</span> <span class="n">compute</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">defaults</span>  <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">wtforms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c"># Augment defaults with None elements for the positional</span>
<span class="c"># arguments</span>
<span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg_names</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
<span class="c"># Map type of default to right form field</span>
<span class="n">type2form</span> <span class="o">=</span> <span class="p">{</span><span class="nb">type</span><span class="p">(</span><span class="mf">1.0</span><span class="p">):</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">FloatField</span><span class="p">,</span>
             <span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>   <span class="n">wtforms</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">,</span>
             <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>  <span class="n">wtforms</span><span class="o">.</span><span class="n">TextField</span><span class="p">,</span>
             <span class="p">}</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arg_names</span><span class="p">,</span> <span class="n">defaults</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
            <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">type2form</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type2form</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)](</span>
                <span class="n">default</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;argument </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> not supported&#39;</span> <span class="o">%</span>
                            <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">InputForm</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
<p>(The <tt class="docutils literal"><span class="pre">compute_gamma</span></tt> function imported from <tt class="docutils literal"><span class="pre">compute</span></tt> is the
only application-specific statement in this code and will be explained later.)</p>
</div>
<div class="section" id="generating-the-view">
<h4>Generating the view<a class="headerlink" href="#generating-the-view" title="Permalink to this headline">¶</a></h4>
<p>The call to <tt class="docutils literal"><span class="pre">compute</span></tt> in the <tt class="docutils literal"><span class="pre">controller.py</span></tt> file must also be expressed
in a general way such that the call handles any type and number of
parameters. This can be done in two ways, using either positional
or keyword arguments.</p>
<p>The technique with positional arguments
is explained first. It consists of collecting all parameters in
a list or tuple, called <tt class="docutils literal"><span class="pre">args</span></tt>, and then calling <tt class="docutils literal"><span class="pre">compute(*args)</span></tt>
(which is equivalent to <tt class="docutils literal"><span class="pre">compute(args[0],</span> <span class="pre">args[1],</span> <span class="pre">...,</span> <span class="pre">args[n])</span></tt>
if <tt class="docutils literal"><span class="pre">n</span></tt> is <tt class="docutils literal"><span class="pre">len(args)-1</span></tt>). The elements of <tt class="docutils literal"><span class="pre">args</span></tt> are the values of the
form variables. We know the name of a form variable as a string
<tt class="docutils literal"><span class="pre">name</span></tt> (from <tt class="docutils literal"><span class="pre">arg_names</span></tt>), and if <tt class="docutils literal"><span class="pre">form</span></tt> is the form object,
the construction <tt class="docutils literal"><span class="pre">getattr(form,</span> <span class="pre">name).data</span></tt> extracts the value
that the user provided (<tt class="docutils literal"><span class="pre">getattr(obj,</span> <span class="pre">attr)</span></tt> gets the attribute, with name
available as a string in <tt class="docutils literal"><span class="pre">attr</span></tt>, in the object <tt class="docutils literal"><span class="pre">obj</span></tt>).
For exampe, if <tt class="docutils literal"><span class="pre">name</span></tt> is <tt class="docutils literal"><span class="pre">'A'</span></tt>, <tt class="docutils literal"><span class="pre">getattr(form,</span> <span class="pre">name).data</span></tt> is the same as
<tt class="docutils literal"><span class="pre">form.A.data</span></tt>.
Collecting all form variables, placing them in a list,
and calling <tt class="docutils literal"><span class="pre">compute</span></tt> are done with</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Our <tt class="docutils literal"><span class="pre">InputForm</span></tt> class guarantees that all arguments in <tt class="docutils literal"><span class="pre">compute</span></tt>
are present in the form, but to be absolutely safe we can
test if <tt class="docutils literal"><span class="pre">name</span></tt> is present in the <tt class="docutils literal"><span class="pre">form</span></tt> object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
</pre></div>
</div>
<p>A potential problem with the <tt class="docutils literal"><span class="pre">args</span></tt> list is that the values might
be in wrong order. It appears, fortunately, that the order we
assign attributes to the form class is preserved when iterating over
the form. Nevertheless, using keyword arguments instead of positional
arguments provides a completely safe solution to calling <tt class="docutils literal"><span class="pre">compute</span></tt>
with the correct arguments. Keyword arguments are placed in a
dictionary <tt class="docutils literal"><span class="pre">kwargs</span></tt> and <tt class="docutils literal"><span class="pre">compute</span></tt> is called as <tt class="docutils literal"><span class="pre">compute(**kwargs)</span></tt>.
The generic solution is</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span>
          <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)}</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">compute(**kwargs)</span></tt> call is equivalent to <tt class="docutils literal"><span class="pre">compute(A=1,</span> <span class="pre">b=3,</span> <span class="pre">w=0.5)</span></tt>
in case <tt class="docutils literal"><span class="pre">kwargs</span> <span class="pre">=</span> <span class="pre">{'w'=0.5,</span> <span class="pre">'A':1,</span> <span class="pre">'b':3}</span></tt> (recall that the order of
the keys in a Python dictionary is undetermined).</p>
</div>
<div class="section" id="generating-the-template">
<h4>Generating the template<a class="headerlink" href="#generating-the-template" title="Permalink to this headline">¶</a></h4>
<p>It remains to generate the right HTML template. The HTML code depends
on what the returned <tt class="docutils literal"><span class="pre">result</span></tt> object from <tt class="docutils literal"><span class="pre">compute</span></tt> contains. Only a
human who has read the <tt class="docutils literal"><span class="pre">compute</span></tt> code knows the details of the returned
result. Therefore, we leave it to a human to provide the part
of the HTML template that renders the result. The file <tt class="docutils literal"><span class="pre">templates/view_results.html</span></tt> contains this human-provided code, while <tt class="docutils literal"><span class="pre">templates/view.html</span></tt>
is a completely generic template for the forms:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;</span> <span class="nt">&lt;td&gt;</span>{{ field }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{% if field.errors %}
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
      {% for error in field.errors %}
        <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
      {% endfor %}<span class="nt">&lt;/ul&gt;</span>
    {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Compute</span><span class="nt">&gt;&lt;/form&gt;&lt;/p&gt;</span>

{% if result != None %}
{{ result|safe }}
{% endif %}
</pre></div>
</div>
<p>At the end of this code, an HTML text <tt class="docutils literal"><span class="pre">result</span></tt> (string) is to be
inserted.  This text is typically generated by calling Flask&#8217;s
<tt class="docutils literal"><span class="pre">render_template</span></tt> function, which uses <tt class="docutils literal"><span class="pre">templates/view_results.html</span></tt>
to turn the return object <tt class="docutils literal"><span class="pre">result</span></tt> from the compute function into the
desired HTML code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view_results.html&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="c"># result is now rendered HTML text</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A perhaps simpler alternative would be to have a generic
<tt class="docutils literal"><span class="pre">view_forms.html</span></tt> file and a user-specific
<tt class="docutils literal"><span class="pre">view_results.html</span></tt> and explicitly combining them into a new
file. This requires file writing by the app, which one normally
wants to avoid. Especially if the web app gets multiple users,
the file writing may lead to corrupt files.</p>
</div>
<p>The complete, generic form of the <tt class="docutils literal"><span class="pre">index</span></tt> function becomes</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                  <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="c"># result must be transformed to HTML and inserted as a</span>
        <span class="c"># string in the generic view.html file</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view_results.html&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="application">
<h4>Application<a class="headerlink" href="#application" title="Permalink to this headline">¶</a></h4>
<p>Let us apply the files above to plot the gamma probability density function</p>
<div class="math">
\[g(x; a, h, A) = \frac{|h|}{\Gamma(a)A}\left(\frac{x}{A}\right)^{ah-1}
e^{-\left(\frac{x}{A}\right)^h},\]</div>
<p>and its cumulative density</p>
<div class="math">
\[G(x; a, h, A) = \int_0^x g(\tau; a, h, A)d\tau,\]</div>
<p>computed by numerically the Trapezoidal rule, for instance.
We also want to compute and display
the mean value <span class="math">\(A\Gamma(a + 1/h)/\Gamma(a)\)</span> and
standard deviation</p>
<div class="math">
\[\sigma = \frac{A}{\Gamma(a)}\sqrt{\Gamma(a + 2/h)\Gamma(a) - \Gamma(a+1/h)^2}.\]</div>
<p>Here, <span class="math">\(\Gamma(a)\)</span> is the gamma function, which can be computed
by <tt class="docutils literal"><span class="pre">math.gamma(a)</span></tt> in Python.
Below is a <tt class="docutils literal"><span class="pre">compute.py</span></tt> file with the
relevant implementations of <span class="math">\(g(x;a,h,A)\)</span> (<tt class="docutils literal"><span class="pre">gamma_density</span></tt>),
<span class="math">\(G(x; a, h, A)\)</span> (<tt class="docutils literal"><span class="pre">gamma_cumulative</span></tt>), and a function <tt class="docutils literal"><span class="pre">compute_gamma</span></tt> for
making a plot of <span class="math">\(g\)</span> og <span class="math">\(G\)</span> for <span class="math">\(x\in [0,7\sigma]\)</span>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="c"># http://en.wikipedia.org/wiki/Gamma_distribution</span>
    <span class="n">xA</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xA</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xA</span><span class="o">**</span><span class="n">h</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gamma_cumulative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="c"># Integrate gamma_density using the Trapezoidal rule.</span>
    <span class="c"># Assume x is array.</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">compute_gamma</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return plot and mean/st.dev. value of the gamma density.&quot;&quot;&quot;</span>
    <span class="n">gah</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">h</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">gah</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">stdev</span> <span class="o">=</span> <span class="n">A</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">/</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">gah</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="o">*</span><span class="n">stdev</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  <span class="c"># needed to avoid adding curves in plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;a=</span><span class="si">%g</span><span class="s">, h=</span><span class="si">%g</span><span class="s">, A=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="c"># Make Matplotlib write to BytesIO file object and grab</span>
    <span class="c"># return the object&#39;s string</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># rewind to beginning of file</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="n">figdata_density_png</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;svg&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">figdata_density_svg</span> <span class="o">=</span> <span class="s">&#39;&lt;svg&#39;</span> <span class="o">+</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;svg&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">figdata_density_svg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">figdata_density_svg</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">gamma_cumulative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">figdata_cumulative_png</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;svg&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">figdata_cumulative_svg</span> <span class="o">=</span> <span class="s">&#39;&lt;svg&#39;</span> <span class="o">+</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;svg&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">figdata_cumulative_svg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">figdata_cumulative_svg</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">figdata_density_png</span><span class="p">,</span> <span class="n">figdata_cumulative_png</span><span class="p">,</span> \
           <span class="n">figdata_density_svg</span><span class="p">,</span> <span class="n">figdata_cumulative_svg</span><span class="p">,</span> \
           <span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">mean</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">stdev</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">compute_gamma</span></tt> function returns a tuple of six values.
We want output as displayed in Figure <a class="reference internal" href="#wf-gen-flask-fig-gamma"><em>Design of a web page illustrating the gamma probability functions</em></a>.</p>
<div class="figure" id="wf-gen-flask-fig-gamma">
<a class="reference internal image-reference" href="_images/gen_flask_gamma.png"><img alt="_images/gen_flask_gamma.png" src="_images/gen_flask_gamma.png" style="width: 700px;" /></a>
<p class="caption"><em>Design of a web page illustrating the gamma probability functions</em></p>
</div>
<p>The design is realized in the file <tt class="docutils literal"><span class="pre">view_results.html</span></tt> shown below.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;table&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ result[0] }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/td&gt;&lt;td&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ result[1] }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td&gt;</span>{{ result[2]|safe }}<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;td&gt;</span>{{ result[3]|safe }}<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;&lt;td&gt;</span>
Mean value: {{ result[4] }} <span class="nt">&lt;br&gt;</span>
Standard deviation value: {{ result[5] }}
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>To create the web application, we just perform the following steps:</p>
<ol class="arabic simple">
<li>copy the generic <tt class="docutils literal"><span class="pre">controller.py</span></tt> and <tt class="docutils literal"><span class="pre">model.py</span></tt> files to a new directory</li>
<li>write the compute function in a file <tt class="docutils literal"><span class="pre">compute.py</span></tt></li>
<li>edit <tt class="docutils literal"><span class="pre">controller.py</span></tt> and <tt class="docutils literal"><span class="pre">model.py</span></tt> to use the right name of the
compute function (<tt class="docutils literal"><span class="pre">from</span> <span class="pre">compute</span> <span class="pre">import</span> <span class="pre">name</span> <span class="pre">as</span> <span class="pre">compute</span></tt>)</li>
<li>add an appropriate <tt class="docutils literal"><span class="pre">templates/view_forms.html</span></tt> file that visualizes
the returned value <tt class="docutils literal"><span class="pre">results</span></tt> from the compute function</li>
</ol>
</div>
</div>
<div class="section" id="user-login-and-storage-of-computed-results">
<span id="wf-flask-login"></span><h3>User login and storage of computed results<a class="headerlink" href="#user-login-and-storage-of-computed-results" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-33"></span><p id="index-34">We now want to make an app where the computed results can be stored in
a database. To this end, each user must create an account and login to
this account for archiving results and for browsing previous runs of
the application. More files are needed for this purpose, compared to
the previous apps, and the files are located in the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/login">login</a> directory.</p>
<div class="section" id="required-additional-software">
<h4>Required additional software<a class="headerlink" href="#required-additional-software" title="Permalink to this headline">¶</a></h4>
<p>Three more packages are needed for this more advanced application:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://flask-login.readthedocs.org/en/latest/">Flask-Login</a></li>
<li><a class="reference external" href="http://flask.pocoo.org/docs/0.10/patterns/sqlalchemy/">Flask-SQLAlchemy</a></li>
<li><a class="reference external" href="http://packages.python.org/Flask-Mail">Flask-Mail</a></li>
</ul>
</div></blockquote>
<p>Installation is done by</p>
<div class="highlight-text"><div class="highlight"><pre>sudo pip install --upgrade flask-login
sudo pip install --upgrade flask-sqlalchemy
sudo pip install --upgrade flask-mail
</pre></div>
</div>
</div>
<div class="section" id="the-compute-part-2">
<h4>The compute part  (2)<a class="headerlink" href="#the-compute-part-2" title="Permalink to this headline">¶</a></h4>
<p>The <tt class="docutils literal"><span class="pre">compute.py</span></tt> file contains the <tt class="docutils literal"><span class="pre">compute</span></tt>
function from the <tt class="docutils literal"><span class="pre">vib2</span></tt> app in the section <a class="reference internal" href="#wf-vib2-flask-nofiles"><em>Avoiding plot files</em></a>.</p>
<p>There is quite much Flask code required for user accounts and login.
The files here were generated by the Parampool package and then
edited and specialized to the present application. In general,
it is not recommended to hack further on the example given here,
but rather utilize Parampool to generate web apps with user accounts
and login.</p>
</div>
<div class="section" id="the-interfaces-of-the-app">
<h4>The interfaces of the app<a class="headerlink" href="#the-interfaces-of-the-app" title="Permalink to this headline">¶</a></h4>
<p>The first page after starting the app (<tt class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span></tt>)
shows input fields for the numerical parameters, but there are also
links to the right for registering a new user or logging in to an
existing account:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_main.png"><img alt="_images/login_main.png" src="_images/login_main.png" style="width: 700px;" /></a>
</div>
<p>Clicking on <em>Register</em> brings up a registration page:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_register.png"><img alt="_images/login_register.png" src="_images/login_register.png" style="width: 700px;" /></a>
</div>
<p>Already registered users can just log in:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_login.png"><img alt="_images/login_login.png" src="_images/login_login.png" style="width: 700px;" /></a>
</div>
<p>Then the fields with input parameters are shown again. After pressing
<em>Compute</em> we are left with a combination of input and results, plus
a field where the user can write a comment about this simulation:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_results.png"><img alt="_images/login_results.png" src="_images/login_results.png" style="width: 700px;" /></a>
</div>
<p>All simulations (input data, results, and comment) are stored in
a database. Clicking on <em>Previous simulation</em> brings us to an
overview of what is in the database:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_old.png"><img alt="_images/login_old.png" src="_images/login_old.png" style="width: 500px;" /></a>
</div>
<p>Here, one can browse previous results, remove entries, or erase the
whole database.</p>
</div>
<div class="section" id="the-source-code">
<h4>The source code<a class="headerlink" href="#the-source-code" title="Permalink to this headline">¶</a></h4>
<p>Rather than explaining everything about the source code
in detail, we primarily list
the various code files below. A starting point is the central <tt class="docutils literal"><span class="pre">controller.py</span></tt>
file, which is now quite lengthy and involves four different
URLs (the input page, the login page, the registration page, and the
previous results page).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span> <span class="k">as</span> <span class="n">compute_function</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">ComputeForm</span>
<span class="kn">from</span> <span class="nn">db_models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Compute</span>
<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">LoginManager</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> \
     <span class="n">login_user</span><span class="p">,</span> <span class="n">logout_user</span><span class="p">,</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>
<span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@login_manager.user_loader</span>
<span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

<span class="c"># Path to the web application</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ComputeForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">compute_function</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                      <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
                <span class="nb">object</span> <span class="o">=</span> <span class="n">Compute</span><span class="p">()</span>
                <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
                <span class="nb">object</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
                <span class="nb">object</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c"># Send email notification</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">notify</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                    <span class="n">send_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">result</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">populate_form_from_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
                           <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">populate_form_from_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Repopulate form with previous values&quot;&quot;&quot;</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ComputeForm</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
        <span class="n">field</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">form</span>

<span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">flask.ext.mail</span> <span class="kn">import</span> <span class="n">Mail</span><span class="p">,</span> <span class="n">Message</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="s">&quot;Compute Computations Complete&quot;</span><span class="p">,</span>
                  <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">])</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">A simulation has been completed by the Flask Compute app.</span>
<span class="s">Please log in at</span>

<span class="s">http://localhost:5000/login</span>

<span class="s">to see the results.</span>

<span class="s">---</span>
<span class="s">If you don&#39;t want email notifications when a result is found,</span>
<span class="s">please register a new user and leave the &#39;notify&#39; field</span>
<span class="s">unchecked.</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/reg&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_login</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">register_form</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">register_form</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;reg.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">login_form</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">login_form</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
        <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;login.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/logout&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="n">logout_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/old&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">old</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">populate_form_from_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">result</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
                <span class="n">comments</span> <span class="o">=</span> <span class="s">&quot;&lt;h3&gt;Comments&lt;/h3&gt;&quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">comments</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comments</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">:</span><span class="n">result</span><span class="p">,</span>
                 <span class="s">&#39;id&#39;</span><span class="p">:</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&#39;comments&#39;</span><span class="p">:</span> <span class="n">comments</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;old.html&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/add_comment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">add_comment</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;comments&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/delete/&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">delete_post</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;old&#39;</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;sqlite.db&#39;</span><span class="p">)):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Creation of the <tt class="docutils literal"><span class="pre">app</span></tt> object is put in a separate file <tt class="docutils literal"><span class="pre">app.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;sqlite:///sqlite.db&#39;</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>

<span class="c"># Email settings</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">MAIL_SERVER</span><span class="o">=</span><span class="s">&#39;smtp.gmail.com&#39;</span><span class="p">,</span>
        <span class="n">MAIL_PORT</span><span class="o">=</span><span class="mi">587</span><span class="p">,</span>
        <span class="n">MAIL_USE_TLS</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">MAIL_USERNAME</span> <span class="o">=</span> <span class="s">&#39;cbcwebsolvermail@gmail.com&#39;</span><span class="p">,</span>
        <span class="n">MAIL_PASSWORD</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">decodestring</span><span class="p">(</span><span class="s">&#39;WGlmZmljdox0UFch&#39;</span><span class="p">),</span>
        <span class="n">MAIL_DEFAULT_SENDER</span> <span class="o">=</span> <span class="s">&#39;Some name &lt;name@gmail.com&gt;&#39;</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>The forms for the compute function and for the login is
stored in a file called <tt class="docutils literal"><span class="pre">forms.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">wtforms</span> <span class="kn">as</span> <span class="nn">wtf</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="k">class</span> <span class="nc">ComputeForm</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( A \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( b \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( w \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">pi</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( T \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;resolution&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>

<span class="kn">from</span> <span class="nn">db_models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span>
<span class="kn">import</span> <span class="nn">flask.ext.wtf.html5</span> <span class="kn">as</span> <span class="nn">html5</span>

<span class="c"># Standard Forms</span>
<span class="k">class</span> <span class="nc">register_form</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Username&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">PasswordField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span>
            <span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">(),</span>
            <span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">EqualTo</span><span class="p">(</span>
                <span class="s">&#39;confirm&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Passwords must match&#39;</span><span class="p">)])</span>
    <span class="n">confirm</span>  <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">PasswordField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Confirm Password&#39;</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>
    <span class="n">email</span>    <span class="o">=</span> <span class="n">html5</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Email&#39;</span><span class="p">)</span>
    <span class="n">notify</span>   <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Email notifications&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="s">&#39;Cannot send notifications without a valid email address&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;User already exists&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">login_form</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Username&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">PasswordField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Unknown username&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Invalid password&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
<p>Database-related code for the SQLAlchemy database is collected in
<tt class="docutils literal"><span class="pre">db_models.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask.ext.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">pwhash</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">notify</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;User </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pwhash</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwhash</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">pw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">is_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

<span class="k">class</span> <span class="nc">Compute</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">,</span>
           <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s">&#39;Compute&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s">&#39;dynamic&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Finally, we need views. For the results of the computation we have
a <tt class="docutils literal"><span class="pre">view.html</span></tt> file that is very similar to <tt class="docutils literal"><span class="pre">view_table.html</span></tt>
in the <tt class="docutils literal"><span class="pre">vib1</span></tt> app:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span>
<span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>

{% if user.is_anonymous() %}
  <span class="nt">&lt;p</span> <span class="na">align=</span><span class="s">&quot;right&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/login&quot;</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
  / <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/reg&quot;</span><span class="nt">&gt;</span>Register<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
{% else %}
  <span class="nt">&lt;p</span> <span class="na">align=</span><span class="s">&quot;right&quot;</span><span class="nt">&gt;</span>Logged in as {{user.username}}<span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/old&quot;</span><span class="nt">&gt;</span>Previous simulations<span class="nt">&lt;a/&gt;&lt;br&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/logout&quot;</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
{% endif %}

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;p&gt;</span>
<span class="c">&lt;!-- Input and Results are typeset as a two-column table --&gt;</span>
<span class="nt">&lt;table&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;h2&gt;</span>Input:<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span> <span class="na">enctype=</span><span class="s">multipart/form-data</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span>
      {% if field.errors %}
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
        {% for error in field.errors %}
          <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
        {% endfor %}<span class="nt">&lt;/ul&gt;</span>
      {% endif %}
      <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Compute&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/td&gt;</span>

<span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
  {% if result != None %}
    <span class="nt">&lt;h2&gt;</span>Results:<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ result|safe }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
    {% if not user.is_anonymous() %}
      <span class="nt">&lt;h3&gt;</span>Comments:<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;/add_comment&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;comments&quot;</span> <span class="na">rows=</span><span class="s">&quot;4&quot;</span> <span class="na">cols=</span><span class="s">&quot;40&quot;</span><span class="nt">&gt;&lt;/textarea&gt;</span>
          <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Add&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/form&gt;</span>
      {% endif %}

  {% endif %}
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">login.html</span></tt> template for the login page takes the form</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h2&gt;</span>Login:<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;table&gt;</span>
    {% for field in form %}
      <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            {% if field.errors %}
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
              {% for error in field.errors %}
                <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
              {% endfor %}<span class="nt">&lt;/ul&gt;</span>
            {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    {% endfor %}
  <span class="nt">&lt;/table&gt;</span>
  <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Login&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The page for registering a new user has a simple template <tt class="docutils literal"><span class="pre">reg.html</span></tt>:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h2&gt;</span>Register:<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
   {% for field in form %}
     <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
         <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            {% if field.errors %}
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
              {% for error in field.errors %}
                <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
              {% endfor %}<span class="nt">&lt;/ul&gt;</span>
            {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
   {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Register</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The final file is <tt class="docutils literal"><span class="pre">old.html</span></tt> for retrieving old simulations:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
 <span class="na">src=</span><span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;h2&gt;</span>Previous simulations<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;p</span> <span class="na">align=</span><span class="s">&quot;right&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>Back to index<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
{% if data %}
  {% for post in data %}
    <span class="nt">&lt;hr&gt;</span>
    <span class="nt">&lt;table&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">width=</span><span class="s">&quot;30%&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Input<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;table&gt;</span>
      {% for field in post.form %}
        <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}:<span class="ni">&amp;nbsp;</span><span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{ field.data }}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
      {% endfor %}
      <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;/td&gt;&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">width=</span><span class="s">&quot;60%&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Results<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ post.result|safe }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
    {% if True %}
      <span class="nt">&lt;p&gt;</span>
      {{ comments }}
    {% endif %}
    <span class="nt">&lt;/td&gt;&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">width=</span><span class="s">&quot;60%&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">action=</span><span class="s">&quot;/delete/{{ post.id }}&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">&quot;Delete&quot;</span>
       <span class="na">title=</span><span class="s">&quot;Delete this post from database&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
   {% endfor %}
   <span class="nt">&lt;hr&gt;</span>
   <span class="nt">&lt;center&gt;</span>
   <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">action=</span><span class="s">&quot;/delete/-1&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">&quot;Delete all&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;/form&gt;</span>
   <span class="nt">&lt;/center&gt;</span>
{% else %}
  No previous simulations
{% endif %}
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<ul class="last simple">
<li>Sending email from the app does not work.</li>
<li>Storing comments does not work.</li>
</ul>
</div>
<p>[<strong>hpl 1</strong>: Check if an autogenerated app from <tt class="docutils literal"><span class="pre">_generate_app.py</span></tt> can send mail and store comments. Need a <tt class="docutils literal"><span class="pre">compute</span></tt> function that returns full HTML text then.]</p>
</div>
<div class="section" id="resources-1">
<h4>Resources  (1)<a class="headerlink" href="#resources-1" title="Permalink to this headline">¶</a></h4>
<p>Working with a database in Flask is described here:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://pythonhosted.org/Flask-SQLAlchemy/quickstart.html">http://pythonhosted.org/Flask-SQLAlchemy/quickstart.html</a>,</li>
<li><a class="reference external" href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-iv-database">http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-iv-database</a>,</li>
<li><a class="reference external" href="https://flask-login.readthedocs.org/en/latest/">The Flask login extension</a></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="uploading-of-files">
<span id="wf-flask-upload"></span><h3>Uploading of files<a class="headerlink" href="#uploading-of-files" title="Permalink to this headline">¶</a></h3>
<span class="target" id="index-35"></span><div class="section" id="overview-of-the-application">
<span id="index-36"></span><h4>Overview of the application<a class="headerlink" href="#overview-of-the-application" title="Permalink to this headline">¶</a></h4>
<p>Many user interfaces need the user to provide data files. A minimalistic
application is to have a button for uploading a single file.
As example we use a file with a series of numbers, and the application&#8217;s
purpose is to compute the mean and standard deviation of the numbers.
The first user interface just has the <em>Choose File</em> and <em>Compute</em> buttons:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/upload1.png"><img alt="_images/upload1.png" src="_images/upload1.png" style="width: 550px;" /></a>
</div>
<p>Clicking on <em>Choose File</em> brings up a file browser where the user can
choose the file to uploaded to the application. Say this is a file
<tt class="docutils literal"><span class="pre">testfile.dat</span></tt>. The interface now looks like</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/upload2.png"><img alt="_images/upload2.png" src="_images/upload2.png" style="width: 550px;" /></a>
</div>
<p>Pressing thereafter <em>Compute</em> leads to storage of
<tt class="docutils literal"><span class="pre">testfile.dat</span></tt> on the server in a subdirectory <tt class="docutils literal"><span class="pre">uploads</span></tt> and
computation of basic statistics of the numbers in the file.
The resulting output looks like</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/upload3.png"><img alt="_images/upload3.png" src="_images/upload3.png" style="width: 550px;" /></a>
</div>
<p>The text &#8220;No file chosen&#8221; is automatically displayed by the
widget object used for file upload and indicates that a new
file can be chosen. Below we shall present all parts of the code
needed to create this interactive application.</p>
</div>
<div class="section" id="the-model-class">
<h4>The model class<a class="headerlink" href="#the-model-class" title="Permalink to this headline">¶</a></h4>
<p>The widget <tt class="docutils literal"><span class="pre">FieldField</span></tt> is used for an input field with a <em>Choose File</em>
button:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">wtforms</span> <span class="kn">as</span> <span class="nn">wtf</span>

<span class="k">class</span> <span class="nc">Average</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">filename</span>   <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span>
                               <span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
</pre></div>
</div>
</div>
<div class="section" id="the-controller-file">
<h4>The controller file<a class="headerlink" href="#the-controller-file" title="Permalink to this headline">¶</a></h4>
<p>The controller file needs some special code to specify a directory
to store uploaded files. We also include some code to check that
the file has a name with the right extension.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Relative path of directory for uploaded files</span>
<span class="n">UPLOAD_DIR</span> <span class="o">=</span> <span class="s">&#39;uploads/&#39;</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;UPLOAD_FOLDER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UPLOAD_DIR</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s">&#39;MySecretKey&#39;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">)</span>

<span class="c"># Allowed file types for file upload</span>
<span class="n">ALLOWED_EXTENSIONS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;txt&#39;</span><span class="p">,</span> <span class="s">&#39;dat&#39;</span><span class="p">,</span> <span class="s">&#39;npy&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Does filename have the right extension?&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> \
           <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ALLOWED_EXTENSIONS</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">index</span></tt> function must have code for saving the file, and as usual,
calling the compute function and rendering a new page:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Average</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># default</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>

        <span class="c"># Save uploaded file on server if it exists and is valid</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">form</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
                <span class="c"># Make a valid version of filename for any file ystem</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span>
                                       <span class="n">filename</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">compute_function</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-compute-function">
<h4>The compute function<a class="headerlink" href="#the-compute-function" title="Permalink to this headline">¶</a></h4>
<p>We assume that the uploaded file is available in the <tt class="docutils literal"><span class="pre">uploads</span></tt>
subdirectory, so the compute function needs to open this file, read
the numbers, and compute statistics. The file reading and computations
are easily done by <tt class="docutils literal"><span class="pre">numpy</span></tt> functions. The results are presented in
an HTML table.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">compute_mean_std</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;uploads&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">Data from file &lt;tt&gt;</span><span class="si">%s</span><span class="s">&lt;/tt&gt;:</span>
<span class="s">&lt;p&gt;</span>
<span class="s">&lt;table border=1&gt;</span>
<span class="s">&lt;tr&gt;&lt;td&gt; mean    &lt;/td&gt;&lt;td&gt; </span><span class="si">%.3g</span><span class="s"> &lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">&lt;tr&gt;&lt;td&gt; st.dev. &lt;/td&gt;&lt;td&gt; </span><span class="si">%.3g</span><span class="s"> &lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="the-html-template-2">
<h4>The HTML template  (2)<a class="headerlink" href="#the-html-template-2" title="Permalink to this headline">¶</a></h4>
<p>Although the present minimalistic application only needs a very simple
HTML template, we reuse a quite generic template known from previous examples,
where the input variables are listed to the left and the output of the
compute function is presented to the right. Such a template looks like</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title&gt;</span>Flask Average app<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>

  <span class="c">&lt;!-- Input and Results are typeset as a two-column table --&gt;</span>
  <span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Input:<span class="nt">&lt;/h2&gt;</span>

      <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span> <span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;table&gt;</span>
          {% for field in form %}
            <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;</span>{% if field.errors %}
                  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
                  {% for error in field.errors %}
                    <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
                  {% endfor %}<span class="nt">&lt;/ul&gt;</span>
                {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
          {% endfor %}
        <span class="nt">&lt;/table&gt;</span>
        <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Compute&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/td&gt;</span>

  <span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
    {% if result != None %}
      <span class="nt">&lt;h2&gt;</span>Results:<span class="nt">&lt;/h2&gt;</span>
        {{ result|safe }}

    {% endif %}
  <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The complete set of files is found in the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/upload">upload</a> directory.</p>
</div>
</div>
</div>
<div class="section" id="handling-multiple-input-variables-in-django">
<span id="wf-vib-django"></span><h2>Handling multiple input variables in Django<a class="headerlink" href="#handling-multiple-input-variables-in-django" title="Permalink to this headline">¶</a></h2>
<p>We shall briefly how to work with multi-variable input in Django.
The text is the Django counterpart to the section <a class="reference internal" href="#wf-vib-flask"><em>Handling multiple input variables in Flask</em></a>.
There are four float input variables: <span class="math">\(A\)</span>, <span class="math">\(b\)</span>, <span class="math">\(w\)</span>, and <span class="math">\(T\)</span>.
A function <tt class="docutils literal"><span class="pre">compute</span></tt> in the file <tt class="docutils literal"><span class="pre">compute.py</span></tt> makes
a plot of the function <span class="math">\(u(t)=Ae^{-bt}\sin (wt)\)</span>
depending on these four parameters and returns
the name of the plot file. Our task is to define four input fields,
execute the <tt class="docutils literal"><span class="pre">compute</span></tt> function and show the input fields together with
the resulting plot,
cf. Figures <a class="reference internal" href="#wf-vib1-flask-fig-input"><em>The input page</em></a>
and <a class="reference internal" href="#wf-vib1-flask-fig-result"><em>The result page</em></a>.</p>
<div class="section" id="programming-the-django-application-2">
<h3>Programming the Django application  (2)<a class="headerlink" href="#programming-the-django-application-2" title="Permalink to this headline">¶</a></h3>
<div class="section" id="adding-the-app-to-a-project">
<h4>Adding the app to a project<a class="headerlink" href="#adding-the-app-to-a-project" title="Permalink to this headline">¶</a></h4>
<p>Any Django app needs a project, but here we reuse the project
we set up for the scientific hello world examples. We go to
the directory <tt class="docutils literal"><span class="pre">apps/django_apps</span></tt> and create the Django app <tt class="docutils literal"><span class="pre">vib1</span></tt>:</p>
<div class="highlight-text"><div class="highlight"><pre>Terminal&gt; python ../../django_project/manage.py startapp vib1
</pre></div>
</div>
<p>Then we</p>
<ol class="arabic simple">
<li>add <tt class="docutils literal"><span class="pre">relative2absolute_path('../../apps/django_apps/vib1/templates'),</span></tt>
to the <tt class="docutils literal"><span class="pre">TEMPLATE_DIRS</span></tt> tuple in <tt class="docutils literal"><span class="pre">settings.py</span></tt>,</li>
<li>add <tt class="docutils literal"><span class="pre">vib1</span></tt> to the <tt class="docutils literal"><span class="pre">INSTALLED_APPS</span></tt> tuple, and</li>
<li>add <tt class="docutils literal"><span class="pre">url(r'^vib1/',</span> <span class="pre">'django_apps.vib1.views.index')</span></tt> to the <tt class="docutils literal"><span class="pre">patterns</span></tt>
call in <tt class="docutils literal"><span class="pre">urls.py</span></tt>.</li>
</ol>
<p>These steps ensure that Django can find our application as a module/package,
that Django can find our templates associated with this application,
and that the URL address applies the name <tt class="docutils literal"><span class="pre">vib1</span></tt> to reach the application.</p>
</div>
<div class="section" id="the-compute-part-3">
<h4>The compute part  (3)<a class="headerlink" href="#the-compute-part-3" title="Permalink to this headline">¶</a></h4>
<p>The computations in our application are put in a file <tt class="docutils literal"><span class="pre">compute.py</span></tt>
and explained in detail in the section <a class="reference internal" href="#wf-vib1-flask-app"><em>Programming the Flask application  (2)</em></a>.</p>
</div>
<div class="section" id="the-model-3">
<span id="index-37"></span><h4>The model  (3)<a class="headerlink" href="#the-model-3" title="Permalink to this headline">¶</a></h4>
<p>We can now write <tt class="docutils literal"><span class="pre">models.py</span></tt> and the <tt class="docutils literal"><span class="pre">Input</span></tt> class that defines
the form fields for the four input variables:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">ModelForm</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; amplitude (m)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; damping coefficient (kg/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; frequency (1/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; time interval (s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Input</span>
</pre></div>
</div>
<p>Note here that we can provide a more explanatory name than just
the variable name, e.g., <tt class="docutils literal"><span class="pre">'</span> <span class="pre">amplitude</span> <span class="pre">(m)'</span></tt> for <tt class="docutils literal"><span class="pre">A</span></tt>. However,
Django will always capitalize these descriptions, so if one really
needs lower case names (e.g., to be compatible with a mathematical notation
or when just listing the unit),
one must start the text with a space, as we have demonstrated above.
We also provide a default
value such that all fields have a value when the user sees
the page.</p>
</div>
<div class="section" id="the-view-3">
<span id="index-38"></span><h4>The view  (3)<a class="headerlink" href="#the-view-3" title="Permalink to this headline">¶</a></h4>
<p>The <tt class="docutils literal"><span class="pre">views.py</span></tt> file looks as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render_to_response</span>
<span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">RequestContext</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">InputForm</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">form2</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">form2</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">form2</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">form2</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="n">form2</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;static/&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render_to_response</span><span class="p">(</span><span class="s">&#39;vib1.html&#39;</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
             <span class="s">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
             <span class="p">},</span> <span class="n">context_instance</span><span class="o">=</span><span class="n">RequestContext</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
</pre></div>
</div>
<p>Some remarks are necessary:</p>
<ol class="arabic simple">
<li>Doing an <tt class="docutils literal"><span class="pre">os.chdir</span></tt> to the current working directory is necessary
as Django may be left back in another working directory if you have
tested other apps.</li>
<li>The <tt class="docutils literal"><span class="pre">form2</span></tt> object from <tt class="docutils literal"><span class="pre">form.save</span></tt> is the object we extract
data from and send to <tt class="docutils literal"><span class="pre">compute</span></tt>, but the original <tt class="docutils literal"><span class="pre">form</span></tt>
object is needed when making the HTML page through the template.</li>
<li>Images, media files, style sheets, javascript files, etc. must
reside in a subdirectory <tt class="docutils literal"><span class="pre">static</span></tt>. The specifications of the
URL applies tools to find this <tt class="docutils literal"><span class="pre">static</span></tt> directory and then
the <tt class="docutils literal"><span class="pre">static</span></tt> prefix in the <tt class="docutils literal"><span class="pre">result</span></tt> filename must be removed.</li>
</ol>
<p>The template for rendering the page is listed next.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>{% csrf_token %}
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.errors }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Compute</span><span class="nt">&gt;&lt;/form&gt;&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
{% if result != None %}
{% load static %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{% get_static_prefix %}{{ result }}&quot;</span> <span class="na">width=</span><span class="s">500</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>The tricky part is the syntax for displaying <em>static content</em>, such as
the plot file made in the <tt class="docutils literal"><span class="pre">compute</span></tt> function.</p>
</div>
</div>
<div class="section" id="custom-validation-2">
<h3>Custom validation  (2)<a class="headerlink" href="#custom-validation-2" title="Permalink to this headline">¶</a></h3>
<p>Django has a series of methods available for user-provided validation
of form data. These are exemplified in the app <tt class="docutils literal"><span class="pre">vib2</span></tt>, which
is an extension of the <tt class="docutils literal"><span class="pre">vib1</span></tt> app with additional code. (This other
app needs of course registrations in <tt class="docutils literal"><span class="pre">settings.py</span></tt> and <tt class="docutils literal"><span class="pre">urls.py</span></tt>, similar
to what we did for the <tt class="docutils literal"><span class="pre">vib1</span></tt> app.)</p>
<p id="index-39">Making sure that <span class="math">\(A&gt;0\)</span> is easiest done with a built-in Django
validator for minimum value checking:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; amplitude (m)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span>
</pre></div>
</div>
<p>We can write our own validators, which are functions taking the value
is the only argument and raising a <tt class="docutils literal"><span class="pre">ValidationError</span></tt> exception if the
value is wrong. Checking that a value is inside an interval can first
be implemented by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_interval</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Validate that a value is inside an interval.&quot;&quot;&quot;</span>
    <span class="n">failure</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">min_value</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">max_value</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">&#39;value=</span><span class="si">%s</span><span class="s"> not in [</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">value</span><span class="p">,</span>
             <span class="s">&#39;-infty&#39;</span> <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_value</span><span class="p">),</span>
             <span class="s">&#39;infty&#39;</span> <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_value</span><span class="p">)))</span>
</pre></div>
</div>
<p>However, this function takes more than the value as argument. We therefore
need to wrap it by a function with <tt class="docutils literal"><span class="pre">value</span></tt> as the only argument. The following
utility returns such a
function (see the section <a class="reference internal" href="#wf-vib1-flask-validation"><em>Custom validation  (1)</em></a> for more
explanation):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">interval</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Django-compatible interface to check_interval.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">check_interval</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, <tt class="docutils literal"><span class="pre">interval(0,</span> <span class="pre">1)</span></tt> returns a function that takes <tt class="docutils literal"><span class="pre">value</span></tt> as its
only argument and checks if it is inside <span class="math">\([0,1]\)</span>.
Such a function can be inserted in the <tt class="docutils literal"><span class="pre">validators</span></tt> list in
the field constructor, here to tell that <span class="math">\(b\)</span> must be in <span class="math">\([0,\infty)\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Input</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s">&#39; damping coefficient (kg/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">None</span><span class="p">)])</span>
</pre></div>
</div>
<p>A final example on custom validation is to avoid plotting more
than 30 periods of the oscillating function <span class="math">\(u\)</span>. This translates
to checking that <span class="math">\(T\)</span> is geater
than 30 periods, i.e., <span class="math">\(T&gt;30\cdot 2\pi/w\)</span>. The task is done in
the <tt class="docutils literal"><span class="pre">InputForm</span></tt> class, where any method <tt class="docutils literal"><span class="pre">clean_name</span></tt> can do
validation and adjustment of the field name <tt class="docutils literal"><span class="pre">name</span></tt>. The code for
a <tt class="docutils literal"><span class="pre">clean_T</span></tt> method goes as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Input</span>

    <span class="k">def</span> <span class="nf">clean_T</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">T</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;T&#39;</span><span class="p">]</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;w&#39;</span><span class="p">]</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">w</span>
        <span class="k">if</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="o">*</span><span class="n">period</span><span class="p">:</span>
            <span class="n">num_periods</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">period</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s">&#39;Cannot plot as much as </span><span class="si">%d</span><span class="s"> periods! T &lt; </span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">num_periods</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="n">period</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">T</span>
</pre></div>
</div>
<p>We refer to the vast Django documentation for many other ways of
validating forms. The reader is encouraged to run the <tt class="docutils literal"><span class="pre">vib2</span></tt>
application and test out the validations we have implemented.</p>
</div>
<div class="section" id="customizing-widgets">
<h3>Customizing widgets<a class="headerlink" href="#customizing-widgets" title="Permalink to this headline">¶</a></h3>
<p>One will occasionally have full control of the layout of the individual
elements in a web form. These are typeset inside <tt class="docutils literal"><span class="pre">input</span></tt> tags in
HTML. Django associates the term <em>widget</em> with an HTML form field. To set
the size (width) of the field and other properties, one must in
Django specify a <tt class="docutils literal"><span class="pre">widgets</span></tt> dictionary in the form class. The key
is the name of the parameter in the model class, while the value
is a widget class name. Standard input fields for numbers and
text apply the <tt class="docutils literal"><span class="pre">TextInput</span></tt> widget. An example
on setting the size of the <tt class="docutils literal"><span class="pre">T</span></tt> field to a width of 10 characters goes
like</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">TextInput</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Input</span>
        <span class="n">widgets</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;T&#39;</span><span class="p">:</span> <span class="n">TextInput</span><span class="p">(</span><span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}),</span>
        <span class="p">}</span>
</pre></div>
</div>
<p>At the time of this writing, Django does not yet support the many
additional HTML5 input fields. Nevertheless, the <tt class="docutils literal"><span class="pre">parampool</span></tt> package
gives access to HTML5 widgets in a Django context.
We recommend to use <tt class="docutils literal"><span class="pre">parampool</span></tt> to automatically generate the necessary
Django files, and
then one can view the form class in the <tt class="docutils literal"><span class="pre">models.py</span></tt> file for how
HTML5 widgets can be used in the definition of the <tt class="docutils literal"><span class="pre">widgets</span></tt>
dictionary.</p>
</div>
<div class="section" id="resources-2">
<h3>Resources  (2)<a class="headerlink" href="#resources-2" title="Permalink to this headline">¶</a></h3>
<p>Below are some resources for accounts and login with Django as well as
utilization of Bootstrap styles in the views.</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/auth/default/#user-objects">Django: make user</a></li>
<li><a class="reference external" href="https://docs.djangoproject.com/en/dev/topics/db/queries/">Django: read and write database</a></li>
<li><a class="reference external" href="http://stackoverflow.com/questions/11821116/django-and-bootstrap-what-app-is-recommended">http://stackoverflow.com/questions/11821116/django-and-bootstrap-what-app-is-recommended</a></li>
<li><a class="reference external" href="https://github.com/dyve/django-bootstrap3">https://github.com/dyve/django-bootstrap3</a></li>
<li><a class="reference external" href="https://www.youtube.com/watch?v=3Bwl5CYa5Uc">https://www.youtube.com/watch?v=3Bwl5CYa5Uc</a></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<div class="section" id="exercise-1-add-two-numbers">
<span id="wf-exer-add2"></span><h3>Exercise 1: Add two numbers<a class="headerlink" href="#exercise-1-add-two-numbers" title="Permalink to this headline">¶</a></h3>
<p>Make a web application that reads two numbers from a web page,
adds the numbers, and prints the sum in a new web page.
Package the necessary files that constitute the application
in a tar file.
Filename: <tt class="docutils literal"><span class="pre">add2.tar.gz</span></tt>.</p>
</div>
<div class="section" id="exercise-2-upload-data-file-and-visualize-curves">
<span id="wf-exer-upload"></span><h3>Exercise 2: Upload data file and visualize curves<a class="headerlink" href="#exercise-2-upload-data-file-and-visualize-curves" title="Permalink to this headline">¶</a></h3>
<p>Suppose you have tabular data in a file:</p>
<div class="highlight-text"><div class="highlight"><pre>#  t        y       error
0.0000    1.2345   1.4E-4
1.0000    0.9871  -4.9E-3
1.2300    0.5545   8.2E-3
</pre></div>
</div>
<p>That is, there is a comment line with headings for the various
columns, and then floating-point values are listed with an
arbitrary number of columns and rows. You want to upload such
a data file to a web application and have the each column, from
the second one, plotted against the the values in the first column.
In the particular example, <tt class="docutils literal"><span class="pre">y</span></tt> and <tt class="docutils literal"><span class="pre">error</span></tt> should be plotted against
<tt class="docutils literal"><span class="pre">t</span></tt>, yielding two curves.</p>
<p>The web application may have one field: the name of the file to upload.
Search for constructions on how to upload a files and write this
application. Generate a suitable data file for testing purposes.
Filename: <tt class="docutils literal"><span class="pre">upload.tar.gz</span></tt>.</p>
</div>
<div class="section" id="exercise-3-plot-a-user-specified-formula">
<span id="wf-exer-formula"></span><h3>Exercise 3: Plot a user-specified formula<a class="headerlink" href="#exercise-3-plot-a-user-specified-formula" title="Permalink to this headline">¶</a></h3>
<p>The purpose of this exercise is to write a web application that
can visualize any user-given formula. For example, in the interface below,</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/plot_formula.png"><img alt="_images/plot_formula.png" src="_images/plot_formula.png" style="width: 600px;" /></a>
</div>
<p>the user has</p>
<blockquote>
<div><ul class="simple">
<li>specified a curve <span class="math">\(\sin (x)\)</span> (<tt class="docutils literal"><span class="pre">sin(x)</span></tt>) to be plotted</li>
<li>specified the <span class="math">\(x\)</span> interval to be <span class="math">\([0,2\pi]\)</span> (<tt class="docutils literal"><span class="pre">[0,</span> <span class="pre">2*pi]</span></tt>)</li>
<li>clicked <em>Compute</em> to get a blue line with the sine curve</li>
<li>specified a new formula <span class="math">\(\sin(x)e^{-x}\)</span> (<tt class="docutils literal"><span class="pre">sin(x)*exp(-x)</span></tt>)</li>
<li>chosen <em>No</em> as the answer to <em>Erase all curves?</em></li>
<li>clicked <em>Compute</em> to have the  <span class="math">\(\sin(x)e^{-x}\)</span> drawn
with green line without erasing the previous curve</li>
</ul>
</div></blockquote>
<p>That is, the user can fill in any expression in <span class="math">\(x\)</span>, specify the
domain for plotting, and choose whether new curves should be added
to the plot or if all curves should be erased prior to drawing a
new one.</p>
<p><strong>Hint 1.</strong>
You may use the <tt class="docutils literal"><span class="pre">vib1</span></tt> app from the section <a class="reference internal" href="#wf-vib1-flask-app"><em>Programming the Flask application  (2)</em></a>
with the <tt class="docutils literal"><span class="pre">view_errcheck.html</span></tt> template as starting point.
Preferably, let plots be created as strings, as explained for the <tt class="docutils literal"><span class="pre">vib2</span></tt>
app in the section <a class="reference internal" href="#wf-vib2-flask-nofiles"><em>Avoiding plot files</em></a>.</p>
<p>The <em>Formula</em> and <em>Domain</em> fields need to be <tt class="docutils literal"><span class="pre">TextField</span></tt> objects,
and the compute function must perform an <tt class="docutils literal"><span class="pre">eval</span></tt> on the user&#8217;s input.
The <em>Erase</em> field is a <tt class="docutils literal"><span class="pre">SelectField</span></tt> object with selections <em>Yes</em> and
<em>No</em>. The former means that the compute function calls the <tt class="docutils literal"><span class="pre">figure</span></tt>
function in Matplotlib before creating a new plot. If this is not
done, a new formula will be plotting in the same figure as the last one.
With the Yes/No selection, it is possible either plot individual curves
or compare curves in the same plot.</p>
<p><strong>Hint 2.</strong>
Performing <tt class="docutils literal"><span class="pre">eval</span></tt> on the user&#8217;s input requires that names like
<tt class="docutils literal"><span class="pre">sin</span></tt>, <tt class="docutils literal"><span class="pre">exp</span></tt>, and <tt class="docutils literal"><span class="pre">pi</span></tt> are defined. The simplest approach is to
do a</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>in the top of the file containing the compute function. All the names
from <tt class="docutils literal"><span class="pre">numpy</span></tt> are then available as global variables and one can simply
do <tt class="docutils literal"><span class="pre">domain</span> <span class="pre">=</span> <span class="pre">eval(domain)</span></tt> to turn the string <tt class="docutils literal"><span class="pre">domain</span></tt> coming from
the <em>Domain</em> text field into a Python list with two elements.</p>
<p>A better approach is not to rely on global variables, but run <tt class="docutils literal"><span class="pre">eval</span></tt>
in the <tt class="docutils literal"><span class="pre">numpy</span></tt> namespace:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span>
<span class="n">domain</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
</pre></div>
</div>
<p>The evaluation of the formula is slightly more complicated if <tt class="docutils literal"><span class="pre">eval</span></tt>
is to be run with the <tt class="docutils literal"><span class="pre">numpy</span></tt> namespace. One first needs
to create <span class="math">\(x\)</span> coordinates:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10001</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, <tt class="docutils literal"><span class="pre">eval(formula,</span> <span class="pre">numpy.__dict__)</span></tt> will not work because a formula
like <tt class="docutils literal"><span class="pre">sin(x)</span></tt> needs both <tt class="docutils literal"><span class="pre">sin</span></tt> and <tt class="docutils literal"><span class="pre">x</span></tt> in the namespace. The latter
is not in the namespace and must be explicitly included. A new namespace
can be made:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">namespace</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">})</span>
<span class="n">formula</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Hint 3.</strong>
You should add tests when evaluating and using the strings from input
as these may have wrong syntax.</p>
<p>Filename: <tt class="docutils literal"><span class="pre">plot_formula.tar.gz</span></tt>.</p>
</div>
<div class="section" id="exercise-4-visualize-taylor-polynomial-approximations">
<span id="wf-exer-taylor"></span><h3>Exercise 4: Visualize Taylor polynomial approximations<a class="headerlink" href="#exercise-4-visualize-taylor-polynomial-approximations" title="Permalink to this headline">¶</a></h3>
<p>This exercise develops a web application that can plot Taylor polynomial
approximations of <em>any</em> degree
to <em>any</em> user-given formula. You should do
<a class="reference internal" href="#wf-exer-formula"><em>Exercise 3: Plot a user-specified formula</em></a> first as many of the techniques there
must be used and even further developed in the present exercise.</p>
<p>The figure below shows an example of what one can do in the
web app:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/Taylor_approx.png"><img alt="_images/Taylor_approx.png" src="_images/Taylor_approx.png" style="width: 600px;" /></a>
</div>
<p>Here, the user has</p>
<blockquote>
<div><ul class="simple">
<li>filled in the formula <span class="math">\(\sin(x)\)</span> (<tt class="docutils literal"><span class="pre">sin(x)</span></tt>)</li>
<li>specified <em>N</em> to be 3</li>
<li>clicked <em>Compute</em> to get the formula <span class="math">\(\sin(x)\)</span> plotted together with
the Taylor polynomial approximation of degree 3, expanded around <span class="math">\(x=0\)</span></li>
<li>changed <em>N</em> to 5</li>
<li>chosen <em>No</em> for the question <em>Erase all curves?</em></li>
<li>clicked <em>Compute</em> to have the series expansion of degree 5 plotted
in the same plot</li>
<li>changed <em>N</em> to 10</li>
<li>clicked <em>Compute</em> to have the series expansion of degree 10 plotted
in the same plot</li>
</ul>
</div></blockquote>
<p>We can use <tt class="docutils literal"><span class="pre">sympy</span></tt> to produce Taylor polynomial expansions of arbitrary
expressions. Here is a session demonstrating how to obtain the
series expansion of <span class="math">\(e^{-x}\sin (\pi x)\)</span> to 2nd degree.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sympy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">symbols</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">sp</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">sp</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="go">pi*x - pi*x**2 + O(x**3)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sp</span><span class="o">.</span><span class="n">latex</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="go">&#39;\\pi x - \\pi x^{2} + \\mathcal{O}\\left(x^{3}\\right)&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fs</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>  <span class="c"># get rid of O() term</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">fs</span>
<span class="go">-pi*x**2 + pi*x</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f_func</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">lambdify</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="n">fs</span><span class="p">)</span>     <span class="c"># make Python function</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f_func</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">0.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f_func</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">-6.283185307179586</span>
</pre></div>
</div>
<p>Basically, the steps above must be carried out to create a Python
function for the series expansion such that it can be plotted.
A similar <tt class="docutils literal"><span class="pre">sp.lambdify</span></tt> call on the original formula is also necessary
to plot that one.</p>
<p>However, the challenge is that the formula is
available only as a string, and it may contain an independent variable
whose name is also only available through a string from the web interface.
That is, we may give formulas like <tt class="docutils literal"><span class="pre">exp(-t)</span></tt> if <tt class="docutils literal"><span class="pre">t</span></tt> is chosen as
independent variable.
Also, the expression does not contain function names prefixed with <tt class="docutils literal"><span class="pre">sympy</span></tt> or
<tt class="docutils literal"><span class="pre">sp</span></tt>, just plain names like <tt class="docutils literal"><span class="pre">sin</span></tt>, <tt class="docutils literal"><span class="pre">cos</span></tt>, <tt class="docutils literal"><span class="pre">exp</span></tt>, etc.
An example on <tt class="docutils literal"><span class="pre">formula</span></tt> is <tt class="docutils literal"><span class="pre">cos(pi*x)</span> <span class="pre">+</span> <span class="pre">log(x)</span></tt>.</p>
<p><strong>a)</strong>
Write a function</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">formula2series2pyfunc</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</pre></div>
</div>
<p>that takes a <tt class="docutils literal"><span class="pre">sympy</span></tt> formula, and integer <tt class="docutils literal"><span class="pre">N</span></tt>, a <tt class="docutils literal"><span class="pre">sympy</span></tt> symbol <tt class="docutils literal"><span class="pre">x</span></tt>
and another <tt class="docutils literal"><span class="pre">sympy</span></tt> symbol <tt class="docutils literal"><span class="pre">x0</span></tt> and returns
1) a Python function for <tt class="docutils literal"><span class="pre">formula</span></tt>, 2) a Python function for the
series expansion of degree <tt class="docutils literal"><span class="pre">N</span></tt> of the formula around <tt class="docutils literal"><span class="pre">x0</span></tt>, and
3) a LaTeX string containing the formula for the series expansion.</p>
<p>Put the function in a file <tt class="docutils literal"><span class="pre">compute.py</span></tt>. You should thereafter be able to run
the following session:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">compute</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sympy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">symbols</span><span class="p">(</span><span class="s">&#39;t&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">formula</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">latex</span> <span class="o">=</span> <span class="n">compute</span><span class="o">.</span><span class="n">formula2series2pyfunc</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">latex</span>
<span class="go">&#39;- \\frac{4 t^{3}}{3} + 2 t^{2} - 2 t + 1&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<span class="go">[&lt;matplotlib.lines.Line2D at 0x7fc6c020f350&gt;,</span>
<span class="go"> &lt;matplotlib.lines.Line2D at 0x7fc6c020f5d0&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>The resulting plot is displayed below.</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/Taylor_approx_exp2t.png"><img alt="_images/Taylor_approx_exp2t.png" src="_images/Taylor_approx_exp2t.png" style="width: 500px;" /></a>
</div>
<p><strong>Hint.</strong>
The series expansion is obtained by <tt class="docutils literal"><span class="pre">formula.series(x,</span> <span class="pre">x0,</span> <span class="pre">N)</span></tt>,
but the output contains an <tt class="docutils literal"><span class="pre">O()</span></tt> term which makes it impossible to
convert the expression to a Python function via <tt class="docutils literal"><span class="pre">sympy.lambify</span></tt>.
Use</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">series</span> <span class="o">=</span> <span class="n">formula</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">removeO</span><span class="p">()</span>
</pre></div>
</div>
<p>to get an expression that can be used as argument to <tt class="docutils literal"><span class="pre">sympy.lambdify</span></tt>.
We use <tt class="docutils literal"><span class="pre">N+1</span></tt> since <tt class="docutils literal"><span class="pre">N</span></tt> in the <tt class="docutils literal"><span class="pre">series</span></tt> function refers to the degree
of the <tt class="docutils literal"><span class="pre">O()</span></tt> term, which is now removed.</p>
<p>For the LaTeX expression it is natural to have the <tt class="docutils literal"><span class="pre">O()</span></tt> term:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">latex</span> <span class="o">=</span> <span class="n">sympy</span><span class="o">.</span><span class="n">latex</span><span class="p">(</span><span class="n">formula</span><span class="o">.</span><span class="n">series</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>because then the terms start with the lowest order (and not the highest
order as is the case when <tt class="docutils literal"><span class="pre">removeO()</span></tt> is used).</p>
<p><strong>b)</strong>
Write the compute function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">visualize_series</span><span class="p">(</span>
    <span class="n">formula</span><span class="p">,</span>                  <span class="c"># string: formula</span>
    <span class="n">independent_variable</span><span class="p">,</span>     <span class="c"># string: name of independent var.</span>
    <span class="n">N</span><span class="p">,</span>                        <span class="c"># int: degree of polynomial approx.</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span>   <span class="c"># strings: extent of axes</span>
    <span class="n">legend_loc</span><span class="p">,</span>               <span class="c"># string: upper left, etc.</span>
    <span class="n">x0</span><span class="o">=</span><span class="s">&#39;0&#39;</span><span class="p">,</span>                   <span class="c"># string: point of expansion</span>
    <span class="n">erase</span><span class="o">=</span><span class="s">&#39;yes&#39;</span><span class="p">,</span>              <span class="c"># string: &#39;yes&#39; or &#39;no&#39;</span>
    <span class="p">):</span>
</pre></div>
</div>
<p><strong>Hint 1.</strong>
Converting the string <tt class="docutils literal"><span class="pre">formula</span></tt> to a valid <tt class="docutils literal"><span class="pre">sympy</span></tt> expression is
challenging. First, create a local variable for a <tt class="docutils literal"><span class="pre">sympy</span></tt> symbol
with the content of
<tt class="docutils literal"><span class="pre">independent_variable</span></tt> as name, since such a variable is needed
with performing <tt class="docutils literal"><span class="pre">eval</span></tt> on <tt class="docutils literal"><span class="pre">formula</span></tt>. Also introduce a variable <tt class="docutils literal"><span class="pre">x</span></tt>
to point to the same <tt class="docutils literal"><span class="pre">sympy</span></tt> symbol. Relevant code is</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Turn independent variable into sympy symbol, stored in x</span>
<span class="kn">import</span> <span class="nn">sympy</span> <span class="kn">as</span> <span class="nn">sp</span>
<span class="k">exec</span><span class="p">(</span><span class="s">&#39;x = </span><span class="si">%s</span><span class="s"> = sp.symbols(&quot;</span><span class="si">%s</span><span class="s">&quot;)&#39;</span> <span class="o">%</span>
     <span class="p">(</span><span class="n">independent_variable</span><span class="p">,</span> <span class="n">independent_variable</span><span class="p">))</span>
</pre></div>
</div>
<p><strong>Hint 2.</strong>
Evaluating <tt class="docutils literal"><span class="pre">formula</span></tt> in the namespace of <tt class="docutils literal"><span class="pre">sympy</span></tt> (so that all the <tt class="docutils literal"><span class="pre">sin</span></tt>,
<tt class="docutils literal"><span class="pre">exp</span></tt>, <tt class="docutils literal"><span class="pre">pi</span></tt>, and similar symbols are defined properly as <tt class="docutils literal"><span class="pre">sympy</span></tt>
objects) needs a merge of the <tt class="docutils literal"><span class="pre">sympy</span></tt> namespace and the variable for
the <tt class="docutils literal"><span class="pre">sympy</span></tt> symbol representing the independent variable:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">namespace</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">local</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">local</span><span class="p">[</span><span class="n">independent_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
<span class="n">namespace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
<span class="n">formula</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">namespace</span><span class="p">)</span>
</pre></div>
</div>
<p>Turning <tt class="docutils literal"><span class="pre">x0</span></tt> into a valid <tt class="docutils literal"><span class="pre">sympy</span></tt> expression is easier: <tt class="docutils literal"><span class="pre">x0</span> <span class="pre">=</span> <span class="pre">eval(x0,</span> <span class="pre">sp.__dict__)</span></tt>.</p>
<p><strong>Hint 3.</strong>
Note that in the web interface, the minimum and maximum values on the axis
can be mathematical expressions such as <tt class="docutils literal"><span class="pre">2*pi</span></tt>. This means that these
quantities must be strings that are evaluated in the <tt class="docutils literal"><span class="pre">numpy</span></tt> namespace, e.g.,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="n">xmin</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Hint 4.</strong>
Getting the legends right when plotting multiple curves in the same
plot is a bit tricky. One solution is to have a global variable <tt class="docutils literal"><span class="pre">legends</span></tt>
that is initialized to <tt class="docutils literal"><span class="pre">[]</span></tt> and do the following inside the compute function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="k">global</span> <span class="n">legends</span>
<span class="k">if</span> <span class="n">erase</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span><span class="p">:</span>   <span class="c"># Start new figure?</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">legends</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">legends</span><span class="p">:</span>
    <span class="c"># We come here every time the figure is empty so</span>
    <span class="c"># we need to draw the formula</span>
    <span class="n">legends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;$</span><span class="si">%s</span><span class="s">$&#39;</span> <span class="o">%</span> <span class="n">sp</span><span class="o">.</span><span class="n">latex</span><span class="p">(</span><span class="n">formula</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
<p>Here, <tt class="docutils literal"><span class="pre">f</span></tt> is the Python function for computing the <tt class="docutils literal"><span class="pre">numpy</span></tt> variant
of the expression in <tt class="docutils literal"><span class="pre">formula</span></tt>.</p>
<p><strong>Hint 5.</strong>
Use the test block in the file to call the compute function several
times with different values of the <tt class="docutils literal"><span class="pre">erase</span></tt> parameter to test that
the erase functionality is correct.</p>
<p><strong>c)</strong>
Write the remaining files. These have straightforward content if
<a class="reference internal" href="#wf-exer-formula"><em>Exercise 3: Plot a user-specified formula</em></a> is done and understood.</p>
<p>Filename: <tt class="docutils literal"><span class="pre">Taylor_approx.tar.gz</span></tt>.</p>
</div>
<div class="section" id="exercise-5-extend-the-gen-app">
<span id="wf-exer-gen-demo"></span><h3>Exercise 5: Extend the <tt class="docutils literal"><span class="pre">gen</span></tt> app<a class="headerlink" href="#exercise-5-extend-the-gen-app" title="Permalink to this headline">¶</a></h3>
<p>Add a new argument <tt class="docutils literal"><span class="pre">x_axis</span></tt> to the <tt class="docutils literal"><span class="pre">compute</span></tt> function in the
<a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/gen">gen</a>
application from the section <a class="reference internal" href="#wf-autogen-flask"><em>Autogenerating the code</em></a>. The <tt class="docutils literal"><span class="pre">x_axis</span></tt> argument measures the extent
of the <span class="math">\(x\)</span> axis in the plots in terms of the number of standard
deviations (default may be 7).  Observe how the web interface
automatically adds the new argument and how the plots adapt!</p>
</div>
<div class="section" id="exercise-6-equip-the-gen-app-with-more-data-types">
<span id="wf-exer-gen-lists"></span><h3>Exercise 6: Equip the <tt class="docutils literal"><span class="pre">gen</span></tt> app with more data types<a class="headerlink" href="#exercise-6-equip-the-gen-app-with-more-data-types" title="Permalink to this headline">¶</a></h3>
<p>In the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/gen">gen</a>
application from the section <a class="reference internal" href="#wf-autogen-flask"><em>Autogenerating the code</em></a>,
use the <tt class="docutils literal"><span class="pre">label</span></tt> argument in the form field objects to add an
information of the type of data that is to be supplied in the
text field. Extend the <tt class="docutils literal"><span class="pre">model.py</span></tt> file to also handle
lists, tuples, and Numerical Python arrays. For these three
new data types, use a <tt class="docutils literal"><span class="pre">TextField</span></tt> object and run <tt class="docutils literal"><span class="pre">eval</span></tt>
on the text in the <tt class="docutils literal"><span class="pre">view.py</span></tt> file.
A simple test is to extend the <tt class="docutils literal"><span class="pre">compute</span></tt> function with an
argument <tt class="docutils literal"><span class="pre">x_range</span></tt> for the range of the <span class="math">\(x\)</span> axis, specified as
an interval (2-list or 2-tuple).
Filename: <tt class="docutils literal"><span class="pre">gen_ext.tar.gz</span></tt>.</p>
</div>
<div class="section" id="exercise-7-auto-generate-code-from-function-signature">
<h3>Exercise 7: Auto-generate code from function signature<a class="headerlink" href="#exercise-7-auto-generate-code-from-function-signature" title="Permalink to this headline">¶</a></h3>
<p>Given a <tt class="docutils literal"><span class="pre">compute</span></tt> with a set of positional and keyword
arguments, the purpose of this exercise is to <em>automatically</em> generate the
Flask files <tt class="docutils literal"><span class="pre">model.py</span></tt> and <tt class="docutils literal"><span class="pre">controller.py</span></tt>. Use the Python <tt class="docutils literal"><span class="pre">inspect</span></tt>
module, see the section <a class="reference internal" href="#wf-autogen-flask"><em>Autogenerating the code</em></a>, to extract
the positional and keyword arguments in <tt class="docutils literal"><span class="pre">compute</span></tt>, and use this
information to construct the relevant Python code in strings. Write
the strings to <tt class="docutils literal"><span class="pre">model.py</span></tt> and <tt class="docutils literal"><span class="pre">controller.py</span></tt> files. Assume as
in the section <a class="reference internal" href="#wf-autogen-flask"><em>Autogenerating the code</em></a> that the user provides
a file <tt class="docutils literal"><span class="pre">view_results.html</span></tt> for defining how the returned object
from the <tt class="docutils literal"><span class="pre">compute</span></tt> function is to be rendered.</p>
<p>Test the code generator on the <tt class="docutils literal"><span class="pre">compute</span></tt> function in the <tt class="docutils literal"><span class="pre">vib1</span></tt>
application to check that the generated
<tt class="docutils literal"><span class="pre">model.py</span></tt> and <tt class="docutils literal"><span class="pre">controller.py</span></tt> files are correct.
Filename: <tt class="docutils literal"><span class="pre">generate_flask.py</span></tt>.</p>
</div>
</div>
<div class="section" id="resources-3">
<h2>Resources  (3)<a class="headerlink" href="#resources-3" title="Permalink to this headline">¶</a></h2>
<div class="section" id="flask-resources">
<h3>Flask resources<a class="headerlink" href="#flask-resources" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://flask.pocoo.org/">Flask website</a></li>
<li><a class="reference external" href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world">The Flask Mega-Tutorial</a> by Miguel Grinberg</li>
<li><a class="reference external" href="http://wtforms.simplecodes.com/docs/0.6/index.html">WTForms Documentation</a></li>
<li><a class="reference external" href="http://jinja.pocoo.org/docs/">The Jinja2 templating language</a></li>
<li><a class="reference external" href="http://werkzeug.pocoo.org/">The Werkzeug library</a></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="django-resources">
<h3>Django resources<a class="headerlink" href="#django-resources" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://www.djangoproject.com/">Django webpage</a></li>
<li><a class="reference external" href="https://code.djangoproject.com/wiki/Tutorials">Web tutorials</a></li>
<li><a class="reference external" href="http://www.youtube.com/playlist?list=PL385A53B00B8B158E">YouTube videos</a></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="remaining">
<h2>Remaining<a class="headerlink" href="#remaining" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>apply (generated apps) to simviz (make py simviz too and describe that)</li>
<li>store data in database</li>
<li>discuss list values read as text and use of eval, perhaps exercise</li>
<li>avoid Flask or Django in exercises, just do not specify and have
common exercises at the very end</li>
<li>app: username, TextAreaField, store in database and retrieve for admin</li>
</ul>
</div></blockquote>
</div>
</div>


                </div>
              </div>
            </div>
          </div>
        </div>
        
        
      </div><!-- /row -->

      <!-- row -->
      <div class="row-fluid">
<div class="related navbar ">
  <div class="navbar-inner">
    <ul class="nav pull-right">
      
        <li><a href="genindex.html" title="General Index" >index</a></li>
        <li><a href="._web4sa000.html" title="&lt;no title&gt;" >previous</a></li>
        <li><a href="index.html">Using Web Frameworks for Scientific Applications</a></li> 
      
    </ul>
  </div>
</div>
      </div><!-- /row -->

      <!-- footer -->
      <footer>
          &copy; Copyright 2015, H. P. Langtangen and A. E. Johansen.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3.
      </footer>
      <!-- /footer -->

    </div>
    <!-- /container -->

  </body>
</html>