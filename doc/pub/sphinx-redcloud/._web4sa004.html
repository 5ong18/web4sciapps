

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Handling multiple input variables in Flask &mdash; Using Web Frameworks for Scientific Applications</title>
    
    <link rel="stylesheet" href="_static/cloud.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="_static/cloud.js"></script>

        <script src="http://sagecell.sagemath.org/static/jquery.min.js"></script>
        <script src="http://sagecell.sagemath.org/static/embedded_sagecell.js"></script>

        <script>sagecell.makeSagecell({inputLocation: ".sage"});</script>

        <style type="text/css">
                .sagecell .CodeMirror-scroll {
                        overflow-y: hidden;
                        overflow-x: auto;
                }
                .sagecell .CodeMirror {
                        height: auto;
                }
        </style>

    
    <link rel="top" title="Using Web Frameworks for Scientific Applications" href="index.html" />
    <link rel="next" title="Handling multiple input variables in Django" href="._web4sa005.html" />
    <link rel="prev" title="Making a Django application" href="._web4sa003.html" />
 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body role="document">
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="._web4sa005.html" title="Handling multiple input variables in Django"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="._web4sa003.html" title="Making a Django application"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">Using Web Frameworks for Scientific Applications</a> &raquo;</li>
 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="handling-multiple-input-variables-in-flask">
<span id="wf-vib-flask"></span><h1>Handling multiple input variables in Flask<a class="headerlink" href="#handling-multiple-input-variables-in-flask" title="Permalink to this headline">¶</a></h1>
<p>The scientific hello world example shows how to work with one input
variable and one output variable. We can easily derive an extensible
recipe for apps with a collection of input variables and some
associated HTML code as result. Multiple input variables are listed
in the <code class="docutils literal"><span class="pre">InputForm</span></code> class using different types for different forms
(text field, float field, integer field, check box field for boolean
values, etc.).  The value of these variables will be available in a
<code class="docutils literal"><span class="pre">form</span></code> object for computation. It is then a matter of setting
up a template code where the various variables if the <code class="docutils literal"><span class="pre">form</span></code> object
are formatted in HTML code as desired.</p>
<p>Our sample web application
addresses the task of plotting the function <span class="math">\(u(t)=Ae^{-bt}\sin (wt)\)</span> for
<span class="math">\(t\in [0,T]\)</span>. The web application must have fields for the numbers <span class="math">\(A\)</span>,
<span class="math">\(b\)</span>, <span class="math">\(w\)</span>, and <span class="math">\(T\)</span>, and a <em>Compute</em> button, as shown in Figure
<a class="reference internal" href="#wf-vib1-flask-fig-input"><span class="std std-ref">The input page</span></a>. Filling in values, say <span class="math">\(0.1\)</span> for <span class="math">\(b\)</span> and
<span class="math">\(20\)</span> for <span class="math">\(T\)</span>, results in what we see in Figure <a class="reference internal" href="#wf-vib1-flask-fig-result"><span class="std std-ref">The result page</span></a>,
i.e., a plot of <span class="math">\(u(t)\)</span> is added after the input fields and the <em>Compute</em>
button.</p>
<div class="figure" id="id1">
<span id="wf-vib1-flask-fig-input"></span><a class="reference internal image-reference" href="_images/vib1_flask_input.png"><img alt="_images/vib1_flask_input.png" src="_images/vib1_flask_input.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-text"><em>The input page</em></span></p>
</div>
<div class="figure" id="id2">
<span id="wf-vib1-flask-fig-result"></span><a class="reference internal image-reference" href="_images/vib1_flask_output.png"><img alt="_images/vib1_flask_output.png" src="_images/vib1_flask_output.png" style="width: 700px;" /></a>
<p class="caption"><span class="caption-text"><em>The result page</em></span></p>
</div>
<p>We shall make a series of different versions of this app:</p>
<ol class="arabic simple">
<li><code class="docutils literal"><span class="pre">vib1</span></code> for the basic set-up and illustration of tailoring the HTML code.</li>
<li><code class="docutils literal"><span class="pre">vib2</span></code> for custom validation of input, governed by the programmer,
and inlined graphics in the HTML code.</li>
<li><code class="docutils literal"><span class="pre">gen</span></code> for automatic generation of the Flask app (!).</li>
<li><code class="docutils literal"><span class="pre">login</span></code> for storing computed results in user accounts.</li>
</ol>
<div class="section" id="programming-the-flask-application-2">
<span id="wf-vib1-flask-app"></span><h2>Programming the Flask application  (2)<a class="headerlink" href="#programming-the-flask-application-2" title="Permalink to this headline">¶</a></h2>
<p>The forthcoming text explains the necessary steps to realize a
Flask app that behaves as depicted in Figures <a class="reference internal" href="#wf-vib1-flask-fig-input"><span class="std std-ref">The input page</span></a>
and <a class="reference internal" href="#wf-vib1-flask-fig-result"><span class="std std-ref">The result page</span></a>. We start with the
<code class="docutils literal"><span class="pre">compute.py</span></code> module since it contains only the computation of <span class="math">\(u(t)\)</span>
and the making of the plot, without any interaction with Flask.</p>
<p>The files associated with this app are found in the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib1">vib1</a> directory.</p>
<div class="section" id="the-compute-part-1">
<h3>The compute part  (1)<a class="headerlink" href="#the-compute-part-1" title="Permalink to this headline">¶</a></h3>
<p>More specifically, inside <code class="docutils literal"><span class="pre">compute.py</span></code>, we have a function for
evaluating <span class="math">\(u(t)\)</span> and a <code class="docutils literal"><span class="pre">compute</span></code> function for making the plot. The
return value of the latter is the name of the plot file, which should
get a unique name every time the <code class="docutils literal"><span class="pre">compute</span></code> function is called such
that the browser cannot reuse an already cached image when displaying
the plot. Flask
applications must have all extra files (CSS, images, etc.) in a
subdirectory <code class="docutils literal"><span class="pre">static</span></code>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">linspace</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">glob</span>

<span class="k">def</span> <span class="nf">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  <span class="c"># needed to avoid adding curves in plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;A=</span><span class="si">%g</span><span class="s">, b=</span><span class="si">%g</span><span class="s">, w=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Remove old plot files</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;*.png&#39;</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c"># Use time since Jan 1, 1970 in filename in order make</span>
    <span class="c"># a unique filename that the browser has not chached</span>
    <span class="n">plotfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">+</span> <span class="s">&#39;.png&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plotfile</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">compute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition-avoid-file-writing admonition" id="index-0">
<p class="first admonition-title">Avoid file writing</p>
<p class="last">It is in general not a good idea to write plots to file or let a
web app write to file. If this app is deployed at some web site and
multiple users are running the app, the <code class="docutils literal"><span class="pre">os.remove</span></code> statements may remove
plots created by all other users. However, the app is useful as a
graphical user interface run locally on a machine.
Later, we shall avoid writing plot files and instead
store plots in strings and embed the strings
in the <code class="docutils literal"><span class="pre">img</span></code> tag in the HTML code.</p>
</div>
<p>We organize the model, view, and controller as three separate
files, as illustrated in
the section <a class="reference internal" href="._web4sa002.html#wf-hw3-flask"><span class="std std-ref">Splitting the app into model, view, and controller files</span></a>. This more complicated app involves
more code and especially the model will soon be handy to isolate in its own
file.</p>
</div>
<div class="section" id="the-model-2">
<h3>The model  (2)<a class="headerlink" href="#the-model-2" title="Permalink to this headline">¶</a></h3>
<p>Our first version of <code class="docutils literal"><span class="pre">model.py</span></code> reads</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">validators</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;amplitude (m)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;damping factor (kg/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;frequency (1/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;time interval (s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
</pre></div>
</div>
<p>As seen, the field classes can take a <code class="docutils literal"><span class="pre">label</span></code> argument for a longer
description, here also including the units in which the variable is
measured. It is also possible to add a <code class="docutils literal"><span class="pre">description</span></code> argument with
some help message. Furthermore, we include a <code class="docutils literal"><span class="pre">default</span></code> value, which
will appear in the text field such that the user does not need to
fill in all values.</p>
</div>
<div class="section" id="the-view-2">
<span id="index-1"></span><h3>The view  (2)<a class="headerlink" href="#the-view-2" title="Permalink to this headline">¶</a></h3>
<p>The view component will of course make use of templates, and we shall experiment
with different templates. Therefore, we allow a command-line argument
to this Flask app for choosing which template we want. The rest of
the <code class="docutils literal"><span class="pre">controller.py</span></code> file follows much the same set up as for the scientific
hello world app:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">InputForm</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">&#39;view_plain&#39;</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="k">if</span> <span class="n">template_name</span> <span class="o">==</span> <span class="s">&#39;view_flask_bootstrap&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
    <span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/vib1&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template_name</span> <span class="o">+</span> <span class="s">&#39;.html&#39;</span><span class="p">,</span>
                           <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-html-template-1">
<h3>The HTML template  (1)<a class="headerlink" href="#the-html-template-1" title="Permalink to this headline">¶</a></h3>
<p>The details governing how the web page really looks like lie in the
template file. Since we have several fields and want them nicely
align in a tabular fashion, we place the field name, text areas,
and labels inside an HTML table in our first attempt to write a
template, <code class="docutils literal"><span class="pre">view_plain.html</span></code>:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;&lt;td&gt;</span>{{ field }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Compute</span><span class="nt">&gt;&lt;/form&gt;&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>Observe how easy it is to iterate over the <code class="docutils literal"><span class="pre">form</span></code> object and grab data
for each field: <code class="docutils literal"><span class="pre">field.name</span></code> is the name of the variable in the
<code class="docutils literal"><span class="pre">InputForm</span></code> class, <code class="docutils literal"><span class="pre">field.label</span></code> is the full name with units as given
through the <code class="docutils literal"><span class="pre">label</span></code> keyword when constructing the field object, and
writing the field object itself generates the text area for
input (i.e., the HTML input form). The control statements we can
use in the template are part of the <a class="reference external" href="http://jinja.pocoo.org/docs/">Jinja2</a>
templating language. For now, the if-test, for-loop and
output of values (<code class="docutils literal"><span class="pre">{{</span> <span class="pre">object</span> <span class="pre">}}</span></code>) are enough to generate the HTML
code we want.</p>
<p>Recall that the objects we need in the template, like <code class="docutils literal"><span class="pre">result</span></code> and <code class="docutils literal"><span class="pre">form</span></code>
in the present case, are transferred to the template via keyword
arguments to the <code class="docutils literal"><span class="pre">render_template</span></code> function. We can easily pass on
any object in our application to the template. Debugging of the template
is done by viewing the HTML source of the web page in the browser.</p>
<p>You are encouraged to go to the <code class="docutils literal"><span class="pre">vib</span></code> directory,
run <code class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span></code>, and load</p>
<div class="highlight-text"><div class="highlight"><pre>`http://127.0.0.1:5000/vib1`
</pre></div>
</div>
<p>into your web browser for testing.</p>
</div>
</div>
<div class="section" id="implementing-error-checking-in-the-template">
<h2>Implementing error checking in the template<a class="headerlink" href="#implementing-error-checking-in-the-template" title="Permalink to this headline">¶</a></h2>
<p id="index-2">What happens if the user gives wrong input, for instance the letters <code class="docutils literal"><span class="pre">asd</span></code>
instead of a number? Actually nothing! The <code class="docutils literal"><span class="pre">FloatField</span></code> object
checks that the input is compatible with a real number in the
<code class="docutils literal"><span class="pre">form.validate()</span></code> call, but returns just <code class="docutils literal"><span class="pre">False</span></code> if this is not
the case. Looking at the code in <code class="docutils literal"><span class="pre">controller.py</span></code>,</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
</pre></div>
</div>
<p>we realize that wrong input implies <code class="docutils literal"><span class="pre">result</span> <span class="pre">=</span> <span class="pre">None</span></code> and no computations
and no plot! Fortunately, each field object gets an attribute <code class="docutils literal"><span class="pre">error</span></code>
with information on errors that occur on input. We can write out
this information on the web page, as exemplified in the template
<code class="docutils literal"><span class="pre">view_errcheck.html</span></code>:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;&lt;td&gt;</span>{{ field(size=12) }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
    {% if field.errors %}
      <span class="nt">&lt;td&gt;&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
      {% for error in field.errors %}
        <span class="nt">&lt;li&gt;&lt;font</span> <span class="na">color=</span><span class="s">&quot;red&quot;</span><span class="nt">&gt;</span>{{ error }}<span class="nt">&lt;/font&gt;&lt;/li&gt;</span>
      {% endfor %}<span class="nt">&lt;/ul&gt;&lt;/td&gt;</span>
    {% endif %}
    <span class="nt">&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Compute</span><span class="nt">&gt;&lt;/form&gt;&lt;/p&gt;</span>
<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>Two things are worth noticing here:</p>
<ol class="arabic simple">
<li>We can control the width of the text field where the
user writes the numbers, here set to 12 characters.</li>
<li>We can make an extra column in the HTML table with a list
of possible errors for each field object.</li>
</ol>
<p>Let us test the error handling of the <code class="docutils literal"><span class="pre">A</span></code> field by
writing <code class="docutils literal"><span class="pre">asd</span></code> instead of a number. This input
triggers an error, whose message is written in red to the right of the label,
see Figure <a class="reference internal" href="#wf-vib1-flask-fig-error1"><span class="std std-ref">Error message because of wrong input</span></a>.</p>
<div class="figure" id="id3">
<span id="wf-vib1-flask-fig-error1"></span><a class="reference internal image-reference" href="_images/vib1_flask_error1.png"><img alt="_images/vib1_flask_error1.png" src="_images/vib1_flask_error1.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-text"><em>Error message because of wrong input</em></span></p>
</div>
<p>It is possible to use the additional HTML5 fields for input in a Flask
context. Instead of explaining how here, we recommend to use the
<a class="reference external" href="https://github.com/hplgit/parampool">Parampool</a>
package to automatically generate Flask files with HTML5 fields.</p>
</div>
<div class="section" id="using-style-sheets">
<h2>Using style sheets<a class="headerlink" href="#using-style-sheets" title="Permalink to this headline">¶</a></h2>
<p id="index-3">Web developers make heavy use of CSS style sheets to control the look
and feel of web pages. Templates can utilize style sheets as any other
standard HTML code. Here is a very simple example where we introduce
a class <code class="docutils literal"><span class="pre">name</span></code> for the HTML table&#8217;s column with the field name and set the
foreground color of the text in this column to blue.
The style sheet is called <code class="docutils literal"><span class="pre">basic.css</span></code> and <em>must</em> reside in the
<code class="docutils literal"><span class="pre">static</span></code> subdirectory of the Flask application directory. The content
of <code class="docutils literal"><span class="pre">basic.css</span></code> is just the line</p>
<div class="highlight-text"><div class="highlight"><pre>td.name { color: blue; }
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">view_css.html</span></code> file using this style sheet features a <code class="docutils literal"><span class="pre">link</span></code> tag
to the style sheet in the HTML header, and the column containing
the field name has
the HTML tag <code class="docutils literal"><span class="pre">&lt;td</span> <span class="pre">class=&quot;name&quot;&gt;</span></code> to trigger the specification in
the style sheet:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
<span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;static/basic.css&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field(size=12) }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
</pre></div>
</div>
<p>Just run <code class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span> <span class="pre">view_css</span></code> to see that the names
of the variables to set in the web page are blue.</p>
</div>
<div class="section" id="using-latex-mathematics">
<h2>Using LaTeX mathematics<a class="headerlink" href="#using-latex-mathematics" title="Permalink to this headline">¶</a></h2>
<p id="index-4">Scientific applications frequently have many input data that are
defined through mathematics and where the typesetting on the
web page should be as close as possible to the typesetting where
the mathematics is documented. In the present example we would like
to typeset <span class="math">\(A\)</span>, <span class="math">\(b\)</span>, <span class="math">\(w\)</span>, and <span class="math">\(T\)</span> with italic font as done
in LaTeX. Fortunately, native LaTeX typesetting is available in
HTML through the tool <a class="reference external" href="http://www.mathjax.org/">MathJax</a>.
Our template <code class="docutils literal"><span class="pre">view_tex.html</span></code> enables MathJax. Formulas are written
with standard LaTeX inside <code class="docutils literal"><span class="pre">\(</span></code> and <code class="docutils literal"><span class="pre">\)</span></code>, while equations are surrounded
by <code class="docutils literal"><span class="pre">$$</span></code>. Here we use formulas only:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
 <span class="na">src=</span><span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>\( {{ field.name }} \)<span class="nt">&lt;/td&gt;&lt;td&gt;</span>{{ field(size=12) }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
</pre></div>
</div>
<p>Figure <a class="reference internal" href="#wf-vib1-flask-fig-latex"><span class="std std-ref">LaTeX typesetting of mathematical symbols</span></a> displays how the
LaTeX rendering looks like in the browser.</p>
<div class="figure" id="id4">
<span id="wf-vib1-flask-fig-latex"></span><a class="reference internal image-reference" href="_images/vib1_flask_latex.png"><img alt="_images/vib1_flask_latex.png" src="_images/vib1_flask_latex.png" style="width: 650px;" /></a>
<p class="caption"><span class="caption-text"><em>LaTeX typesetting of mathematical symbols</em></span></p>
</div>
</div>
<div class="section" id="rearranging-the-elements-in-the-html-template">
<h2>Rearranging the elements in the HTML template<a class="headerlink" href="#rearranging-the-elements-in-the-html-template" title="Permalink to this headline">¶</a></h2>
<p>Now we want to place the plot to the right of the input forms in
the web page, see Figure <a class="reference internal" href="#wf-vib1-flask-fig-sidebyside"><span class="std std-ref">New design with input and output side by side</span></a>. This can
be accomplished by having an outer table with two rows. The first
row contains the table with the input forms in the first column and
the plot in the second column, while the second row features the
<em>Compute</em> button in the first column.</p>
<div class="figure" id="id5">
<span id="wf-vib1-flask-fig-sidebyside"></span><a class="reference internal image-reference" href="_images/vib1_flask_table2.png"><img alt="_images/vib1_flask_table2.png" src="_images/vib1_flask_table2.png" style="width: 700px;" /></a>
<p class="caption"><span class="caption-text"><em>New design with input and output side by side</em></span></p>
</div>
<p>The enabling template file is <code class="docutils literal"><span class="pre">view_table.html</span></code>:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
 <span class="na">src=</span><span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span> <span class="c">&lt;!-- table with forms to the left and plot to the right --&gt;</span>
<span class="nt">&lt;tr&gt;&lt;td&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td&gt;</span>\( {{ field.name }} \)<span class="nt">&lt;/td&gt;&lt;td&gt;</span>{{ field(size=12) }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
    {% if field.errors %}
      <span class="nt">&lt;td&gt;&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
      {% for error in field.errors %}
        <span class="nt">&lt;li&gt;&lt;font</span> <span class="na">color=</span><span class="s">&quot;red&quot;</span><span class="nt">&gt;</span>{{ error }}<span class="nt">&lt;/font&gt;&lt;/li&gt;</span>
      {% endfor %}<span class="nt">&lt;/ul&gt;&lt;/td&gt;</span>
    {% endif %}
    <span class="nt">&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/td&gt;</span>

<span class="nt">&lt;td&gt;</span>
<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td&gt;&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Compute</span><span class="nt">&gt;&lt;/p&gt;&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="bootstrap-html-style">
<h2>Bootstrap HTML style<a class="headerlink" href="#bootstrap-html-style" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="http://getbootstrap.com/">Bootstrap</a> framework for creating web pages
has been very popular in recent years, both because of the design and
the automatic support for responsive pages on all sorts of devices.
Bootstrap can easily be used in combination with Flask. The template file
<code class="docutils literal"><span class="pre">view_bootstrap.html</span></code> is identical to the former <code class="docutils literal"><span class="pre">view_table.html</span></code>,
except that we load the Bootstrap CSS file and include in comments
how to add the typical navigation bar found in many Bootstrap-based
web pages. Moreover, we use the grid layout functionality of Bootstrap
to control the placement of elements (name, input field, label,
and error message) in the input form.</p>
<p>The template looks like</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>


<span class="nt">&lt;link</span> <span class="na">href=</span>
<span class="s">&quot;http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css&quot;</span>
<span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span>
<span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>
<span class="c">&lt;!--</span>
<span class="c">&lt;nav class=&quot;navbar navbar-default&quot; role=&quot;navigation&quot;&gt;</span>
<span class="c">&lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;bs-example-navbar-collapse-1&quot;&gt;</span>
<span class="c">    &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span>
<span class="c">       {% for text, url in some_sequence %}</span>
<span class="c">       &lt;li&gt;&lt;a href=&quot;/{{url}}&quot;&gt;{{ text }}&lt;/a&gt;&lt;/li&gt;</span>
<span class="c">       {% endfor %}</span>
<span class="c">       &lt;/ul&gt;</span>
<span class="c">&lt;/div&gt;</span>
<span class="c">&lt;/nav&gt;</span>
<span class="c">--&gt;</span>

<span class="nt">&lt;h2&gt;</span>Damped sine wave<span class="nt">&lt;/h2&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;navbar-form navbar-top&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-group&quot;</span><span class="nt">&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;input-group&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;col-xs-1 control-label&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;input-group-addon&quot;</span><span class="nt">&gt;</span> \( {{ field.name }} \) <span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-xs-2&quot;</span><span class="nt">&gt;</span>
      {{ field(class_=&quot;form-control&quot;) }}
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-xs-3&quot;</span><span class="nt">&gt;</span>
        {{ field.label }}
      <span class="nt">&lt;/div&gt;</span>
      {% if field.errors %}
        {% for error in field.errors %}
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-xs-3&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;color: red;&quot;</span><span class="nt">&gt;</span>{{ error }}<span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        {% endfor %}
      {% endif %}
     <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  {% endfor %}
<span class="nt">&lt;br/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Compute&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-default&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The input fields and fonts now get the typical Bootstrap look and feel:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/vib1_flask_bootstrap.png"><img alt="_images/vib1_flask_bootstrap.png" src="_images/vib1_flask_bootstrap.png" style="width: 800px;" /></a>
</div>
<p>The only special feature in this template is the need to pass a CSS
class <code class="docutils literal"><span class="pre">form-control</span></code> to the field object in the part that defines
the input field. We also use the standard <code class="docutils literal"><span class="pre">input-group-addon</span></code> style
in the name part of the Bootstrap form. A heading <em>Damped sine wave</em> was
added to demonstrate the Bootstrap fonts.</p>
<p>It is easy to switch to other Bootstrap styles, e.g., those in the
&#8220;Bootswatch family&#8221;: &#8220;<a class="reference external" href="http:bootswatch.com">http:bootswatch.com</a>&#8221;:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;link</span> <span class="na">href=</span>
<span class="s">&quot;http://netdna.bootstrapcdn.com/bootswatch/3.1.1/X/bootstrap.min.css&quot;</span>
<span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>
<p>where <code class="docutils literal"><span class="pre">X</span></code> can be <code class="docutils literal"><span class="pre">journal</span></code>, <code class="docutils literal"><span class="pre">cosmo</span></code>, <code class="docutils literal"><span class="pre">flatly</span></code>, and other legal
Bootswatch styles. The journal style looks like this:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/vib1_flask_bootswatch_journal.png"><img alt="_images/vib1_flask_bootswatch_journal.png" src="_images/vib1_flask_bootswatch_journal.png" style="width: 800px;" /></a>
</div>
<p>While <code class="docutils literal"><span class="pre">view_bootstrap.html</span></code> makes use of plain Bootstrap HTML code, there is
also a higher-level framework, called <a class="reference external" href="http://pythonhosted.org/Flask-Bootstrap/">Flask-Bootstrap</a> that combines Flask and Bootstrap. Installation of
this extension is done by <code class="docutils literal"><span class="pre">sudo</span> <span class="pre">pip</span> <span class="pre">install</span> <span class="pre">flask-bootstrap</span></code>.</p>
<p>After <code class="docutils literal"><span class="pre">app</span> <span class="pre">=</span> <span class="pre">Flask(__name__)</span></code> we need to do</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask_bootstrap</span> <span class="kn">import</span> <span class="n">Bootstrap</span>
<span class="n">Bootstrap</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</pre></div>
</div>
<p>The template employs new keywords <code class="docutils literal"><span class="pre">extends</span></code> and <code class="docutils literal"><span class="pre">block</span></code>:</p>
<div class="highlight-html"><div class="highlight"><pre>{% extends &quot;bootstrap/base.html&quot; %}

{% block styles %}
{{super()}}
<span class="nt">&lt;style&gt;</span>
    <span class="nc">.appsize</span> <span class="p">{</span> <span class="k">width</span><span class="o">:</span> <span class="m">800px</span> <span class="p">}</span>
<span class="nt">&lt;/style&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span>
<span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>
{% endblock %}

<span class="c">&lt;!--</span>
<span class="c">{% block navbar %}</span>
<span class="c">&lt;nav class=&quot;navbar navbar-default&quot; role=&quot;navigation&quot;&gt;</span>
<span class="c">&lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;bs-example-navbar-collapse-1&quot;&gt;</span>
<span class="c">    &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span>
<span class="c">       {% for f in some_sequence %}</span>
<span class="c">       &lt;li&gt;&lt;a href=&quot;/{{f}}&quot;&gt;{{f}}&lt;/a&gt;&lt;/li&gt;</span>
<span class="c">       {% endfor %}</span>
<span class="c">       &lt;/ul&gt;</span>
<span class="c">&lt;/div&gt;</span>
<span class="c">&lt;/nav&gt;</span>
<span class="c">{% endblock %}</span>
<span class="c">--&gt;</span>

{% block content %}

<span class="nt">&lt;h2&gt;</span>Damped sine wave<span class="nt">&lt;/h2&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;navbar-form navbar-top&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-group&quot;</span><span class="nt">&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;row&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;input-group appsize&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;label</span> <span class="na">class=</span><span class="s">&quot;col-sm-1 control-label&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;input-group-addon&quot;</span><span class="nt">&gt;</span> \( {{ field.name }} \) <span class="nt">&lt;/span&gt;</span>
      <span class="nt">&lt;/label&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-sm-4&quot;</span><span class="nt">&gt;</span>
      {{ field(class_=&quot;form-control&quot;) }}
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-sm-4&quot;</span><span class="nt">&gt;</span>
        {{ field.label }}
      <span class="nt">&lt;/div&gt;</span>
      {% if field.errors %}
        {% for error in field.errors %}
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;col-sm-3&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;color: red;&quot;</span><span class="nt">&gt;</span>{{ error }}<span class="nt">&lt;/div&gt;</span>
          <span class="nt">&lt;/div&gt;</span>
        {% endfor %}
      {% endif %}
     <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  {% endfor %}
<span class="nt">&lt;br/&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Compute&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-default&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>

<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
{% endif %}
<span class="nt">&lt;/html&gt;</span>
{% endblock %}
</pre></div>
</div>
<p>It is important to have the MathJax script declaration and all styles within
<code class="docutils literal"><span class="pre">{%</span> <span class="pre">block</span> <span class="pre">styles</span> <span class="pre">%}</span></code>.</p>
<p>It seems easier to apply plain Bootstrap HTML code than the
functionality in the Flask-Bootstrap layer.</p>
</div>
<div class="section" id="custom-validation-1">
<span id="wf-vib1-flask-validation"></span><h2>Custom validation  (1)<a class="headerlink" href="#custom-validation-1" title="Permalink to this headline">¶</a></h2>
<p id="index-5">The <code class="docutils literal"><span class="pre">FloatField</span></code> objects can check that the input is compatible with
a number, but what if we want to control that <span class="math">\(A&gt;0\)</span>, <span class="math">\(b&gt;0\)</span>, and
<span class="math">\(T\)</span> is not greater than 30 periods (otherwise the plot gets cluttered)?
We can write functions for checking appropriate conditions and
supply the function to the list of validator functions in the call to
the <code class="docutils literal"><span class="pre">FloatField</span></code> constructor or other field constructors. The extra
code is a part of the <code class="docutils literal"><span class="pre">model.py</span></code> and the presented extensions appear
in the directory <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib2">vib2</a>.</p>
<div class="section" id="using-flask-validators">
<h3>Using Flask validators<a class="headerlink" href="#using-flask-validators" title="Permalink to this headline">¶</a></h3>
<p>The simplest approach to validation is to use existing functionality
in the web framework. Checking that <span class="math">\(A&gt;0\)</span> can be done by
the <code class="docutils literal"><span class="pre">NumberRange</span></code> validator which checks that the value is inside
a prescribed interval:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">wtforms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">FloatField</span><span class="p">,</span> <span class="n">validators</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;amplitude (m)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">NumberRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1E+20</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="section" id="tailored-validation">
<h3>Tailored validation<a class="headerlink" href="#tailored-validation" title="Permalink to this headline">¶</a></h3>
<p>We can also easily provide our own more tailored validators.
As an example, let us explain how we can check that <span class="math">\(T\)</span> is less than 30 periods.
One period is <span class="math">\(2\pi /w\)</span> so we need to check if <span class="math">\(T&gt; 30\cdot 2\pi/w\)</span>
and raise an exception in that case.
A validation function takes two arguments: the whole <code class="docutils literal"><span class="pre">form</span></code> and the
specific <code class="docutils literal"><span class="pre">field</span></code> to test:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_T</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Form validation: failure if T &gt; 30 periods.&quot;&quot;&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span>
    <span class="n">period</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">w</span>
    <span class="k">if</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="o">*</span><span class="n">period</span><span class="p">:</span>
        <span class="n">num_periods</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">T</span><span class="o">/</span><span class="n">period</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">validators</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">&#39;Cannot plot as much as </span><span class="si">%d</span><span class="s"> periods! T&lt;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">num_periods</span><span class="p">,</span> <span class="mi">30</span><span class="o">*</span><span class="n">period</span><span class="p">))</span>
</pre></div>
</div>
<p>The appropriate exception is of type <code class="docutils literal"><span class="pre">validators.ValidationError</span></code>.
Observe that through <code class="docutils literal"><span class="pre">form</span></code> we have in fact access to all the input
data so we can easily use the value of <span class="math">\(w\)</span> when checking the validity
of the value of <span class="math">\(T\)</span>. The <code class="docutils literal"><span class="pre">check_T</span></code> function is easy to
add to the list of validator functions in the call to the <code class="docutils literal"><span class="pre">FloatField</span></code>
constructor for <code class="docutils literal"><span class="pre">T</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;time interval&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">6</span><span class="o">*</span><span class="n">pi</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">(),</span> <span class="n">check_T</span><span class="p">])</span>
</pre></div>
</div>
<p>The validator
objects are tested one by one as they appear in the list, and if
one fails, the others are not invoked.
We therefore add <code class="docutils literal"><span class="pre">check_T</span></code> after the check of input such that we know we
have a value for all data when we run the computations and test
in <code class="docutils literal"><span class="pre">check_T</span></code>.</p>
</div>
<div class="section" id="tailored-validation-of-intervals">
<h3>Tailored validation of intervals<a class="headerlink" href="#tailored-validation-of-intervals" title="Permalink to this headline">¶</a></h3>
<p>Although there is already a <code class="docutils literal"><span class="pre">NumberRange</span></code> validator for checking
whether a value is inside an interval, we can write our own
version with some improved functionality for open intervals where
the maximum or minimum value can be infinite.
The infinite value can on input be represented by <code class="docutils literal"><span class="pre">None</span></code>.
A general such function may take the form</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">check_interval</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For validation: failure if value is outside an interval.&quot;&quot;&quot;</span>
    <span class="n">failure</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">min_value</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">max_value</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">if</span> <span class="n">failure</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">validators</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span>
            <span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s"> not in [</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
             <span class="s">&#39;-infty&#39;</span> <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_value</span><span class="p">),</span>
             <span class="s">&#39;infty&#39;</span>  <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_value</span><span class="p">)))</span>
</pre></div>
</div>
<p id="index-6">The problem is that <code class="docutils literal"><span class="pre">check_interval</span></code> takes four arguments, not only
the <code class="docutils literal"><span class="pre">form</span></code> and <code class="docutils literal"><span class="pre">field</span></code> arguments that a validator function in the
Flask framework can accept.
The way out of this difficulty is to use a Python tool <code class="docutils literal"><span class="pre">functools.partial</span></code>
which allows us to call a function with some of the arguments set beforehand.
Here, we want to create a new function that calls <code class="docutils literal"><span class="pre">check_interval</span></code>
with some prescribed values of <code class="docutils literal"><span class="pre">min_value</span></code> and <code class="docutils literal"><span class="pre">max_value</span></code>.
This function looks like it does not have these arguments, only
<code class="docutils literal"><span class="pre">form</span></code> and <code class="docutils literal"><span class="pre">field</span></code>. The following function produces this function, which we
can use as a valid Flask validator function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">functools</span>

<span class="k">def</span> <span class="nf">interval</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
        <span class="n">check_interval</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="n">max_value</span><span class="p">)</span>
</pre></div>
</div>
<p>We can now in any field constructor just add
<code class="docutils literal"><span class="pre">interval(a,</span> <span class="pre">b)</span></code> as a validator function, here checking that <span class="math">\(b\in [0,\infty)\)</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">FloatField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;damping factor (kg/s)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">(),</span> <span class="n">interval</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">None</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="section" id="demo">
<h3>Demo<a class="headerlink" href="#demo" title="Permalink to this headline">¶</a></h3>
<p>Let us test our tailored error checking. Run <code class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span></code>
in the <code class="docutils literal"><span class="pre">vib2</span></code> directory and fill in <span class="math">\(-1.0\)</span> in the <span class="math">\(b\)</span> field.
Pressing <em>Compute</em> invokes our <code class="docutils literal"><span class="pre">interval(0,None)</span></code> function, which
is nothing but a call to <code class="docutils literal"><span class="pre">check_interval</span></code> with the
arguments <code class="docutils literal"><span class="pre">field</span></code>, <code class="docutils literal"><span class="pre">form</span></code>, <code class="docutils literal"><span class="pre">0</span></code>, and <code class="docutils literal"><span class="pre">None</span></code>.
Inside this function,
the test <code class="docutils literal"><span class="pre">if</span> <span class="pre">field.data</span> <span class="pre">&lt;</span> <span class="pre">min_value</span></code> becomes true, <code class="docutils literal"><span class="pre">failure</span></code>
is set, and the exception is raised. The message in the exception
is available in the <code class="docutils literal"><span class="pre">field.errors</span></code> attribute so our template
will write it out in red, see Figure <a class="reference internal" href="#wf-vib2-flask-fig-error1"><span class="std std-ref">Triggering of a user-defined error check</span></a>.
The template used in <code class="docutils literal"><span class="pre">vib2</span></code> is basically the same as <code class="docutils literal"><span class="pre">view_tex.html</span></code>
in <code class="docutils literal"><span class="pre">vib1</span></code>, i.e., it feaures LaTeX mathematics and checking of
<code class="docutils literal"><span class="pre">field.errors</span></code>.</p>
<div class="figure" id="id6">
<span id="wf-vib2-flask-fig-error1"></span><a class="reference internal image-reference" href="_images/vib2_flask_error1.png"><img alt="_images/vib2_flask_error1.png" src="_images/vib2_flask_error1.png" style="width: 500px;" /></a>
<p class="caption"><span class="caption-text"><em>Triggering of a user-defined error check</em></span></p>
</div>
<p>Finally, we mention a detail in the <code class="docutils literal"><span class="pre">controller.py</span></code> file in the <code class="docutils literal"><span class="pre">vib2</span></code>
app: instead of sending <code class="docutils literal"><span class="pre">form.var.data</span></code> to the <code class="docutils literal"><span class="pre">compute</span></code> function we
may automatically generate a set of local variables such that the
application of data from the web page, here in the <code class="docutils literal"><span class="pre">compute</span></code> call, looks nicer:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="c"># Make local variable (name field.name)</span>
            <span class="k">exec</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The idea is just to run <code class="docutils literal"><span class="pre">exec</span></code> on a declaration of a local variable
with name <code class="docutils literal"><span class="pre">field.name</span></code> for each field in the form. This trick is often
neat if web variables are buried in objects (<code class="docutils literal"><span class="pre">form.T.data</span></code>) and you want these
variables in your
code to look like they do in mathematical writing (<code class="docutils literal"><span class="pre">T</span></code> for <span class="math">\(T\)</span>).</p>
</div>
</div>
<div class="section" id="avoiding-plot-files">
<span id="wf-vib2-flask-nofiles"></span><h2>Avoiding plot files<a class="headerlink" href="#avoiding-plot-files" title="Permalink to this headline">¶</a></h2>
<p>Files with plots are easy to deal with as long as they are in the
<code class="docutils literal"><span class="pre">static</span></code> subdirectory of the Flask application directory. However,
as already pointed out, the previous <code class="docutils literal"><span class="pre">vib1</span></code> app, which writes plot
files, is not suited for multiple simultaneous users since every
user will destroy <em>all</em> existing plot files before making a new
one. Therefore, we need a robust solution for multiple users of
the app.</p>
<p>The idea is to not write plot files, but instead return the plot
as a string and embed that string directly in the HTML code.
This is relatively straightforward with Matplotlib
and Python. The relevant code is found in the <code class="docutils literal"><span class="pre">compute.py</span></code> file
of the <code class="docutils literal"><span class="pre">vib2</span></code> app.</p>
<span class="target" id="index-7"></span><span class="target" id="index-8"></span><span class="target" id="index-9"></span><span class="target" id="index-10"></span><div class="section" id="png-plots">
<span id="index-11"></span><h3>PNG plots<a class="headerlink" href="#png-plots" title="Permalink to this headline">¶</a></h3>
<p>Python has the <code class="docutils literal"><span class="pre">io.StringIO</span></code> object for writing text to a
string buffer with the same syntax as used for writing text to
files. For binary streams, such as PNG files, one can use
a similar object, <code class="docutils literal"><span class="pre">io.BytesIO</span></code>, to hold the stream (i.e., the plot file)
in memory. The idea is to let Matplotlib write to
a <code class="docutils literal"><span class="pre">io.BytesIO</span></code> object and afterwards extract the
series of bytes in the plot file from this object and embed it in
the HTML file directly. This approach avoids storing plots in separate
files, at the cost of bigger HTML files.</p>
<p>The first step is to let Matplotlib write the PNG data to
the <code class="docutils literal"><span class="pre">BytesIO</span></code> buffer:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plot</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="c"># run plt.plot, plt.title, etc.</span>
<span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
<span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># rewind to beginning of file</span>
<span class="n">figdata_png</span> <span class="o">=</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>  <span class="c"># extract string (stream of bytes)</span>
</pre></div>
</div>
<p>Before the PNG data can be embedded in HTML we need to convert the
data to base64 format:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">base64</span>
<span class="n">figdata_png</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">figdata_png</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can embed the PNG data in HTML by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;data:image/png;base64,PLOTSTR&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s">&quot;500&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where <code class="docutils literal"><span class="pre">PLOTSTR</span></code> is the content of the string <code class="docutils literal"><span class="pre">figdata_png</span></code>.</p>
<p>The complete <code class="docutils literal"><span class="pre">compute.py</span></code> function takes the form</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  <span class="c"># needed to avoid adding curves in plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;A=</span><span class="si">%g</span><span class="s">, b=</span><span class="si">%g</span><span class="s">, w=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>

    <span class="c"># Make Matplotlib write to BytesIO file object and grab</span>
    <span class="c"># return the object&#39;s string</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># rewind to beginning of file</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="n">figdata_png</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">figdata_png</span>
</pre></div>
</div>
<p>The relevant syntax in an HTML template is</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ results }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>
<p>if <code class="docutils literal"><span class="pre">results</span></code> holds the returned object from the <code class="docutils literal"><span class="pre">compute</span></code> function above.</p>
</div>
<div class="section" id="svg-plots">
<span id="index-12"></span><h3>SVG plots<a class="headerlink" href="#svg-plots" title="Permalink to this headline">¶</a></h3>
<p>Inline figures in HTML, instead of using files, are most often realized
by XML code with the figure data in SVG format.
Plot strings in the SVG format are created very similarly to the PNG
example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;svg&#39;</span><span class="p">)</span>
<span class="n">figdata_svg</span> <span class="o">=</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">figdata_svg</span></code> string contains XML code text can almost
be directly embedded in
HTML5. However, the beginning of the text contains information before
the <code class="docutils literal"><span class="pre">svg</span></code> tag that we want to remove:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
  &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Created with matplotlib (http://matplotlib.sourceforge.net/) --&gt;
&lt;svg height=&quot;441pt&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 585 441&quot; ...
</pre></div>
</div>
<p>The removal is done with a little string manipulation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">figdata_svg</span> <span class="o">=</span> <span class="s">&#39;&lt;svg&#39;</span> <span class="o">+</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;svg&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Now, <code class="docutils literal"><span class="pre">figdata_svg</span></code> can be directly inserted in HTML code without
any surrounding tags (because it is perfectly valid HTML code in itself).</p>
<p>The SVG code generated by Matplotlib may contain UTF-8 characters
so it is necessary to make a unicode string out of the text:
<code class="docutils literal"><span class="pre">unicode(figdata_svg,</span> <span class="pre">'utf-8')</span></code>, otherwise the HTML template will
lead to an encoding exception.</p>
<p>We have made an alternative compute function <code class="docutils literal"><span class="pre">compute_png_svg</span></code>
that returns both a PNG and an SVG plot:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">compute_png_svg</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;svg&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">figdata_svg</span> <span class="o">=</span> <span class="s">&#39;&lt;svg&#39;</span> <span class="o">+</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;svg&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">figdata_svg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">figdata_svg</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">figdata_png</span><span class="p">,</span> <span class="n">figdata_svg</span>
</pre></div>
</div>
<p id="index-13">The relevant syntax for inserting an SVG plot in the HTML template is now</p>
<div class="highlight-html"><div class="highlight"><pre>{{ result[1]|safe }}
</pre></div>
</div>
<p>The use of <code class="docutils literal"><span class="pre">safe</span></code> is essential here.</p>
<div class="admonition-important-use-safe-for-verbatim-html-code admonition">
<p class="first admonition-title">Important: use <code class="docutils literal"><span class="pre">safe</span></code> for verbatim HTML code</p>
<p class="last">Special HTML characters like <code class="docutils literal"><span class="pre">&lt;</span></code>, <code class="docutils literal"><span class="pre">&gt;</span></code>,
<code class="docutils literal"><span class="pre">&amp;</span></code>, <code class="docutils literal"><span class="pre">&quot;</span></code>, and <code class="docutils literal"><span class="pre">'</span></code> are escaped in a template string like <code class="docutils literal"><span class="pre">{{</span> <span class="pre">str</span> <span class="pre">}}</span></code>
(i.e., <code class="docutils literal"><span class="pre">&amp;</span></code> is replaced by <code class="docutils literal"><span class="pre">&amp;amp;</span></code> <cite>&lt;</cite> is replaced by <code class="docutils literal"><span class="pre">&amp;lt;</span></code>, etc.).
We need to avoid this manipulation of the string content
because <code class="docutils literal"><span class="pre">result[1]</span></code> contains
XML code where the mentioned characters are essential part of the syntax.
Writing <code class="docutils literal"><span class="pre">{{str|safe}}</span></code> ensures that the contents of the string <code class="docutils literal"><span class="pre">str</span></code>
are not altered before being embedded in the HTML text.</p>
</div>
<p>An alternative template, <code class="docutils literal"><span class="pre">view_svg.html</span></code> applies the SVG plot instead
of the PNG plot. We use the command-line argument <code class="docutils literal"><span class="pre">svg</span></code> for indicating
that we want an SVG instead of a PNG plot:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># SVG or PNG plot?</span>
<span class="n">svg</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;svg&#39;</span><span class="p">:</span>
        <span class="n">svg</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">if</span> <span class="n">svg</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute_png_svg</span> <span class="k">as</span> <span class="n">compute</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s">&#39;view_svg.html&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s">&#39;view.html&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="using-mpld3">
<span id="index-14"></span><h3>Using mpld3<a class="headerlink" href="#using-mpld3" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="http://mpld3.github.io">mpld3</a> library can convert Matplotlib
plots to HTML code that can be directly embedded in a web page. Here
is a basic example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Plot array y vs x</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span><span class="o">,</span> <span class="nn">mpld3</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">html_text</span> <span class="o">=</span> <span class="n">mpld3</span><span class="o">.</span><span class="n">fig_to_html</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
</pre></div>
</div>
<p>The string <code class="docutils literal"><span class="pre">html_text</span></code> contains all the HTML code that is needed to
display the plot.</p>
<p>The great advantage of the <code class="docutils literal"><span class="pre">mpld3</span></code> library is that it contains
capabilities for creating custom interactive plots through combining
Matplotlib with JavaScript, see the <a class="reference external" href="http://mpld3.github.io/examples/index.html#example-gallery">mpld3 Example Gallery</a>.</p>
</div>
</div>
<div class="section" id="plotting-with-the-bokeh-library">
<span id="wf-bokeh-flask"></span><h2>Plotting with the Bokeh library<a class="headerlink" href="#plotting-with-the-bokeh-library" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-15"></span><p id="index-16">As an alternative to using Matplotlib for plotting, we can utilize
the <a class="reference external" href="http://bokeh.pydata.org/en/latest/">Bokeh</a> tool, which is
particularly developed for graphics in web browsers.
The <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib3">vib3</a> app is similar to the
previously described <code class="docutils literal"><span class="pre">vib1</span></code> and <code class="docutils literal"><span class="pre">vib2</span></code> app, except that we make one plot with
Bokeh. Only the <code class="docutils literal"><span class="pre">compute.py</span></code> and <code class="docutils literal"><span class="pre">view.html</span></code> files
are different. Obviously, we need to run Bokeh in the compute function.
Normally, Bokeh stores the HTML code for the plot in a file
with a specified name. We can load the text in this file and
extract the relevant HTML code for a plot. However, it is easier to
use <a class="reference external" href="http://bokeh.pydata.org/en/latest/docs/user_guide/embed.html">Bokeh tools</a> for returning the HTML code elements directly.
The steps are exemplified in the <code class="docutils literal"><span class="pre">compute.py</span></code> file:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">exp</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">linspace</span>
<span class="kn">import</span> <span class="nn">bokeh.plotting</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">A</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

    <span class="c"># create a new plot with a title and axis labels</span>
    <span class="n">TOOLS</span> <span class="o">=</span> <span class="s">&quot;pan,wheel_zoom,box_zoom,reset,save,box_select,lasso_select&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;simple line example&quot;</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">TOOLS</span><span class="p">,</span>
                   <span class="n">x_axis_label</span><span class="o">=</span><span class="s">&#39;t&#39;</span><span class="p">,</span> <span class="n">y_axis_label</span><span class="o">=</span><span class="s">&#39;y&#39;</span><span class="p">)</span>

    <span class="c"># add a line renderer with legend and line thickness</span>
    <span class="n">p</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="s">&quot;u(t)&quot;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">bokeh.resources</span> <span class="kn">import</span> <span class="n">CDN</span>
    <span class="kn">from</span> <span class="nn">bokeh.embed</span> <span class="kn">import</span> <span class="n">components</span>
    <span class="n">script</span><span class="p">,</span> <span class="n">div</span> <span class="o">=</span> <span class="n">components</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">head</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">&lt;link rel=&quot;stylesheet&quot;</span>
<span class="s"> href=&quot;http://cdn.pydata.org/bokeh/release/bokeh-0.9.0.min.css&quot;</span>
<span class="s"> type=&quot;text/css&quot; /&gt;</span>
<span class="s">&lt;script type=&quot;text/javascript&quot;</span>
<span class="s"> src=&quot;http://cdn.pydata.org/bokeh/release/bokeh-0.9.0.min.js&quot;&gt;</span>
<span class="s">&lt;/script&gt;</span>
<span class="s">&lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s">Bokeh.set_log_level(&quot;info&quot;);</span>
<span class="s">&lt;/script&gt;</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">head</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">div</span>
</pre></div>
</div>
<p>The key data returned from <code class="docutils literal"><span class="pre">compute</span></code> consists of a text for loading Bokeh
tools in the <code class="docutils literal"><span class="pre">head</span></code> part of the HTML document (common for all plots in
the file) and for the plot itself there is a <code class="docutils literal"><span class="pre">script</span></code> tag and a <code class="docutils literal"><span class="pre">div</span></code> tag. The
<code class="docutils literal"><span class="pre">script</span></code> tag can be placed anywhere, while the <code class="docutils literal"><span class="pre">div</span></code> tag must be placed
exactly where we want to have the plot. In case of multiple plots,
there will be a common <code class="docutils literal"><span class="pre">script</span></code> tag and one <code class="docutils literal"><span class="pre">div</span></code> tag for each plot.</p>
<p>We need to insert the three elements return from <code class="docutils literal"><span class="pre">compute</span></code>,
available in the tuple <code class="docutils literal"><span class="pre">result</span></code>, into the <code class="docutils literal"><span class="pre">view.html</span></code> file.
The link and scripts for Bokeh tools in <code class="docutils literal"><span class="pre">result[0]</span></code> is inserted
in the <code class="docutils literal"><span class="pre">head</span></code> part, while the script and div tags for the plot
is inserted where we want to have to plot.
The complete <code class="docutils literal"><span class="pre">view.html</span></code> file looks like this:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;head&gt;</span>
    {{ result[0]|safe }}
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span>
<span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>\( {{ field.name }} \) <span class="ni">&amp;nbsp;&amp;nbsp;</span><span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field(size=12) }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
    {% if field.errors %}
      <span class="nt">&lt;td&gt;&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
      {% for error in field.errors %}
        <span class="nt">&lt;li&gt;&lt;font</span> <span class="na">color=</span><span class="s">&quot;red&quot;</span><span class="nt">&gt;</span>{{ error }}<span class="nt">&lt;/font&gt;&lt;/li&gt;</span>
      {% endfor %}<span class="nt">&lt;/ul&gt;&lt;/td&gt;</span>
    {% endif %}
    <span class="nt">&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Compute&quot;</span><span class="nt">&gt;&lt;/form&gt;&lt;/p&gt;</span>

<span class="nt">&lt;p&gt;</span>
{% if result != None %}
<span class="c">&lt;!-- script and div elements for Bokeh plot --&gt;</span>
{{ result[1]|safe }}
{{ result[2]|safe }}
{% endif %}
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>A feature of Bokeh plots is that one can zoom, pan, and save
to PNG file, among other
things. There is a toolbar at the top for such actions.</p>
<p>The <code class="docutils literal"><span class="pre">controller.py</span></code> file is basically the same as before (but simpler
than in the <code class="docutils literal"><span class="pre">vib2</span></code> app since we do not deal with PNG and/or SVG plots):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">InputForm</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/vib3&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
            <span class="c"># Make local variable (name field.name)</span>
            <span class="k">exec</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
                           <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Finally, we remark that Bokeh plays very well with Flask.
<a class="reference internal" href="._web4sa006.html#wf-exer-bokeh-ui"><span class="std std-ref">Project 8: Interactive function exploration</span></a> suggests a web app that combines
Bokeh with Flask in a very interactive way.</p>
<span class="target" id="index-17"></span><div class="section" id="pandas-highcharts-plotting-library">
<span id="index-18"></span><h3>Pandas highcharts plotting library<a class="headerlink" href="#pandas-highcharts-plotting-library" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://pypi.python.org/pypi/pandas-highcharts/">pandas-highcharts</a>
package is another strong alternative to Bokeh for interative
plotting in web pages. It is a stable and widely used code.</p>
</div>
</div>
<div class="section" id="autogenerating-the-code">
<span id="wf-autogen-flask"></span><h2>Autogenerating the code<a class="headerlink" href="#autogenerating-the-code" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-19"></span><span class="target" id="index-20"></span><p id="index-21">We shall now present generic <code class="docutils literal"><span class="pre">model.py</span></code> and <code class="docutils literal"><span class="pre">controller.py</span></code>
files that work with <em>any</em> <code class="docutils literal"><span class="pre">compute</span></code> function (!). This example will
demonstrate some advanced, powerful features of Python. The source code
is found in the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/gen">gen</a>
directory.</p>
<div class="section" id="inspecting-function-signatures">
<h3>Inspecting function signatures<a class="headerlink" href="#inspecting-function-signatures" title="Permalink to this headline">¶</a></h3>
<p>The basic idea is that the Python module <code class="docutils literal"><span class="pre">inspect</span></code> can be used to
retrieve the names of the arguments and the default values of
keyword arguments of <em>any</em> given <code class="docutils literal"><span class="pre">compute</span></code> function. Say we have some</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">mycompute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]):</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Running</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">defaults</span>  <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span>
</pre></div>
</div>
<p>leads to</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">arg_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;x_range&#39;</span><span class="p">]</span>
<span class="n">defaults</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<p>We have all the argument names in <code class="docutils literal"><span class="pre">arg_names</span></code> and
<code class="docutils literal"><span class="pre">defaults[i]</span></code> is the default value of keyword argument
<code class="docutils literal"><span class="pre">arg_names[j]</span></code>, where <code class="docutils literal"><span class="pre">j</span> <span class="pre">=</span> <span class="pre">len(arg_names)</span> <span class="pre">-</span> <span class="pre">len(defaults)</span> <span class="pre">+</span> <span class="pre">i</span></code>.</p>
</div>
<div class="section" id="generating-the-model">
<h3>Generating the model<a class="headerlink" href="#generating-the-model" title="Permalink to this headline">¶</a></h3>
<p>Knowing the name <code class="docutils literal"><span class="pre">name</span></code> of some argument in the <code class="docutils literal"><span class="pre">compute</span></code>
function, we can make the corresponding class attribute
in the <code class="docutils literal"><span class="pre">InputForm</span></code> class by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">FloatForm</span><span class="p">())</span>
</pre></div>
</div>
<p>For name equal to <code class="docutils literal"><span class="pre">'A'</span></code> this is the same as hardcoding</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">FloatForm</span><span class="p">()</span>
</pre></div>
</div>
<p>Assuming that all arguments in <code class="docutils literal"><span class="pre">compute</span></code> are floats, we could
do</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">:</span>
    <span class="k">pass</span>  <span class="c"># Empty class</span>

<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">FloatForm</span><span class="p">())</span>
</pre></div>
</div>
<p>However, we can do better than this: for
keyword arguments the type of the default value can be used to
select the appropriate form class. The complete <code class="docutils literal"><span class="pre">model.py</span></code> file
then goes as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example on generic model.py file which inspects the arguments</span>
<span class="sd">of the compute function and automatically generates a relevant</span>
<span class="sd">InputForm class.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">wtforms</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute_gamma</span> <span class="k">as</span> <span class="n">compute</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">defaults</span>  <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">wtforms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c"># Augment defaults with None elements for the positional</span>
<span class="c"># arguments</span>
<span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg_names</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
<span class="c"># Map type of default to right form field</span>
<span class="n">type2form</span> <span class="o">=</span> <span class="p">{</span><span class="nb">type</span><span class="p">(</span><span class="mf">1.0</span><span class="p">):</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">FloatField</span><span class="p">,</span>
             <span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>   <span class="n">wtforms</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">,</span>
             <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>  <span class="n">wtforms</span><span class="o">.</span><span class="n">TextField</span><span class="p">,</span>
             <span class="p">}</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arg_names</span><span class="p">,</span> <span class="n">defaults</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
            <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">type2form</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type2form</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)](</span>
                <span class="n">default</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;argument </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> not supported&#39;</span> <span class="o">%</span>
                            <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">InputForm</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
<p>(The <code class="docutils literal"><span class="pre">compute_gamma</span></code> function imported from <code class="docutils literal"><span class="pre">compute</span></code> is the
only application-specific statement in this code and will be explained later.)</p>
</div>
<div class="section" id="generating-the-view">
<h3>Generating the view<a class="headerlink" href="#generating-the-view" title="Permalink to this headline">¶</a></h3>
<p>The call to <code class="docutils literal"><span class="pre">compute</span></code> in the <code class="docutils literal"><span class="pre">controller.py</span></code> file must also be expressed
in a general way such that the call handles any type and number of
parameters. This can be done in two ways, using either positional
or keyword arguments.</p>
<p>The technique with positional arguments
is explained first. It consists of collecting all parameters in
a list or tuple, called <code class="docutils literal"><span class="pre">args</span></code>, and then calling <code class="docutils literal"><span class="pre">compute(*args)</span></code>
(which is equivalent to <code class="docutils literal"><span class="pre">compute(args[0],</span> <span class="pre">args[1],</span> <span class="pre">...,</span> <span class="pre">args[n])</span></code>
if <code class="docutils literal"><span class="pre">n</span></code> is <code class="docutils literal"><span class="pre">len(args)-1</span></code>). The elements of <code class="docutils literal"><span class="pre">args</span></code> are the values of the
form variables. We know the name of a form variable as a string
<code class="docutils literal"><span class="pre">name</span></code> (from <code class="docutils literal"><span class="pre">arg_names</span></code>), and if <code class="docutils literal"><span class="pre">form</span></code> is the form object,
the construction <code class="docutils literal"><span class="pre">getattr(form,</span> <span class="pre">name).data</span></code> extracts the value
that the user provided (<code class="docutils literal"><span class="pre">getattr(obj,</span> <span class="pre">attr)</span></code> gets the attribute, with name
available as a string in <code class="docutils literal"><span class="pre">attr</span></code>, in the object <code class="docutils literal"><span class="pre">obj</span></code>).
For exampe, if <code class="docutils literal"><span class="pre">name</span></code> is <code class="docutils literal"><span class="pre">'A'</span></code>, <code class="docutils literal"><span class="pre">getattr(form,</span> <span class="pre">name).data</span></code> is the same as
<code class="docutils literal"><span class="pre">form.A.data</span></code>.
Collecting all form variables, placing them in a list,
and calling <code class="docutils literal"><span class="pre">compute</span></code> are done with</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Our <code class="docutils literal"><span class="pre">InputForm</span></code> class guarantees that all arguments in <code class="docutils literal"><span class="pre">compute</span></code>
are present in the form, but to be absolutely safe we can
test if <code class="docutils literal"><span class="pre">name</span></code> is present in the <code class="docutils literal"><span class="pre">form</span></code> object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
</pre></div>
</div>
<p>A potential problem with the <code class="docutils literal"><span class="pre">args</span></code> list is that the values might
be in wrong order. It appears, fortunately, that the order we
assign attributes to the form class is preserved when iterating over
the form. Nevertheless, using keyword arguments instead of positional
arguments provides a completely safe solution to calling <code class="docutils literal"><span class="pre">compute</span></code>
with the correct arguments. Keyword arguments are placed in a
dictionary <code class="docutils literal"><span class="pre">kwargs</span></code> and <code class="docutils literal"><span class="pre">compute</span></code> is called as <code class="docutils literal"><span class="pre">compute(**kwargs)</span></code>.
The generic solution is</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span>
          <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)}</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">compute(**kwargs)</span></code> call is equivalent to <code class="docutils literal"><span class="pre">compute(A=1,</span> <span class="pre">b=3,</span> <span class="pre">w=0.5)</span></code>
in case <code class="docutils literal"><span class="pre">kwargs</span> <span class="pre">=</span> <span class="pre">{'w'=0.5,</span> <span class="pre">'A':1,</span> <span class="pre">'b':3}</span></code> (recall that the order of
the keys in a Python dictionary is undetermined).</p>
</div>
<div class="section" id="generating-the-template">
<h3>Generating the template<a class="headerlink" href="#generating-the-template" title="Permalink to this headline">¶</a></h3>
<p>It remains to generate the right HTML template. The HTML code depends
on what the returned <code class="docutils literal"><span class="pre">result</span></code> object from <code class="docutils literal"><span class="pre">compute</span></code> contains. Only a
human who has read the <code class="docutils literal"><span class="pre">compute</span></code> code knows the details of the returned
result. Therefore, we leave it to a human to provide the part
of the HTML template that renders the result. The file <code class="docutils literal"><span class="pre">templates/view_results.html</span></code> contains this human-provided code, while <code class="docutils literal"><span class="pre">templates/view.html</span></code>
is a completely generic template for the forms:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;</span> <span class="nt">&lt;td&gt;</span>{{ field }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{% if field.errors %}
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
      {% for error in field.errors %}
        <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
      {% endfor %}<span class="nt">&lt;/ul&gt;</span>
    {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Compute</span><span class="nt">&gt;&lt;/form&gt;&lt;/p&gt;</span>

{% if result != None %}
{{ result|safe }}
{% endif %}
</pre></div>
</div>
<p>At the end of this code, an HTML text <code class="docutils literal"><span class="pre">result</span></code> (string) is to be
inserted.  This text is typically generated by calling Flask&#8217;s
<code class="docutils literal"><span class="pre">render_template</span></code> function, which uses <code class="docutils literal"><span class="pre">templates/view_results.html</span></code>
to turn the return object <code class="docutils literal"><span class="pre">result</span></code> from the compute function into the
desired HTML code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view_results.html&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="c"># result is now rendered HTML text</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A perhaps simpler alternative would be to have a generic
<code class="docutils literal"><span class="pre">view_forms.html</span></code> file and a user-specific
<code class="docutils literal"><span class="pre">view_results.html</span></code> and explicitly combining them into a new
file. This requires file writing by the app, which one normally
wants to avoid. Especially if the web app gets multiple users,
the file writing may lead to corrupt files.</p>
</div>
<p>The complete, generic form of the <code class="docutils literal"><span class="pre">index</span></code> function becomes</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                  <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="c"># result must be transformed to HTML and inserted as a</span>
        <span class="c"># string in the generic view.html file</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view_results.html&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="application">
<h3>Application<a class="headerlink" href="#application" title="Permalink to this headline">¶</a></h3>
<p>Let us apply the files above to plot the gamma probability density function</p>
<div class="math">
\[g(x; a, h, A) = \frac{|h|}{\Gamma(a)A}\left(\frac{x}{A}\right)^{ah-1}
e^{-\left(\frac{x}{A}\right)^h},\]</div>
<p>and its cumulative density</p>
<div class="math">
\[G(x; a, h, A) = \int_0^x g(\tau; a, h, A)d\tau,\]</div>
<p>computed by numerically the Trapezoidal rule, for instance.
We also want to compute and display
the mean value <span class="math">\(A\Gamma(a + 1/h)/\Gamma(a)\)</span> and
standard deviation</p>
<div class="math">
\[\sigma = \frac{A}{\Gamma(a)}\sqrt{\Gamma(a + 2/h)\Gamma(a) - \Gamma(a+1/h)^2}.\]</div>
<p>Here, <span class="math">\(\Gamma(a)\)</span> is the gamma function, which can be computed
by <code class="docutils literal"><span class="pre">math.gamma(a)</span></code> in Python.
Below is a <code class="docutils literal"><span class="pre">compute.py</span></code> file with the
relevant implementations of <span class="math">\(g(x;a,h,A)\)</span> (<code class="docutils literal"><span class="pre">gamma_density</span></code>),
<span class="math">\(G(x; a, h, A)\)</span> (<code class="docutils literal"><span class="pre">gamma_cumulative</span></code>), and a function <code class="docutils literal"><span class="pre">compute_gamma</span></code> for
making a plot of <span class="math">\(g\)</span> og <span class="math">\(G\)</span> for <span class="math">\(x\in [0,7\sigma]\)</span>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="c"># http://en.wikipedia.org/wiki/Gamma_distribution</span>
    <span class="n">xA</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xA</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xA</span><span class="o">**</span><span class="n">h</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gamma_cumulative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="c"># Integrate gamma_density using the Trapezoidal rule.</span>
    <span class="c"># Assume x is array.</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">compute_gamma</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return plot and mean/st.dev. value of the gamma density.&quot;&quot;&quot;</span>
    <span class="n">gah</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">h</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">gah</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">stdev</span> <span class="o">=</span> <span class="n">A</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">/</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">gah</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="o">*</span><span class="n">stdev</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  <span class="c"># needed to avoid adding curves in plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;a=</span><span class="si">%g</span><span class="s">, h=</span><span class="si">%g</span><span class="s">, A=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="c"># Make Matplotlib write to BytesIO file object and grab</span>
    <span class="c"># return the object&#39;s string</span>
    <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># rewind to beginning of file</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="n">figdata_density_png</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;svg&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">figdata_density_svg</span> <span class="o">=</span> <span class="s">&#39;&lt;svg&#39;</span> <span class="o">+</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;svg&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">figdata_density_svg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">figdata_density_svg</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">gamma_cumulative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">figdata_cumulative_png</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;svg&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">figdata_cumulative_svg</span> <span class="o">=</span> <span class="s">&#39;&lt;svg&#39;</span> <span class="o">+</span> <span class="n">figfile</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;svg&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">figdata_cumulative_svg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">figdata_cumulative_svg</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">figdata_density_png</span><span class="p">,</span> <span class="n">figdata_cumulative_png</span><span class="p">,</span> \
           <span class="n">figdata_density_svg</span><span class="p">,</span> <span class="n">figdata_cumulative_svg</span><span class="p">,</span> \
           <span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">mean</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">stdev</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">compute_gamma</span></code> function returns a tuple of six values.
We want output as displayed in Figure <a class="reference internal" href="#wf-gen-flask-fig-gamma"><span class="std std-ref">Design of a web page illustrating the gamma probability functions</span></a>.</p>
<div class="figure" id="id7">
<span id="wf-gen-flask-fig-gamma"></span><a class="reference internal image-reference" href="_images/gen_flask_gamma.png"><img alt="_images/gen_flask_gamma.png" src="_images/gen_flask_gamma.png" style="width: 700px;" /></a>
<p class="caption"><span class="caption-text"><em>Design of a web page illustrating the gamma probability functions</em></span></p>
</div>
<p>The design is realized in the file <code class="docutils literal"><span class="pre">view_results.html</span></code> shown below.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;table&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ result[0] }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/td&gt;&lt;td&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ result[1] }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td&gt;</span>{{ result[2]|safe }}<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;td&gt;</span>{{ result[3]|safe }}<span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;&lt;td&gt;</span>
Mean value: {{ result[4] }} <span class="nt">&lt;br&gt;</span>
Standard deviation value: {{ result[5] }}
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>To create the web application, we just perform the following steps:</p>
<ol class="arabic simple">
<li>copy the generic <code class="docutils literal"><span class="pre">controller.py</span></code> and <code class="docutils literal"><span class="pre">model.py</span></code> files to a new directory</li>
<li>write the compute function in a file <code class="docutils literal"><span class="pre">compute.py</span></code></li>
<li>edit <code class="docutils literal"><span class="pre">controller.py</span></code> and <code class="docutils literal"><span class="pre">model.py</span></code> to use the right name of the
compute function (<code class="docutils literal"><span class="pre">from</span> <span class="pre">compute</span> <span class="pre">import</span> <span class="pre">name</span> <span class="pre">as</span> <span class="pre">compute</span></code>)</li>
<li>add an appropriate <code class="docutils literal"><span class="pre">templates/view_forms.html</span></code> file that visualizes
the returned value <code class="docutils literal"><span class="pre">results</span></code> from the compute function</li>
</ol>
</div>
</div>
<div class="section" id="user-login-and-storage-of-computed-results">
<span id="wf-flask-login"></span><h2>User login and storage of computed results<a class="headerlink" href="#user-login-and-storage-of-computed-results" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-22"></span><p id="index-23">We now want to make an app where the computed results can be stored in
a database. To this end, each user must create an account and login to
this account for archiving results and for browsing previous runs of
the application. More files are needed for this purpose, compared to
the previous apps, and the files are located in the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/login">login</a> directory.</p>
<div class="section" id="required-additional-software">
<h3>Required additional software<a class="headerlink" href="#required-additional-software" title="Permalink to this headline">¶</a></h3>
<p>Three more packages are needed for this more advanced application:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://flask-login.readthedocs.org/en/latest/">Flask-Login</a></li>
<li><a class="reference external" href="http://flask.pocoo.org/docs/0.10/patterns/sqlalchemy/">Flask-SQLAlchemy</a></li>
<li><a class="reference external" href="http://packages.python.org/Flask-Mail">Flask-Mail</a></li>
</ul>
</div></blockquote>
<p>Installation is done by</p>
<div class="highlight-text"><div class="highlight"><pre>sudo pip install --upgrade flask-login
sudo pip install --upgrade flask-sqlalchemy
sudo pip install --upgrade flask-mail
</pre></div>
</div>
</div>
<div class="section" id="the-compute-part-2">
<h3>The compute part  (2)<a class="headerlink" href="#the-compute-part-2" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">compute.py</span></code> file contains the <code class="docutils literal"><span class="pre">compute</span></code>
function from the <code class="docutils literal"><span class="pre">vib2</span></code> app in the section <a class="reference internal" href="#wf-vib2-flask-nofiles"><span class="std std-ref">Avoiding plot files</span></a>.</p>
<p>There is quite much Flask code required for user accounts and login.
The files here were generated by the Parampool package and then
edited and specialized to the present application. In general,
it is not recommended to hack further on the example given here,
but rather utilize Parampool to generate web apps with user accounts
and login.</p>
</div>
<div class="section" id="the-interfaces-of-the-app">
<h3>The interfaces of the app<a class="headerlink" href="#the-interfaces-of-the-app" title="Permalink to this headline">¶</a></h3>
<p>The first page after starting the app (<code class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span></code>)
shows input fields for the numerical parameters, but there are also
links to the right for registering a new user or logging in to an
existing account:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_main.png"><img alt="_images/login_main.png" src="_images/login_main.png" style="width: 700px;" /></a>
</div>
<p>Clicking on <em>Register</em> brings up a registration page:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_register.png"><img alt="_images/login_register.png" src="_images/login_register.png" style="width: 700px;" /></a>
</div>
<p>Already registered users can just log in:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_login.png"><img alt="_images/login_login.png" src="_images/login_login.png" style="width: 700px;" /></a>
</div>
<p>Then the fields with input parameters are shown again. After pressing
<em>Compute</em> we are left with a combination of input and results, plus
a field where the user can write a comment about this simulation:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_results.png"><img alt="_images/login_results.png" src="_images/login_results.png" style="width: 700px;" /></a>
</div>
<p>All simulations (input data, results, and comment) are stored in
a database. Clicking on <em>Previous simulation</em> brings us to an
overview of what is in the database:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_old.png"><img alt="_images/login_old.png" src="_images/login_old.png" style="width: 500px;" /></a>
</div>
<p>Here, one can browse previous results, remove entries, or erase the
whole database.</p>
</div>
<div class="section" id="the-source-code">
<h3>The source code<a class="headerlink" href="#the-source-code" title="Permalink to this headline">¶</a></h3>
<p>Rather than explaining everything about the source code
in detail, we primarily list
the various code files below. A starting point is the central <code class="docutils literal"><span class="pre">controller.py</span></code>
file, which is now quite lengthy and involves four different
URLs (the input page, the login page, the registration page, and the
previous results page).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span> <span class="k">as</span> <span class="n">compute_function</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">ComputeForm</span>
<span class="kn">from</span> <span class="nn">db_models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Compute</span>
<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">LoginManager</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> \
     <span class="n">login_user</span><span class="p">,</span> <span class="n">logout_user</span><span class="p">,</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>
<span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@login_manager.user_loader</span>
<span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

<span class="c"># Path to the web application</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ComputeForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">compute_function</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                      <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
                <span class="nb">object</span> <span class="o">=</span> <span class="n">Compute</span><span class="p">()</span>
                <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
                <span class="nb">object</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
                <span class="nb">object</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c"># Send email notification</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">notify</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                    <span class="n">send_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">result</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">populate_form_from_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
                           <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">populate_form_from_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Repopulate form with previous values&quot;&quot;&quot;</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ComputeForm</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
        <span class="n">field</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">form</span>

<span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">flask.ext.mail</span> <span class="kn">import</span> <span class="n">Mail</span><span class="p">,</span> <span class="n">Message</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="s">&quot;Compute Computations Complete&quot;</span><span class="p">,</span>
                  <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">])</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">A simulation has been completed by the Flask Compute app.</span>
<span class="s">Please log in at</span>

<span class="s">http://localhost:5000/login</span>

<span class="s">to see the results.</span>

<span class="s">---</span>
<span class="s">If you don&#39;t want email notifications when a result is found,</span>
<span class="s">please register a new user and leave the &#39;notify&#39; field</span>
<span class="s">unchecked.</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/reg&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_login</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">register_form</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">register_form</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;reg.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">login_form</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">login_form</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
        <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;login.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/logout&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="n">logout_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/old&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">old</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">populate_form_from_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">result</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
                <span class="n">comments</span> <span class="o">=</span> <span class="s">&quot;&lt;h3&gt;Comments&lt;/h3&gt;&quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">comments</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comments</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">:</span><span class="n">result</span><span class="p">,</span>
                 <span class="s">&#39;id&#39;</span><span class="p">:</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&#39;comments&#39;</span><span class="p">:</span> <span class="n">comments</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;old.html&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/add_comment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">add_comment</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;comments&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/delete/&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">delete_post</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;old&#39;</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;sqlite.db&#39;</span><span class="p">)):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Creation of the <code class="docutils literal"><span class="pre">app</span></code> object is put in a separate file <code class="docutils literal"><span class="pre">app.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;sqlite:///sqlite.db&#39;</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>

<span class="c"># Email settings</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">MAIL_SERVER</span><span class="o">=</span><span class="s">&#39;smtp.gmail.com&#39;</span><span class="p">,</span>
        <span class="n">MAIL_PORT</span><span class="o">=</span><span class="mi">587</span><span class="p">,</span>
        <span class="n">MAIL_USE_TLS</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">MAIL_USERNAME</span> <span class="o">=</span> <span class="s">&#39;cbcwebsolvermail@gmail.com&#39;</span><span class="p">,</span>
        <span class="n">MAIL_PASSWORD</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">decodestring</span><span class="p">(</span><span class="s">&#39;WGlmZmljdox0UFch&#39;</span><span class="p">),</span>
        <span class="n">MAIL_DEFAULT_SENDER</span> <span class="o">=</span> <span class="s">&#39;Some name &lt;name@gmail.com&gt;&#39;</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>The forms for the compute function and for the login is
stored in a file called <code class="docutils literal"><span class="pre">forms.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">wtforms</span> <span class="kn">as</span> <span class="nn">wtf</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="k">class</span> <span class="nc">ComputeForm</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( A \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( b \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( w \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">pi</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( T \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;resolution&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>

<span class="kn">from</span> <span class="nn">db_models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span>
<span class="kn">import</span> <span class="nn">flask.ext.wtf.html5</span> <span class="kn">as</span> <span class="nn">html5</span>

<span class="c"># Standard Forms</span>
<span class="k">class</span> <span class="nc">register_form</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Username&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">PasswordField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span>
            <span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">(),</span>
            <span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">EqualTo</span><span class="p">(</span>
                <span class="s">&#39;confirm&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Passwords must match&#39;</span><span class="p">)])</span>
    <span class="n">confirm</span>  <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">PasswordField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Confirm Password&#39;</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>
    <span class="n">email</span>    <span class="o">=</span> <span class="n">html5</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Email&#39;</span><span class="p">)</span>
    <span class="n">notify</span>   <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Email notifications&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="s">&#39;Cannot send notifications without a valid email address&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;User already exists&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">login_form</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Username&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">PasswordField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Unknown username&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Invalid password&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
<p>Database-related code for the SQLAlchemy database is collected in
<code class="docutils literal"><span class="pre">db_models.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask.ext.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">pwhash</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">notify</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;User </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pwhash</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwhash</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">pw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">is_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

<span class="k">class</span> <span class="nc">Compute</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">,</span>
           <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s">&#39;Compute&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s">&#39;dynamic&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Finally, we need views. For the results of the computation we have
a <code class="docutils literal"><span class="pre">view.html</span></code> file that is very similar to <code class="docutils literal"><span class="pre">view_table.html</span></code>
in the <code class="docutils literal"><span class="pre">vib1</span></code> app:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span>
<span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>

{% if user.is_anonymous() %}
  <span class="nt">&lt;p</span> <span class="na">align=</span><span class="s">&quot;right&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/login&quot;</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
  / <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/reg&quot;</span><span class="nt">&gt;</span>Register<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
{% else %}
  <span class="nt">&lt;p</span> <span class="na">align=</span><span class="s">&quot;right&quot;</span><span class="nt">&gt;</span>Logged in as {{user.username}}<span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/old&quot;</span><span class="nt">&gt;</span>Previous simulations<span class="nt">&lt;a/&gt;&lt;br&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/logout&quot;</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
{% endif %}

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;p&gt;</span>
<span class="c">&lt;!-- Input and Results are typeset as a two-column table --&gt;</span>
<span class="nt">&lt;table&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;h2&gt;</span>Input:<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span> <span class="na">enctype=</span><span class="s">multipart/form-data</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span>
      {% if field.errors %}
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
        {% for error in field.errors %}
          <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
        {% endfor %}<span class="nt">&lt;/ul&gt;</span>
      {% endif %}
      <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Compute&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/td&gt;</span>

<span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
  {% if result != None %}
    <span class="nt">&lt;h2&gt;</span>Results:<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ result|safe }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
    {% if not user.is_anonymous() %}
      <span class="nt">&lt;h3&gt;</span>Comments:<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;/add_comment&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;comments&quot;</span> <span class="na">rows=</span><span class="s">&quot;4&quot;</span> <span class="na">cols=</span><span class="s">&quot;40&quot;</span><span class="nt">&gt;&lt;/textarea&gt;</span>
          <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Add&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/form&gt;</span>
      {% endif %}

  {% endif %}
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">login.html</span></code> template for the login page takes the form</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h2&gt;</span>Login:<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;table&gt;</span>
    {% for field in form %}
      <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            {% if field.errors %}
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
              {% for error in field.errors %}
                <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
              {% endfor %}<span class="nt">&lt;/ul&gt;</span>
            {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    {% endfor %}
  <span class="nt">&lt;/table&gt;</span>
  <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Login&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The page for registering a new user has a simple template <code class="docutils literal"><span class="pre">reg.html</span></code>:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h2&gt;</span>Register:<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
   {% for field in form %}
     <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
         <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            {% if field.errors %}
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
              {% for error in field.errors %}
                <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
              {% endfor %}<span class="nt">&lt;/ul&gt;</span>
            {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
   {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Register</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The final file is <code class="docutils literal"><span class="pre">old.html</span></code> for retrieving old simulations:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
 <span class="na">src=</span><span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;h2&gt;</span>Previous simulations<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;p</span> <span class="na">align=</span><span class="s">&quot;right&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>Back to index<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
{% if data %}
  {% for post in data %}
    <span class="nt">&lt;hr&gt;</span>
    <span class="nt">&lt;table&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">width=</span><span class="s">&quot;30%&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Input<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;table&gt;</span>
      {% for field in post.form %}
        <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}:<span class="ni">&amp;nbsp;</span><span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{ field.data }}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
      {% endfor %}
      <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;/td&gt;&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">width=</span><span class="s">&quot;60%&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Results<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ post.result|safe }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
    {% if True %}
      <span class="nt">&lt;p&gt;</span>
      {{ comments }}
    {% endif %}
    <span class="nt">&lt;/td&gt;&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">width=</span><span class="s">&quot;60%&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">action=</span><span class="s">&quot;/delete/{{ post.id }}&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">&quot;Delete&quot;</span>
       <span class="na">title=</span><span class="s">&quot;Delete this post from database&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
   {% endfor %}
   <span class="nt">&lt;hr&gt;</span>
   <span class="nt">&lt;center&gt;</span>
   <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">action=</span><span class="s">&quot;/delete/-1&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">&quot;Delete all&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;/form&gt;</span>
   <span class="nt">&lt;/center&gt;</span>
{% else %}
  No previous simulations
{% endif %}
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<ul class="last simple">
<li>Sending email from the app does not work.</li>
<li>Storing comments does not work.</li>
</ul>
</div>
<p>[<strong>hpl 1</strong>: Check if an autogenerated app from <code class="docutils literal"><span class="pre">_generate_app.py</span></code> can send mail and store comments. Need a <code class="docutils literal"><span class="pre">compute</span></code> function that returns full HTML text then.]</p>
</div>
<div class="section" id="resources-1">
<h3>Resources  (1)<a class="headerlink" href="#resources-1" title="Permalink to this headline">¶</a></h3>
<p>Working with a database in Flask is described here:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://pythonhosted.org/Flask-SQLAlchemy/quickstart.html">http://pythonhosted.org/Flask-SQLAlchemy/quickstart.html</a>,</li>
<li><a class="reference external" href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-iv-database">http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-iv-database</a>,</li>
<li><a class="reference external" href="https://flask-login.readthedocs.org/en/latest/">The Flask login extension</a></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="uploading-of-files">
<span id="wf-flask-upload"></span><h2>Uploading of files<a class="headerlink" href="#uploading-of-files" title="Permalink to this headline">¶</a></h2>
<span class="target" id="index-24"></span><div class="section" id="overview-of-the-application">
<span id="index-25"></span><h3>Overview of the application<a class="headerlink" href="#overview-of-the-application" title="Permalink to this headline">¶</a></h3>
<p>Many user interfaces need the user to provide data files. A minimalistic
application is to have a button for uploading a single file.
As example we use a file with a series of numbers, and the application&#8217;s
purpose is to compute the mean and standard deviation of the numbers.
The first user interface just has the <em>Choose File</em> and <em>Compute</em> buttons:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/upload1.png"><img alt="_images/upload1.png" src="_images/upload1.png" style="width: 550px;" /></a>
</div>
<p>Clicking on <em>Choose File</em> brings up a file browser where the user can
choose the file to uploaded to the application. Say this is a file
<code class="docutils literal"><span class="pre">testfile.dat</span></code>. The interface now looks like</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/upload2.png"><img alt="_images/upload2.png" src="_images/upload2.png" style="width: 550px;" /></a>
</div>
<p>Pressing thereafter <em>Compute</em> leads to storage of
<code class="docutils literal"><span class="pre">testfile.dat</span></code> on the server in a subdirectory <code class="docutils literal"><span class="pre">uploads</span></code> and
computation of basic statistics of the numbers in the file.
The resulting output looks like</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/upload3.png"><img alt="_images/upload3.png" src="_images/upload3.png" style="width: 550px;" /></a>
</div>
<p>The text &#8220;No file chosen&#8221; is automatically displayed by the
widget object used for file upload and indicates that a new
file can be chosen. Below we shall present all parts of the code
needed to create this interactive application.</p>
</div>
<div class="section" id="the-model-class">
<h3>The model class<a class="headerlink" href="#the-model-class" title="Permalink to this headline">¶</a></h3>
<p>The widget <code class="docutils literal"><span class="pre">FieldField</span></code> is used for an input field with a <em>Choose File</em>
button:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">wtforms</span> <span class="kn">as</span> <span class="nn">wtf</span>

<span class="k">class</span> <span class="nc">Average</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">filename</span>   <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span>
                               <span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
</pre></div>
</div>
</div>
<div class="section" id="the-controller-file">
<h3>The controller file<a class="headerlink" href="#the-controller-file" title="Permalink to this headline">¶</a></h3>
<p>The controller file needs some special code to specify a directory
to store uploaded files. We also include some code to check that
the file has a name with the right extension.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Relative path of directory for uploaded files</span>
<span class="n">UPLOAD_DIR</span> <span class="o">=</span> <span class="s">&#39;uploads/&#39;</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;UPLOAD_FOLDER&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UPLOAD_DIR</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s">&#39;MySecretKey&#39;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">)</span>

<span class="c"># Allowed file types for file upload</span>
<span class="n">ALLOWED_EXTENSIONS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;txt&#39;</span><span class="p">,</span> <span class="s">&#39;dat&#39;</span><span class="p">,</span> <span class="s">&#39;npy&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Does filename have the right extension?&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> \
           <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ALLOWED_EXTENSIONS</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">index</span></code> function must have code for saving the file, and as usual,
calling the compute function and rendering a new page:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">Average</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c"># default</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span><span class="p">:</span>

        <span class="c"># Save uploaded file on server if it exists and is valid</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="n">form</span><span class="o">.</span><span class="n">filename</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
                <span class="c"># Make a valid version of filename for any file ystem</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="nb">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span>
                                       <span class="n">filename</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">compute_function</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="the-compute-function">
<h3>The compute function<a class="headerlink" href="#the-compute-function" title="Permalink to this headline">¶</a></h3>
<p>We assume that the uploaded file is available in the <code class="docutils literal"><span class="pre">uploads</span></code>
subdirectory, so the compute function needs to open this file, read
the numbers, and compute statistics. The file reading and computations
are easily done by <code class="docutils literal"><span class="pre">numpy</span></code> functions. The results are presented in
an HTML table.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">compute_mean_std</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;uploads&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>
    <span class="k">return</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">Data from file &lt;tt&gt;</span><span class="si">%s</span><span class="s">&lt;/tt&gt;:</span>
<span class="s">&lt;p&gt;</span>
<span class="s">&lt;table border=1&gt;</span>
<span class="s">&lt;tr&gt;&lt;td&gt; mean    &lt;/td&gt;&lt;td&gt; </span><span class="si">%.3g</span><span class="s"> &lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">&lt;tr&gt;&lt;td&gt; st.dev. &lt;/td&gt;&lt;td&gt; </span><span class="si">%.3g</span><span class="s"> &lt;/td&gt;&lt;/tr&gt;</span>
<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="the-html-template-2">
<h3>The HTML template  (2)<a class="headerlink" href="#the-html-template-2" title="Permalink to this headline">¶</a></h3>
<p>Although the present minimalistic application only needs a very simple
HTML template, we reuse a quite generic template known from previous examples,
where the input variables are listed to the left and the output of the
compute function is presented to the right. Such a template looks like</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title&gt;</span>Flask Average app<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>

  <span class="c">&lt;!-- Input and Results are typeset as a two-column table --&gt;</span>
  <span class="nt">&lt;table&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Input:<span class="nt">&lt;/h2&gt;</span>

      <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span> <span class="na">enctype=</span><span class="s">&quot;multipart/form-data&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;table&gt;</span>
          {% for field in form %}
            <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
                <span class="nt">&lt;td&gt;</span>{% if field.errors %}
                  <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
                  {% for error in field.errors %}
                    <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
                  {% endfor %}<span class="nt">&lt;/ul&gt;</span>
                {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
          {% endfor %}
        <span class="nt">&lt;/table&gt;</span>
        <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Compute&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/td&gt;</span>

  <span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
    {% if result != None %}
      <span class="nt">&lt;h2&gt;</span>Results:<span class="nt">&lt;/h2&gt;</span>
        {{ result|safe }}

    {% endif %}
  <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The complete set of files is found in the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/upload">upload</a> directory.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="sphinxlocaltoc">
    <h3><a href="index.html">Page contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Handling multiple input variables in Flask</a><ul>
<li><a class="reference internal" href="#programming-the-flask-application-2">Programming the Flask application  (2)</a><ul>
<li><a class="reference internal" href="#the-compute-part-1">The compute part  (1)</a></li>
<li><a class="reference internal" href="#the-model-2">The model  (2)</a></li>
<li><a class="reference internal" href="#the-view-2">The view  (2)</a></li>
<li><a class="reference internal" href="#the-html-template-1">The HTML template  (1)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementing-error-checking-in-the-template">Implementing error checking in the template</a></li>
<li><a class="reference internal" href="#using-style-sheets">Using style sheets</a></li>
<li><a class="reference internal" href="#using-latex-mathematics">Using LaTeX mathematics</a></li>
<li><a class="reference internal" href="#rearranging-the-elements-in-the-html-template">Rearranging the elements in the HTML template</a></li>
<li><a class="reference internal" href="#bootstrap-html-style">Bootstrap HTML style</a></li>
<li><a class="reference internal" href="#custom-validation-1">Custom validation  (1)</a><ul>
<li><a class="reference internal" href="#using-flask-validators">Using Flask validators</a></li>
<li><a class="reference internal" href="#tailored-validation">Tailored validation</a></li>
<li><a class="reference internal" href="#tailored-validation-of-intervals">Tailored validation of intervals</a></li>
<li><a class="reference internal" href="#demo">Demo</a></li>
</ul>
</li>
<li><a class="reference internal" href="#avoiding-plot-files">Avoiding plot files</a><ul>
<li><a class="reference internal" href="#png-plots">PNG plots</a></li>
<li><a class="reference internal" href="#svg-plots">SVG plots</a></li>
<li><a class="reference internal" href="#using-mpld3">Using mpld3</a></li>
</ul>
</li>
<li><a class="reference internal" href="#plotting-with-the-bokeh-library">Plotting with the Bokeh library</a><ul>
<li><a class="reference internal" href="#pandas-highcharts-plotting-library">Pandas highcharts plotting library</a></li>
</ul>
</li>
<li><a class="reference internal" href="#autogenerating-the-code">Autogenerating the code</a><ul>
<li><a class="reference internal" href="#inspecting-function-signatures">Inspecting function signatures</a></li>
<li><a class="reference internal" href="#generating-the-model">Generating the model</a></li>
<li><a class="reference internal" href="#generating-the-view">Generating the view</a></li>
<li><a class="reference internal" href="#generating-the-template">Generating the template</a></li>
<li><a class="reference internal" href="#application">Application</a></li>
</ul>
</li>
<li><a class="reference internal" href="#user-login-and-storage-of-computed-results">User login and storage of computed results</a><ul>
<li><a class="reference internal" href="#required-additional-software">Required additional software</a></li>
<li><a class="reference internal" href="#the-compute-part-2">The compute part  (2)</a></li>
<li><a class="reference internal" href="#the-interfaces-of-the-app">The interfaces of the app</a></li>
<li><a class="reference internal" href="#the-source-code">The source code</a></li>
<li><a class="reference internal" href="#resources-1">Resources  (1)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#uploading-of-files">Uploading of files</a><ul>
<li><a class="reference internal" href="#overview-of-the-application">Overview of the application</a></li>
<li><a class="reference internal" href="#the-model-class">The model class</a></li>
<li><a class="reference internal" href="#the-controller-file">The controller file</a></li>
<li><a class="reference internal" href="#the-compute-function">The compute function</a></li>
<li><a class="reference internal" href="#the-html-template-2">The HTML template  (2)</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div class="sphinxprev">
    <h4>Previous page</h4>
    <p class="topless"><a href="._web4sa003.html"
                          title="Previous page">&larr; Making a Django application</a></p>
  </div>
  <div class="sphinxnext">
    <h4>Next page</h4>
    <p class="topless"><a href="._web4sa005.html"
                          title="Next page">&rarr; Handling multiple input variables in Django</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/._web4sa004.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="._web4sa005.html" title="Handling multiple input variables in Django"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="._web4sa003.html" title="Making a Django application"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">Using Web Frameworks for Scientific Applications</a> &raquo;</li>
 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright H. P. Langtangen and A. E. Johansen.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4a0+.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>