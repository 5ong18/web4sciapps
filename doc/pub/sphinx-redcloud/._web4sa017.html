


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>User login and storage of computed results &mdash; Using Web Frameworks for Scientific Applications</title>
    
    <link rel="stylesheet" href="_static/redcloud.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Noticia+Text|Droid+Sans+Mono" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/jquery.cookie.js"></script>
    <script type="text/javascript" src="_static/toggle_sections.js"></script>

        <script src="http://sagecell.sagemath.org/static/jquery.min.js"></script>
        <script src="http://sagecell.sagemath.org/static/embedded_sagecell.js"></script>

        <script>sagecell.makeSagecell({inputLocation: ".sage"});</script>

        <style type="text/css">
                .sagecell .CodeMirror-scroll {
                        overflow-y: hidden;
                        overflow-x: auto;
                }
                .sagecell .CodeMirror {
                        height: auto;
                }
        </style>

    
    <link rel="top" title="Using Web Frameworks for Scientific Applications" href="index.html" />
    <link rel="next" title="Handling multiple input variables in Django" href="._web4sa018.html" />
    <link rel="prev" title="Autogenerating the code" href="._web4sa016.html" />
 
  </head>
  <body>
    <div class="relbar-top">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="._web4sa018.html" title="Handling multiple input variables in Django"
             accesskey="N">next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="._web4sa016.html" title="Autogenerating the code"
             accesskey="P">previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">Using Web Frameworks for Scientific Applications</a> &raquo;</li>
 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="user-login-and-storage-of-computed-results">
<span id="wf-flask-login"></span><h1>User login and storage of computed results<a class="headerlink" href="#user-login-and-storage-of-computed-results" title="Permalink to this headline">¶</a></h1>
<span class="target" id="index-0"></span><p id="index-1">We now want to make an app where the computed results can be stored in
a database. To this end, each user must create an account and login to
this account for archiving results and for browsing previous runs of
the application. More files are needed for this purpose, compared to
the previous apps, and the files are located in the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/login">login</a> directory.</p>
<div class="section" id="required-additional-software">
<h2>Required additional software<a class="headerlink" href="#required-additional-software" title="Permalink to this headline">¶</a></h2>
<p>Three more packages are needed for this more advanced application:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://flask-login.readthedocs.org/en/latest/">Flask-Login</a></li>
<li><a class="reference external" href="http://flask.pocoo.org/docs/0.10/patterns/sqlalchemy/">Flask-SQLAlchemy</a></li>
<li><a class="reference external" href="http://packages.python.org/Flask-Mail">Flask-Mail</a></li>
</ul>
</div></blockquote>
<p>Installation is done by</p>
<div class="highlight-text"><div class="highlight"><pre>sudo pip install --upgrade flask-login
sudo pip install --upgrade flask-sqlalchemy
sudo pip install --upgrade flask-mail
</pre></div>
</div>
</div>
<div class="section" id="the-compute-part-2">
<h2>The compute part  (2)<a class="headerlink" href="#the-compute-part-2" title="Permalink to this headline">¶</a></h2>
<p>The <tt class="docutils literal"><span class="pre">compute.py</span></tt> file contains the <tt class="docutils literal"><span class="pre">compute</span></tt>
function from the <tt class="docutils literal"><span class="pre">vib2</span></tt> app in the section <a class="reference internal" href="._web4sa015.html#wf-vib2-flask-nofiles"><em>Avoiding plot files</em></a>.</p>
<p>There is quite much Flask code required for user accounts and login.
The files here were generated by the Parampool package and then
edited and specialized to the present application. In general,
it is not recommended to hack further on the example given here,
but rather utilize Parampool to generate web apps with user accounts
and login.</p>
</div>
<div class="section" id="the-interfaces-of-the-app">
<h2>The interfaces of the app<a class="headerlink" href="#the-interfaces-of-the-app" title="Permalink to this headline">¶</a></h2>
<p>The first page after starting the app (<tt class="docutils literal"><span class="pre">python</span> <span class="pre">controller.py</span></tt>)
shows input fields for the numerical parameters, but there are also
links to the right for registering a new user or logging in to an
existing account:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_main.png"><img alt="_images/login_main.png" src="_images/login_main.png" style="width: 700px;" /></a>
</div>
<p>Clicking on <em>Register</em> brings up a registration page:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_register.png"><img alt="_images/login_register.png" src="_images/login_register.png" style="width: 700px;" /></a>
</div>
<p>Already registered users can just log in:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_login.png"><img alt="_images/login_login.png" src="_images/login_login.png" style="width: 700px;" /></a>
</div>
<p>Then the fields with input parameters are shown again. After pressing
<em>Compute</em> we are left with a combination of input and results, plus
a field where the user can write a comment about this simulation:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_results.png"><img alt="_images/login_results.png" src="_images/login_results.png" style="width: 700px;" /></a>
</div>
<p>All simulations (input data, results, and comment) are stored in
a database. Clicking on <em>Previous simulation</em> brings us to an
overview of what is in the database:</p>
<div class="figure">
<a class="reference internal image-reference" href="_images/login_old.png"><img alt="_images/login_old.png" src="_images/login_old.png" style="width: 500px;" /></a>
</div>
<p>Here, one can browse previous results, remove entries, or erase the
whole database.</p>
</div>
<div class="section" id="the-source-code">
<h2>The source code<a class="headerlink" href="#the-source-code" title="Permalink to this headline">¶</a></h2>
<p>Rather than explaining everything about the source code
in detail, we primarily list
the various code files below. A starting point is the central <tt class="docutils literal"><span class="pre">controller.py</span></tt>
file, which is now quite lengthy and involves four different
URLs (the input page, the login page, the registration page, and the
previous results page).</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span> <span class="k">as</span> <span class="n">compute_function</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span>
<span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">ComputeForm</span>
<span class="kn">from</span> <span class="nn">db_models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span><span class="p">,</span> <span class="n">Compute</span>
<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">LoginManager</span><span class="p">,</span> <span class="n">current_user</span><span class="p">,</span> \
     <span class="n">login_user</span><span class="p">,</span> <span class="n">logout_user</span><span class="p">,</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>
<span class="n">login_manager</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="nd">@login_manager.user_loader</span>
<span class="k">def</span> <span class="nf">load_user</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

<span class="c"># Path to the web application</span>
<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ComputeForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">compute_function</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                      <span class="n">form</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">form</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
                <span class="nb">object</span> <span class="o">=</span> <span class="n">Compute</span><span class="p">()</span>
                <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
                <span class="nb">object</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span>
                <span class="nb">object</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

                <span class="c"># Send email notification</span>
                <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">notify</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">:</span>
                    <span class="n">send_email</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">result</span>
                <span class="n">form</span> <span class="o">=</span> <span class="n">populate_form_from_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;view.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span>
                           <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">populate_form_from_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Repopulate form with previous values&quot;&quot;&quot;</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">ComputeForm</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
        <span class="n">field</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">form</span>

<span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">flask.ext.mail</span> <span class="kn">import</span> <span class="n">Mail</span><span class="p">,</span> <span class="n">Message</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="n">Mail</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="s">&quot;Compute Computations Complete&quot;</span><span class="p">,</span>
                  <span class="n">recipients</span><span class="o">=</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">])</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">A simulation has been completed by the Flask Compute app.</span>
<span class="s">Please log in at</span>

<span class="s">http://localhost:5000/login</span>

<span class="s">to see the results.</span>

<span class="s">---</span>
<span class="s">If you don&#39;t want email notifications when a result is found,</span>
<span class="s">please register a new user and leave the &#39;notify&#39; field</span>
<span class="s">unchecked.</span>
<span class="s">&quot;&quot;&quot;</span>
    <span class="n">mail</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/reg&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">create_login</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">register_form</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">register_form</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
        <span class="n">form</span><span class="o">.</span><span class="n">populate_obj</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">form</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;reg.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">forms</span> <span class="kn">import</span> <span class="n">login_form</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">login_form</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>
        <span class="n">login_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;login.html&quot;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/logout&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
    <span class="n">logout_user</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/old&#39;</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">old</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="n">form</span> <span class="o">=</span> <span class="n">populate_form_from_instance</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">result</span>
            <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">comments</span><span class="p">:</span>
                <span class="n">comments</span> <span class="o">=</span> <span class="s">&quot;&lt;h3&gt;Comments&lt;/h3&gt;&quot;</span> <span class="o">+</span> <span class="n">instance</span><span class="o">.</span><span class="n">comments</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">comments</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span><span class="s">&#39;form&#39;</span><span class="p">:</span><span class="n">form</span><span class="p">,</span> <span class="s">&#39;result&#39;</span><span class="p">:</span><span class="n">result</span><span class="p">,</span>
                 <span class="s">&#39;id&#39;</span><span class="p">:</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&#39;comments&#39;</span><span class="p">:</span> <span class="n">comments</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;old.html&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/add_comment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">add_comment</span><span class="p">():</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">comments</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;comments&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">))</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/delete/&lt;id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">delete_post</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">current_user</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">instances</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">Compute</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s">&#39;old&#39;</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&#39;sqlite.db&#39;</span><span class="p">)):</span>
        <span class="n">db</span><span class="o">.</span><span class="n">create_all</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Creation of the <tt class="docutils literal"><span class="pre">app</span></tt> object is put in a separate file <tt class="docutils literal"><span class="pre">app.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s">&#39;SQLALCHEMY_DATABASE_URI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;sqlite:///sqlite.db&#39;</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>

<span class="c"># Email settings</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">MAIL_SERVER</span><span class="o">=</span><span class="s">&#39;smtp.gmail.com&#39;</span><span class="p">,</span>
        <span class="n">MAIL_PORT</span><span class="o">=</span><span class="mi">587</span><span class="p">,</span>
        <span class="n">MAIL_USE_TLS</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">MAIL_USERNAME</span> <span class="o">=</span> <span class="s">&#39;cbcwebsolvermail@gmail.com&#39;</span><span class="p">,</span>
        <span class="n">MAIL_PASSWORD</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">decodestring</span><span class="p">(</span><span class="s">&#39;WGlmZmljdox0UFch&#39;</span><span class="p">),</span>
        <span class="n">MAIL_DEFAULT_SENDER</span> <span class="o">=</span> <span class="s">&#39;Some name &lt;name@gmail.com&gt;&#39;</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>The forms for the compute function and for the login is
stored in a file called <tt class="docutils literal"><span class="pre">forms.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">wtforms</span> <span class="kn">as</span> <span class="nn">wtf</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="k">class</span> <span class="nc">ComputeForm</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( A \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( b \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( w \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">pi</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;\( T \)&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;resolution&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()])</span>

<span class="kn">from</span> <span class="nn">db_models</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">User</span>
<span class="kn">import</span> <span class="nn">flask.ext.wtf.html5</span> <span class="kn">as</span> <span class="nn">html5</span>

<span class="c"># Standard Forms</span>
<span class="k">class</span> <span class="nc">register_form</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Username&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">PasswordField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span>
            <span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">(),</span>
            <span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">EqualTo</span><span class="p">(</span>
                <span class="s">&#39;confirm&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&#39;Passwords must match&#39;</span><span class="p">)])</span>
    <span class="n">confirm</span>  <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">PasswordField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Confirm Password&#39;</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>
    <span class="n">email</span>    <span class="o">=</span> <span class="n">html5</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Email&#39;</span><span class="p">)</span>
    <span class="n">notify</span>   <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">&#39;Email notifications&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notify</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="s">&#39;Cannot send notifications without a valid email address&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;User already exists&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">login_form</span><span class="p">(</span><span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Username&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">wtf</span><span class="o">.</span><span class="n">PasswordField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s">&#39;Password&#39;</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtf</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Required</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wtf</span><span class="o">.</span><span class="n">Form</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Unknown username&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;Invalid password&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>
</div>
<p>Database-related code for the SQLAlchemy database is collected in
<tt class="docutils literal"><span class="pre">db_models.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask.ext.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">generate_password_hash</span><span class="p">,</span> <span class="n">check_password_hash</span>
<span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">pwhash</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">120</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">notify</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;User </span><span class="si">%r</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">check_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pwhash</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pwhash</span> <span class="o">=</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="n">pw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_authenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">is_anonymous</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>

<span class="k">class</span> <span class="nc">Compute</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">())</span>
    <span class="n">comments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&#39;user.id&#39;</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s">&#39;User&#39;</span><span class="p">,</span>
           <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s">&#39;Compute&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s">&#39;dynamic&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Finally, we need views. For the results of the computation we have
a <tt class="docutils literal"><span class="pre">view.html</span></tt> file that is very similar to <tt class="docutils literal"><span class="pre">view_table.html</span></tt>
in the <tt class="docutils literal"><span class="pre">vib1</span></tt> app:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span>
&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;&gt;
<span class="nt">&lt;/script&gt;</span>

{% if user.is_anonymous() %}
  <span class="nt">&lt;p</span> <span class="na">align=</span><span class="s">&quot;right&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/login&quot;</span><span class="nt">&gt;</span>Login<span class="nt">&lt;/a&gt;</span>
  / <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/reg&quot;</span><span class="nt">&gt;</span>Register<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
{% else %}
  <span class="nt">&lt;p</span> <span class="na">align=</span><span class="s">&quot;right&quot;</span><span class="nt">&gt;</span>Logged in as {{user.username}}<span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/old&quot;</span><span class="nt">&gt;</span>Previous simulations<span class="nt">&lt;a/&gt;&lt;br&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/logout&quot;</span><span class="nt">&gt;</span>Logout<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
{% endif %}

This web page visualizes the function \(
u(t) = Ae^{-bt}\sin (w t), \hbox{ for } t\in [0,T]
\).

<span class="nt">&lt;p&gt;</span>
<span class="c">&lt;!-- Input and Results are typeset as a two-column table --&gt;</span>
<span class="nt">&lt;table&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;h2&gt;</span>Input:<span class="nt">&lt;/h2&gt;</span>

<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span> <span class="na">enctype=</span><span class="s">multipart/form-data</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span>
      {% if field.errors %}
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
        {% for error in field.errors %}
          <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
        {% endfor %}<span class="nt">&lt;/ul&gt;</span>
      {% endif %}
      <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Compute&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/td&gt;</span>

<span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span><span class="nt">&gt;</span>
  {% if result != None %}
    <span class="nt">&lt;h2&gt;</span>Results:<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ result|safe }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
    {% if not user.is_anonymous() %}
      <span class="nt">&lt;h3&gt;</span>Comments:<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span> <span class="na">action=</span><span class="s">&quot;/add_comment&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">&quot;comments&quot;</span> <span class="na">rows=</span><span class="s">&quot;4&quot;</span> <span class="na">cols=</span><span class="s">&quot;40&quot;</span><span class="nt">&gt;&lt;/textarea&gt;</span>
          <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Add&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;/form&gt;</span>
      {% endif %}

  {% endif %}
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">login.html</span></tt> template for the login page takes the form</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h2&gt;</span>Login:<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;table&gt;</span>
    {% for field in form %}
      <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            {% if field.errors %}
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
              {% for error in field.errors %}
                <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
              {% endfor %}<span class="nt">&lt;/ul&gt;</span>
            {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    {% endfor %}
  <span class="nt">&lt;/table&gt;</span>
  <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Login&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The page for registering a new user has a simple template <tt class="docutils literal"><span class="pre">reg.html</span></tt>:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;h2&gt;</span>Register:<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
   {% for field in form %}
     <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}<span class="nt">&lt;/td&gt;</span>
         <span class="nt">&lt;td&gt;</span>{{ field(size=20) }}<span class="nt">&lt;/td&gt;</span>
          <span class="nt">&lt;td&gt;</span>
            {% if field.errors %}
              <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
              {% for error in field.errors %}
                <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
              {% endfor %}<span class="nt">&lt;/ul&gt;</span>
            {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
   {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Register</span><span class="nt">&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The final file is <tt class="docutils literal"><span class="pre">old.html</span></tt> for retrieving old simulations:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;title&gt;</span>Flask Vib app<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>

<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/x-mathjax-config&quot;</span><span class="nt">&gt;</span>
<span class="nx">MathJax</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Config</span><span class="p">({</span>
  <span class="nx">TeX</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">equationNumbers</span><span class="o">:</span> <span class="p">{</span>  <span class="nx">autoNumber</span><span class="o">:</span> <span class="s2">&quot;AMS&quot;</span>  <span class="p">},</span>
     <span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;AMSmath.js&quot;</span><span class="p">,</span> <span class="s2">&quot;AMSsymbols.js&quot;</span><span class="p">,</span> <span class="s2">&quot;autobold.js&quot;</span><span class="p">,</span> <span class="s2">&quot;color.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span>
 <span class="na">src=</span><span class="s">&quot;http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/script&gt;</span>

<span class="nt">&lt;h2&gt;</span>Previous simulations<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;p</span> <span class="na">align=</span><span class="s">&quot;right&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>Back to index<span class="nt">&lt;/a&gt;&lt;/p&gt;</span>
{% if data %}
  {% for post in data %}
    <span class="nt">&lt;hr&gt;</span>
    <span class="nt">&lt;table&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">width=</span><span class="s">&quot;30%&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Input<span class="nt">&lt;/h3&gt;</span>
      <span class="nt">&lt;table&gt;</span>
      {% for field in post.form %}
        <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.label }}:<span class="ni">&amp;nbsp;</span><span class="nt">&lt;/td&gt;</span>
            <span class="nt">&lt;td&gt;</span>{{ field.data }}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
      {% endfor %}
      <span class="nt">&lt;/table&gt;</span>
    <span class="nt">&lt;/td&gt;&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">width=</span><span class="s">&quot;60%&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>Results<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ post.result|safe }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
    {% if True %}
      <span class="nt">&lt;p&gt;</span>
      {{ comments }}
    {% endif %}
    <span class="nt">&lt;/td&gt;&lt;td</span> <span class="na">valign=</span><span class="s">&quot;top&quot;</span> <span class="na">width=</span><span class="s">&quot;60%&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p&gt;</span>
    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">action=</span><span class="s">&quot;/delete/{{ post.id }}&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">&quot;Delete&quot;</span>
       <span class="na">title=</span><span class="s">&quot;Delete this post from database&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
    <span class="nt">&lt;/table&gt;</span>
   {% endfor %}
   <span class="nt">&lt;hr&gt;</span>
   <span class="nt">&lt;center&gt;</span>
   <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">action=</span><span class="s">&quot;/delete/-1&quot;</span><span class="nt">&gt;</span>
     <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">&quot;Delete all&quot;</span><span class="nt">&gt;</span>
   <span class="nt">&lt;/form&gt;</span>
   <span class="nt">&lt;/center&gt;</span>
{% else %}
  No previous simulations
{% endif %}
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<ul class="last simple">
<li>Sending email from the app does not work.</li>
<li>Storing comments does not work.</li>
</ul>
</div>
<p>[<strong>hpl 1</strong>: Check if an autogenerated app from <tt class="docutils literal"><span class="pre">_generate_app.py</span></tt> can send mail and store comments. Need a <tt class="docutils literal"><span class="pre">compute</span></tt> function that returns full HTML text then.]</p>
</div>
<div class="section" id="resources-1">
<h2>Resources  (1)<a class="headerlink" href="#resources-1" title="Permalink to this headline">¶</a></h2>
<p>Working with a database in Flask is described here:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://pythonhosted.org/Flask-SQLAlchemy/quickstart.html">http://pythonhosted.org/Flask-SQLAlchemy/quickstart.html</a>,</li>
<li><a class="reference external" href="http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-iv-database">http://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-iv-database</a>,</li>
<li><a class="reference external" href="https://flask-login.readthedocs.org/en/latest/">The Flask login extension</a></li>
</ul>
</div></blockquote>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">User login and storage of computed results</a><ul>
<li><a class="reference internal" href="#required-additional-software">Required additional software</a></li>
<li><a class="reference internal" href="#the-compute-part-2">The compute part  (2)</a></li>
<li><a class="reference internal" href="#the-interfaces-of-the-app">The interfaces of the app</a></li>
<li><a class="reference internal" href="#the-source-code">The source code</a></li>
<li><a class="reference internal" href="#resources-1">Resources  (1)</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="._web4sa016.html"
                        title="previous chapter">Autogenerating the code</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="._web4sa018.html"
                        title="next chapter">Handling multiple input variables in Django</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/._web4sa017.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="._web4sa018.html" title="Handling multiple input variables in Django"
             >next</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="._web4sa016.html" title="Autogenerating the code"
             >previous</a> &nbsp; &nbsp;</li>
    <li><a href="index.html">Using Web Frameworks for Scientific Applications</a> &raquo;</li>
 
      </ul>
    </div>
    </div>

    <div class="footer">
        &copy; Copyright 2014, H. P. Langtangen and A. E. Johansen.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.
    </div>
    <!-- cloud_sptheme 1.3 -->
  </body>
</html>