

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Avoiding plot files &mdash; Using Web Frameworks for Scientific Applications</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>

        <script src="http://sagecell.sagemath.org/static/jquery.min.js"></script>
        <script src="http://sagecell.sagemath.org/static/embedded_sagecell.js"></script>

        <script>sagecell.makeSagecell({inputLocation: ".sage"});</script>

        <style type="text/css">
                .sagecell .CodeMirror-scroll {
                        overflow-y: hidden;
                        overflow-x: auto;
                }
                .sagecell .CodeMirror {
                        height: auto;
                }
        </style>

    
    <link rel="top" title="Using Web Frameworks for Scientific Applications" href="index.html" />
    <link rel="next" title="Autogenerating the code" href="._web4sa016.html" />
    <link rel="prev" title="Custom validation (1)" href="._web4sa014.html" />
 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="._web4sa016.html" title="Autogenerating the code"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="._web4sa014.html" title="Custom validation (1)"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Using Web Frameworks for Scientific Applications</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="avoiding-plot-files">
<span id="wf-vib2-flask-nofiles"></span><h1>Avoiding plot files<a class="headerlink" href="#avoiding-plot-files" title="Permalink to this headline">¶</a></h1>
<p>Files with plots are easy to deal with as long as they are in the
<tt class="docutils literal"><span class="pre">static</span></tt> subdirectory of the Flask application directory. However,
as already pointed out, the previous <tt class="docutils literal"><span class="pre">vib1</span></tt> app, which writes plot
files, is not suited for multiple simultaneous users since every
user will destroy <em>all</em> existing plot files before making a new
one. Therefore, we need a robust solution for multiple users of
the app.</p>
<p>The idea is to not write plot files, but instead return the plot
as a string and embed that string directly in the HTML code.
This is relatively straightforward with Matplotlib
and Python. The relevant code is found in the <tt class="docutils literal"><span class="pre">compute.py</span></tt> file
of the <tt class="docutils literal"><span class="pre">vib2</span></tt> app.</p>
<span class="target" id="index-0"></span><span class="target" id="index-1"></span><span class="target" id="index-2"></span><span class="target" id="index-3"></span><div class="section" id="png-plots">
<span id="index-4"></span><h2>PNG plots<a class="headerlink" href="#png-plots" title="Permalink to this headline">¶</a></h2>
<p>Python has the <tt class="docutils literal"><span class="pre">StringIO</span></tt> object that is a string buffer with the
look and behavior of a file. The idea is to let Matplotlib write to
a <tt class="docutils literal"><span class="pre">StringIO</span></tt> object and afterwards extract the string from this object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plot</span>
<span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="c"># run plt.plot, plt.title, etc.</span>
<span class="n">figfile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
<span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># rewind to beginning of file</span>
<span class="n">figdata_png</span> <span class="o">=</span> <span class="n">figfile</span><span class="o">.</span><span class="n">buf</span>  <span class="c"># extract string</span>
</pre></div>
</div>
<p>Before the PNG data can be embedded in HTML we need to convert the
data to base64 format:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">base64</span>
<span class="n">figdata_png</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">figdata_png</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we can embed the PNG data in HTML by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="o">&lt;</span><span class="n">img</span> <span class="n">src</span><span class="o">=</span><span class="s">&quot;data:image/png;base64,PLOTSTR&quot;</span> <span class="n">width</span><span class="o">=</span><span class="s">&quot;500&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>where <tt class="docutils literal"><span class="pre">PLOTSTR</span></tt> is the content of the string <tt class="docutils literal"><span class="pre">figdata_png</span></tt>.</p>
<p>The complete <tt class="docutils literal"><span class="pre">compute.py</span></tt> function takes the form</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">compute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return filename of plot of the damped_vibration function.&quot;&quot;&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">damped_vibrations</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  <span class="c"># needed to avoid adding curves in plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;A=</span><span class="si">%g</span><span class="s">, b=</span><span class="si">%g</span><span class="s">, w=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>

    <span class="c"># Make Matplotlib write to StringIO file object and grab</span>
    <span class="c"># return the object&#39;s string</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;png&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># rewind to beginning of file</span>
    <span class="kn">import</span> <span class="nn">base64</span>
    <span class="n">figdata_png</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">figfile</span><span class="o">.</span><span class="n">buf</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">figdata_png</span>
</pre></div>
</div>
<p>The relevant syntax in an HTML template is</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;data:image/png;base64,{{ results }}&quot;</span> <span class="na">width=</span><span class="s">&quot;500&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>
<p>if <tt class="docutils literal"><span class="pre">results</span></tt> holds the returned object from the <tt class="docutils literal"><span class="pre">compute</span></tt> function above.</p>
</div>
<div class="section" id="svg-plots">
<span id="index-5"></span><h2>SVG plots<a class="headerlink" href="#svg-plots" title="Permalink to this headline">¶</a></h2>
<p>Inline figures in HTML, instead of using files, are most often realized
by XML code with the figure data in SVG format.
Plot strings in the SVG format are created very similarly to the PNG
example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">figfile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;svg&#39;</span><span class="p">)</span>
<span class="n">figdata_svg</span> <span class="o">=</span> <span class="n">figfile</span><span class="o">.</span><span class="n">buf</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">figdata_svg</span></tt> string contains XML code text can almost
be directly embedded in
HTML5. However, the beginning of the text contains information before
the <tt class="docutils literal"><span class="pre">svg</span></tt> tag that we want to remove:</p>
<div class="highlight-text"><div class="highlight"><pre>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;no&quot;?&gt;
&lt;!DOCTYPE svg PUBLIC &quot;-//W3C//DTD SVG 1.1//EN&quot;
  &quot;http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd&quot;&gt;
&lt;!-- Created with matplotlib (http://matplotlib.sourceforge.net/) --&gt;
&lt;svg height=&quot;441pt&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 585 441&quot; ...
</pre></div>
</div>
<p>The removal is done with a little string manipulation:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">figdata_svg</span> <span class="o">=</span> <span class="s">&#39;&lt;svg&#39;</span> <span class="o">+</span> <span class="n">figfile</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;svg&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>Now, <tt class="docutils literal"><span class="pre">figdata_svg</span></tt> can be directly inserted in HTML code without
any surrounding tags (because it is perfectly valid HTML code in itself).</p>
<p>The SVG code generated by Matplotlib may contain UTF-8 characters
so it is necessary to make a unicode string out of the text:
<tt class="docutils literal"><span class="pre">unicode(figdata_svg,</span> <span class="pre">'utf-8')</span></tt>, otherwise the HTML template will
lead to an encoding exception.</p>
<p>We have made an alternative compute function <tt class="docutils literal"><span class="pre">compute_png_svg</span></tt>
that returns both a PNG and an SVG plot:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">compute_png_svg</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">figfile</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">figfile</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;svg&#39;</span><span class="p">)</span>
    <span class="n">figfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">figdata_svg</span> <span class="o">=</span> <span class="s">&#39;&lt;svg&#39;</span> <span class="o">+</span> <span class="n">figfile</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&lt;svg&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">figdata_svg</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">figdata_svg</span><span class="p">,</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">figdata_png</span><span class="p">,</span> <span class="n">figdata_svg</span>
</pre></div>
</div>
<p id="index-6">The relevant syntax for inserting an SVG plot in the HTML template is now</p>
<div class="highlight-html"><div class="highlight"><pre>{{ result[1]|safe }}
</pre></div>
</div>
<p>The use of <tt class="docutils literal"><span class="pre">safe</span></tt> is essential here.</p>
<div class="admonition-important-use-safe-for-verbatim-html-code admonition">
<p class="first admonition-title">Important: use <tt class="docutils literal"><span class="pre">safe</span></tt> for verbatim HTML code</p>
<p class="last">Special HTML characters like <tt class="docutils literal"><span class="pre">&lt;</span></tt>, <tt class="docutils literal"><span class="pre">&gt;</span></tt>,
<tt class="docutils literal"><span class="pre">&amp;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;</span></tt>, and <tt class="docutils literal"><span class="pre">'</span></tt> are escaped in a template string like <tt class="docutils literal"><span class="pre">{{</span> <span class="pre">str</span> <span class="pre">}}</span></tt>
(i.e., <tt class="docutils literal"><span class="pre">&amp;</span></tt> is replaced by <tt class="docutils literal"><span class="pre">&amp;amp;</span></tt> <cite>&lt;</cite> is replaced by <tt class="docutils literal"><span class="pre">&amp;lt;</span></tt>, etc.).
We need to avoid this manipulation of the string content
because <tt class="docutils literal"><span class="pre">result[1]</span></tt> contains
XML code where the mentioned characters are essential part of the syntax.
Writing <tt class="docutils literal"><span class="pre">{{str|safe}}</span></tt> ensures that the contents of the string <tt class="docutils literal"><span class="pre">str</span></tt>
are not altered before being embedded in the HTML text.</p>
</div>
<p>An alternative template, <tt class="docutils literal"><span class="pre">view_svg.html</span></tt> applies the SVG plot instead
of the PNG plot. We use the command-line argument <tt class="docutils literal"><span class="pre">svg</span></tt> for indicating
that we want an SVG instead of a PNG plot:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># SVG or PNG plot?</span>
<span class="n">svg</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;svg&#39;</span><span class="p">:</span>
        <span class="n">svg</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">if</span> <span class="n">svg</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute_png_svg</span> <span class="k">as</span> <span class="n">compute</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s">&#39;view_svg.html&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s">&#39;view.html&#39;</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <center>
            <p class="logo"><a href="http://cbc.simula.no/" title="Go to Center for Biomedical Computing">
              <img class="logo" src="_static/cbc_logo.png" alt="Logo"/>
            </a></p>
            </center>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Avoiding plot files</a><ul>
<li><a class="reference internal" href="#png-plots">PNG plots</a></li>
<li><a class="reference internal" href="#svg-plots">SVG plots</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="._web4sa014.html"
                        title="previous chapter">Custom validation  (1)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="._web4sa016.html"
                        title="next chapter">Autogenerating the code</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/._web4sa015.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="._web4sa016.html" title="Autogenerating the code"
             >next</a> |</li>
        <li class="right" >
          <a href="._web4sa014.html" title="Custom validation (1)"
             >previous</a> |</li>
        <li><a href="index.html">Using Web Frameworks for Scientific Applications</a> &raquo;</li> 
      </ul>
    </div>
<div class="wrapper">
  <div class="footer">
  <a href="http://cbc.simula.no"><img src="_static/cbc_banner.png" width="100%"><a>
  </div>
</div>

  </body>
</html>