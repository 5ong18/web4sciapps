.. !split

.. _wf:vib2:flask:nofiles:

Avoiding plot files
-------------------

Files with plots are easy to deal with as long as they are in the
``static`` subdirectory of the Flask application directory. However,
as already pointed out, the previous ``vib1`` app, which writes plot
files, is not suited for multiple simultaneous users since every
user will destroy *all* existing plot files before making a new
one. Therefore, we need a robust solution for multiple users of
the app.

The idea is to not write plot files, but instead return the plot
as a string and embed that string directly in the HTML code.
This is relatively straightforward with Matplotlib
and Python. The relevant code is found in the ``compute.py`` file
of the ``vib2`` app.

.. index:: inline PNG image in HTML

.. index:: StringIO objects

.. index:: file-like string objects (StringIO)

.. index:: strings as files (StringIO)

.. index:: base64 encoding of PNG images

PNG plots
~~~~~~~~~

Python has the ``StringIO`` object that is a string buffer with the
look and behavior of a file. The idea is to let Matplotlib write to
a ``StringIO`` object and afterwards extract the string from this object:

.. code-block:: python

        import matplotlib.pyplot as plot
        from StringIO import StringIO
        # run plt.plot, plt.title, etc.
        figfile = StringIO()
        plt.savefig(figfile, format='png')
        figfile.seek(0)  # rewind to beginning of file
        figdata_png = figfile.buf  # extract string

Before the PNG data can be embedded in HTML we need to convert the
data to base64 format:

.. code-block:: python

        import base64
        figdata_png = base64.b64encode(figdata_png)

Now we can embed the PNG data in HTML by

.. code-block:: python

        <img src="data:image/png;base64,PLOTSTR" width="500">

where ``PLOTSTR`` is the content of the string ``figdata_png``.

The complete ``compute.py`` function takes the form

.. code-block:: python

        def compute(A, b, w, T, resolution=500):
            """Return filename of plot of the damped_vibration function."""
            t = linspace(0, T, resolution+1)
            y = damped_vibrations(t, A, b, w)
            plt.figure()  # needed to avoid adding curves in plot
            plt.plot(t, y)
            plt.title('A=%g, b=%g, w=%g' % (A, b, w))
        
            # Make Matplotlib write to StringIO file object and grab
            # return the object's string
            from StringIO import StringIO
            figfile = StringIO()
            plt.savefig(figfile, format='png')
            figfile.seek(0)  # rewind to beginning of file
            import base64
            figdata_png = base64.b64encode(figfile.buf)
            return figdata_png

The relevant syntax in an HTML template is

.. code-block:: html

        <img src="data:image/png;base64,{{ results }}" width="500">

if ``results`` holds the returned object from the ``compute`` function above.

.. index:: inline SVG figure in HTML

SVG plots
~~~~~~~~~

Inline figures in HTML, instead of using files, are most often realized
by XML code with the figure data in SVG format.
Plot strings in the SVG format are created very similarly to the PNG
example:

.. code-block:: python

        figfile = StringIO()
        plt.savefig(figfile, format='svg')
        figdata_svg = figfile.buf

The ``figdata_svg`` string contains XML code text can almost
be directly embedded in
HTML5. However, the beginning of the text contains information before
the ``svg`` tag that we want to remove:

.. code-block:: text

        <?xml version="1.0" encoding="utf-8" standalone="no"?>
        <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
          "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
        <!-- Created with matplotlib (http://matplotlib.sourceforge.net/) -->
        <svg height="441pt" version="1.1" viewBox="0 0 585 441" ...

The removal is done with a little string manipulation:

.. code-block:: python

        figdata_svg = '<svg' + figfile.buf.split('<svg')[1]

Now, ``figdata_svg`` can be directly inserted in HTML code without
any surrounding tags (because it is perfectly valid HTML code in itself).

The SVG code generated by Matplotlib may contain UTF-8 characters
so it is necessary to make a unicode string out of the text:
``unicode(figdata_svg, 'utf-8')``, otherwise the HTML template will
lead to an encoding exception.

We have made an alternative compute function ``compute_png_svg``
that returns both a PNG and an SVG plot:

.. code-block:: python

        def compute_png_svg(A, b, w, T, resolution=500):
            ...
            figfile = StringIO()
            plt.savefig(figfile, format='svg')
            figfile.seek(0)
            figdata_svg = '<svg' + figfile.buf.split('<svg')[1]
            figdata_svg = unicode(figdata_svg,'utf-8')
            return figdata_png, figdata_svg

.. index::
   single: safe, as in object|safe

The relevant syntax for inserting an SVG plot in the HTML template is now

.. code-block:: html

        {{ result[1]|safe }}

The use of ``safe`` is essential here.


.. admonition:: Important: use ``safe`` for verbatim HTML code

   Special HTML characters like ``<``, ``>``,
   ``&``, ``"``, and ``'`` are escaped in a template string like ``{{ str }}``
   (i.e., ``&`` is replaced by ``&amp;`` `<` is replaced by ``&lt;``, etc.).
   We need to avoid this manipulation of the string content
   because ``result[1]`` contains
   XML code where the mentioned characters are essential part of the syntax.
   Writing ``{{str|safe}}`` ensures that the contents of the string ``str``
   are not altered before being embedded in the HTML text.




An alternative template, ``view_svg.html`` applies the SVG plot instead
of the PNG plot. We use the command-line argument ``svg`` for indicating
that we want an SVG instead of a PNG plot:

.. code-block:: python

        # SVG or PNG plot?
        svg = False
        try:
            if sys.argv[1] == 'svg':
                svg = True
        except IndexError:
            pass
        if svg:
            from compute import compute_png_svg as compute
            template = 'view_svg.html'
        else:
            from compute import compute
            template = 'view.html'

