

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Autogenerating the code &mdash; Using Web Frameworks for Scientific Applications</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>

        <script src="http://sagecell.sagemath.org/static/jquery.min.js"></script>
        <script src="http://sagecell.sagemath.org/static/embedded_sagecell.js"></script>

        <script>sagecell.makeSagecell({inputLocation: ".sage"});</script>

        <style type="text/css">
                .sagecell .CodeMirror-scroll {
                        overflow-y: hidden;
                        overflow-x: auto;
                }
                .sagecell .CodeMirror {
                        height: auto;
                }
        </style>

    
    <link rel="top" title="Using Web Frameworks for Scientific Applications" href="index.html" />
    <link rel="next" title="Avoiding plot files" href="._web4sa014.html" />
    <link rel="prev" title="Custom validation (1)" href="._web4sa012.html" />
 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="._web4sa014.html" title="Avoiding plot files"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="._web4sa012.html" title="Custom validation (1)"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">Using Web Frameworks for Scientific Applications</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="autogenerating-the-code">
<span id="wf-vib3-flask-autogen"></span><h1>Autogenerating the code<a class="headerlink" href="#autogenerating-the-code" title="Permalink to this headline">Â¶</a></h1>
<span class="target" id="index-0"></span><span class="target" id="index-1"></span><p id="index-2">We shall now present generic <tt class="docutils literal"><span class="pre">model.py</span></tt> and <tt class="docutils literal"><span class="pre">controller.py</span></tt>
files that work with <em>any</em> <tt class="docutils literal"><span class="pre">compute</span></tt> function (!). This example will
demonstrate some advanced, powerful features of Python. The source code
is found in the <a class="reference external" href="https://github.com/hplgit/web4sciapps/tree/master/doc/src/web4sa/src-web4sa/apps/flask_apps/vib3">vib3</a>
directory.</p>
<p><strong>Inspecting function signatures.</strong>
The basic idea is that the Python module <tt class="docutils literal"><span class="pre">inspect</span></tt> can be used to
retrieve the names of the arguments and the default values of
keyword arguments of <em>any</em> given <tt class="docutils literal"><span class="pre">compute</span></tt> function. Say we have some</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">mycompute</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]):</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>Running</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">defaults</span>  <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span>
</pre></div>
</div>
<p>leads to</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">arg_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="s">&#39;m&#39;</span><span class="p">,</span> <span class="s">&#39;s&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;x_range&#39;</span><span class="p">]</span>
<span class="n">defaults</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
<p>We have all the argument names in <tt class="docutils literal"><span class="pre">arg_names</span></tt> and
<tt class="docutils literal"><span class="pre">defaults[i]</span></tt> is the default value of keyword argument
<tt class="docutils literal"><span class="pre">arg_names[j]</span></tt>, where <tt class="docutils literal"><span class="pre">j</span> <span class="pre">=</span> <span class="pre">len(arg_names)</span> <span class="pre">-</span> <span class="pre">len(defaults)</span> <span class="pre">+</span> <span class="pre">i</span></tt>.</p>
<p><strong>Generating the model.</strong>
Knowing the name <tt class="docutils literal"><span class="pre">name</span></tt> of some argument in the <tt class="docutils literal"><span class="pre">compute</span></tt>
function, we can make the corresponding class attribute
in the <tt class="docutils literal"><span class="pre">InputForm</span></tt> class by</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">FloatForm</span><span class="p">())</span>
</pre></div>
</div>
<p>For name equal to <tt class="docutils literal"><span class="pre">'A'</span></tt> this is the same as hardcoding</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">:</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">FloatForm</span><span class="p">()</span>
</pre></div>
</div>
<p>Assuming that all arguments in <tt class="docutils literal"><span class="pre">compute</span></tt> are floats, we could
do</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">InputForm</span><span class="p">:</span>
    <span class="k">pass</span>  <span class="c"># Empty class</span>

<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">mycompute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">:</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">FloatForm</span><span class="p">())</span>
</pre></div>
</div>
<p>However, we can do better than this: for
keyword arguments the type of the default value can be used to
select the appropriate form class. The complete <tt class="docutils literal"><span class="pre">model.py</span></tt> file
then goes as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Example on generic model.py file which inspects the arguments</span>
<span class="sd">of the compute function and automatically generates a relevant</span>
<span class="sd">InputForm class.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">wtforms</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span>

<span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute_gamma</span> <span class="k">as</span> <span class="n">compute</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">defaults</span>  <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span>

<span class="k">class</span> <span class="nc">InputForm</span><span class="p">(</span><span class="n">wtforms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c"># Augment defaults with None elements for the positional</span>
<span class="c"># arguments</span>
<span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg_names</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
<span class="c"># Map type of default to right form field</span>
<span class="n">type2form</span> <span class="o">=</span> <span class="p">{</span><span class="nb">type</span><span class="p">(</span><span class="mf">1.0</span><span class="p">):</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">FloatField</span><span class="p">,</span>
             <span class="nb">type</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>   <span class="n">wtforms</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">,</span>
             <span class="nb">type</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>  <span class="n">wtforms</span><span class="o">.</span><span class="n">TextField</span><span class="p">,</span>
             <span class="p">}</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">arg_names</span><span class="p">,</span> <span class="n">defaults</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">wtforms</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span>
            <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">type2form</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type2form</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)](</span>
                <span class="n">default</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">wtforms</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">InputRequired</span><span class="p">()]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;argument </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> not supported&#39;</span> <span class="o">%</span>
                            <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">InputForm</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">item</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">InputForm</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
<p>(The <tt class="docutils literal"><span class="pre">compute_gamma</span></tt> function imported from <tt class="docutils literal"><span class="pre">compute</span></tt> is the
only application-specific statement in this code and will be explained later.)</p>
<p><strong>Generating the view.</strong>
The call to <tt class="docutils literal"><span class="pre">compute</span></tt> in the <tt class="docutils literal"><span class="pre">controller.py</span></tt> file must also be expressed
in a general way such that the call handles any type and number of
parameters. This can be done in two ways, using either positional
or keyword arguments.</p>
<p>The technique with positional arguments
is explained first. It consists of collecting all parameters in
a list or tuple, called <tt class="docutils literal"><span class="pre">args</span></tt>, and then calling <tt class="docutils literal"><span class="pre">compute(*args)</span></tt>
(which is equivalent to <tt class="docutils literal"><span class="pre">compute(args[0],</span> <span class="pre">args[1],</span> <span class="pre">...,</span> <span class="pre">args[n])</span></tt>
if <tt class="docutils literal"><span class="pre">n</span></tt> is <tt class="docutils literal"><span class="pre">len(args)-1</span></tt>). The elements of <tt class="docutils literal"><span class="pre">args</span></tt> are the values of the
form variables. We know the name of a form variable as a string
<tt class="docutils literal"><span class="pre">name</span></tt> (from <tt class="docutils literal"><span class="pre">arg_names</span></tt>), and if <tt class="docutils literal"><span class="pre">form</span></tt> is the form object,
the construction <tt class="docutils literal"><span class="pre">getattr(form,</span> <span class="pre">name).data</span></tt> extracts the value
that the user provided (<tt class="docutils literal"><span class="pre">getattr(obj,</span> <span class="pre">attr)</span></tt> gets the attribute, with name
available as a string in <tt class="docutils literal"><span class="pre">attr</span></tt>, in the object <tt class="docutils literal"><span class="pre">obj</span></tt>).
For exampe, if <tt class="docutils literal"><span class="pre">name</span></tt> is <tt class="docutils literal"><span class="pre">'A'</span></tt>, <tt class="docutils literal"><span class="pre">getattr(form,</span> <span class="pre">name).data</span></tt> is the same as
<tt class="docutils literal"><span class="pre">form.A.data</span></tt>.
Collecting all form variables, placing them in a list,
and calling <tt class="docutils literal"><span class="pre">compute</span></tt> are done with</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
<span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<p>Our <tt class="docutils literal"><span class="pre">InputForm</span></tt> class guarantees that all arguments in <tt class="docutils literal"><span class="pre">compute</span></tt>
are present in the form, but to be absolutely safe we can
test if <tt class="docutils literal"><span class="pre">name</span></tt> is present in the <tt class="docutils literal"><span class="pre">form</span></tt> object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)]</span>
</pre></div>
</div>
<p>A potential problem with the <tt class="docutils literal"><span class="pre">args</span></tt> list is that the values might
be in wrong order. It appears, fortunately, that the order we
assign attributes to the form class is preserved when iterating over
the form. Nevertheless, using keyword arguments instead of positional
arguments provides a completely safe solution to calling <tt class="docutils literal"><span class="pre">compute</span></tt>
with the correct arguments. Keyword arguments are placed in a
dictionary <tt class="docutils literal"><span class="pre">kwargs</span></tt> and <tt class="docutils literal"><span class="pre">compute</span></tt> is called as <tt class="docutils literal"><span class="pre">compute(**kwargs)</span></tt>.
The generic solution is</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span>
          <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)}</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">compute(**kwargs)</span></tt> call is equivalent to <tt class="docutils literal"><span class="pre">compute(A=1,</span> <span class="pre">b=3,</span> <span class="pre">w=0.5)</span></tt>
in case <tt class="docutils literal"><span class="pre">kwargs</span> <span class="pre">=</span> <span class="pre">{'w'=0.5,</span> <span class="pre">'A':1,</span> <span class="pre">'b':3}</span></tt> (recall that the order of
the keys in a Python dictionary is undetermined).</p>
<p><strong>Generating the template.</strong>
It remains to generate the right HTML template. The HTML code depends
on what the returned <tt class="docutils literal"><span class="pre">result</span></tt> object from <tt class="docutils literal"><span class="pre">compute</span></tt> contains. Only a
human who has read the <tt class="docutils literal"><span class="pre">compute</span></tt> code knows the details of the returned
result. Therefore, we leave it to a human to provide the part
of the HTML template that renders the result. The file <tt class="docutils literal"><span class="pre">templates/view_results.html</span></tt> contains this human-provided code, while <tt class="docutils literal"><span class="pre">templates/view.html</span></tt>
is a completely generic template for the forms:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">post</span> <span class="na">action=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;table&gt;</span>
  {% for field in form %}
    <span class="nt">&lt;tr&gt;&lt;td&gt;</span>{{ field.name }}<span class="nt">&lt;/td&gt;</span> <span class="nt">&lt;td&gt;</span>{{ field }}<span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td&gt;</span>{% if field.errors %}
      <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">errors</span><span class="nt">&gt;</span>
      {% for error in field.errors %}
        <span class="nt">&lt;li&gt;</span>{{ error }}<span class="nt">&lt;/li&gt;</span>
      {% endfor %}<span class="nt">&lt;/ul&gt;</span>
    {% endif %}<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
  {% endfor %}
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Compute</span><span class="nt">&gt;&lt;/form&gt;&lt;/p&gt;</span>

{% if result != None %}
{{ result|safe }}
{% endif %}
</pre></div>
</div>
<p>At the end of this code, an HTML text <tt class="docutils literal"><span class="pre">result</span></tt> (string) is to be
inserted.  This text is typically generated by calling Flask&#8217;s
<tt class="docutils literal"><span class="pre">render_template</span></tt> function, which uses <tt class="docutils literal"><span class="pre">templates/view_results.html</span></tt>
to turn the return object <tt class="docutils literal"><span class="pre">result</span></tt> from the compute function into the
desired HTML code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view_results.html&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="c"># result is now rendered HTML text</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A perhaps simpler alternative would be to have a generic
<tt class="docutils literal"><span class="pre">view_forms.html</span></tt> file and a user-specific
<tt class="docutils literal"><span class="pre">view_results.html</span></tt> and explicitly combining them into a new
file. This requires file writing by the app, which one normally
wants to avoid. Especially if the web app gets multiple users,
the file writing may lead to corrupt files.</p>
</div>
<p>The complete, generic form of the <tt class="docutils literal"><span class="pre">index</span></tt> function becomes</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">InputForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;POST&#39;</span> <span class="ow">and</span> <span class="n">form</span><span class="o">.</span><span class="n">validate</span><span class="p">():</span>
        <span class="n">arg_names</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">compute</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
                  <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">arg_names</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">form</span><span class="p">,</span> <span class="n">name</span><span class="p">)}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">compute</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
        <span class="c"># result must be transformed to HTML and inserted as a</span>
        <span class="c"># string in the generic view.html file</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view_results.html&#39;</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&#39;view.html&#39;</span><span class="p">,</span> <span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">,</span> <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Application.</strong>
Let us apply the files above to plot the gamma probability density function</p>
<div class="math">
\[g(x; a, h, A) = \frac{|h|}{\Gamma(a)A}\left(\frac{x}{A}\right)^{ah-1}
e^{-\left(\frac{x}{A}\right)^h},\]</div>
<p>and its cumulative density</p>
<div class="math">
\[G(x; a, h, A) = \int_0^x g(\tau; a, h, A)d\tau,\]</div>
<p>computed by numerically the Trapezoidal rule, for instance.
We also want to compute and display
the mean value <span class="math">\(A\Gamma(a + 1/h)/\Gamma(a)\)</span> and
standard deviation</p>
<div class="math">
\[\sigma = \frac{A}{\Gamma(a)}\sqrt{\Gamma(a + 2/h)\Gamma(a) - \Gamma(a+1/h)^2}.\]</div>
<p>Here, <span class="math">\(\Gamma(a)\)</span> is the gamma function, which can be computed
by <tt class="docutils literal"><span class="pre">math.gamma(a)</span></tt> in Python.
Below is a <tt class="docutils literal"><span class="pre">compute.py</span></tt> file with the
relevant implementations of <span class="math">\(g(x;a,h,A)\)</span> (<tt class="docutils literal"><span class="pre">gamma_density</span></tt>),
<span class="math">\(G(x; a, h, A)\)</span> (<tt class="docutils literal"><span class="pre">gamma_cumulative</span></tt>), and a function <tt class="docutils literal"><span class="pre">compute_gamma</span></tt> for
making a plot of <span class="math">\(g\)</span> og <span class="math">\(G\)</span> for <span class="math">\(x\in [0,7\sigma]\)</span>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="c"># http://en.wikipedia.org/wiki/Gamma_distribution</span>
    <span class="n">xA</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">h</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xA</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">h</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">xA</span><span class="o">**</span><span class="n">h</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gamma_cumulative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="c"># Integrate gamma_density using the Trapezoidal rule.</span>
    <span class="c"># Assume x is array.</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">r</span>

<span class="k">def</span> <span class="nf">compute_gamma</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return plot and mean/st.dev. value of the gamma density.&quot;&quot;&quot;</span>
    <span class="n">gah</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">h</span><span class="p">)</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">gah</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">stdev</span> <span class="o">=</span> <span class="n">A</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">/</span><span class="n">h</span><span class="p">)</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="n">gah</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="o">*</span><span class="n">stdev</span><span class="p">,</span> <span class="n">resolution</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">gamma_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>  <span class="c"># needed to avoid adding curves in plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">&#39;a=</span><span class="si">%g</span><span class="s">, h=</span><span class="si">%g</span><span class="s">, A=</span><span class="si">%g</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Remove old plot files</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;*.png&#39;</span><span class="p">)):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c"># Use time since Jan 1, 1970 in filename in order make</span>
    <span class="c"># a unique filename that the browser has not chached</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">plotfile1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;density_</span><span class="si">%s</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">plotfile2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;static&#39;</span><span class="p">,</span> <span class="s">&#39;cumulative_</span><span class="si">%s</span><span class="s">.png&#39;</span> <span class="o">%</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">gamma_cumulative</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">plotfile2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plotfile1</span><span class="p">,</span> <span class="n">plotfile2</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">mean</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%.2f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">stdev</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">compute_gamma</span></tt> function returns a tuple of four values.
We want output as displayed in Figure <a class="reference internal" href="#wf-vib3-flask-fig-gamma"><em>Design of a web page illustrating the gamma probability functions</em></a>.</p>
<div class="figure" id="wf-vib3-flask-fig-gamma">
<a class="reference internal image-reference" href="_images/vib3_flask_gamma.png"><img alt="_images/vib3_flask_gamma.png" src="_images/vib3_flask_gamma.png" style="width: 700px;" /></a>
<p class="caption"><em>Design of a web page illustrating the gamma probability functions</em></p>
</div>
<p>The design is realized in the file <tt class="docutils literal"><span class="pre">view_results.html</span></tt> shown below.</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;p&gt;</span>
<span class="nt">&lt;table&gt;</span>
<span class="nt">&lt;tr&gt;</span>
<span class="nt">&lt;td&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result[0] }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/td&gt;&lt;td&gt;</span>
<span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">&quot;{{ result[1] }}&quot;</span> <span class="na">width=</span><span class="s">&quot;400&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;tr&gt;&lt;td&gt;</span>
Mean value: {{ result[2] }} <span class="nt">&lt;br&gt;</span>
Standard deviation value: {{ result[3] }}
<span class="nt">&lt;/td&gt;&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/p&gt;</span>
</pre></div>
</div>
<p>To create the web application, we just copy the generic <tt class="docutils literal"><span class="pre">controller.py</span></tt>,
<tt class="docutils literal"><span class="pre">model.py</span></tt>,
and <tt class="docutils literal"><span class="pre">templates/view_forms.html</span></tt> files, add the
application-specific
<tt class="docutils literal"><span class="pre">compute.py</span></tt> and <tt class="docutils literal"><span class="pre">templates/view_results.html</span></tt> files given above,
and <em>write one line</em> in
<tt class="docutils literal"><span class="pre">model.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">compute</span> <span class="kn">import</span> <span class="n">compute_gamma</span> <span class="k">as</span> <span class="n">compute</span>
</pre></div>
</div>
<p>That&#8217;s it! Running <tt class="docutils literal"><span class="pre">controller.py</span></tt> file starts the app.</p>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <center>
            <p class="logo"><a href="http://cbc.simula.no/" title="Go to Center for Biomedical Computing">
              <img class="logo" src="_static/cbc_logo.png" alt="Logo"/>
            </a></p>
            </center>
  <h4>Previous topic</h4>
  <p class="topless"><a href="._web4sa012.html"
                        title="previous chapter">Custom validation  (1)</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="._web4sa014.html"
                        title="next chapter">Avoiding plot files</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/._web4sa013.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="._web4sa014.html" title="Avoiding plot files"
             >next</a> |</li>
        <li class="right" >
          <a href="._web4sa012.html" title="Custom validation (1)"
             >previous</a> |</li>
        <li><a href="index.html">Using Web Frameworks for Scientific Applications</a> &raquo;</li> 
      </ul>
    </div>
<div class="wrapper">
  <div class="footer">
  <a href="http://cbc.simula.no"><img src="_static/cbc_banner.png" width="100%"><a>
  </div>
</div>

  </body>
</html>